<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ’ç¨‹ç®¡ç† - Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .back-btn {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .back-btn:hover {
            text-decoration: underline;
        }

        .main-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 13px;
        }

        .template-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .template-info.show {
            display: block;
        }

        .template-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .template-info .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .template-info .stat-item {
            font-size: 13px;
        }

        .template-info .stat-item strong {
            color: #333;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .schedule-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            display: none;
        }

        .schedule-preview.show {
            display: block;
        }

        .schedule-preview h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .preview-item {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }

        .preview-item strong {
            color: #333;
        }

        .upcoming-schedules {
            margin-top: 40px;
        }

        .upcoming-schedules h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e8ed;
        }

        .schedule-list {
            display: grid;
            gap: 15px;
        }

        .schedule-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .schedule-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .schedule-card p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .schedule-card .time {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .schedule-card .delete-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        .schedule-card .delete-btn:hover {
            background: #c82333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-PENDING {
            background: #fff3cd;
            color: #856404;
        }

        .status-GENERATED {
            background: #cce5ff;
            color: #004085;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-btn">â† è¿”å›ç®¡ç†ä»‹é¢</a>
            <h1>ğŸ“… æ™ºèƒ½æ’ç¨‹ç®¡ç†</h1>
            <p>æ‰‹å‹•å»ºç«‹ç™¼æ–‡æ’ç¨‹ï¼Œç³»çµ±å°‡åœ¨æŒ‡å®šæ™‚é–“è‡ªå‹•ç”Ÿæˆä¸¦ç™¼å¸ƒå…§å®¹</p>
        </div>

        <div class="main-content">
            <!-- æç¤ºè¨Šæ¯ -->
            <div id="alert" class="alert"></div>

            <!-- å»ºç«‹æ’ç¨‹è¡¨å–® -->
            <h2 style="color: #333; margin-bottom: 20px;">å»ºç«‹æ–°æ’ç¨‹</h2>

            <form id="scheduleForm">
                <div class="form-group">
                    <label for="templateSelect">é¸æ“‡å…§å®¹æ¨¡æ¿ *</label>
                    <select id="templateSelect" required>
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                    <small>é¸æ“‡è¦ä½¿ç”¨çš„æ–‡ç« é¢¨æ ¼æ¨¡æ¿</small>

                    <!-- æ¨¡æ¿è³‡è¨Šå¡ç‰‡ -->
                    <div id="templateInfo" class="template-info">
                        <p><strong>æè¿°ï¼š</strong><span id="templateDesc"></span></p>
                        <div class="stats">
                            <div class="stat-item">
                                <strong>ä½¿ç”¨æ¬¡æ•¸ï¼š</strong><span id="templateUses">0</span>
                            </div>
                            <div class="stat-item">
                                <strong>å¹³å‡äº’å‹•ç‡ï¼š</strong><span id="templateEngagement">0.00%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="scheduledTime">ç™¼æ–‡æ™‚é–“ *</label>
                    <input type="datetime-local" id="scheduledTime" required>
                    <small id="timeHint">å…è¨±æ™‚æ®µï¼šè¼‰å…¥ä¸­...</small>
                </div>

                <!-- æ’ç¨‹é è¦½ -->
                <div id="schedulePreview" class="schedule-preview">
                    <h3>ğŸ“‹ æ’ç¨‹é è¦½</h3>
                    <div class="preview-item">
                        <strong>æ¨¡æ¿ï¼š</strong><span id="previewTemplate"></span>
                    </div>
                    <div class="preview-item">
                        <strong>ç™¼æ–‡æ™‚é–“ï¼š</strong><span id="previewTime"></span>
                    </div>
                    <div class="preview-item">
                        <strong>å€’æ•¸ï¼š</strong><span id="previewCountdown"></span>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button type="submit" class="btn" id="submitBtn">
                        âœ… å»ºç«‹æ’ç¨‹
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ æ¸…é™¤
                    </button>
                </div>
            </form>

            <!-- å³å°‡ç™¼å¸ƒçš„æ’ç¨‹åˆ—è¡¨ -->
            <div class="upcoming-schedules">
                <h2>ğŸ“Š å³å°‡ç™¼å¸ƒçš„æ’ç¨‹</h2>
                <div id="scheduleList">
                    <div class="loading">è¼‰å…¥ä¸­</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let token = localStorage.getItem('token');
        let templates = [];
        let config = null;

        // API åŸºç¤ URL
        const API_BASE = '/api';

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', async () => {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (!token) {
                alert('è«‹å…ˆç™»å…¥ç³»çµ±');
                window.location.href = '/';
                return;
            }

            // è¼‰å…¥è³‡æ–™
            await loadTemplates();
            await loadConfig();
            await loadUpcomingSchedules();

            // è¨­ç½®è¡¨å–®äº‹ä»¶ç›£è½
            setupEventListeners();
        });

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ¨¡æ¿é¸æ“‡è®Šæ›´
            document.getElementById('templateSelect').addEventListener('change', (e) => {
                const templateId = e.target.value;
                if (templateId) {
                    showTemplateInfo(templateId);
                    updatePreview();
                } else {
                    hideTemplateInfo();
                }
            });

            // æ™‚é–“é¸æ“‡è®Šæ›´
            document.getElementById('scheduledTime').addEventListener('change', () => {
                updatePreview();
            });

            // è¡¨å–®æäº¤
            document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createSchedule();
            });
        }

        // è¼‰å…¥æ¨¡æ¿åˆ—è¡¨
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/scheduling/templates`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥æ¨¡æ¿åˆ—è¡¨');
                }

                const data = await response.json();
                templates = data.templates;

                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">è«‹é¸æ“‡æ¨¡æ¿...</option>';

                templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = `${template.name} ${template.avg_engagement_rate > 0 ? 'â­ ' + template.avg_engagement_rate + '%' : ''}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', error);
                showAlert('ç„¡æ³•è¼‰å…¥æ¨¡æ¿åˆ—è¡¨ï¼š' + error.message, 'error');
            }
        }

        // è¼‰å…¥æ’ç¨‹é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/scheduling/config`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥æ’ç¨‹é…ç½®');
                }

                const data = await response.json();
                config = data.config;

                // æ›´æ–°æ™‚é–“æç¤º
                const startTime = `${String(config.start_hour).padStart(2, '0')}:${String(config.start_minute).padStart(2, '0')}`;
                const endTime = `${String(config.end_hour).padStart(2, '0')}:${String(config.end_minute).padStart(2, '0')}`;
                document.getElementById('timeHint').textContent = `å…è¨±æ™‚æ®µï¼š${startTime} - ${endTime}`;

                // è¨­ç½®æ™‚é–“è¼¸å…¥æ¡†çš„æœ€å°å€¼ç‚ºç•¶å‰æ™‚é–“
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(config.start_hour, config.start_minute, 0, 0);

                const minTime = formatDateTimeLocal(tomorrow);
                document.getElementById('scheduledTime').min = formatDateTimeLocal(now);
                document.getElementById('scheduledTime').value = minTime;
            } catch (error) {
                console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
                showAlert('ç„¡æ³•è¼‰å…¥æ’ç¨‹é…ç½®ï¼š' + error.message, 'error');
            }
        }

        // è¼‰å…¥å³å°‡ç™¼å¸ƒçš„æ’ç¨‹
        async function loadUpcomingSchedules() {
            try {
                const response = await fetch(`${API_BASE}/scheduling/upcoming?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥æ’ç¨‹åˆ—è¡¨');
                }

                const data = await response.json();
                const schedules = data.schedules;

                const listContainer = document.getElementById('scheduleList');

                if (schedules.length === 0) {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <p>ç›®å‰æ²’æœ‰å¾…ç™¼å¸ƒçš„æ’ç¨‹</p>
                            <p style="font-size: 14px;">å»ºç«‹ç¬¬ä¸€å€‹æ’ç¨‹é–‹å§‹è‡ªå‹•ç™¼æ–‡ï¼</p>
                        </div>
                    `;
                    return;
                }

                // æ¸²æŸ“æ’ç¨‹å¡ç‰‡
                listContainer.innerHTML = schedules.map(schedule => `
                    <div class="schedule-card">
                        <button class="delete-btn" onclick="deleteSchedule('${schedule.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                        <p class="time">${formatScheduleTime(schedule.scheduled_time)}</p>
                        <h4>${schedule.template_name}</h4>
                        <p>${schedule.template_description || ''}</p>
                        <p style="margin-top: 10px;">
                            <span class="status-badge status-${schedule.status}">${formatStatus(schedule.status)}</span>
                            ${schedule.selection_method === 'MANUAL' ? 'ğŸ‘¤ æ‰‹å‹•å»ºç«‹' : 'ğŸ¤– AI å»ºè­°'}
                        </p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            å€’æ•¸ï¼š${getCountdown(schedule.scheduled_time)}
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥æ’ç¨‹å¤±æ•—:', error);
                document.getElementById('scheduleList').innerHTML = `
                    <div class="empty-state">
                        <p style="color: #dc3545;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        // é¡¯ç¤ºæ¨¡æ¿è³‡è¨Š
        function showTemplateInfo(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            document.getElementById('templateDesc').textContent = template.description || 'ç„¡æè¿°';
            document.getElementById('templateUses').textContent = template.total_uses || 0;
            document.getElementById('templateEngagement').textContent = (template.avg_engagement_rate || 0) + '%';
            document.getElementById('templateInfo').classList.add('show');
        }

        // éš±è—æ¨¡æ¿è³‡è¨Š
        function hideTemplateInfo() {
            document.getElementById('templateInfo').classList.remove('show');
        }

        // æ›´æ–°æ’ç¨‹é è¦½
        function updatePreview() {
            const templateId = document.getElementById('templateSelect').value;
            const scheduledTime = document.getElementById('scheduledTime').value;

            if (!templateId || !scheduledTime) {
                document.getElementById('schedulePreview').classList.remove('show');
                return;
            }

            const template = templates.find(t => t.id === templateId);
            const date = new Date(scheduledTime);

            document.getElementById('previewTemplate').textContent = template.name;
            document.getElementById('previewTime').textContent = formatScheduleTime(scheduledTime);
            document.getElementById('previewCountdown').textContent = getCountdown(scheduledTime);

            document.getElementById('schedulePreview').classList.add('show');
        }

        // å»ºç«‹æ’ç¨‹
        async function createSchedule() {
            const templateId = document.getElementById('templateSelect').value;
            const scheduledTime = document.getElementById('scheduledTime').value;

            if (!templateId || !scheduledTime) {
                showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            // è½‰æ›ç‚º ISO 8601 æ ¼å¼
            const isoTime = new Date(scheduledTime).toISOString();

            // ç¦ç”¨æäº¤æŒ‰éˆ•
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'å»ºç«‹ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/scheduling/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateId,
                        scheduledTime: isoTime
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'å»ºç«‹å¤±æ•—');
                }

                // æˆåŠŸ
                showAlert('âœ… æ’ç¨‹å»ºç«‹æˆåŠŸï¼', 'success');
                resetForm();
                await loadUpcomingSchedules();
            } catch (error) {
                console.error('å»ºç«‹æ’ç¨‹å¤±æ•—:', error);
                showAlert('å»ºç«‹å¤±æ•—ï¼š' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… å»ºç«‹æ’ç¨‹';
            }
        }

        // åˆªé™¤æ’ç¨‹
        async function deleteSchedule(scheduleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç¨‹å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/scheduling/${scheduleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                }

                showAlert('âœ… æ’ç¨‹å·²åˆªé™¤', 'success');
                await loadUpcomingSchedules();
            } catch (error) {
                console.error('åˆªé™¤æ’ç¨‹å¤±æ•—:', error);
                showAlert('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('scheduleForm').reset();
            document.getElementById('templateInfo').classList.remove('show');
            document.getElementById('schedulePreview').classList.remove('show');

            // é‡æ–°è¨­ç½®é è¨­æ™‚é–“
            if (config) {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(config.start_hour, config.start_minute, 0, 0);
                document.getElementById('scheduledTime').value = formatDateTimeLocal(tomorrow);
            }
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º datetime-local æ ¼å¼
        function formatDateTimeLocal(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // æ ¼å¼åŒ–æ’ç¨‹æ™‚é–“é¡¯ç¤º
        function formatScheduleTime(timeString) {
            const date = new Date(timeString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const dayOfWeek = dayNames[date.getDay()];

            return `${year}/${month}/${day} (${dayOfWeek}) ${hours}:${minutes}`;
        }

        // è¨ˆç®—å€’æ•¸æ™‚é–“
        function getCountdown(timeString) {
            const now = new Date();
            const target = new Date(timeString);
            const diff = target - now;

            if (diff < 0) {
                return 'å·²éæœŸ';
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) {
                return `${days} å¤© ${hours} å°æ™‚`;
            } else if (hours > 0) {
                return `${hours} å°æ™‚ ${minutes} åˆ†é˜`;
            } else {
                return `${minutes} åˆ†é˜`;
            }
        }

        // æ ¼å¼åŒ–ç‹€æ…‹é¡¯ç¤º
        function formatStatus(status) {
            const statusMap = {
                'PENDING': 'å¾…åŸ·è¡Œ',
                'GENERATED': 'å·²ç”Ÿæˆ',
                'POSTED': 'å·²ç™¼å¸ƒ',
                'FAILED': 'å¤±æ•—',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // å®šæ™‚åˆ·æ–°å€’æ•¸æ™‚é–“ï¼ˆæ¯åˆ†é˜ï¼‰
        setInterval(() => {
            loadUpcomingSchedules();
        }, 60000);
    </script>
</body>
</html>
