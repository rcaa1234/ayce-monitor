<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ç‰Œç›£æ§ä¸­å¿ƒ - ç®¡ç†ä»‹é¢</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .user-info {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .user-info p {
            color: #333;
            margin: 5px 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-section,
        .dashboard {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sub-tabs styling */
        .sub-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 15px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .sub-tab-content {
            display: none;
            padding-top: 20px;
        }

        .sub-tab-content.active {
            display: block;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .post-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .post-card .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-DRAFT {
            background: #e9ecef;
            color: #495057;
        }

        .status-GENERATING {
            background: #fff3cd;
            color: #856404;
        }

        .status-PENDING_REVIEW {
            background: #cce5ff;
            color: #004085;
        }

        .status-APPROVED {
            background: #d4edda;
            color: #155724;
        }

        .status-POSTED {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-FAILED {
            background: #f8d7da;
            color: #721c24;
        }

        .post-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            min-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Smart Scheduling Styles */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .template-card {
            background: white;
            border: none;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .template-card:hover {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .template-card.disabled {
            opacity: 0.6;
            background: #f9fafb;
            border-left-color: #9ca3af;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .template-description {
            font-size: 14px;
            color: #6b7280;
        }

        .template-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-enabled {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .template-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .template-prompt {
            font-size: 13px;
            color: #4b5563;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            max-height: 70px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-actions .btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 13px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        .config-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
        }

        .config-card h3 {
            color: #111827;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h4 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 13px;
            opacity: 0.9;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .schedule-date {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .schedule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-generated {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-posted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .schedule-info-item {
            color: #6b7280;
        }

        .schedule-info-item strong {
            color: #111827;
        }

        .schedule-reason {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
            border-left: 3px solid #667eea;
        }

        .schedule-reason strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .preview-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
            color: #1f2937;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }

        .preview-loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .preview-loading .spinner-small {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-test {
            background: #10b981;
            color: white;
        }

        .btn-test:hover {
            background: #059669;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ å“ç‰Œç›£æ§ä¸­å¿ƒ</h1>
            <p>è²é‡ç›£æ§ | ç¶²é»ƒåµæ¸¬ | Threads è‡ªå‹•ç™¼æ–‡</p>
            <div id="userInfo" class="user-info">
                <p><strong>ä½¿ç”¨è€…:</strong> <span id="userName"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>è§’è‰²:</strong> <span id="userRoles"></span></p>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px;">ç™»å…¥ç³»çµ±</h2>
            <div id="loginAlert"></div>

            <!-- Google ç™»å…¥æŒ‰éˆ• -->
            <div id="googleLoginBtn" style="display:flex;justify-content:center;margin-bottom:20px;">
                <button id="googleSignInBtn" onclick="googleSignIn()" style="display:none;background:#fff;color:#333;border:1px solid #dadce0;border-radius:8px;padding:12px 24px;font-size:15px;cursor:pointer;display:none;align-items:center;gap:10px;transition:background 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
            </div>

            <div style="display:flex;align-items:center;margin:20px 0;">
                <hr style="flex:1;border:none;border-top:1px solid #e1e8ed;">
                <span style="padding:0 15px;color:#999;font-size:14px;">æˆ–ä½¿ç”¨å¯†ç¢¼ç™»å…¥</span>
                <hr style="flex:1;border:none;border-top:1px solid #e1e8ed;">
            </div>

            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">ç™»å…¥</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('monitor')">ğŸ“Š è²é‡ç›£æ§</button>
                <button class="tab" onclick="switchTab('influencer')">ğŸ” ç¶²é»ƒåµæ¸¬</button>
                <button class="tab" onclick="switchTab('threads')">ğŸ¤– Threads Bot</button>
                <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
                <button class="tab" id="usersTabBtn" onclick="switchTab('users')" style="display:none;">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</button>
            </div>

            <!-- Alert Area -->
            <div id="dashboardAlert"></div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">è™•ç†ä¸­...</p>
            </div>

            <!-- Overview Tab -->
            <!-- ========================================== -->
            <!-- Threads Bot Section -->
            <!-- ========================================== -->
            <div id="threadsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ¤– Threads Bot</h2>

                <!-- Threads Sub-tabs -->
                <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                    <button class="threads-sub-tab active" onclick="switchThreadsSubTab('overview')"
                        style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                        ğŸ“Š ç¸½è¦½
                    </button>
                    <button class="threads-sub-tab" onclick="switchThreadsSubTab('scheduling')"
                        style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                        ğŸ“… ç™¼æ–‡æ’ç¨‹
                    </button>
                    <button class="threads-sub-tab" onclick="switchThreadsSubTab('templates')"
                        style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                        âœ¨ æç¤ºè©è¨­å®š
                    </button>
                    <button class="threads-sub-tab" onclick="switchThreadsSubTab('accounts')"
                        style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                        ğŸ‘¤ å¸³è™Ÿç®¡ç†
                    </button>
                </div>

                <!-- Threads Overview Sub-tab -->
                <div id="threadsOverviewSubTab" class="threads-sub-content active">
                <!-- System Overview -->
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px;">ç³»çµ±ç¸½è¦½</h2>
                    <div class="stats" id="stats" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card">
                            <h3 id="totalPosts">0</h3>
                            <p>ç¸½è²¼æ–‡æ•¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingPosts">0</h3>
                            <p>å¾…å¯©æ ¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="scheduledPosts">0</h3>
                            <p>æ’ç¨‹ä¸­</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="postedPosts">0</h3>
                            <p>å·²ç™¼å¸ƒ</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div>
                    <h2 style="margin-bottom: 20px;">è²¼æ–‡çµ±è¨ˆ</h2>

                    <!-- Statistics Sub-tabs -->
                    <div
                        style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                        <button class="stats-sub-tab active" onclick="switchStatsTab('summary')"
                            style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“Š æ‘˜è¦
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('templates')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“Š é¡å‹
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('timeslots')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            â° æ™‚æ®µ
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('details')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“‹ æ˜ç´°
                        </button>
                    </div>

                    <!-- Statistics Summary Sub-tab -->
                    <div id="statsSummaryTab" class="stats-sub-content active"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; margin: 0;">æ•´é«”è¡¨ç¾</h3>
                            <select id="summaryDaysSelect" onchange="loadStatsSummary()"
                                style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                <option value="7">æœ€è¿‘ 7 å¤©</option>
                                <option value="30">æœ€è¿‘ 30 å¤©</option>
                                <option value="90">æœ€è¿‘ 90 å¤©</option>
                                <option value="180">æœ€è¿‘ 180 å¤©</option>
                                <option value="360">æœ€è¿‘ 360 å¤©</option>
                                <option value="all">å…¨éƒ¨æ­·å²</option>
                            </select>
                        </div>

                        <!-- Key Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalPosts">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å·²ç™¼å¸ƒè²¼æ–‡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalViews">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½è§€çœ‹æ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalLikes">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½æŒ‰è®šæ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;"
                                    id="statsAvgEngagement">-</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å¹³å‡åƒèˆ‡ç‡</div>
                            </div>
                        </div>

                        <!-- Trend Chart -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0;">è¶¨å‹¢åœ–</h4>
                                <select id="trendDaysSelect" onchange="loadStatsSummary()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                                    <option value="30">æœ€è¿‘ 30 å¤©</option>
                                    <option value="90">æœ€è¿‘ 90 å¤©</option>
                                    <option value="180">æœ€è¿‘ 180 å¤©</option>
                                    <option value="360">æœ€è¿‘ 360 å¤©</option>
                                </select>
                            </div>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="stats7DayChart"></canvas>
                            </div>
                            <div
                                style="margin-top: 10px; padding: 8px 12px; background: #f0f4f8; border-radius: 6px; font-size: 11px; color: #64748b;">
                                <strong>ğŸ“Š åƒèˆ‡ç‡è¨ˆç®—å…¬å¼ï¼š</strong>
                                <span
                                    style="font-family: monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">
                                    åƒèˆ‡ç‡ = (æŒ‰è®š + å›è¦† + è½‰ç™¼) Ã· è§€çœ‹æ•¸ Ã— 100%
                                </span>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div id="statsSyncStatus"
                            style="background: white; padding: 15px; border-radius: 8px; font-size: 13px; color: #666;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div>ä¸Šæ¬¡åŒæ­¥: <span id="statsLastSync">-</span></div>
                                    <div style="margin-top: 5px;">å·²åŒæ­¥è²¼æ–‡: <span id="statsSyncedCount">-</span> ç¯‡</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="syncThreadsPosts(true)"
                                        style="padding: 5px 12px; background: #059669; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ“¦ å®Œæ•´åŒ¯å…¥å…¨éƒ¨
                                    </button>
                                    <button onclick="reclassifyTemplates()"
                                        style="padding: 5px 12px; background: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ·ï¸ é‡æ–°åˆ†é¡æ¨¡æ¿
                                    </button>
                                    <button onclick="triggerManualSync()"
                                        style="padding: 5px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ”„ åŒæ­¥äº’å‹•æ•¸æ“š
                                    </button>
                                    <button onclick="clearPendingPosts()"
                                        style="padding: 5px 12px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ æ¸…é™¤å¾…å¯©æ ¸
                                    </button>
                                    <button onclick="clearScheduledPosts()"
                                        style="padding: 5px 12px; background: #f97316; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹ä¸­
                                    </button>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #999;">
                                ğŸ’¡ æç¤ºï¼šã€Œå®Œæ•´åŒ¯å…¥å…¨éƒ¨ã€åŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ï¼Œã€Œé‡æ–°åˆ†é¡æ¨¡æ¿ã€æœƒç‚ºæ²’æœ‰æ¨¡æ¿çš„è²¼æ–‡è‡ªå‹•åˆ†é¡ã€‚
                            </p>
                        </div>

                        <!-- Data Analytics Section -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="font-size: 15px; color: #333; margin: 0;">ğŸ“ˆ æ•¸æ“šåˆ†æ</h4>
                                <select id="analyticsDaysSelect" onchange="onAnalyticsDaysChange()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                                    <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
                                    <option value="90">æœ€è¿‘ 90 å¤©</option>
                                    <option value="180">æœ€è¿‘ 180 å¤©</option>
                                    <option value="365">æœ€è¿‘ 365 å¤©</option>
                                    <option value="9999">å…¨éƒ¨æ­·å²</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <!-- Best Posting Hours -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ• æœ€ä½³ç™¼æ–‡æ™‚æ®µ</h4>
                                <div id="bestHoursChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...
                                    </p>
                                </div>
                            </div>

                            <!-- Best Posting Days -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ“… æ˜ŸæœŸè¡¨ç¾åˆ†æ</h4>
                                <div id="bestDaysChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performing Posts -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ† Top 5 è¡¨ç¾æœ€ä½³è²¼æ–‡</h4>
                            <div id="topPostsList" style="max-height: 300px; overflow-y: auto;">
                                <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- Content Length Analysis -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ“ å…§å®¹é•·åº¦åˆ†æ</h4>
                            <div id="contentLengthAnalysis" style="min-height: 80px;">
                                <p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Templates Sub-tab (æ”¹ç‚ºç™¼æ–‡é¡å‹åˆ†æ) -->
                    <div id="statsTemplatesTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“Š ç™¼æ–‡é¡å‹åˆ†æ</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                            çµ±è¨ˆä¸‰ç¨®ç™¼æ–‡é¡å‹çš„è¡¨ç¾ï¼šAI ç™¼æ–‡ã€é AI (å«åœ–)ã€é AI (ç„¡åœ–)
                        </p>
                        <div id="statsTemplatesList" style="display: grid; gap: 15px;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>

                        <!-- ç¶­åº¦ä½¿ç”¨çµ±è¨ˆå€å¡Š -->
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 15px; font-size: 16px; color: #374151;">ğŸ¯ AI ç™¼æ–‡ç¶­åº¦çµ±è¨ˆ</h4>
                            <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                                åˆ†ææœ€è¿‘ 30 å¤© AI ç™¼æ–‡ä½¿ç”¨çš„å…­ç¨®ç¶­åº¦åˆ†ä½ˆ
                            </p>
                            <div id="dimension-stats-overview" style="display: grid; gap: 15px;">
                                <p style="color: #999; text-align: center; padding: 20px 0;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Timeslots Sub-tab -->
                    <div id="statsTimeslotsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">æ™‚æ®µåˆ†æ</h3>
                        <div id="statsTimeslotsList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- Statistics Details Sub-tab -->
                    <div id="statsDetailsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">è²¼æ–‡æ˜ç´°</h3>

                        <!-- Export Button -->
                        <div style="margin-bottom: 15px; text-align: right;">
                            <button onclick="exportStatsToCSV()"
                                style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                ğŸ“¥ åŒ¯å‡º CSV
                            </button>
                        </div>

                        <div id="statsDetailsList" style="max-height: 450px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- Posts Management Section -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">è²¼æ–‡ç®¡ç†</h3>
                    <div class="filter-bar">
                        <select id="filterStatus" onchange="loadPosts()">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="DRAFT">è‰ç¨¿</option>
                            <option value="GENERATING">ç”¢ç”Ÿä¸­</option>
                            <option value="PENDING_REVIEW">å¾…å¯©æ ¸</option>
                            <option value="APPROVED">å·²æ ¸å‡†</option>
                            <option value="POSTED">å·²ç™¼å¸ƒ</option>
                            <option value="FAILED">å¤±æ•—</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="loadPosts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">â˜‘ï¸ å…¨é¸/åé¸</button>
                        <button class="btn btn-danger btn-small" onclick="batchDeletePosts()" id="batchDeleteBtn"
                            style="display: none;">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤</button>
                    </div>
                    <div id="postsGrid" class="posts-grid"></div>
                </div>
            </div>
            <!-- End of threadsOverviewSubTab -->

                <!-- Threads Scheduling Sub-tab -->
                <div id="threadsSchedulingSubTab" class="threads-sub-content" style="display: none;">
                <h2 style="margin-bottom: 20px;">ç™¼æ–‡æ’ç¨‹ç®¡ç†</h2>

                <!-- Internal Sub-tabs -->
                <div class="sub-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    <button class="sub-tab active" onclick="switchSchedulingSubTab('ai')">ğŸ¤– AIç™¼æ–‡</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('manual')">ğŸ“ é ç´„ç™¼æ–‡</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('pending')">ğŸ“‹ æ’ç¨‹ä¸­è²¼æ–‡</button>
                </div>

                <!-- AI Post Sub-tab -->
                <div id="aiSubTab" class="sub-tab-content active">
                    <h3 style="margin-bottom: 20px;">AI è‡ªå‹•ç™¼æ–‡è¨­å®š</h3>
                    <p style="color: #666; margin-bottom: 20px;">è¨­å®š AI è‡ªå‹•ç”Ÿæˆè²¼æ–‡çš„ç™¼æ–‡é »ç‡å’Œæ™‚æ®µï¼Œç³»çµ±æœƒæ ¹æ“šã€Œæç¤ºè©è¨­å®šã€çš„å…§å®¹è‡ªå‹•ç”¢ç”Ÿä¸¦ç™¼å¸ƒè²¼æ–‡</p>

                    <div class="config-grid">
                        <!-- Left: Configuration Form -->
                        <div class="config-card">
                            <h3>ç™¼æ–‡è¨­å®š</h3>
                            <form id="ai-config-form" onsubmit="saveAIConfig(event)">
                                <div class="form-group">
                                    <label for="posts-per-day">æ¯æ—¥ç™¼æ–‡æ¬¡æ•¸</label>
                                    <input type="number" id="posts-per-day" min="1" max="10" value="1" required>
                                    <small>ç³»çµ±æ¯å¤©è‡ªå‹•å»ºç«‹å¹¾å€‹ç™¼æ–‡æ’ç¨‹</small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-start">ç™¼æ–‡æ™‚æ®µ - é–‹å§‹æ™‚é–“</label>
                                    <input type="time" id="time-range-start" value="09:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI æœƒåœ¨æ­¤æ™‚é–“ä¹‹å¾Œéš¨æ©Ÿé¸æ“‡ç™¼æ–‡æ™‚é–“</small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-end">ç™¼æ–‡æ™‚æ®µ - çµæŸæ™‚é–“</label>
                                    <input type="time" id="time-range-end" value="21:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI æœƒåœ¨æ­¤æ™‚é–“ä¹‹å‰é¸æ“‡ç™¼æ–‡æ™‚é–“</small>
                                </div>

                                <div class="form-group">
                                    <label>å•Ÿç”¨æ˜ŸæœŸ</label>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="1" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±ä¸€</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="2" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±äºŒ</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="3" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±ä¸‰</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="4" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±å››</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="5" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±äº”</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="6" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±å…­</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="7" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±æ—¥</span>
                                        </label>
                                    </div>
                                    <small style="margin-top: 8px; display: block;">é¸æ“‡ AI è‡ªå‹•ç™¼æ–‡çš„æ˜ŸæœŸï¼Œæœªé¸æ“‡çš„æ˜ŸæœŸä¸æœƒè‡ªå‹•ç™¼æ–‡</small>
                                </div>

                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="auto-schedule-enabled" checked>
                                        <label for="auto-schedule-enabled" style="margin-bottom: 0;">å•Ÿç”¨è‡ªå‹•ç™¼æ–‡</label>
                                    </div>
                                    <small>æ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ä¸¦ç™¼é€åˆ° LINE å¯©æ ¸</small>
                                </div>

                                <button type="submit" class="btn btn-success" style="width: 100%;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                            </form>
                        </div>

                        <!-- Right: Quick Actions & Info -->
                        <div class="config-card">
                            <h3>å¿«é€Ÿæ“ä½œ</h3>

                            <div
                                style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                                <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">ğŸ“Œ ä½¿ç”¨èªªæ˜</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #334155; line-height: 1.8;">
                                    <li><strong>å•Ÿç”¨è‡ªå‹•ç™¼æ–‡</strong>ï¼šæ¯å¤© 00:00 è‡ªå‹•å»ºç«‹ç™¼æ–‡æ’ç¨‹</li>
                                    <li><strong>æç¤ºè©è¨­å®š</strong>ï¼šåœ¨ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆå…§å®¹çš„æŒ‡ä»¤</li>
                                    <li><strong>LINE å¯©æ ¸</strong>ï¼šç™¼æ–‡å‰æœƒç™¼é€åˆ° LINE é€šçŸ¥å¯©æ ¸</li>
                                    <li><strong>åŸ·è¡Œæµç¨‹</strong>ï¼šå»ºç«‹æ’ç¨‹ â†’ ç”Ÿæˆæ–‡ç«  â†’ LINE é€šçŸ¥ â†’ å¯©æ ¸ â†’ ç™¼å¸ƒ</li>
                                </ul>
                            </div>

                            <div
                                style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">âš ï¸ é‡è¦æé†’</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f; line-height: 1.8;">
                                    <li>è«‹å…ˆåœ¨ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆæç¤ºè©</li>
                                    <li>è«‹åœ¨ã€Œå¸³è™Ÿç®¡ç†ã€é é¢è¨­å®š Threads å¸³è™Ÿå’Œ LINE User ID</li>
                                    <li>æ¯å¤©æ¯å€‹æ™‚æ®µåªæœƒå»ºç«‹ä¸€å€‹ç™¼æ–‡æ’ç¨‹</li>
                                </ul>
                            </div>

                            <button class="btn btn-primary" onclick="triggerDailySchedule()"
                                style="width: 100%; padding: 15px; font-size: 16px;">
                                ğŸ§ª æ¸¬è©¦ç”Ÿæˆç™¼æ–‡
                            </button>
                            <small
                                style="display: block; margin-top: 10px; color: #6b7280; text-align: center; font-size: 12px;">
                                ç³»çµ±æœƒç«‹å³ç”Ÿæˆä¸€ç¯‡æ–‡ç« ä¸¦ç™¼é€ LINE é€šçŸ¥å¯©æ ¸
                            </small>
                        </div>
                    </div>

                    <div id="ai-message"></div>

                    <div style="margin-top: 40px;">
                        <div class="action-bar">
                            <h3>ç™¼æ–‡æ’ç¨‹æ­·å²</h3>
                            <button class="btn btn-secondary" onclick="loadScheduleHistory()">é‡æ–°æ•´ç†</button>
                        </div>
                        <div id="schedule-history-container"></div>
                    </div>
                </div>
                </div>
                <!-- End of threadsSchedulingSubTab -->

                <!-- Threads Accounts Sub-tab -->
                <div id="threadsAccountsSubTab" class="threads-sub-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">å¸³è™Ÿç®¡ç†</h3>

                <!-- AI ç™¼æ–‡è¨­å®š -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- ç™¼å¸ƒå¸³è™Ÿè¨­å®š -->
                    <div
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">ğŸ“± AI ç™¼æ–‡å¸³è™Ÿ</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">é¸æ“‡ Threads å¸³è™Ÿ</label>
                            <select id="ucbThreadsAccount" class="form-control"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                                <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                            </select>
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                AI è‡ªå‹•ç™¼æ–‡å°‡ä½¿ç”¨æ­¤å¸³è™Ÿç™¼å¸ƒè²¼æ–‡
                            </p>
                        </div>
                        <button class="btn" onclick="saveAccountSettings()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); width: 100%;">
                            ğŸ’¾ å„²å­˜å¸³è™Ÿè¨­å®š
                        </button>
                    </div>

                    <!-- LINE é€šçŸ¥è¨­å®š -->
                    <div
                        style="background: linear-gradient(135deg, #00c300 0%, #00a000 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">ğŸ’¬ LINE é€šçŸ¥è¨­å®š</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">LINE User ID</label>
                            <input type="text" id="ucbLineNotifyUserId" class="form-control"
                                placeholder="è«‹è¼¸å…¥ LINE User ID"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                ç™¼é€ã€Œ/myidã€çµ¦ LINE Bot å³å¯å–å¾— ID
                            </p>
                        </div>
                        <button class="btn" onclick="testUCBLineNotification()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">ğŸ“¨
                            æ¸¬è©¦é€šçŸ¥</button>
                    </div>
                </div>

                <!-- æ–°å¢ Threads å¸³è™Ÿ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ”— æ–°å¢ Threads å¸³è™Ÿ</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ç”±æ–¼ Threads API éœ€è¦ OAuth æˆæ¬Š,è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œ:
                    </p>
                    <ol style="color: #666; line-height: 1.8;">
                        <li>å‰å¾€ <a href="https://developers.facebook.com/" target="_blank" style="color: #667eea;">Meta
                                Developers</a> å»ºç«‹æ‡‰ç”¨ç¨‹å¼</li>
                        <li>å–å¾— Client ID å’Œ Client Secret</li>
                        <li>è¨­å®š Redirect URI ç‚º: <code
                                style="background: #e1e8ed; padding: 2px 6px; border-radius: 3px;">http://localhost:3000/api/threads/oauth/callback</code>
                        </li>
                        <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æˆæ¬Š</li>
                    </ol>
                    <button class="btn" onclick="startThreadsOAuth()" style="margin-top: 15px;">ğŸ”— é–‹å§‹ Threads
                        æˆæ¬Š</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">å·²é€£çµçš„ Threads å¸³è™Ÿ</h3>
                    <button class="btn" onclick="runDiagnostics()" style="background: #17a2b8; padding: 8px 16px;">ğŸ”
                        è¨ºæ–·ç™¼å¸ƒå•é¡Œ</button>
                </div>
                <div id="threadsAccountsList" class="posts-grid"></div>

                <!-- Diagnostics Result -->
                <div id="diagnosticsResult"
                    style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-bottom: 15px;">ğŸ” è¨ºæ–·çµæœ</h3>
                    <div id="diagnosticsContent"></div>
                </div>
            </div>

            <!-- Manual Post Sub-tab -->
            <div id="manualSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">é ç´„ç™¼æ–‡</h3>
                <p style="color: #666; margin-bottom: 20px;">ç›´æ¥è¼¸å…¥è²¼æ–‡å…§å®¹ï¼Œå¯ç«‹å³ç™¼å¸ƒæˆ–é ç´„æ™‚é–“ç™¼å¸ƒ</p>

                <form onsubmit="createManualPost(event)">
                    <div class="form-group">
                        <label>è²¼æ–‡å…§å®¹ *</label>
                        <textarea id="manualPostContent" rows="10" placeholder="ç›´æ¥è¼¸å…¥æ‚¨æƒ³ç™¼å¸ƒçš„å…§å®¹..." required
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; line-height: 1.6;"></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            å­—æ•¸: <span id="contentCharCount">0</span> / 500 (Threads å»ºè­°)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒåˆ° Threads å¸³è™Ÿ *</label>
                        <select id="manualPostThreadsAccount" required style="padding: 12px; font-size: 15px;">
                            <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒæ™‚é–“</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="now" checked
                                    onchange="toggleScheduleInput()">
                                ç«‹å³ç™¼å¸ƒ
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="scheduled"
                                    onchange="toggleScheduleInput()">
                                æ’ç¨‹ç™¼å¸ƒ
                            </label>
                        </div>
                        <input type="datetime-local" id="manualPostSchedule"
                            style="padding: 12px; font-size: 15px; display: none;">
                    </div>

                    <button type="submit" class="btn" style="padding: 15px 30px; font-size: 16px;">ç™¼å¸ƒè²¼æ–‡</button>
                </form>
            </div>

            <!-- Pending Posts Sub-tab -->
            <div id="pendingSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">æ’ç¨‹ä¸­è²¼æ–‡</h3>
                <p style="color: #666; margin-bottom: 20px;">é¡¯ç¤ºå·²å¯©æ ¸é€šéã€ç­‰å¾…ç™¼å¸ƒçš„è²¼æ–‡</p>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="loadPendingPosts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>

                <div id="pendingPostsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>
                </div>
                </div>
                <!-- End of threadsAccountsSubTab -->

                <!-- Threads Templates Sub-tab (æç¤ºè©è¨­å®š) -->
                <div id="threadsTemplatesSubTab" class="threads-sub-content" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <!-- å·¦å´ï¼šæç¤ºè©ç·¨è¼¯å€ -->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">âœ¨ æç¤ºè©è¨­å®š</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è¨­å®š AI è‡ªå‹•ç™¼æ–‡ä½¿ç”¨çš„ä¸»æç¤ºè©</p>

                    <form id="ai-prompt-form" onsubmit="saveAIPrompt(event)">
                        <div class="form-group">
                            <label for="ai-engine">AI å¼•æ“</label>
                            <select id="ai-engine" required style="padding: 12px; font-size: 15px;">
                                <option value="GPT5_2">GPT-5.2 (æ¨è–¦)</option>
                                <option value="GPT5_2_INSTANT">GPT-5.2 Instant (å¿«é€Ÿ)</option>
                                <option value="GPT4O">GPT-4o</option>
                                <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                                <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                                <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                            </select>
                            <small>é¸æ“‡ç”Ÿæˆè²¼æ–‡ä½¿ç”¨çš„ AI å¼•æ“</small>
                        </div>

                        <div class="form-group">
                            <label for="ai-prompt">AI æç¤ºè©</label>
                            <textarea id="ai-prompt" rows="18" required
                                style="width: 100%; padding: 15px; font-size: 14px; line-height: 1.7; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"
                                placeholder="è«‹è¼¸å…¥çµ¦ AI çš„æŒ‡ä»¤..."></textarea>
                            <small>ç³»çµ±æœƒè‡ªå‹•åŠ å…¥ç¶­åº¦è¨­å®šå’ŒæˆåŠŸç¯„ä¾‹</small>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1; padding: 15px;">ğŸ’¾
                                å„²å­˜æç¤ºè©</button>
                            <button type="button" class="btn btn-primary" onclick="testAIPrompt()"
                                style="flex: 1; padding: 15px;">ğŸ§ª æ¸¬è©¦ç”Ÿæˆ</button>
                        </div>
                    </form>

                    <!-- æ¸¬è©¦ç”Ÿæˆçµæœ -->
                    <div id="ai-prompt-test-result"
                        style="display: none; margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #374151;">ğŸ“ ç”Ÿæˆçµæœé è¦½</h4>
                        <div id="ai-prompt-test-content"
                            style="white-space: pre-wrap; line-height: 1.8; font-size: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šç¶­åº¦è¨­å®šé¢æ¿ -->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">ğŸ›ï¸ ç¶­åº¦è¨­å®š</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">èª¿æ•´å„ç¶­åº¦çš„é¸é …æ¬Šé‡å’Œç‹€æ…‹</p>

                    <div id="dimensions-container">
                        <!-- MODULE -->
                        <div class="dimension-section" data-dimension="module">
                            <div class="dimension-header" onclick="toggleDimension('module')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ“¦ å…§å®¹æ¨¡çµ„ (MODULE)</span>
                                <span id="module-toggle">â–¼</span>
                            </div>
                            <div id="module-options" class="dimension-options" style="padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- ANGLE -->
                        <div class="dimension-section" data-dimension="angle" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('angle')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ¬ æƒ…å¢ƒåˆ‡è§’ (ANGLE)</span>
                                <span id="angle-toggle">â–¶</span>
                            </div>
                            <div id="angle-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- OUTLET -->
                        <div class="dimension-section" data-dimension="outlet" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('outlet')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ’¡ è™•ç†å‡ºå£ (OUTLET)</span>
                                <span id="outlet-toggle">â–¶</span>
                            </div>
                            <div id="outlet-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- TONE_BIAS -->
                        <div class="dimension-section" data-dimension="tone_bias" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('tone_bias')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ—£ï¸ èªæ°£åå£“ (TONE)</span>
                                <span id="tone_bias-toggle">â–¶</span>
                            </div>
                            <div id="tone_bias-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- ENDING_STYLE -->
                        <div class="dimension-section" data-dimension="ending_style" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('ending_style')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ”š æ”¶å°¾æ„åœ– (ENDING)</span>
                                <span id="ending_style-toggle">â–¶</span>
                            </div>
                            <div id="ending_style-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- LENGTH_TARGET -->
                        <div class="dimension-section" data-dimension="length_target" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('length_target')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ“ å­—æ•¸ç›®æ¨™ (LENGTH)</span>
                                <span id="length_target-toggle">â–¶</span>
                            </div>
                            <div id="length_target-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- çµ±è¨ˆå€å¡Š -->
                    <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px;">ğŸ“Š æœ€è¿‘ 30 å¤©ä½¿ç”¨çµ±è¨ˆ</h4>
                        <div id="dimension-stats" style="font-size: 13px; color: #666;">
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
                </div>
                </div>
                <!-- End of threadsTemplatesSubTab -->

            </div>
            <!-- End of threadsTab -->

            <!-- ========================================== -->
            <!-- Monitor Tab (è²é‡ç›£æ§) - Now first/active -->
            <!-- ========================================== -->
            <div id="monitorTab" class="tab-content active">
                <h2 style="margin-bottom: 20px;">ğŸ“Š è²é‡ç›£æ§</h2>

            <!-- Monitor Sub-tabs -->
            <!-- ç›£æ§åŠŸèƒ½ç¸½è¦½ -->
            <div id="monitorOverview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleMonitorOverview()">
                    <h4 style="margin: 0; font-size: 14px;">ğŸ“– è²é‡ç›£æ§é‹ä½œæµç¨‹</h4>
                    <span id="monitorOverviewToggle" style="font-size: 12px;">â–¼ å±•é–‹èªªæ˜</span>
                </div>
                <div id="monitorOverviewContent" style="display: none; margin-top: 15px; font-size: 13px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                        <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 8px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ·ï¸</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">1. é—œéµå­—çµ„</div>
                            <div style="font-size: 11px; opacity: 0.9;">è¨­å®šè¦ç›£æ§çš„å“ç‰Œé—œéµå­—</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 8px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸŒ</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">2. ä¾†æºç®¡ç†</div>
                            <div style="font-size: 11px; opacity: 0.9;">è¨­å®šè¦çˆ¬å–çš„ç¶²ç«™ï¼ˆDcardã€PTTï¼‰</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 8px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“‹</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">3. æåŠåˆ—è¡¨</div>
                            <div style="font-size: 11px; opacity: 0.9;">æŸ¥çœ‹åŒ¹é…é—œéµå­—çš„æ–‡ç« </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 8px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“Š</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">4. è²é‡çµ±è¨ˆ</div>
                            <div style="font-size: 11px; opacity: 0.9;">æŸ¥çœ‹è¶¨å‹¢åœ–è¡¨å’Œçˆ¬å–æ—¥èªŒ</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 8px; font-size: 12px;">
                        <strong>ğŸ“Œ é‡é»èªªæ˜ï¼š</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                            <li><strong>æåŠåˆ—è¡¨</strong>ï¼šé¡¯ç¤ºæ‰€æœ‰åŒ¹é…é—œéµå­—çš„æ–‡ç« ï¼Œå¯ç¯©é¸åˆ†é¡ï¼ˆç—›é»/æƒ…å¢ƒï¼‰ï¼Œé€ç¯‡é–±è®€è™•ç†</li>
                            <li><strong>è²é‡çµ±è¨ˆ</strong>ï¼šå½™ç¸½æ•¸æ“šï¼Œçœ‹å“ªå€‹å“ç‰Œè¢«æåŠæœ€å¤šã€å“ªå€‹ä¾†æºæœ€æ´»èºã€æ­·å²è¶¨å‹¢è®ŠåŒ–</li>
                            <li><strong>è‡ªå‹•åˆ†é¡</strong>ï¼šç³»çµ±æœƒè‡ªå‹•åˆ¤æ–·æ–‡ç« æ˜¯ã€Œç”¢å“ç—›é»ã€é‚„æ˜¯ã€Œéœ€æ±‚æƒ…å¢ƒã€ï¼Œç—›é»æœƒç™¼ LINE é€šçŸ¥</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                <button class="monitor-sub-tab active" onclick="switchMonitorTab('stats')"
                    style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ“Š è²é‡çµ±è¨ˆ
                </button>
                <button class="monitor-sub-tab" onclick="switchMonitorTab('mentions')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ“‹ æåŠåˆ—è¡¨
                </button>
                <button class="monitor-sub-tab" onclick="switchMonitorTab('brands')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ·ï¸ é—œéµå­—çµ„
                </button>
                <button class="monitor-sub-tab" onclick="switchMonitorTab('sources')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸŒ ä¾†æºç®¡ç†
                </button>
                <button class="monitor-sub-tab" onclick="switchMonitorTab('crisis')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸš¨ å±æ©Ÿé è­¦
                </button>
                <button class="monitor-sub-tab" onclick="switchMonitorTab('recommend')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ’¡ å…§å®¹æ¨è–¦
                </button>
            </div>

            <!-- Mentions Sub-tab -->
            <div id="monitorMentionsTab" class="sub-tab-content" style="display: none;">
                <!-- é é¢èªªæ˜ -->
                <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; color: #1e40af;">
                    <strong>ğŸ“‹ æåŠåˆ—è¡¨</strong>ï¼šé¡¯ç¤ºæ‰€æœ‰åŒ¹é…é—œéµå­—çš„æ–‡ç« ï¼Œå¯é€ç¯‡é–±è®€ã€æ¨™è¨˜å·²è®€ã€æŸ¥çœ‹åˆ†é¡ã€‚é€™æ˜¯ä½ è™•ç†æ¯ç­†æåŠçš„å·¥ä½œå°ã€‚
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="mentionBrandFilter" onchange="loadMentions()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨é—œéµå­—çµ„</option>
                        </select>
                        <select id="mentionTopicFilter" onchange="loadMentions()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨åˆ†é¡</option>
                            <option value="pain_point">ğŸ”´ ç”¢å“ç—›é»</option>
                            <option value="need_context">ğŸ”µ éœ€æ±‚æƒ…å¢ƒ</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                        <select id="mentionReadFilter" onchange="loadMentions()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="false">æœªè®€</option>
                            <option value="true">å·²è®€</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="loadMentions()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="btn btn-secondary" onclick="reclassifyAll()" title="é‡æ–°åˆ†é¡æ‰€æœ‰æåŠ">ğŸ”„ é‡åˆ†é¡</button>
                    </div>
                </div>

                <!-- åˆ†é¡èªªæ˜ -->
                <div id="classificationHelp" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">ğŸ“Š è‡ªå‹•åˆ†é¡èªªæ˜</h4>
                    <p style="font-size: 13px; color: #0c4a6e; margin: 0 0 10px 0;">ç³»çµ±æœƒè‡ªå‹•åˆ†ææåŠå…§å®¹ï¼Œè¾¨è­˜ä»¥ä¸‹é¡å‹ï¼š</p>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 12px;">
                        <div>
                            <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px;">ğŸ”´ ç”¢å“ç—›é»</span>
                            <span style="color: #666; margin-left: 5px;">å™ªéŸ³ã€ä¸é©ã€æ•…éšœã€çºŒèˆªç­‰è² é¢é«”é©—</span>
                        </div>
                        <div>
                            <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px;">ğŸ”µ éœ€æ±‚æƒ…å¢ƒ</span>
                            <span style="color: #666; margin-left: 5px;">æ–°æ‰‹è©¢å•ã€è³¼è²·è€ƒé‡ã€ä½¿ç”¨æƒ…å¢ƒç­‰</span>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #64748b; margin: 10px 0 0 0;">
                        ğŸ’¡ <strong>å¼·å‘½ä¸­</strong>ï¼šå…§å®¹åŒæ™‚åŒ…å«æƒ…è¶£ç›¸é—œè©æ™‚ï¼Œåˆ†é¡æ›´æº–ç¢ºã€‚ç—›é»å¼·å‘½ä¸­æœƒè‡ªå‹•ç™¼é€ LINE è­¦ç¤ºã€‚
                    </p>
                    <button onclick="document.getElementById('classificationHelp').style.display='none'" style="position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; color: #94a3b8;">âœ•</button>
                </div>
                <button onclick="document.getElementById('classificationHelp').style.display='block'" style="margin-bottom: 15px; padding: 5px 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 5px; color: #0369a1; cursor: pointer; font-size: 12px;">â„¹ï¸ åˆ†é¡èªªæ˜</button>

                <div id="mentionsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- Brands Sub-tab -->
            <div id="monitorBrandsTab" class="sub-tab-content" style="display: none;">
                <!-- é—œéµå­—è¨­å®šèªªæ˜ -->
                <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; font-size: 12px; color: #92400e;">
                    <strong>ğŸ’¡ é—œéµå­—è¨­å®šèªªæ˜ï¼š</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>ç”¨<strong>é€—è™Ÿ</strong>åˆ†éš”å¤šå€‹é—œéµå­—ï¼Œä¾‹å¦‚ï¼š<code>å“ç‰ŒA, å“ç‰ŒB, ç°¡ç¨±</code></li>
                        <li>çˆ¬èŸ²æœƒåœ¨ä¾†æºé é¢æœå°‹é€™äº›é—œéµå­—ï¼Œæ‰¾åˆ°å°±æœƒå»ºç«‹æåŠè¨˜éŒ„</li>
                        <li>é—œéµå­—ä¸åˆ†å¤§å°å¯«ï¼Œæ”¯æ´ä¸­è‹±æ–‡</li>
                        <li>å»ºè­°åŠ å…¥å“ç‰Œçš„å„ç¨®å¯«æ³•ã€æš±ç¨±ã€å¸¸è¦‹éŒ¯å­—</li>
                    </ul>
                </div>

                <!-- æ–°å¢é—œéµå­—çµ„è¡¨å–®å€å¡Š -->
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px;">â• æ–°å¢é—œéµå­—çµ„</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label style="font-size: 12px; opacity: 0.9; display: block; margin-bottom: 5px;">ä¸»é¡Œåç¨± *</label>
                            <input type="text" id="newBrandName" placeholder="ä¾‹ï¼šæˆ‘çš„å“ç‰Œ"
                                style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label
                                style="font-size: 12px; opacity: 0.9; display: block; margin-bottom: 5px;">ç›£æ§é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰*</label>
                            <input type="text" id="newBrandKeywords" placeholder="ä¾‹ï¼šå“ç‰ŒA, å“ç‰ŒB, ç›¸é—œè©"
                                style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <button onclick="createBrandFromForm()"
                            style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            æ–°å¢
                        </button>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="font-size: 12px; opacity: 0.9; margin-right: 15px;">
                            <input type="radio" name="brandType" value="own" checked style="margin-right: 5px;"> è‡ªæœ‰
                        </label>
                        <label style="font-size: 12px; opacity: 0.9;">
                            <input type="radio" name="brandType" value="competitor" style="margin-right: 5px;"> ç«¶å“
                        </label>
                    </div>
                </div>

                <!-- é—œéµå­—çµ„åˆ—è¡¨ -->
                <h3 style="margin-bottom: 15px; font-size: 16px; color: #374151;">ğŸ“‹ å·²è¨­å®šé—œéµå­—çµ„</h3>
                <div id="brandsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                </div>

                <!-- åˆ†éš”ç·š -->
                <hr style="margin: 40px 0; border: none; border-top: 2px solid #e5e7eb;">

                <!-- åˆ†é¡è¨­å®šå€å¡Š -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; color: #374151;">âš™ï¸ åˆ†é¡è¨­å®š</h3>
                    <span id="classifierVersion" style="color: #666; font-size: 12px;"></span>
                </div>

                <!-- èªªæ˜å€å¡Š -->
                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">ğŸ“– åˆ†é¡æµç¨‹èªªæ˜</h4>
                    <div style="font-size: 13px; color: #0c4a6e;">
                        <ol style="margin: 0; padding-left: 20px;">
                            <li><strong>é—œéµå­—æ¯”å°</strong>ï¼šç”¨ä¸Šæ–¹çš„ã€Œé—œéµå­—çµ„ã€æ‰¾å‡ºç›¸é—œæ–‡ç« </li>
                            <li><strong>å…§å®¹åˆ†é¡</strong>ï¼šç”¨ä¸‹æ–¹çš„ã€Œåˆ†é¡è¦å‰‡ã€æ¨™è¨˜æ–‡ç« é¡å‹ï¼ˆç—›é»/æƒ…å¢ƒï¼‰</li>
                        </ol>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #64748b;">
                            ğŸ’¡ ç¬¦åˆã€Œç”¢å“ç—›é»ã€çš„æ–‡ç« æœƒè‡ªå‹•ç™¼é€ LINE é€šçŸ¥
                        </p>
                    </div>
                </div>

                <!-- æ’é™¤è©è¨­å®š -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">ğŸš« æ’é™¤è©</h4>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ç¬¦åˆé€™äº›è©çš„æ–‡ç« ä¸æœƒè¢«åˆ†é¡ï¼ˆå¦‚å»£å‘Šã€æ¥­é…ï¼‰ã€‚ç”¨ <code>|</code> åˆ†éš”ã€‚
                    </p>
                    <textarea id="excludePatternsInput" rows="2"
                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 13px; box-sizing: border-box;"
                        placeholder="(å»£å‘Š|æ¥­é…|åœ˜è³¼|æŠ½ç)"></textarea>
                    <button onclick="saveExcludePatterns()" class="btn btn-primary" style="margin-top: 10px; padding: 8px 16px; font-size: 13px;">
                        ğŸ’¾ å„²å­˜
                    </button>
                </div>

                <!-- åˆ†é¡è¦å‰‡ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- ç—›é»è¦å‰‡ -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ef4444;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #374151; font-size: 14px;">ğŸ”´ ç”¢å“ç—›é»</h4>
                            <button onclick="showAddRuleModal('pain_point')" class="btn btn-secondary" style="padding: 4px 12px; font-size: 11px;">
                                â• æ–°å¢
                            </button>
                        </div>
                        <div id="painPointRulesList" style="display: grid; gap: 8px; max-height: 300px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- éœ€æ±‚æƒ…å¢ƒè¦å‰‡ -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #374151; font-size: 14px;">ğŸ”µ éœ€æ±‚æƒ…å¢ƒ</h4>
                            <button onclick="showAddRuleModal('need_context')" class="btn btn-secondary" style="padding: 4px 12px; font-size: 11px;">
                                â• æ–°å¢
                            </button>
                        </div>
                        <div id="needContextRulesList" style="display: grid; gap: 8px; max-height: 300px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Sources Sub-tab -->
            <div id="monitorSourcesTab" class="sub-tab-content" style="display: none;">
                <!-- çˆ¬èŸ²é‹ä½œèªªæ˜ -->
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; font-size: 12px; color: #166534;">
                    <strong>ğŸ•·ï¸ çˆ¬èŸ²é‹ä½œæ–¹å¼ï¼š</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>è‡ªå‹•çˆ¬å–</strong>ï¼šç³»çµ±æ¯ 30 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼Œå°ã€Œå·²åˆ°æœŸã€çš„ä¾†æºåŸ·è¡Œçˆ¬å–</li>
                        <li><strong>åˆ°æœŸåˆ¤å®š</strong>ï¼šæ ¹æ“šæ¯å€‹ä¾†æºè¨­å®šçš„ã€Œæª¢æŸ¥é–“éš”ã€æ±ºå®š</li>
                        <li><strong>çˆ¬å–ç¯„åœ</strong>ï¼šæŠ“å–ä¾†æºé é¢ä¸Šçš„æ–‡ç« åˆ—è¡¨ï¼ˆæœ€å¤š 50 ç¯‡ï¼‰ï¼Œä¸¦ç”¨é—œéµå­—çµ„é€²è¡Œæ¯”å°</li>
                        <li><strong>å¹³å°æ”¯æ´</strong>ï¼šDcardã€PTT æœ‰å°ˆå±¬è§£æå™¨ï¼Œå…¶ä»–å¹³å°ä½¿ç”¨é€šç”¨ HTML è§£æ</li>
                        <li><strong>æ‰‹å‹•çˆ¬å–</strong>ï¼šé»æ“Šã€ŒğŸ”„ çˆ¬å–ã€å¯ç«‹å³åŸ·è¡Œï¼Œæœƒé¡¯ç¤ºçµæœçµ±è¨ˆ</li>
                    </ul>
                </div>

                <!-- é è¨­ä¾†æºå¤šé¸å€å¡Š -->
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ å¾é è¨­ä¾†æºæ–°å¢</h4>
                    <div id="sourceTemplatesList"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <p style="color: rgba(255,255,255,0.7); grid-column: span 2; text-align: center; margin: 0;">
                            è¼‰å…¥ä¸­...</p>
                    </div>
                    <button onclick="addSelectedSources()"
                        style="margin-top: 12px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        â• æ–°å¢é¸å–çš„ä¾†æº
                    </button>
                </div>

                <!-- æ‰‹å‹•æ–°å¢ä¾†æºè¡¨å–® -->
                <div
                    style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e5e7eb;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #374151;">âœï¸ æ‰‹å‹•æ–°å¢ä¾†æº</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">åç¨± *</label>
                            <input type="text" id="newSourceName" placeholder="ä¾‹ï¼šDcard è¥¿æ–¯ç‰ˆ"
                                style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç¶²å€ *</label>
                            <input type="text" id="newSourceUrl" placeholder="https://..."
                                style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <button onclick="createSourceFromForm()"
                            style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            æ–°å¢
                        </button>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="font-size: 12px; color: #666; margin-right: 8px;">å¹³å°ï¼š</label>
                            <select id="newSourcePlatform"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="dcard">Dcard</option>
                                <option value="ptt">PTT</option>
                                <option value="threads">Threads</option>
                                <option value="forum">è«–å£‡</option>
                                <option value="blog">éƒ¨è½æ ¼</option>
                                <option value="news">æ–°è</option>
                                <option value="other" selected>å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; margin-right: 8px;">æª¢æŸ¥é–“éš”ï¼š</label>
                            <select id="newSourceInterval"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="1">æ¯å°æ™‚</option>
                                <option value="2">æ¯ 2 å°æ™‚</option>
                                <option value="6">æ¯ 6 å°æ™‚</option>
                                <option value="12">æ¯ 12 å°æ™‚</option>
                                <option value="24" selected>æ¯å¤©</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ä¾†æºåˆ—è¡¨ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 16px; color: #374151; margin: 0;">ğŸŒ å·²è¨­å®šä¾†æº</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" onclick="deleteAllDcardSources()" style="padding: 8px 15px; font-size: 12px;">
                            ğŸ—‘ï¸ æ¸…é™¤ Dcard ä¾†æº
                        </button>
                        <button id="relinkBtn" class="btn btn-secondary" onclick="relinkAllBrandsSources()" style="padding: 8px 15px; font-size: 12px;">
                            ğŸ”— ä¿®å¾©é—œè¯
                        </button>
                    </div>
                </div>
                <div id="sourcesList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>


            <!-- Stats Sub-tab -->
            <div id="monitorStatsTab" class="sub-tab-content active">
                <!-- é é¢èªªæ˜ -->
                <div style="background: #fdf4ff; border-left: 4px solid #a855f7; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; color: #6b21a8;">
                    <strong>ğŸ“Š è²é‡çµ±è¨ˆ</strong>ï¼šå½™ç¸½æ‰€æœ‰æåŠçš„æ•¸æ“šåˆ†æã€‚çœ‹å“ªå€‹é—œéµå­—çµ„è¢«æåŠæœ€å¤šã€å“ªå€‹ä¾†æºæœ€æ´»èºï¼Œä»¥åŠçˆ¬å–æ—¥èªŒã€‚
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>è²é‡çµ±è¨ˆ</h3>
                    <select id="monitorStatsDays" onchange="loadMonitorStats()"
                        style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="7">éå» 7 å¤©</option>
                        <option value="14">éå» 14 å¤©</option>
                        <option value="30" selected>éå» 30 å¤©</option>
                    </select>
                </div>

                <div class="stats" id="monitorStatsCards"
                    style="grid-template-columns: repeat(3, 1fr); margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3 id="monitorTotalMentions">0</h3>
                        <p>ç¸½æåŠæ•¸</p>
                    </div>
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <h3 id="monitorUnreadCount" style="color: white;">0</h3>
                        <p style="color: rgba(255,255,255,0.8);">æœªè®€æåŠ</p>
                    </div>
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 id="monitorBrandCount" style="color: white;">0</h3>
                        <p style="color: rgba(255,255,255,0.8);">ç›£æ§å“ç‰Œ</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div
                        style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">ğŸ“Š å„å“ç‰ŒæåŠæ•¸</h4>
                        <div id="monitorBrandStats"></div>
                    </div>
                    <div
                        style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">ğŸŒ å„ä¾†æºæåŠæ•¸</h4>
                        <div id="monitorSourceStats"></div>
                    </div>
                </div>

                <!-- è²é‡é€±å ± -->
                <div
                    style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">ğŸ“Š è²é‡é€±å ±</h4>
                        <div style="display: flex; gap: 10px;">
                            <select id="weeklyReportWeeks" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="0">æœ¬é€±</option>
                                <option value="1">ä¸Šé€±</option>
                                <option value="2">2 é€±å‰</option>
                                <option value="3">3 é€±å‰</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadWeeklyReport()"
                                style="padding: 8px 15px; font-size: 12px;">ğŸ”„ è¼‰å…¥é€±å ±</button>
                            <button class="btn btn-primary" onclick="sendWeeklyReportToLine()"
                                style="padding: 8px 15px; font-size: 12px;">ğŸ“¤ ç™¼é€åˆ° LINE</button>
                        </div>
                    </div>
                    <div id="weeklyReportContent">
                        <p style="color: #999; text-align: center; padding: 20px 0;">é»æ“Šã€Œè¼‰å…¥é€±å ±ã€æŸ¥çœ‹æ•¸æ“š</p>
                    </div>
                </div>

                <!-- çˆ¬å–æ—¥èªŒ -->
                <div
                    style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">ğŸ“‹ çˆ¬å–æ—¥èªŒï¼ˆæœ€è¿‘ 20 ç­†ï¼‰</h4>
                        <button class="btn btn-secondary" onclick="loadCrawlLogs()"
                            style="padding: 8px 15px; font-size: 12px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                    <div id="crawlLogsList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #999; text-align: center; padding: 20px 0;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                </div>

            <!-- Crisis Alert Sub-tab (å±æ©Ÿé è­¦) -->
            <div id="monitorCrisisTab" class="sub-tab-content" style="display: none;">
                <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; color: #991b1b;">
                    <strong>ğŸš¨ å±æ©Ÿé è­¦</strong>ï¼šç›£æ§è² é¢è²é‡çªå¢ï¼Œå³æ™‚ç™¼é€ LINE é€šçŸ¥ã€‚ç³»çµ±æ¯ 15 åˆ†é˜è‡ªå‹•æª¢æŸ¥ã€‚
                </div>

                <!-- å±æ©Ÿé è­¦çµ±è¨ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="crisisStatAlerts">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">å¾…è™•ç†è­¦å ±</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="crisisStatToday">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">ä»Šæ—¥è² é¢æåŠ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="crisisStatResolved">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">å·²è§£æ±ºè­¦å ±</div>
                    </div>
                </div>

                <!-- å±æ©Ÿé è­¦è¨­å®š -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 16px;">âš™ï¸ é è­¦è¨­å®š</h3>
                        <button class="btn btn-primary" onclick="triggerCrisisCheck()" style="padding: 8px 16px;">
                            ğŸ” ç«‹å³æª¢æŸ¥
                        </button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>æ¯”è¼ƒåŸºæº–å¤©æ•¸</label>
                            <input type="number" id="crisisBaselineDays" value="7" min="1" max="30"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">èˆ‡éå» N å¤©çš„å¹³å‡å€¼æ¯”è¼ƒ</small>
                        </div>
                        <div class="form-group">
                            <label>è§¸ç™¼å€æ•¸</label>
                            <input type="number" id="crisisTriggerMultiplier" value="2.0" min="1.5" max="10" step="0.5"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">ä»Šæ—¥ â‰¥ å¹³å‡ Ã— å€æ•¸æ™‚è§¸ç™¼</small>
                        </div>
                        <div class="form-group">
                            <label>å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="crisisCooldownMinutes" value="60" min="15" max="1440"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">åŒé¡è­¦å ±çš„æœ€å°é–“éš”</small>
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px;">é¸é …</label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                                <input type="checkbox" id="crisisOnlyNegative" checked style="width: 16px; height: 16px;">
                                <span>åªç›£æ§è² é¢å…§å®¹</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="crisisAlertEnabled" checked style="width: 16px; height: 16px;">
                                <span>å•Ÿç”¨è­¦å ±é€šçŸ¥</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveCrisisConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>
                </div>

                <!-- è­¦å ±æ—¥èªŒ -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px;">ğŸ“‹ è­¦å ±æ—¥èªŒ</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="crisisLogStatusFilter" onchange="loadCrisisLogs()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="new">ğŸ”´ æ–°è­¦å ±</option>
                                <option value="acknowledged">ğŸŸ¡ å·²ç¢ºèª</option>
                                <option value="resolved">ğŸŸ¢ å·²è§£æ±º</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadCrisisLogs()" style="padding: 8px 12px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                        </div>
                    </div>
                    <div id="crisisLogsList" style="max-height: 500px; overflow-y: auto;">
                        <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- Content Recommendation Sub-tab (å…§å®¹æ¨è–¦) -->
            <div id="monitorRecommendTab" class="sub-tab-content" style="display: none;">
                <div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 12px 15px; margin-bottom: 20px; font-size: 13px; color: #166534;">
                    <strong>ğŸ’¡ å…§å®¹æ¨è–¦</strong>ï¼šæ ¹æ“šè²é‡ç›£æ§åˆ†æç†±é–€è©±é¡Œï¼ŒAI è‡ªå‹•åˆ¤æ–·èˆ‡å“ç‰Œçš„ç›¸é—œæ€§ï¼Œç”Ÿæˆå…§å®¹å»ºè­°ã€‚ç³»çµ±æ¯å¤© 08:00 è‡ªå‹•æ›´æ–°ã€‚
                </div>

                <!-- å…§å®¹æ¨è–¦çµ±è¨ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="recommendStatTopics">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">å¯ç”¨è©±é¡Œ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="recommendStatSuggestions">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">å…§å®¹å»ºè­°</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 28px; font-weight: bold;" id="recommendStatAdopted">0</div>
                        <div style="font-size: 13px; opacity: 0.9;">å·²æ¡ç”¨</div>
                    </div>
                </div>

                <!-- Brand Profile è¨­å®š -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 16px;">ğŸ¢ å“ç‰Œ Profile</h3>
                        <button class="btn btn-primary" onclick="triggerRecommendation()" style="padding: 8px 16px;">
                            ğŸ”„ ç«‹å³ç”Ÿæˆæ¨è–¦
                        </button>
                    </div>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                        è¨­å®šå“ç‰Œè³‡è¨Šï¼Œè®“ AI èƒ½æ›´æº–ç¢ºåˆ¤æ–·è©±é¡Œèˆ‡å“ç‰Œçš„ç›¸é—œæ€§ã€‚
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="form-group">
                            <label>å“ç‰Œåç¨±</label>
                            <input type="text" id="profileName" placeholder="ä¾‹ï¼šAYCE"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­é¡åˆ¥</label>
                            <input type="text" id="profileIndustry" placeholder="ä¾‹ï¼šæˆäººç”¨å“/æƒ…è¶£ç”¢æ¥­"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>ä¸»è¦ç”¢å“ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="profileProducts" placeholder="ä¾‹ï¼šé£›æ©Ÿæ¯, æŒ‰æ‘©æ£’, æ½¤æ»‘æ¶²"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>ç”¢å“é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="profileProductKeywords" placeholder="ä¾‹ï¼šæƒ…è¶£, éœ‡å‹•, å¸å®, æ½¤æ»‘"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>ç›®æ¨™å¹´é½¡ç¯„åœ</label>
                            <input type="text" id="profileAgeRange" placeholder="ä¾‹ï¼š20-40"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>èªèª¿é¢¨æ ¼</label>
                            <input type="text" id="profileToneStyle" placeholder="ä¾‹ï¼šç›´ç™½å¦ç‡ä½†ä¸ä½ä¿—"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>ç›¸é—œè©±é¡Œç¯„åœï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="profileRelevantTopics" placeholder="ä¾‹ï¼šæ€§ç”Ÿæ´», è¦ªå¯†é—œä¿‚, è‡ªæ…°, æƒ…è¶£ç”¨å“, æ€§å¥åº·"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">AI æœƒå„ªå…ˆæ¨è–¦é€™äº›è©±é¡Œç¯„åœå…§çš„å…§å®¹</small>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>è©±é¡Œæ’é™¤æ¸…å–®ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="profileTopicExclusions" placeholder="ä¾‹ï¼šæœªæˆå¹´, æš´åŠ›, éè‡ªé¡˜"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">åŒ…å«é€™äº›è©çš„è©±é¡Œæœƒè¢«è‡ªå‹•éæ¿¾</small>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>å…§å®¹ç¦å€ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="profileContentTaboos" placeholder="ä¾‹ï¼šéåº¦ç…½æƒ…, è™›å‡å®£å‚³, æ”»æ“Šç«¶å“"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <small style="color: #666;">AI ç”Ÿæˆå…§å®¹æ™‚æœƒé¿å…é€™äº›æ–¹å‘</small>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveBrandProfile()">ğŸ’¾ å„²å­˜ Profile</button>
                    </div>
                </div>

                <!-- ç†±é–€è©±é¡Œåˆ—è¡¨ -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px;">ğŸ”¥ ç†±é–€è©±é¡Œ</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="topicStatusFilter" onchange="loadTopics()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="new">ğŸ†• æ–°è©±é¡Œ</option>
                                <option value="used">âœ… å·²ä½¿ç”¨</option>
                                <option value="rejected">âŒ å·²æ‹’çµ•</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadTopics()" style="padding: 8px 12px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                        </div>
                    </div>
                    <div id="topicsList" style="display: grid; gap: 15px;">
                        <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- å…§å®¹å»ºè­°åˆ—è¡¨ -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px;">ğŸ“ å…§å®¹å»ºè­°</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="suggestionStatusFilter" onchange="loadSuggestions()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="new">ğŸ†• å¾…è™•ç†</option>
                                <option value="adopted">âœ… å·²æ¡ç”¨</option>
                                <option value="rejected">âŒ å·²æ‹’çµ•</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadSuggestions()" style="padding: 8px 12px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                        </div>
                    </div>
                    <div id="suggestionsList" style="display: grid; gap: 15px;">
                        <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            </div>

            <!-- ========================================== -->
            <!-- Influencer Detection Tab (ç¶²é»ƒåµæ¸¬) -->
            <!-- ========================================== -->
            <div id="influencerTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ” ç¶²é»ƒåµæ¸¬</h2>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: bold;" id="influencerStatTotal">0</div>
                    <div style="font-size: 13px; opacity: 0.9;">æœ‰ Twitter ä½œè€…</div>
                </div>
                <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 20px; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: bold;" id="influencerStatVerified">0</div>
                    <div style="font-size: 13px; opacity: 0.9;">å·²é©—è­‰</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: bold;" id="influencerStatContacted">0</div>
                    <div style="font-size: 13px; opacity: 0.9;">å·²è¯ç¹«</div>
                </div>
                <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; padding: 20px; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: bold;" id="influencerStatCooperating">0</div>
                    <div style="font-size: 13px; opacity: 0.9;">åˆä½œä¸­</div>
                </div>
            </div>

            <!-- ç¶²é»ƒåµæ¸¬å­åˆ†é  -->
            <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                <button class="influencer-sub-tab active" onclick="switchInfluencerSubTab('authors')"
                    style="padding: 8px 12px; border: none; background: #f59e0b; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ‘¤ ä½œè€…åå–®
                </button>
                <button class="influencer-sub-tab" onclick="switchInfluencerSubTab('contacts')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ğŸ’¼ è¯ç¹«è¨˜éŒ„
                </button>
                <button class="influencer-sub-tab" onclick="switchInfluencerSubTab('settings')"
                    style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    âš™ï¸ åµæ¸¬è¨­å®š
                </button>
            </div>

            <!-- ä½œè€…åå–® Sub-tab -->
            <div id="influencerAuthorsTab" class="influencer-sub-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="influencerStatusFilter" onchange="loadInfluencerAuthors()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="new">ğŸ†• æ–°ç™¼ç¾</option>
                            <option value="contacted">ğŸ“§ å·²è¯ç¹«</option>
                            <option value="cooperating">ğŸ¤ åˆä½œä¸­</option>
                            <option value="rejected">âŒ å·²æ‹’çµ•</option>
                            <option value="blacklisted">ğŸš« é»‘åå–®</option>
                        </select>
                        <select id="influencerVerifiedFilter" onchange="loadInfluencerAuthors()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨é©—è­‰ç‹€æ…‹</option>
                            <option value="true">âœ“ å·²é©—è­‰</option>
                            <option value="false">âš ï¸ å¾…é©—è­‰</option>
                        </select>
                        <select id="influencerContactFilter" onchange="loadInfluencerAuthors()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨è¯ç¹«ç‹€æ…‹</option>
                            <option value="true">ğŸ“§ å·²è¯ç¹«é</option>
                            <option value="false">- æœªè¯ç¹«</option>
                        </select>
                        <select id="influencerSortBy" onchange="loadInfluencerAuthors()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="first_detected_at">æ’åºï¼šç™¼ç¾æ™‚é–“</option>
                            <option value="last_dcard_post_at">æ’åºï¼šDcard ç™¼æ–‡</option>
                            <option value="last_twitter_post_at">æ’åºï¼šTwitter ç™¼æ–‡</option>
                            <option value="contact_count">æ’åºï¼šè¯ç¹«æ¬¡æ•¸</option>
                            <option value="status">æ’åºï¼šç‹€æ…‹</option>
                        </select>
                        <select id="influencerSortOrder" onchange="loadInfluencerAuthors()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="DESC">é™å†ª</option>
                            <option value="ASC">å‡å†ª</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="triggerInfluencerScan()">ğŸ” ç«‹å³æƒæ</button>
                        <button class="btn btn-secondary" onclick="loadInfluencerAuthors()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="btn btn-primary" onclick="exportInfluencerExcel()" style="background: #059669;">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                    </div>
                </div>

                <div id="influencerAuthorsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                </div>

                <!-- åˆ†é  -->
                <div id="influencerAuthorsPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
            </div>

            <!-- è¯ç¹«è¨˜éŒ„ Sub-tab -->
            <div id="influencerContactsTab" class="influencer-sub-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ’¼ è¯ç¹«è¨˜éŒ„</h3>
                    <button class="btn btn-secondary" onclick="loadInfluencerContacts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
                <div id="influencerContactsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- åµæ¸¬è¨­å®š Sub-tab -->
            <div id="influencerSettingsTab" class="influencer-sub-content" style="display: none;">
                <div style="max-width: 600px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ”„ è‡ªå‹•æƒæè¨­å®š</h3>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="influencerAutoScan" style="width: 18px; height: 18px;">
                                <span>å•Ÿç”¨è‡ªå‹•æƒæ</span>
                            </label>
                            <p style="font-size: 12px; color: #666; margin: 5px 0 0 28px;">è‡ªå‹•æƒæ Dcard è¥¿æ–¯ç‰ˆæœ€æ–°æ–‡ç« </p>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">æƒæé–“éš”ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="influencerScanInterval" value="30" min="10" max="1440"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100px;">
                        </div>
                        <button class="btn" onclick="saveInfluencerSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ”— åµæ¸¬æ¨¡å¼èªªæ˜</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ç³»çµ±åµæ¸¬ä»¥ä¸‹ Twitter/X æ ¼å¼ï¼š</p>
                        <div style="display: flex; flex-direction: column; gap: 10px; font-size: 13px;">
                            <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #1da1f2;">
                                <strong>å®Œæ•´é€£çµ</strong>: twitter.com/username æˆ– x.com/username
                            </div>
                            <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #1da1f2;">
                                <strong>ç´” ID æ ¼å¼</strong>: æ¨ç‰¹: usernameã€Twitter: xxxã€TW: xxx
                            </div>
                            <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #1da1f2;">
                                <strong>@mention</strong>: @usernameï¼ˆéœ€æ­é… twitter é—œéµå­—ï¼‰
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- System Settings Tab (ç³»çµ±è¨­å®š) -->
            <!-- ========================================== -->
            <div id="settingsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">âš™ï¸ ç³»çµ±è¨­å®š</h2>

            <!-- LINE é€šçŸ¥è¨­å®š -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #00c300;">ğŸ’¬ LINE é€šçŸ¥è¨­å®š</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è¨­å®š LINE é€šçŸ¥ï¼Œç•¶ç™¼ç¾ç”¢å“ç—›é»æˆ–æ–°ç¶²é»ƒæ™‚è‡ªå‹•æ¨é€é€šçŸ¥ã€‚</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>LINE User ID</label>
                        <input type="text" id="settingsLineUserId" placeholder="è«‹è¼¸å…¥ LINE User ID"
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <small style="color: #666;">ç™¼é€ã€Œ/myidã€çµ¦ LINE Bot å³å¯å–å¾— ID</small>
                    </div>
                    <div class="form-group">
                        <label>é€šçŸ¥è¨­å®š</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; padding-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="settingsNotifyPainPoint" checked style="width: 16px; height: 16px;">
                                <span>ç”¢å“ç—›é»é€šçŸ¥</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="settingsNotifyInfluencer" checked style="width: 16px; height: 16px;">
                                <span>æ–°ç¶²é»ƒåµæ¸¬é€šçŸ¥</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="saveLineSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    <button class="btn btn-secondary" onclick="testLineNotification()">ğŸ“¨ æ¸¬è©¦é€šçŸ¥</button>
                </div>
            </div>

            <!-- API é‡‘é‘°è¨­å®š -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #374151;">ğŸ”‘ API é‡‘é‘°è¨­å®š</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">ç®¡ç†ç³»çµ±ä½¿ç”¨çš„ API é‡‘é‘°ã€‚</p>

                <div style="display: grid; gap: 20px;">
                    <div class="form-group">
                        <label>ZenRows API Keyï¼ˆç”¨æ–¼çˆ¬å– Dcardï¼‰</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="settingsZenrowsKey" placeholder="è¼¸å…¥ ZenRows API Key"
                                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            <button class="btn btn-secondary" onclick="togglePasswordVisibility('settingsZenrowsKey')">ğŸ‘ï¸</button>
                        </div>
                        <small style="color: #666;">å¾ç’°å¢ƒè®Šæ•¸è®€å–ï¼Œæ­¤è™•åƒ…ä¾›æŸ¥çœ‹ç‹€æ…‹</small>
                    </div>
                    <div class="form-group">
                        <label>ScrapingBee API Keyï¼ˆå‚™ç”¨çˆ¬èŸ²ï¼‰</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="settingsScrapingBeeKey" placeholder="è¼¸å…¥ ScrapingBee API Key"
                                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            <button class="btn btn-secondary" onclick="togglePasswordVisibility('settingsScrapingBeeKey')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±è³‡è¨Š -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #374151;">â„¹ï¸ ç³»çµ±è³‡è¨Š</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <span style="color: #666;">ç‰ˆæœ¬</span>
                        <div style="font-weight: bold; margin-top: 5px;">1.0.0</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <span style="color: #666;">æœ€å¾Œæ›´æ–°</span>
                        <div style="font-weight: bold; margin-top: 5px;">2025-01-25</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <span style="color: #666;">è³‡æ–™åº«ç‹€æ…‹</span>
                        <div style="font-weight: bold; margin-top: 5px; color: #22c55e;">âœ“ æ­£å¸¸</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <span style="color: #666;">çˆ¬èŸ²ç‹€æ…‹</span>
                        <div style="font-weight: bold; margin-top: 5px; color: #22c55e;">âœ“ é‹ä½œä¸­</div>
                    </div>
                </div>
            </div>
            <!-- ========================================== -->
            <!-- Users Management Tab (admin only) -->
            <!-- ========================================== -->
            <div id="usersTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</h2>
                <div id="usersTableContainer">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f8f9fa;text-align:left;">
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">åç¨±</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">Email</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">ç™»å…¥æ–¹å¼</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">ç‹€æ…‹</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">è§’è‰²</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">è¨»å†Šæ™‚é–“</th>
                                <th style="padding:12px;border-bottom:2px solid #e1e8ed;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" style="padding:40px;text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        <!-- End of dashboard -->

        <!-- Post Detail Modal -->
        <div id="postModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>è²¼æ–‡è©³æƒ…</h2>
                    <button class="close-modal" onclick="closeModal()">&times;</button>
                </div>
                <div id="modalBody"></div>
            </div>
        </div>

        <!-- Edit Post Modal -->
        <div id="editPostModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>âœï¸ ç·¨è¼¯è²¼æ–‡å…§å®¹</h2>
                    <button class="close-modal" onclick="closeEditPostModal()">Ã—</button>
                </div>
                <form id="editPostForm" onsubmit="saveEditedPost(event)">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label for="editPostContent">è²¼æ–‡å…§å®¹</label>
                        <textarea id="editPostContent" rows="15" required
                            style="width: 100%; padding: 15px; font-size: 15px; line-height: 1.8; border: 1px solid #ddd; border-radius: 8px; resize: vertical; min-height: 300px;"
                            placeholder="è«‹è¼¸å…¥è²¼æ–‡å…§å®¹..."></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            å­—æ•¸: <span id="editPostCharCount">0</span> | ç·¨è¼¯å¾Œçš„å…§å®¹æœƒåœ¨æ’ç¨‹æ™‚é–“ç™¼å¸ƒåˆ° Threads
                        </p>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="editPostScheduleTime">ç™¼æ–‡æ™‚é–“</label>
                        <input type="datetime-local" id="editPostScheduleTime"
                            style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 8px;">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">ä¿®æ”¹ç™¼æ–‡æ™‚é–“ï¼ˆéœ€è‡³å°‘ 15 åˆ†é˜å¾Œï¼‰</p>
                    </div>
                    <input type="hidden" id="editPostScheduleId">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditPostModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Global variables
            let token = localStorage.getItem('token');
            let currentUserRoles = [];
            const API_BASE = '/api';

            // Initialize
            initGoogleLogin();
            if (token) {
                checkAuth();
            }

            // Authentication
            async function login(event) {
                event.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        token = data.token;
                        localStorage.setItem('token', token);
                        showDashboard(data.user);
                    } else {
                        showAlert('loginAlert', data.error || 'ç™»å…¥å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('loginAlert', 'é€£ç·šå¤±æ•—: ' + error.message, 'error');
                }
            }

            async function checkAuth() {
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showDashboard(data.user);
                    } else {
                        logout();
                    }
                } catch (error) {
                    logout();
                }
            }

            function logout() {
                token = null;
                localStorage.removeItem('token');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('userInfo').classList.remove('active');
            }

            function showDashboard(user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userInfo').classList.add('active');

                if (user) {
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userRoles').textContent = user.roles.join(', ');
                    currentUserRoles = user.roles || [];

                    // admin æ‰é¡¯ç¤ºä½¿ç”¨è€…ç®¡ç† tab
                    const usersTabBtn = document.getElementById('usersTabBtn');
                    if (usersTabBtn) {
                        usersTabBtn.style.display = currentUserRoles.includes('admin') ? '' : 'none';
                    }
                }

                // é è¨­è¼‰å…¥è²é‡ç›£æ§è³‡æ–™ï¼ˆç¬¬ä¸€å€‹ tabï¼‰
                loadMonitorData();
            }

            // Tab switching
            function switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                event.target.classList.add('active');

                document.getElementById(tabName + 'Tab').classList.add('active');

                // Load data based on tab
                if (tabName === 'monitor') {
                    loadMonitorData();
                }
                if (tabName === 'threads') {
                    loadOverview();
                    loadPosts();
                }
                if (tabName === 'influencer') {
                    loadInfluencerAuthors();
                }
                if (tabName === 'settings') {
                    loadSystemSettings();
                }
                if (tabName === 'users') {
                    loadUsers();
                }
            }

            // Threads sub-tab switching
            function switchThreadsSubTab(subTabName) {
                // Update sub-tab buttons
                document.querySelectorAll('.threads-sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#333';
                });
                event.target.classList.add('active');
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';

                // Hide all sub-tab content
                document.querySelectorAll('.threads-sub-content').forEach(c => {
                    c.style.display = 'none';
                });

                // Show selected sub-tab
                if (subTabName === 'overview') {
                    document.getElementById('threadsOverviewSubTab').style.display = 'block';
                    loadOverview();
                }
                if (subTabName === 'scheduling') {
                    document.getElementById('threadsSchedulingSubTab').style.display = 'block';
                    loadScheduling();
                }
                if (subTabName === 'templates') {
                    document.getElementById('threadsTemplatesSubTab').style.display = 'block';
                    loadTemplates();
                }
                if (subTabName === 'accounts') {
                    document.getElementById('threadsAccountsSubTab').style.display = 'block';
                    loadThreadsAccountsList();
                    loadThreadsAccountsForDropdowns();
                    loadUCBConfig();
                }
            }

            // Influencer sub-tab switching
            function switchInfluencerSubTab(subTabName) {
                // Update sub-tab buttons
                document.querySelectorAll('.influencer-sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#333';
                });
                event.target.classList.add('active');
                event.target.style.background = '#f59e0b';
                event.target.style.color = 'white';

                // Hide all sub-tab content
                document.querySelectorAll('.influencer-sub-content').forEach(c => {
                    c.style.display = 'none';
                });

                // Show selected sub-tab and load data
                if (subTabName === 'authors') {
                    document.getElementById('influencerAuthorsTab').style.display = 'block';
                    loadInfluencerAuthors();
                }
                if (subTabName === 'contacts') {
                    document.getElementById('influencerContactsTab').style.display = 'block';
                    loadInfluencerContacts();
                }
                if (subTabName === 'settings') {
                    document.getElementById('influencerSettingsTab').style.display = 'block';
                    loadInfluencerConfig();
                }
            }

            // Helper function to load monitor data
            function loadMonitorData() {
                loadMonitorStats();  // è¼‰å…¥è²é‡çµ±è¨ˆï¼ˆé è¨­å­åˆ†é ï¼‰
                loadBrands();        // é è¼‰å…¥é—œéµå­—çµ„
            }

            // ========================================
            // ç¶²é»ƒåµæ¸¬åŠŸèƒ½
            // ========================================

            let influencerAuthorsPage = 0;
            const influencerAuthorsLimit = 20;

            async function loadInfluencerStats() {
                try {
                    const response = await fetch(`${API_BASE}/influencer/stats`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) return;
                    const result = await response.json();
                    const stats = result.data || {};

                    document.getElementById('influencerStatTotal').textContent = stats.withTwitter || 0;
                    document.getElementById('influencerStatVerified').textContent = stats.twitterVerified || 0;
                    document.getElementById('influencerStatContacted').textContent = stats.contacted || 0;
                    document.getElementById('influencerStatCooperating').textContent = stats.cooperating || 0;
                } catch (error) {
                    console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                }
            }

            async function loadInfluencerAuthors() {
                const container = document.getElementById('influencerAuthorsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const statusFilter = document.getElementById('influencerStatusFilter')?.value || '';
                    const verifiedFilter = document.getElementById('influencerVerifiedFilter')?.value || '';
                    const contactFilter = document.getElementById('influencerContactFilter')?.value || '';
                    const sortBy = document.getElementById('influencerSortBy')?.value || 'first_detected_at';
                    const sortOrder = document.getElementById('influencerSortOrder')?.value || 'DESC';

                    let url = `${API_BASE}/influencer/authors?limit=${influencerAuthorsLimit}&offset=${influencerAuthorsPage * influencerAuthorsLimit}&sortBy=${sortBy}&sortOrder=${sortOrder}`;
                    if (statusFilter) url += `&status=${statusFilter}`;
                    if (verifiedFilter) url += `&twitterVerified=${verifiedFilter}`;
                    if (contactFilter) url += `&hasContact=${contactFilter}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                    const result = await response.json();
                    const authors = result.data || [];
                    const total = result.total || 0;

                    // è¼‰å…¥çµ±è¨ˆ
                    loadInfluencerStats();

                    if (authors.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”</div>
                                <p style="font-size: 16px; margin-bottom: 10px;">å°šç„¡åµæ¸¬åˆ°æœ‰ Twitter çš„ä½œè€…</p>
                                <p style="font-size: 14px; color: #999;">é»æ“Šã€Œç«‹å³æƒæã€é–‹å§‹åµæ¸¬ Dcard è¥¿æ–¯ç‰ˆçš„ä½œè€…</p>
                            </div>
                        `;
                        return;
                    }

                    // ç·Šæ¹Šçš„å–®è¡Œè¡¨æ ¼ä½ˆå±€
                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #f8f9fa; font-size: 12px; color: #666;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">Dcard</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">Twitter</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">Dcard ç™¼æ–‡</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">Twitter ç™¼æ–‡</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">ç‹€æ…‹</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${authors.map(author => `
                                    <tr style="border-bottom: 1px solid #f0f0f0; font-size: 13px;">
                                        <td style="padding: 10px;">
                                            <a href="${author.dcard_url || '#'}" target="_blank" style="color: #333; text-decoration: none; font-weight: 500;">
                                                ${author.dcard_username || 'åŒ¿å'}
                                            </a>
                                            <span style="font-size: 10px; color: #999; margin-left: 5px;">@${author.dcard_id || ''}</span>
                                        </td>
                                        <td style="padding: 10px;">
                                            ${author.twitter_id ? `
                                                <a href="${author.twitter_url || 'https://x.com/' + author.twitter_id}" target="_blank"
                                                   style="color: #1da1f2; text-decoration: none; font-weight: 500;">
                                                    @${author.twitter_id}
                                                </a>
                                                ${author.twitter_display_name ? `<span style="font-size: 11px; color: #666; margin-left: 5px;">(${escapeHtml(author.twitter_display_name)})</span>` : ''}
                                            ` : '<span style="color: #ccc;">-</span>'}
                                        </td>
                                        <td style="padding: 10px; text-align: center; font-size: 12px; color: #666;">
                                            ${author.last_dcard_post_at ? formatRelativeTime(author.last_dcard_post_at) : '-'}
                                        </td>
                                        <td style="padding: 10px; text-align: center; font-size: 12px; color: #666;">
                                            ${author.last_twitter_post_at ? formatRelativeTime(author.last_twitter_post_at) : '-'}
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            <select onchange="updateAuthorStatus('${author.id}', this.value)"
                                                style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; cursor: pointer; background: ${getAuthorStatusColor(author.status)}15;">
                                                <option value="new" ${author.status === 'new' ? 'selected' : ''}>æ–°ç™¼ç¾</option>
                                                <option value="contacted" ${author.status === 'contacted' ? 'selected' : ''}>å·²è¯ç¹«</option>
                                                <option value="cooperating" ${author.status === 'cooperating' ? 'selected' : ''}>åˆä½œä¸­</option>
                                                <option value="rejected" ${author.status === 'rejected' ? 'selected' : ''}>å·²æ‹’çµ•</option>
                                                <option value="blacklisted" ${author.status === 'blacklisted' ? 'selected' : ''}>é»‘åå–®</option>
                                            </select>
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="showAddContactModal('${author.id}', '${author.dcard_username || 'åŒ¿å'}')"
                                                style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                                è¯ç¹«
                                            </button>
                                            <button onclick="deleteAuthor('${author.id}', '${author.dcard_username || 'åŒ¿å'}')"
                                                style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 4px;">
                                                åˆª
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // åˆ†é 
                    renderInfluencerPagination(total);
                } catch (error) {
                    console.error('è¼‰å…¥ä½œè€…åˆ—è¡¨å¤±æ•—:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
                }
            }

            function renderInfluencerPagination(total) {
                const container = document.getElementById('influencerAuthorsPagination');
                const totalPages = Math.ceil(total / influencerAuthorsLimit);

                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let html = '';
                if (influencerAuthorsPage > 0) {
                    html += `<button onclick="influencerAuthorsPage--; loadInfluencerAuthors();" class="btn btn-secondary btn-small">ä¸Šä¸€é </button>`;
                }
                html += `<span style="padding: 8px 15px;">ç¬¬ ${influencerAuthorsPage + 1} / ${totalPages} é </span>`;
                if (influencerAuthorsPage < totalPages - 1) {
                    html += `<button onclick="influencerAuthorsPage++; loadInfluencerAuthors();" class="btn btn-secondary btn-small">ä¸‹ä¸€é </button>`;
                }
                container.innerHTML = html;
            }

            async function exportInfluencerExcel() {
                try {
                    const statusFilter = document.getElementById('influencerStatusFilter')?.value || '';
                    const verifiedFilter = document.getElementById('influencerVerifiedFilter')?.value || '';
                    const contactFilter = document.getElementById('influencerContactFilter')?.value || '';
                    const sortBy = document.getElementById('influencerSortBy')?.value || 'first_detected_at';
                    const sortOrder = document.getElementById('influencerSortOrder')?.value || 'DESC';

                    let url = `${API_BASE}/influencer/authors/export/excel?sortBy=${sortBy}&sortOrder=${sortOrder}`;
                    if (statusFilter) url += `&status=${statusFilter}`;
                    if (verifiedFilter) url += `&twitterVerified=${verifiedFilter}`;
                    if (contactFilter) url += `&hasContact=${contactFilter}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `influencer_authors_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(downloadUrl);
                } catch (error) {
                    console.error('åŒ¯å‡º Excel å¤±æ•—:', error);
                    alert('åŒ¯å‡º Excel å¤±æ•—: ' + error.message);
                }
            }

            function formatRelativeTime(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
                if (diffHours < 24) return `${diffHours} å°æ™‚å‰`;
                if (diffDays < 30) return `${diffDays} å¤©å‰`;
                return date.toLocaleDateString('zh-TW');
            }

            function getAuthorStatusColor(status) {
                const colors = {
                    'new': '#f59e0b',
                    'pending': '#6366f1',
                    'contacted': '#3b82f6',
                    'negotiating': '#8b5cf6',
                    'cooperating': '#22c55e',
                    'rejected': '#ef4444',
                    'blacklisted': '#6b7280',
                    'no_social': '#9ca3af',
                };
                return colors[status] || '#9ca3af';
            }

            function getAuthorStatusLabel(status) {
                const labels = {
                    'new': 'ğŸ†• æ–°ç™¼ç¾',
                    'pending': 'â³ å¾…è™•ç†',
                    'contacted': 'ğŸ“§ å·²è¯ç¹«',
                    'negotiating': 'ğŸ’¬ æ´½è«‡ä¸­',
                    'cooperating': 'ğŸ¤ åˆä½œä¸­',
                    'rejected': 'âŒ å·²æ‹’çµ•',
                    'blacklisted': 'ğŸš« é»‘åå–®',
                    'no_social': 'ç„¡ç¤¾ç¾¤',
                };
                return labels[status] || status;
            }

            async function updateAuthorStatus(authorId, status) {
                try {
                    const response = await fetch(`${API_BASE}/influencer/authors/${authorId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status })
                    });

                    if (!response.ok) throw new Error('æ›´æ–°å¤±æ•—');
                    showAlert('ç‹€æ…‹å·²æ›´æ–°', 'success');
                    loadInfluencerStats();
                } catch (error) {
                    console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                    showAlert('æ›´æ–°å¤±æ•—', 'error');
                }
            }

            async function deleteAuthor(authorId, authorName) {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ä½œè€…ã€Œ${authorName}ã€å—ï¼Ÿ`)) return;

                try {
                    const response = await fetch(`${API_BASE}/influencer/authors/${authorId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('åˆªé™¤å¤±æ•—');
                    showAlert('ä½œè€…å·²åˆªé™¤', 'success');
                    loadInfluencerAuthors();
                } catch (error) {
                    console.error('åˆªé™¤ä½œè€…å¤±æ•—:', error);
                    showAlert('åˆªé™¤å¤±æ•—', 'error');
                }
            }

            async function verifyAuthorTwitter(authorId) {
                try {
                    showAlert('é©—è­‰ä¸­...', 'info');
                    const response = await fetch(`${API_BASE}/influencer/authors/${authorId}/verify-twitter`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert(result.message, result.data.exists ? 'success' : 'warning');
                        loadInfluencerAuthors();
                    } else {
                        showAlert(result.error || 'é©—è­‰å¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('é©—è­‰å¤±æ•—:', error);
                    showAlert('é©—è­‰å¤±æ•—', 'error');
                }
            }

            async function triggerInfluencerScan() {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = 'â³ æƒæä¸­...';

                try {
                    const response = await fetch(`${API_BASE}/influencer/scan`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ forum: 'sex' })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert(result.message, 'success');
                        loadInfluencerAuthors();
                    } else {
                        showAlert(result.error || 'æƒæå¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('æƒæå¤±æ•—:', error);
                    showAlert('æƒæå¤±æ•—ï¼Œè«‹ç¨€å¾Œå†è©¦', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            // è¯ç¹«è¨˜éŒ„
            async function loadInfluencerContacts() {
                const container = document.getElementById('influencerContactsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/influencer/contacts?limit=50`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                    const result = await response.json();
                    const contacts = result.data || [];

                    if (contacts.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">å°šç„¡è¯ç¹«è¨˜éŒ„</p>';
                        return;
                    }

                    container.innerHTML = contacts.map(contact => `
                        <div style="background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; margin-bottom: 5px;">
                                        ${contact.author_name || 'åŒ¿å'} ${contact.twitter_id ? '(@' + contact.twitter_id + ')' : ''}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        ğŸ“… ${new Date(contact.contact_date).toLocaleDateString('zh-TW')} Â·
                                        ${getContactMethodLabel(contact.contact_method)}
                                    </div>
                                    ${contact.notes ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">${escapeHtml(contact.notes)}</div>` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                                    <span style="padding: 3px 10px; border-radius: 10px; font-size: 11px;
                                        background: ${getContactResultColor(contact.result)}20; color: ${getContactResultColor(contact.result)};">
                                        ${getContactResultLabel(contact.result)}
                                    </span>
                                    <select onchange="updateContactResult('${contact.id}', this.value)"
                                        style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 11px;">
                                        <option value="pending" ${contact.result === 'pending' ? 'selected' : ''}>â³ å¾…å›è¦†</option>
                                        <option value="no_response" ${contact.result === 'no_response' ? 'selected' : ''}>ğŸ˜¶ ç„¡å›æ‡‰</option>
                                        <option value="responded" ${contact.result === 'responded' ? 'selected' : ''}>ğŸ’¬ å·²å›è¦†</option>
                                        <option value="interested" ${contact.result === 'interested' ? 'selected' : ''}>ğŸ‘ æœ‰æ„é¡˜</option>
                                        <option value="agreed" ${contact.result === 'agreed' ? 'selected' : ''}>ğŸ¤ å·²åŒæ„</option>
                                        <option value="rejected" ${contact.result === 'rejected' ? 'selected' : ''}>âŒ å·²æ‹’çµ•</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('è¼‰å…¥è¯ç¹«è¨˜éŒ„å¤±æ•—:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            function getContactMethodLabel(method) {
                const labels = {
                    'twitter_dm': 'ğŸ¦ Twitter DM',
                    'dcard_msg': 'ğŸ’¬ Dcard ç§è¨Š',
                    'instagram_dm': 'ğŸ“· IG ç§è¨Š',
                    'email': 'ğŸ“§ Email',
                    'other': 'ğŸ“ å…¶ä»–',
                };
                return labels[method] || method;
            }

            function getContactResultColor(result) {
                const colors = {
                    'pending': '#f59e0b',
                    'no_response': '#9ca3af',
                    'responded': '#3b82f6',
                    'interested': '#8b5cf6',
                    'negotiating': '#6366f1',
                    'agreed': '#22c55e',
                    'rejected': '#ef4444',
                };
                return colors[result] || '#9ca3af';
            }

            function getContactResultLabel(result) {
                const labels = {
                    'pending': 'â³ å¾…å›è¦†',
                    'no_response': 'ğŸ˜¶ ç„¡å›æ‡‰',
                    'responded': 'ğŸ’¬ å·²å›è¦†',
                    'interested': 'ğŸ‘ æœ‰æ„é¡˜',
                    'negotiating': 'ğŸ’¬ æ´½è«‡ä¸­',
                    'agreed': 'ğŸ¤ å·²åŒæ„',
                    'rejected': 'âŒ å·²æ‹’çµ•',
                };
                return labels[result] || result;
            }

            async function updateContactResult(contactId, result) {
                try {
                    const response = await fetch(`${API_BASE}/influencer/contacts/${contactId}/result`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ result })
                    });

                    if (!response.ok) throw new Error('æ›´æ–°å¤±æ•—');
                    showAlert('ç‹€æ…‹å·²æ›´æ–°', 'success');
                    loadInfluencerStats();
                } catch (error) {
                    console.error('æ›´æ–°å¤±æ•—:', error);
                    showAlert('æ›´æ–°å¤±æ•—', 'error');
                }
            }

            function showAddContactModal(authorId, authorName) {
                const modal = document.createElement('div');
                modal.id = 'addContactModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;">
                        <h3 style="margin: 0 0 20px 0;">ğŸ“§ æ–°å¢è¯ç¹«è¨˜éŒ„</h3>
                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">ä½œè€…: ${authorName}</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">è¯ç¹«æ—¥æœŸ</label>
                            <input type="date" id="contactDate" value="${new Date().toISOString().split('T')[0]}"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">è¯ç¹«æ–¹å¼</label>
                            <select id="contactMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="twitter_dm">ğŸ¦ Twitter DM</option>
                                <option value="dcard_msg">ğŸ’¬ Dcard ç§è¨Š</option>
                                <option value="other">ğŸ“ å…¶ä»–</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 13px;">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                            <textarea id="contactNotes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; resize: none;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="document.getElementById('addContactModal').remove()" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button onclick="submitAddContact('${authorId}')" class="btn">å„²å­˜</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitAddContact(authorId) {
                const contactDate = document.getElementById('contactDate').value;
                const contactMethod = document.getElementById('contactMethod').value;
                const notes = document.getElementById('contactNotes').value;

                try {
                    const response = await fetch(`${API_BASE}/influencer/contacts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            authorId,
                            contactDate,
                            contactMethod,
                            notes
                        })
                    });

                    if (!response.ok) throw new Error('æ–°å¢å¤±æ•—');

                    document.getElementById('addContactModal').remove();
                    showAlert('è¯ç¹«è¨˜éŒ„å·²æ–°å¢', 'success');
                    loadInfluencerAuthors();
                    loadInfluencerStats();
                } catch (error) {
                    console.error('æ–°å¢è¯ç¹«è¨˜éŒ„å¤±æ•—:', error);
                    showAlert('æ–°å¢å¤±æ•—', 'error');
                }
            }

            async function loadInfluencerConfig() {
                try {
                    const response = await fetch(`${API_BASE}/influencer/config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) return;

                    const result = await response.json();
                    const config = result.data || {};

                    document.getElementById('influencerAutoScan').checked = config.enabled || false;
                    document.getElementById('influencerScanInterval').value = config.check_interval_minutes || 30;
                } catch (error) {
                    console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                }
            }

            async function saveInfluencerSettings() {
                try {
                    const autoScan = document.getElementById('influencerAutoScan').checked;
                    const scanInterval = parseInt(document.getElementById('influencerScanInterval').value);

                    const response = await fetch(`${API_BASE}/influencer/config`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            enabled: autoScan,
                            checkIntervalMinutes: scanInterval
                        })
                    });

                    if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');
                    showAlert('è¨­å®šå·²å„²å­˜', 'success');
                } catch (error) {
                    console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                    showAlert('å„²å­˜å¤±æ•—', 'error');
                }
            }

            // ========================================
            // ç³»çµ±è¨­å®šåŠŸèƒ½
            // ========================================

            async function loadSystemSettings() {
                // ç³»çµ±è¨­å®šé é¢çš„è¼‰å…¥å‡½æ•¸
                // ç›®å‰åªé¡¯ç¤ºéœæ…‹è³‡è¨Šï¼Œä¸éœ€è¦å¾ API è¼‰å…¥
                console.log('ç³»çµ±è¨­å®šé é¢å·²è¼‰å…¥');
            }

            async function saveLineSettings() {
                try {
                    const lineUserId = document.getElementById('settingsLineUserId').value;
                    const notifyPainPoint = document.getElementById('settingsNotifyPainPoint').checked;
                    const notifyInfluencer = document.getElementById('settingsNotifyInfluencer').checked;

                    // é€™è£¡å¯ä»¥å„²å­˜åˆ°å¾Œç«¯
                    showAlert('LINE è¨­å®šå·²å„²å­˜', 'success');
                } catch (error) {
                    console.error('å„²å­˜ LINE è¨­å®šå¤±æ•—:', error);
                    showAlert('å„²å­˜å¤±æ•—', 'error');
                }
            }

            function togglePasswordVisibility(inputId) {
                const input = document.getElementById(inputId);
                if (input.type === 'password') {
                    input.type = 'text';
                } else {
                    input.type = 'password';
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Sub-tab switching for scheduling tab
            function switchSchedulingSubTab(subTabName) {
                // Remove active class from all sub-tabs
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked sub-tab
                event.target.classList.add('active');

                // Show corresponding sub-tab content
                if (subTabName === 'manual') {
                    document.getElementById('manualSubTab').classList.add('active');
                    loadThreadsAccountsForDropdowns();
                } else if (subTabName === 'ai') {
                    document.getElementById('aiSubTab').classList.add('active');
                    // è¼‰å…¥ AI ç™¼æ–‡é…ç½®
                    loadAIConfig();
                    loadScheduleHistory();
                } else if (subTabName === 'pending') {
                    document.getElementById('pendingSubTab').classList.add('active');
                    loadPendingPosts();
                }
            }

            // Load overview
            async function loadOverview() {
                try {
                    // å–å¾—å„ç‹€æ…‹çš„æ•¸é‡ï¼ˆåªå¾ posts è¡¨è¨ˆç®—ï¼Œé¿å…é‡è¤‡ï¼‰
                    const [pendingRes, approvedRes, postedRes] = await Promise.all([
                        fetch(`${API_BASE}/posts?status=PENDING_REVIEW`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE}/posts?status=APPROVED`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE}/posts?status=POSTED`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);

                    const [pendingData, approvedData, postedData] = await Promise.all([
                        pendingRes.json(),
                        approvedRes.json(),
                        postedRes.json()
                    ]);

                    const pending = pendingData.total || 0;
                    const posted = postedData.total || 0;

                    // æ’ç¨‹ä¸­ = APPROVED ç‹€æ…‹çš„è²¼æ–‡ï¼ˆå·²å¯©æ ¸å¾…ç™¼å¸ƒï¼‰
                    // ä¸éœ€è¦é¡å¤–è¨ˆç®— schedulesï¼Œå› ç‚º posts.status å·²ç¶“åæ˜ äº†å¯©æ ¸ç‹€æ…‹
                    const scheduled = approvedData.total || 0;

                    // ç¸½è²¼æ–‡æ•¸ = å¾…å¯©æ ¸ + æ’ç¨‹ä¸­ + å·²ç™¼å¸ƒ
                    const total = pending + scheduled + posted;

                    document.getElementById('totalPosts').textContent = total;
                    document.getElementById('pendingPosts').textContent = pending;
                    document.getElementById('scheduledPosts').textContent = scheduled;
                    document.getElementById('postedPosts').textContent = posted;
                } catch (error) {
                    console.error('Failed to load overview:', error);
                    showAlert('dashboardAlert', 'è¼‰å…¥ç¸½è¦½å¤±æ•—: ' + error.message, 'error');
                }
            }

            // Load posts
            async function loadPosts() {
                const status = document.getElementById('filterStatus')?.value || '';
                const url = status ? `${API_BASE}/posts?status=${status}` : `${API_BASE}/posts`;

                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                    const data = await response.json();
                    const posts = data.data || data.posts || [];
                    renderPosts(posts, 'postsGrid');
                } catch (error) {
                    showAlert('dashboardAlert', 'è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message, 'error');
                }
            }

            // Render posts
            function renderPosts(posts, containerId) {
                const container = document.getElementById(containerId);

                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px;">æš«ç„¡è²¼æ–‡</p>
                        <p style="margin-top: 10px;">å»ºç«‹ç¬¬ä¸€ç¯‡è²¼æ–‡é–‹å§‹ä½¿ç”¨!</p>
                    </div>
                `;
                    // Hide batch delete button when no posts
                    const batchBtn = document.getElementById('batchDeleteBtn');
                    if (batchBtn) batchBtn.style.display = 'none';
                    return;
                }

                // Show checkboxes only in postsGrid (not in recentPosts)
                const showCheckbox = containerId === 'postsGrid';

                container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${showCheckbox ? `<input type="checkbox" class="post-checkbox" data-post-id="${post.id}" onchange="updateBatchDeleteButton()" style="width: 18px; height: 18px; cursor: pointer;">` : ''}
                            <h3>æ–‡ç«  #${post.id.substring(0, 8)}</h3>
                        </div>
                        <span class="status-badge status-${post.status}">${getStatusText(post.status)}</span>
                    </div>

                    <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.created_at).toLocaleString('zh-TW')}</p>
                    ${post.posted_at ? `<p><strong>ç™¼å¸ƒæ™‚é–“:</strong> ${new Date(post.posted_at).toLocaleString('zh-TW')}</p>` : ''}
                    ${post.post_url ? `<p><strong>è²¼æ–‡é€£çµ:</strong> <a href="${post.post_url}" target="_blank">æŸ¥çœ‹</a></p>` : ''}

                    <div class="post-actions">
                        <button class="btn btn-small btn-secondary" onclick="viewPost('${post.id}')">æŸ¥çœ‹è©³æƒ…</button>
                        ${post.status === 'DRAFT' ? `<button class="btn btn-small btn-success" onclick="generateContent('${post.id}')">ç”Ÿæˆå…§å®¹</button>` : ''}
                        ${post.status === 'APPROVED' ? `<button class="btn btn-small btn-success" onclick="publishPost('${post.id}')">ç™¼å¸ƒ</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-success" onclick="approvePost('${post.id}')">æ ¸å‡†</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-warning" onclick="regenerateContent('${post.id}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePost('${post.id}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
            }

            // Create post
            async function createPost(event) {
                event.preventDefault();
                showLoading(true);

                const topic = document.getElementById('postTopic').value;
                const keywords = document.getElementById('postKeywords').value.split(',').map(k => k.trim());
                const targetTone = document.getElementById('postTone').value;
                const targetLength = parseInt(document.getElementById('postLength').value);
                const scheduledFor = document.getElementById('postSchedule').value;
                const autoGenerate = document.getElementById('autoGenerate').checked;

                const postData = {
                    topic,
                    keywords,
                    targetTone,
                    targetLength,
                    ...(scheduledFor && { scheduledFor: new Date(scheduledFor).toISOString() })
                };

                try {
                    const response = await fetch(`${API_BASE}/posts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(postData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', 'è²¼æ–‡å»ºç«‹æˆåŠŸ!', 'success');
                        event.target.reset();

                        if (autoGenerate) {
                            await generateContent(data.id);
                        }

                        switchTab('posts');
                        loadPosts();
                        loadOverview();
                    } else {
                        showAlert('dashboardAlert', data.error || 'å»ºç«‹å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Generate content
            async function generateContent(postId) {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}/generate`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', 'å…§å®¹ç”Ÿæˆä»»å‹™å·²åŠ å…¥ä½‡åˆ—,è«‹ç¨å¾ŒæŸ¥çœ‹', 'info');
                        setTimeout(() => {
                            loadPosts();
                            loadOverview();
                        }, 3000);
                    } else {
                        showAlert('dashboardAlert', data.error || 'ç”Ÿæˆå¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // View post detail
            async function viewPost(postId) {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const post = await response.json();

                    if (response.ok) {
                        const modalBody = document.getElementById('modalBody');
                        modalBody.innerHTML = `
                        <h3>${post.topic}</h3>
                        <p><span class="status-badge status-${post.status}">${getStatusText(post.status)}</span></p>

                        <div style="margin: 20px 0;">
                            <p><strong>é—œéµå­—:</strong> ${post.keywords.join(', ')}</p>
                            <p><strong>èªæ°£:</strong> ${post.targetTone}</p>
                            <p><strong>ç›®æ¨™é•·åº¦:</strong> ${post.targetLength} å­—</p>
                            <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>
                            ${post.scheduledFor ? `<p><strong>æ’ç¨‹æ™‚é–“:</strong> ${new Date(post.scheduledFor).toLocaleString('zh-TW')}</p>` : ''}
                        </div>

                        ${post.latestRevision ? `
                            <h4>æœ€æ–°å…§å®¹ç‰ˆæœ¬</h4>
                            <div class="content-preview">${post.latestRevision.content}</div>
                            <p><strong>å­—æ•¸:</strong> ${post.latestRevision.wordCount}</p>
                            <p><strong>AI å¼•æ“:</strong> ${post.latestRevision.aiEngine}</p>
                            <p><strong>ç”Ÿæˆæ™‚é–“:</strong> ${new Date(post.latestRevision.createdAt).toLocaleString('zh-TW')}</p>
                        ` : '<p style="color: #666;">å°šæœªç”Ÿæˆå…§å®¹</p>'}
                    `;

                        document.getElementById('postModal').classList.add('active');
                    } else {
                        showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Approve post
            async function approvePost(postId) {
                if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤è²¼æ–‡å—?')) return;

                showLoading(true);

                try {
                    // Get post detail first to get revision ID
                    const postResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const post = await postResponse.json();

                    if (!post.latestRevision) {
                        throw new Error('æ‰¾ä¸åˆ°å…§å®¹ç‰ˆæœ¬');
                    }

                    const response = await fetch(`${API_BASE}/review/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            postId: postId,
                            revisionId: post.latestRevision.id,
                            action: 'approve'
                        })
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'è²¼æ–‡å·²æ ¸å‡†', 'success');
                        loadPosts();
                        loadOverview();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'æ ¸å‡†å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Regenerate content
            async function regenerateContent(postId) {
                if (!confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆå…§å®¹å—?')) return;
                await generateContent(postId);
            }

            // Publish post
            async function publishPost(postId) {
                if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒæ­¤è²¼æ–‡åˆ° Threads å—?')) return;

                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}/publish`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', 'ç™¼å¸ƒä»»å‹™å·²åŠ å…¥ä½‡åˆ—', 'info');
                        setTimeout(() => {
                            loadPosts();
                            loadOverview();
                        }, 3000);
                    } else {
                        showAlert('dashboardAlert', data.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Delete post
            async function deletePost(postId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                        loadPosts();
                        loadOverview();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'åˆªé™¤å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Toggle select all checkboxes
            function toggleSelectAll() {
                const checkboxes = document.querySelectorAll('.post-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });

                updateBatchDeleteButton();
            }

            // Update batch delete button visibility
            function updateBatchDeleteButton() {
                const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
                const batchBtn = document.getElementById('batchDeleteBtn');

                if (batchBtn) {
                    if (checkedBoxes.length > 0) {
                        batchBtn.style.display = 'inline-block';
                        batchBtn.textContent = `ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤ (${checkedBoxes.length})`;
                    } else {
                        batchBtn.style.display = 'none';
                    }
                }
            }

            // Batch delete posts
            async function batchDeletePosts() {
                const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
                const postIds = Array.from(checkedBoxes).map(cb => cb.dataset.postId);

                if (postIds.length === 0) {
                    showAlert('dashboardAlert', 'è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è²¼æ–‡', 'error');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${postIds.length} ç¯‡è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                    return;
                }

                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                try {
                    // Delete posts one by one
                    for (const postId of postIds) {
                        try {
                            const response = await fetch(`${API_BASE}/posts/${postId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            failCount++;
                        }
                    }

                    // Show result
                    if (successCount > 0 && failCount === 0) {
                        showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡è²¼æ–‡`, 'success');
                    } else if (successCount > 0 && failCount > 0) {
                        showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡,å¤±æ•— ${failCount} ç¯‡`, 'error');
                    } else {
                        showAlert('dashboardAlert', `åˆªé™¤å¤±æ•—`, 'error');
                    }

                    // Reload posts
                    loadPosts();
                    loadOverview();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ‰¹æ¬¡åˆªé™¤å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Utilities
            function getStatusText(status) {
                const statusMap = {
                    'DRAFT': 'è‰ç¨¿',
                    'GENERATING': 'ç”¢ç”Ÿä¸­',
                    'PENDING_REVIEW': 'å¾…å¯©æ ¸',
                    'APPROVED': 'å·²æ ¸å‡†',
                    'PUBLISHING': 'ç™¼å¸ƒä¸­',
                    'POSTED': 'å·²ç™¼å¸ƒ',
                    'FAILED': 'å¤±æ•—',
                    'ACTION_REQUIRED': 'éœ€è¦è™•ç†',
                    'SKIPPED': 'å·²è·³é'
                };
                return statusMap[status] || status;
            }

            function showAlert(elementId, message, type) {
                const alertDiv = document.getElementById(elementId);
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 5000);
            }

            function showLoading(show) {
                const loading = document.getElementById('loading');
                if (show) {
                    loading.classList.add('active');
                } else {
                    loading.classList.remove('active');
                }
            }

            function closeModal() {
                document.getElementById('postModal').classList.remove('active');
            }

            // Threads Accounts Management
            async function loadThreadsAccounts() {
                // Load accounts for dropdown in create form
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const accounts = await response.json();
                        const select = document.getElementById('postThreadsAccount');
                        select.innerHTML = '<option value="">ç¨å¾Œé¸æ“‡</option>';

                        accounts.forEach(acc => {
                            const option = document.createElement('option');
                            option.value = acc.id;
                            option.textContent = `@${acc.username}`;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load accounts:', error);
                }
            }

            async function loadThreadsAccountsList() {
                const container = document.getElementById('threadsAccountsList');

                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const accounts = data.accounts || [];

                        if (accounts.length === 0) {
                            container.innerHTML = '<div class="empty-state"><p>å°šæœªé€£çµä»»ä½• Threads å¸³è™Ÿ</p></div>';
                            return;
                        }

                        container.innerHTML = accounts.map(acc => `
                        <div class="post-card" style="${acc.is_default ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3>@${acc.username}</h3>
                                ${acc.is_default ? '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">é è¨­å¸³è™Ÿ</span>' : ''}
                            </div>
                            <p><strong>å¸³è™Ÿ ID:</strong> ${acc.account_id || '(æœªè¨­å®š)'}</p>
                            <p><strong>ç‹€æ…‹:</strong> ${acc.status === 'ACTIVE' ? '<span style="color: #28a745;">âœ“ å•Ÿç”¨ä¸­</span>' : '<span style="color: #dc3545;">å·²é–å®š</span>'}</p>
                            <p><strong>é€£çµæ™‚é–“:</strong> ${new Date(acc.created_at).toLocaleString('zh-TW')}</p>
                            <div class="post-actions">
                                ${!acc.is_default ? `<button class="btn btn-small" style="background: #28a745;" onclick="setDefaultAccount('${acc.id}')">è¨­ç‚ºé è¨­</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="removeThreadsAccount('${acc.id}')">è§£é™¤é€£çµ</button>
                            </div>
                        </div>
                    `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—: ' + error.message + '</p></div>';
                }
            }

            async function startThreadsOAuth() {
                try {
                    // Get OAuth URL from backend with authentication
                    const response = await fetch(`${API_BASE}/threads/oauth/authorize`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.authUrl) {
                            // Redirect to Threads authorization page
                            window.location.href = data.authUrl;
                        }
                    } else {
                        const error = await response.json();
                        showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.message}`, 'error');
                }
            }

            async function setDefaultAccount(accountId) {
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts/${accountId}/set-default`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'âœ… å·²è¨­ç‚ºé è¨­å¸³è™Ÿ', 'success');
                        loadThreadsAccountsList();
                        // Reload UCB config to refresh account selector
                        if (typeof loadUcbConfig === 'function') {
                            loadUcbConfig();
                        }
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'è¨­å®šå¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'è¨­å®šå¤±æ•—: ' + error.message, 'error');
                }
            }

            async function removeThreadsAccount(accountId) {
                if (!confirm('ç¢ºå®šè¦è§£é™¤é€£çµæ­¤ Threads å¸³è™Ÿå—?')) return;

                try {
                    const response = await fetch(`${API_BASE}/threads/accounts/${accountId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'Threads å¸³è™Ÿå·²è§£é™¤é€£çµ', 'success');
                        loadThreadsAccountsList();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'è§£é™¤å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'è§£é™¤å¤±æ•—: ' + error.message, 'error');
                }
            }

            async function runDiagnostics() {
                const resultDiv = document.getElementById('diagnosticsResult');
                const contentDiv = document.getElementById('diagnosticsContent');

                // Show loading
                resultDiv.style.display = 'block';
                contentDiv.innerHTML = '<p style="color: #666;">ğŸ”„ è¨ºæ–·ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/diagnose`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('è¨ºæ–·è«‹æ±‚å¤±æ•—');
                    }

                    const data = await response.json();

                    // Build diagnostic HTML
                    let html = '';

                    // Threads Accounts
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="margin-bottom: 10px;">ğŸ“± Threads å¸³è™Ÿç‹€æ…‹</h4>';
                    if (data.checks.threadsAccounts.total === 0) {
                        html += '<p style="color: #dc3545;">âŒ æ‰¾ä¸åˆ°ä»»ä½• Threads å¸³è™Ÿ</p>';
                    } else {
                        data.checks.threadsAccounts.accounts.forEach((acc, i) => {
                            html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${acc.issues.length > 0 ? '#ffc107' : '#28a745'}">`;
                            html += `<p style="margin: 5px 0;"><strong>å¸³è™Ÿ ${i + 1}:</strong> ${acc.username}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Account ID: ${acc.accountId || 'âŒ æœªè¨­å®š'}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç‹€æ…‹: ${acc.status}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">é è¨­å¸³è™Ÿ: ${acc.isDefault ? 'âœ“ æ˜¯' : 'å¦'}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Token ç‹€æ…‹: ${acc.tokenStatus || 'ç„¡'}</p>`;
                            if (acc.issues.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                                acc.issues.forEach(issue => {
                                    html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                                });
                                html += `</div>`;
                            }
                            html += `</div>`;
                        });
                    }
                    html += '</div>';

                    // Recent Posts
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="margin-bottom: 10px;">ğŸ“ æœ€è¿‘çš„æ–‡ç« </h4>';
                    if (data.checks.recentPosts.total === 0) {
                        html += '<p style="color: #666;">ç›®å‰æ²’æœ‰æ–‡ç« </p>';
                    } else {
                        data.checks.recentPosts.posts.slice(0, 3).forEach((post, i) => {
                            const statusColor = {
                                'POSTED': '#28a745',
                                'APPROVED': '#ffc107',
                                'FAILED': '#dc3545',
                                'PENDING_REVIEW': '#17a2b8'
                            }[post.status] || '#6c757d';

                            html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor}">`;
                            html += `<p style="margin: 5px 0;"><strong>æ–‡ç«  ${i + 1}:</strong> <span style="color: ${statusColor}; font-weight: bold;">${post.status}</span></p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">å»ºç«‹: ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>`;
                            if (post.approvedAt) {
                                html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">æ ¸å‡†: ${new Date(post.approvedAt).toLocaleString('zh-TW')}</p>`;
                            }
                            if (post.postedAt) {
                                html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç™¼å¸ƒ: ${new Date(post.postedAt).toLocaleString('zh-TW')}</p>`;
                            }
                            if (post.error) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px;">`;
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #721c24;">éŒ¯èª¤: ${post.error.message || post.error.code}</p>`;
                                html += `</div>`;
                            }
                            if (post.issues.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                                post.issues.forEach(issue => {
                                    html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                                });
                                html += `</div>`;
                            }
                            html += `</div>`;
                        });
                    }
                    html += '</div>';

                    // Analysis & Recommendations
                    html += '<div style="background: white; padding: 15px; border-radius: 8px;">';
                    html += '<h4 style="margin-bottom: 10px;">ğŸ’¡ è¨ºæ–·å»ºè­°</h4>';
                    if (data.analysis.recommendations.length === 0) {
                        html += '<p style="color: #28a745;">âœ… æ‰€æœ‰è¨­å®šçœ‹èµ·ä¾†æ­£å¸¸</p>';
                    } else {
                        html += '<ul style="margin: 0; padding-left: 20px;">';
                        data.analysis.recommendations.forEach(rec => {
                            html += `<li style="margin: 8px 0; color: #856404;">${rec}</li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';

                    contentDiv.innerHTML = html;

                } catch (error) {
                    contentDiv.innerHTML = `<p style="color: #dc3545;">âŒ è¨ºæ–·å¤±æ•—: ${error.message}</p>`;
                }
            }

            // Settings Management
            async function loadSettings() {
                try {
                    const response = await fetch(`${API_BASE}/settings`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('è¼‰å…¥è¨­å®šå¤±æ•—');

                    const data = await response.json();
                    const settings = data.settings;

                    // AI Engine
                    if (settings.ai_engine) {
                        const aiEngineEl = document.getElementById('aiEngine');
                        if (aiEngineEl) aiEngineEl.value = settings.ai_engine.value;
                    }

                    // Custom Prompt
                    if (settings.custom_prompt) {
                        const customPromptEl = document.getElementById('customPrompt');
                        if (customPromptEl) customPromptEl.value = settings.custom_prompt.value;
                    }

                    // Schedule Config
                    if (settings.schedule_config) {
                        const scheduleConfig = settings.schedule_config.value;
                        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                        days.forEach(day => {
                            const config = scheduleConfig[day];
                            if (config) {
                                const checkboxEl = document.getElementById(`schedule_${day}`);
                                const timeEl = document.getElementById(`time_${day}`);
                                if (checkboxEl) checkboxEl.checked = config.enabled;
                                if (timeEl) timeEl.value = config.time;
                            }
                        });
                    }

                    // Auto Post Threads Account - Store value to apply after dropdown is populated
                    if (settings.auto_post_threads_account) {
                        const autoPostEl = document.getElementById('autoPostThreadsAccount');
                        if (autoPostEl && settings.auto_post_threads_account.value) {
                            // Store the saved value temporarily to apply after options are loaded
                            autoPostEl.dataset.savedValue = settings.auto_post_threads_account.value;
                        }
                    }

                    // LINE Notify User ID
                    if (settings.line_notify_user_id) {
                        const lineUserIdEl = document.getElementById('lineNotifyUserId');
                        if (lineUserIdEl) lineUserIdEl.value = settings.line_notify_user_id.value;
                    }

                } catch (error) {
                    showAlert('dashboardAlert', 'è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
                }
            }

            async function saveAllSettings() {
                showLoading(true);

                try {
                    // Collect schedule config
                    const scheduleConfig = {
                        monday: {
                            enabled: document.getElementById('schedule_monday').checked,
                            time: document.getElementById('time_monday').value
                        },
                        tuesday: {
                            enabled: document.getElementById('schedule_tuesday').checked,
                            time: document.getElementById('time_tuesday').value
                        },
                        wednesday: {
                            enabled: document.getElementById('schedule_wednesday').checked,
                            time: document.getElementById('time_wednesday').value
                        },
                        thursday: {
                            enabled: document.getElementById('schedule_thursday').checked,
                            time: document.getElementById('time_thursday').value
                        },
                        friday: {
                            enabled: document.getElementById('schedule_friday').checked,
                            time: document.getElementById('time_friday').value
                        },
                        saturday: {
                            enabled: document.getElementById('schedule_saturday').checked,
                            time: document.getElementById('time_saturday').value
                        },
                        sunday: {
                            enabled: document.getElementById('schedule_sunday').checked,
                            time: document.getElementById('time_sunday').value
                        }
                    };

                    const settings = {
                        ai_engine: {
                            value: document.getElementById('aiEngine').value,
                            type: 'STRING'
                        },
                        custom_prompt: {
                            value: document.getElementById('customPrompt').value,
                            type: 'STRING'
                        },
                        schedule_config: {
                            value: scheduleConfig,
                            type: 'JSON'
                        },
                        auto_post_threads_account: {
                            value: document.getElementById('autoPostThreadsAccount').value,
                            type: 'STRING'
                        },
                        line_notify_user_id: {
                            value: document.getElementById('lineNotifyUserId').value,
                            type: 'STRING'
                        }
                    };

                    const response = await fetch(`${API_BASE}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ settings })
                    });

                    if (!response.ok) throw new Error('å„²å­˜è¨­å®šå¤±æ•—');

                    showAlert('dashboardAlert', 'âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
                } catch (error) {
                    showAlert('dashboardAlert', 'å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function testLineNotification() {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/settings/test-line`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'æ¸¬è©¦é€šçŸ¥å¤±æ•—');
                    }

                    showAlert('dashboardAlert', 'âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€åˆ° LINEï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE è¨Šæ¯ã€‚', 'success');
                } catch (error) {
                    showAlert('dashboardAlert', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function runTestGeneration() {
                showLoading(true);
                document.getElementById('testResults').style.display = 'none';

                try {
                    const response = await fetch(`${API_BASE}/settings/test-generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = 'æ¸¬è©¦ç”Ÿæˆå¤±æ•—';
                        try {
                            const error = await response.json();
                            errorMessage = error.error || error.message || errorMessage;
                            console.error('API Error:', error);
                        } catch (e) {
                            const text = await response.text();
                            console.error('Response text:', text);
                            errorMessage = text || errorMessage;
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('Test generation response:', data);

                    // Display success message with content preview
                    const resultHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #1DB446;">
                        <h4 style="margin: 0 0 15px 0; color: #1DB446;">âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆï¼</h4>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“Š ç”Ÿæˆè³‡è¨Šï¼š</strong></p>
                            <p style="margin: 5px 0;">ğŸ¤– å¼•æ“ï¼š${data.engine}</p>
                            <p style="margin: 5px 0;">ğŸ“ˆ ç›¸ä¼¼åº¦ï¼š${(data.similarity * 100).toFixed(1)}%</p>
                            <p style="margin: 5px 0; color: ${data.similarity > 0.86 ? '#ff0000' : '#4CAF50'};">
                                ${data.similarity > 0.86 ? 'âš ï¸ ç›¸ä¼¼åº¦è¼ƒé«˜ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆ' : 'âœ… ç›¸ä¼¼åº¦æ­£å¸¸'}
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“ æ–‡ç« å…§å®¹é è¦½ï¼š</strong></p>
                            <p style="white-space: pre-wrap; margin: 0; line-height: 1.6; color: #333;">
                                ${data.content.substring(0, 200)}${data.content.length > 200 ? '...' : ''}
                            </p>
                        </div>

                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #2e7d32;">ğŸ“± ä¸‹ä¸€æ­¥ï¼š</p>
                            <p style="margin: 10px 0 0 0; line-height: 1.8; color: #333;">
                                æ¸¬è©¦æ–‡ç« å·²ç™¼é€åˆ°æ‚¨çš„ LINEï¼<br>
                                è«‹åˆ° LINE æŸ¥çœ‹å®Œæ•´å…§å®¹ä¸¦é€²è¡Œå¯©æ ¸ï¼š<br>
                                â€¢ âœ… ç¢ºèªç™¼æ–‡ â†’ ç™¼å¸ƒåˆ° Threads<br>
                                â€¢ ğŸ”„ é‡æ–°ç”Ÿæˆ â†’ ç”¢ç”Ÿæ–°æ–‡ç« <br>
                                â€¢ âœï¸ ä¿®æ”¹å…§å®¹ â†’ ç·¨è¼¯å¾Œç™¼å¸ƒ
                            </p>
                        </div>
                    </div>
                `;

                    document.getElementById('testResultsContent').innerHTML = resultHtml;
                    document.getElementById('testResults').style.display = 'block';

                    showAlert('dashboardAlert', 'âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆä¸¦ç™¼é€åˆ° LINEï¼è«‹åˆ° LINE æŸ¥çœ‹ã€‚', 'success');
                } catch (error) {
                    const errorHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 10px 0; color: #f44336;">âŒ æ¸¬è©¦å¤±æ•—</h4>
                        <p style="margin: 0; color: #666;">${error.message}</p>
                        ${error.message.includes('LINE User ID') ? `
                            <p style="margin: 15px 0 0 0; padding: 10px; background: #fff3e0; border-radius: 4px; color: #ff6600;">
                                ğŸ’¡ æç¤ºï¼šè«‹å…ˆè¨­å®š LINE User ID<br>
                                1. åœ¨ LINE ä¸­å‚³é€ã€Œ/myidã€çµ¦æ©Ÿå™¨äºº<br>
                                2. è¤‡è£½æ”¶åˆ°çš„ User ID<br>
                                3. è²¼åˆ°ä¸Šæ–¹ã€ŒLINE é€šçŸ¥è¨­å®šã€ä¸¦å„²å­˜
                            </p>
                        ` : ''}
                    </div>
                `;
                    document.getElementById('testResultsContent').innerHTML = errorHtml;
                    document.getElementById('testResults').style.display = 'block';

                    showAlert('dashboardAlert', 'æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Character counter for manual post content
            const manualContentTextarea = document.getElementById('manualPostContent');
            if (manualContentTextarea) {
                manualContentTextarea.addEventListener('input', function () {
                    const count = this.value.length;
                    document.getElementById('contentCharCount').textContent = count;
                });
            }

            // Toggle schedule input visibility
            function toggleScheduleInput() {
                const scheduleInput = document.getElementById('manualPostSchedule');
                const isScheduled = document.querySelector('input[name="publishTime"]:checked')?.value === 'scheduled';
                if (scheduleInput) {
                    scheduleInput.style.display = isScheduled ? 'block' : 'none';
                    if (!isScheduled) {
                        scheduleInput.value = '';
                    }
                }
            }

            // Load Threads accounts into dropdowns
            async function loadThreadsAccountsForDropdowns() {
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('è¼‰å…¥å¸³è™Ÿå¤±æ•—');

                    const data = await response.json();
                    const accounts = data.accounts || [];

                    // Populate manual post dropdown
                    const manualSelect = document.getElementById('manualPostThreadsAccount');
                    if (manualSelect) {
                        manualSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');
                    }

                    // Populate auto post dropdown
                    const autoSelect = document.getElementById('autoPostThreadsAccount');
                    if (autoSelect) {
                        autoSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');

                        // Auto-select previously saved account
                        const savedAccountId = autoSelect.dataset.savedValue;
                        if (savedAccountId) {
                            autoSelect.value = savedAccountId;
                            delete autoSelect.dataset.savedValue; // Clear after applying
                        }
                    }

                    // Populate UCB Threads account dropdown
                    const ucbSelect = document.getElementById('ucbThreadsAccount');
                    if (ucbSelect) {
                        ucbSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å¸³è™Ÿåˆ—è¡¨å¤±æ•—:', error);
                }
            }

            // Test UCB LINE notification
            async function testUCBLineNotification() {
                const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

                if (!lineUserId) {
                    alert('è«‹å…ˆè¼¸å…¥ LINE User ID');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/line/test-notification`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ lineUserId })
                    });

                    if (!response.ok) throw new Error('ç™¼é€å¤±æ•—');

                    alert('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE');
                } catch (error) {
                    alert('âŒ æ¸¬è©¦å¤±æ•—: ' + error.message);
                }
            }

            // Create manual post (direct publishing without AI)
            async function createManualPost(event) {
                event.preventDefault();
                showLoading(true);

                const content = document.getElementById('manualPostContent').value.trim();
                const accountId = document.getElementById('manualPostThreadsAccount').value;
                const publishTime = document.querySelector('input[name="publishTime"]:checked')?.value;
                const scheduledFor = publishTime === 'scheduled'
                    ? document.getElementById('manualPostSchedule').value
                    : null;

                // Validation
                if (!content) {
                    showAlert('dashboardAlert', 'è«‹è¼¸å…¥è²¼æ–‡å…§å®¹', 'error');
                    showLoading(false);
                    return;
                }

                if (content.length > 500) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½è¶…é 500 å­—', 'error');
                    showLoading(false);
                    return;
                }

                if (!accountId) {
                    showAlert('dashboardAlert', 'è«‹é¸æ“‡ Threads å¸³è™Ÿ', 'error');
                    showLoading(false);
                    return;
                }

                if (publishTime === 'scheduled' && !scheduledFor) {
                    showAlert('dashboardAlert', 'è«‹é¸æ“‡æ’ç¨‹æ™‚é–“', 'error');
                    showLoading(false);
                    return;
                }

                try {
                    // Create post with manual content
                    const postResponse = await fetch(`${API_BASE}/posts/manual`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            content,
                            accountId,
                            scheduledFor: scheduledFor ? new Date(scheduledFor).toISOString() : null
                        })
                    });

                    const postData = await postResponse.json();

                    if (postResponse.ok) {
                        showAlert('dashboardAlert', publishTime === 'now' ? 'âœ… è²¼æ–‡å·²åŠ å…¥ç™¼å¸ƒä½‡åˆ—ï¼' : 'âœ… è²¼æ–‡å·²æ’ç¨‹æˆåŠŸï¼', 'success');
                        document.getElementById('manualPostContent').value = '';
                        document.getElementById('contentCharCount').textContent = '0';
                        document.getElementById('manualPostThreadsAccount').value = '';
                        document.querySelector('input[name="publishTime"][value="now"]').checked = true;
                        toggleScheduleInput();
                        switchTab('posts');
                        loadPosts();
                        loadOverview();
                    } else {
                        showAlert('dashboardAlert', postData.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // ==================== SMART SCHEDULING FUNCTIONS ====================

            async function loadUCBConfig() {
                try {
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('è¼‰å…¥é…ç½®å¤±æ•—');

                    const data = await response.json();
                    const config = data.config;

                    if (config) {
                        document.getElementById('exploration-factor').value = parseFloat(config.exploration_factor) || 1.5;
                        document.getElementById('min-trials').value = parseInt(config.min_trials_per_template) || 5;
                        document.getElementById('posts-per-day').value = parseInt(config.posts_per_day) || 1;
                        document.getElementById('auto-schedule-enabled').checked = Boolean(config.auto_schedule_enabled);

                        // Load time range settings
                        if (config.time_range_start) {
                            document.getElementById('time-range-start').value = config.time_range_start;
                        }
                        if (config.time_range_end) {
                            document.getElementById('time-range-end').value = config.time_range_end;
                        }

                        // Load Threads account
                        if (config.threads_account_id) {
                            document.getElementById('ucbThreadsAccount').value = config.threads_account_id;
                        }

                        // Load LINE User ID
                        if (config.line_user_id) {
                            document.getElementById('ucbLineNotifyUserId').value = config.line_user_id;
                        }

                        // Load active days
                        const activeDays = config.active_days || [];
                        document.querySelectorAll('.active-day').forEach(checkbox => {
                            checkbox.checked = activeDays.length === 0 || activeDays.includes(parseInt(checkbox.value));
                        });
                    }
                } catch (error) {
                    console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
                }
            }

            async function saveUCBConfig(event) {
                event.preventDefault();

                const data = {
                    exploration_factor: parseFloat(document.getElementById('exploration-factor').value),
                    min_trials_per_template: parseInt(document.getElementById('min-trials').value),
                    posts_per_day: parseInt(document.getElementById('posts-per-day').value),
                    auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                    time_range_start: document.getElementById('time-range-start').value,
                    time_range_end: document.getElementById('time-range-end').value,
                    threads_account_id: document.getElementById('ucbThreadsAccount').value || null,
                    line_user_id: document.getElementById('ucbLineNotifyUserId').value || null,
                    active_days: Array.from(document.querySelectorAll('.active-day:checked')).map(cb => parseInt(cb.value))
                };

                try {
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

                    showSmartMessage('ucb-message', 'é…ç½®å·²å„²å­˜ï¼', 'success');
                } catch (error) {
                    showSmartMessage('ucb-message', 'å„²å­˜å¤±æ•—: ' + error.message, 'error');
                }
            }


            async function triggerDailySchedule() {
                // å…ˆæª¢æŸ¥å¿…è¦è¨­å®š
                const threadsAccount = document.getElementById('ucbThreadsAccount').value;
                const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

                if (!threadsAccount) {
                    alert('âŒ è«‹å…ˆé¸æ“‡ Threads å¸³è™Ÿä¸¦å„²å­˜é…ç½®');
                    return;
                }

                if (!lineUserId) {
                    alert('âŒ è«‹å…ˆè¨­å®š LINE User ID ä¸¦å„²å­˜é…ç½®');
                    return;
                }

                // å…ˆæª¢æŸ¥ AI æç¤ºè©æ˜¯å¦å·²è¨­å®š
                try {
                    const configRes = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const configData = await configRes.json();
                    const config = configData.config || {};

                    if (!config.ai_prompt || config.ai_prompt.trim() === '') {
                        alert('âŒ è«‹å…ˆåˆ°ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆæç¤ºè©');
                        return;
                    }
                } catch (e) {
                    console.error('Failed to check config:', e);
                }

                if (!confirm('ğŸ“‹ ç³»çµ±å°‡ç«‹å³ç”Ÿæˆä¸€ç¯‡æ¸¬è©¦æ–‡ç« \nğŸ’¬ ç”Ÿæˆå®Œæˆå¾Œæœƒç™¼é€ LINE é€šçŸ¥çµ¦æ‚¨å¯©æ ¸\n\nç¢ºå®šè¦ç«‹å³è§¸ç™¼å—ï¼Ÿ')) return;

                try {
                    showSmartMessage('ai-message', 'â³ æ­£åœ¨ç”Ÿæˆæ–‡ç« ...è«‹ç¨å€™', 'info');

                    const response = await fetch(`${API_BASE}/trigger-daily-schedule`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ immediate: true })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.error || 'è§¸ç™¼å¤±æ•—');
                    }

                    const data = await response.json();
                    showSmartMessage('ai-message', 'âœ… æ–‡ç« å·²å»ºç«‹ï¼è«‹ç¨å€™æŸ¥çœ‹ LINE é€šçŸ¥é€²è¡Œå¯©æ ¸', 'success');

                    // Reload schedule history
                    setTimeout(() => {
                        loadScheduleHistory();
                    }, 1000);
                } catch (error) {
                    showSmartMessage('ai-message', 'âŒ è§¸ç™¼å¤±æ•—: ' + error.message, 'error');
                }
            }

            // Schedule History functions
            async function loadScheduleHistory() {
                try {
                    const response = await fetch(`${API_BASE}/auto-schedules`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || errorData.error || 'ç„¡æ³•è¼‰å…¥æ’ç¨‹æ­·å²');
                    }

                    const data = await response.json();
                    const schedules = data.schedules || [];
                    renderScheduleHistory(schedules);
                } catch (error) {
                    console.error('Failed to load schedule history:', error);
                    document.getElementById('schedule-history-container').innerHTML =
                        `<div class="error-message">
                        <strong>ğŸ“‹ è¼‰å…¥æ’ç¨‹æ­·å²å¤±æ•—</strong><br>
                        ${error.message}<br>
                        <small style="opacity: 0.7;">è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æŸ¥çœ‹è©³ç´°éŒ¯èª¤</small>
                    </div>`;
                }
            }

            async function renderScheduleHistory(schedules) {
                const container = document.getElementById('schedule-history-container');

                if (schedules.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <h3>é‚„æ²’æœ‰æ’ç¨‹è¨˜éŒ„</h3>
                        <p>ç³»çµ±æœƒåœ¨æ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ï¼Œæˆ–é»æ“Šã€Œæ¸¬è©¦ç”Ÿæˆç™¼é€ã€é€²è¡Œæ¸¬è©¦</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = `
                <div class="schedule-list">
                    ${schedules.map(schedule => {
                    const statusMap = {
                        'PENDING': { label: 'å¾…åŸ·è¡Œ', class: 'status-pending' },
                        'GENERATED': { label: 'å¾…å¯©æ ¸', class: 'status-generated' },
                        'APPROVED': { label: 'å·²æ ¸å‡†', class: 'status-approved' },
                        'POSTED': { label: 'å·²ç™¼å¸ƒ', class: 'status-posted' },
                        'FAILED': { label: 'å¤±æ•—', class: 'status-failed' },
                        'CANCELLED': { label: 'å·²å–æ¶ˆ', class: 'status-cancelled' }
                    };
                    const status = statusMap[schedule.status] || { label: schedule.status, class: '' };

                    return `
                        <div class="schedule-item">
                            <div class="schedule-header">
                                <div class="schedule-date">ğŸ“… ${formatDate(schedule.schedule_date)}</div>
                                <span class="schedule-status ${status.class}">${status.label}</span>
                            </div>

                            <div class="schedule-info">
                                <div class="schedule-info-item">
                                    <strong>ç™¼æ–‡æ™‚é–“:</strong> ${formatDateTime(schedule.scheduled_time)}
                                </div>
                            </div>

                            ${schedule.generation_plan ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                                    ${schedule.generation_plan.moduleName ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ“¦ ${escapeHtml(schedule.generation_plan.moduleName)}</span>` : ''}
                                    ${schedule.generation_plan.angleName ? `<span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ¬ ${escapeHtml(schedule.generation_plan.angleName)}</span>` : ''}
                                    ${schedule.generation_plan.outletName ? `<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ’¡ ${escapeHtml(schedule.generation_plan.outletName)}</span>` : ''}
                                    ${schedule.generation_plan.toneBiasName ? `<span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ—£ï¸ ${escapeHtml(schedule.generation_plan.toneBiasName)}</span>` : ''}
                                    ${schedule.generation_plan.endingStyleName ? `<span style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ”š ${escapeHtml(schedule.generation_plan.endingStyleName)}</span>` : ''}
                                    ${schedule.generation_plan.lengthTarget ? `<span style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ“ ${escapeHtml(schedule.generation_plan.lengthTarget)}å­—</span>` : ''}
                                </div>
                            ` : `
                                <div style="margin-top: 10px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #6b7280;">
                                    AI è‡ªå‹•ç™¼æ–‡ï¼ˆå–®ä¸€æç¤ºè©ï¼‰
                                </div>
                            `}

                            ${schedule.selection_reason ? `
                                <div class="schedule-reason">
                                    <strong>AI æ±ºç­–åŸå› :</strong>
                                    ${escapeHtml(schedule.selection_reason)}
                                </div>
                            ` : ''}

                            ${schedule.status === 'GENERATED' ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="resendReviewNotification('${schedule.id}')" class="btn btn-secondary btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ“± é‡æ–°ç™¼é€å¯©æ ¸
                                    </button>
                                    <button onclick="manualApproveSchedule('${schedule.id}')" class="btn btn-success btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        âœ… æ‰‹å‹•æ ¸å‡†
                                    </button>
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤æ’ç¨‹
                                    </button>
                                </div>
                            ` : ''}

                            ${schedule.status === 'APPROVED' ? `
                                <div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px; color: #065f46;">
                                    âœ… å·²æ ¸å‡†ï¼Œå°‡æ–¼æ’ç¨‹æ™‚é–“è‡ªå‹•ç™¼å¸ƒ
                                </div>
                            ` : ''}

                            ${(schedule.status === 'PENDING' || schedule.status === 'FAILED') ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤æ­¤æ’ç¨‹
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
            }

            // Resend review notification function
            async function resendReviewNotification(scheduleId) {
                if (!confirm('ç¢ºå®šè¦é‡æ–°ç™¼é€ LINE å¯©æ ¸é€šçŸ¥å—ï¼Ÿ\n\nç¾æœ‰çš„å¯©æ ¸é€£çµå°‡å¤±æ•ˆã€‚')) return;

                try {
                    showSmartMessage('ucb-message', 'ğŸ“± æ­£åœ¨é‡æ–°ç™¼é€å¯©æ ¸é€šçŸ¥...', 'info');

                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/resend-review`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ç™¼é€å¤±æ•—');
                    }

                    showSmartMessage('ucb-message', data.message || 'âœ… å·²é‡æ–°ç™¼é€å¯©æ ¸é€šçŸ¥', 'success');
                } catch (error) {
                    showSmartMessage('ucb-message', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
                }
            }

            // Manual approve schedule function
            async function manualApproveSchedule(scheduleId) {
                if (!confirm('ç¢ºå®šè¦æ‰‹å‹•æ ¸å‡†æ­¤æ’ç¨‹å—ï¼Ÿ\n\næ ¸å‡†å¾Œå°‡æ–¼æ’ç¨‹æ™‚é–“è‡ªå‹•ç™¼å¸ƒåˆ° Threadsã€‚')) return;

                try {
                    showSmartMessage('ucb-message', 'â³ æ­£åœ¨æ ¸å‡†...', 'info');

                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/manual-approve`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'æ ¸å‡†å¤±æ•—');
                    }

                    showSmartMessage('ucb-message', data.message || 'âœ… å·²æ‰‹å‹•æ ¸å‡†', 'success');
                    loadScheduleHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } catch (error) {
                    showSmartMessage('ucb-message', 'âŒ æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
                }
            }

            // Helper functions
            function getEngineName(engineCode) {
                const engineNames = {
                    'GPT5_2': 'GPT-5.2',
                    'GPT5_2_INSTANT': 'GPT-5.2 Instant',
                    'GPT4O': 'GPT-4o',
                    'GEMINI_3_FLASH': 'Gemini 3 Flash',
                    'GEMINI_3_PRO_PREVIEW': 'Gemini 3 Pro',
                    'GEMINI_2_5_FLASH': 'Gemini 2.5 Flash'
                };
                return engineNames[engineCode] || engineCode;
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            }

            function formatDateTime(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function showSmartMessage(containerId, message, type) {
                const container = document.getElementById(containerId);
                const messageDiv = document.createElement('div');
                messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
                messageDiv.textContent = message;

                container.insertBefore(messageDiv, container.firstChild);

                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            // Auto refresh (åƒ…åˆ·æ–°è²¼æ–‡åˆ—è¡¨å’Œå¸³è™Ÿåˆ—è¡¨ï¼Œçµ±è¨ˆåœ–è¡¨ä¸è‡ªå‹•åˆ·æ–°ä»¥ç¯€çœè³‡æº)
            setInterval(() => {
                if (token && document.getElementById('dashboard').classList.contains('active')) {
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'overviewTab') {
                        loadOverview(); // åªåˆ·æ–°ç¸½è¦½æ•¸å­—ï¼Œä¸åˆ·æ–°çµ±è¨ˆåœ–è¡¨
                    }
                    if (activeTab.id === 'postsTab') loadPosts();
                    if (activeTab.id === 'accountsTab') loadThreadsAccountsList();
                }
            }, 60000); // æ”¹ç‚ºæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡

            // ========== STATISTICS FUNCTIONS ==========

            let stats7DayChartInstance = null;

            // Switch between statistics sub-tabs
            function switchStatsTab(tabName) {
                // Remove active class from all stats sub-tabs
                document.querySelectorAll('.stats-sub-tab').forEach(tab => {
                    tab.style.background = '#e5e7eb';
                    tab.style.color = '#333';
                    tab.classList.remove('active');
                });

                // Hide all stats sub-content
                document.querySelectorAll('.stats-sub-content').forEach(content => {
                    content.style.display = 'none';
                });

                // Activate selected tab
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';
                event.target.classList.add('active');

                // Show selected content
                const contentMap = {
                    'summary': 'statsSummaryTab',
                    'templates': 'statsTemplatesTab',
                    'timeslots': 'statsTimeslotsTab',
                    'details': 'statsDetailsTab'
                };

                const contentId = contentMap[tabName];
                if (contentId) {
                    document.getElementById(contentId).style.display = 'block';
                }

                // Load data for the selected tab
                if (tabName === 'summary') {
                    loadStatsSummary();
                } else if (tabName === 'templates') {
                    loadStatsTemplates();
                } else if (tabName === 'timeslots') {
                    loadStatsTimeslots();
                } else if (tabName === 'details') {
                    loadStatsDetails();
                }
            }

            // Load statistics summary
            async function loadStatsSummary() {
                try {
                    // Get selected days from both dropdowns
                    const trendDaysSelect = document.getElementById('trendDaysSelect');
                    const summaryDaysSelect = document.getElementById('summaryDaysSelect');

                    // è¶¨å‹¢åœ–ä½¿ç”¨ trendDaysSelectï¼Œæ•´é«”è¡¨ç¾ä½¿ç”¨ summaryDaysSelect
                    const trendDays = trendDaysSelect ? trendDaysSelect.value : '7';
                    const summaryDays = summaryDaysSelect ? summaryDaysSelect.value : '7';

                    // å¦‚æœé¸æ“‡ã€Œå…¨éƒ¨æ­·å²ã€ï¼Œä½¿ç”¨ 3650 å¤©ï¼ˆç´„ 10 å¹´ï¼‰
                    const summaryDaysNum = summaryDays === 'all' ? 3650 : summaryDays;

                    // Fetch overview statistics from API
                    const [overviewRes, syncStatusRes, trendRes] = await Promise.all([
                        fetch(`${API_BASE}/statistics/overview?days=${summaryDaysNum}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        fetch(`${API_BASE}/statistics/sync-status`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        // è¶¨å‹¢åœ–ä½¿ç”¨ç¨ç«‹çš„å¤©æ•¸
                        fetch(`${API_BASE}/statistics/overview?days=${trendDays}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);

                    const overviewData = await overviewRes.json();
                    const syncData = await syncStatusRes.json();
                    const trendData = await trendRes.json();

                    if (!overviewData.success) {
                        throw new Error(overviewData.error || 'Failed to load overview');
                    }

                    const overview = overviewData.data?.overview || {};
                    // è¶¨å‹¢åœ–è³‡æ–™å¾ç¨ç«‹çš„ API å›æ‡‰å–å¾—
                    const trend = trendData.data?.trend || { dates: [], views: [], engagement: [] };

                    const avgEngagement = parseFloat(overview.avg_engagement_rate) || 0;

                    const data = {
                        total_posts: overview.total_posts || 0,
                        total_views: overview.total_views || 0,
                        total_likes: overview.total_likes || 0,
                        avg_engagement_rate: avgEngagement.toFixed(1),
                        last_sync: syncData.success && syncData.data?.last_synced_at
                            ? new Date(syncData.data.last_synced_at).toLocaleString('zh-TW')
                            : 'å°šæœªåŒæ­¥',
                        trend_data: {
                            dates: (trend.dates || []).map(d => d ? d.substring(5).replace('-', '/') : ''),
                            views: trend.views || [],
                            engagement: (trend.engagement || []).map(e => parseFloat((parseFloat(e) || 0).toFixed(1)))
                        }
                    };

                    // Update summary metrics
                    document.getElementById('statsTotalPosts').textContent = data.total_posts;
                    document.getElementById('statsTotalViews').textContent = data.total_views.toLocaleString();
                    document.getElementById('statsTotalLikes').textContent = data.total_likes.toLocaleString();
                    document.getElementById('statsAvgEngagement').textContent = data.avg_engagement_rate + '%';
                    document.getElementById('statsLastSync').textContent = data.last_sync;

                    // Update synced count
                    const syncedCountEl = document.getElementById('statsSyncedCount');
                    if (syncedCountEl && syncData.success) {
                        syncedCountEl.textContent = syncData.data?.synced_count || 0;
                    }

                    // Update 7-day trend chart
                    const ctx = document.getElementById('stats7DayChart');
                    if (ctx) {
                        // Destroy existing chart if it exists
                        if (stats7DayChartInstance) {
                            stats7DayChartInstance.destroy();
                        }

                        stats7DayChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.trend_data.dates,
                                datasets: [
                                    {
                                        label: 'è§€çœ‹æ•¸',
                                        data: data.trend_data.views,
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'åƒèˆ‡ç‡ (%)',
                                        data: data.trend_data.engagement,
                                        borderColor: '#764ba2',
                                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            font: { size: 11 },
                                            padding: 10
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        position: 'left',
                                        title: { display: true, text: 'è§€çœ‹æ•¸', font: { size: 10 } },
                                        ticks: { font: { size: 10 } }
                                    },
                                    y1: {
                                        type: 'linear',
                                        position: 'right',
                                        title: { display: true, text: 'åƒèˆ‡ç‡ (%)', font: { size: 10 } },
                                        ticks: { font: { size: 10 } },
                                        grid: { drawOnChartArea: false }
                                    }
                                }
                            }
                        });
                    }

                    // Load analytics data (ä½¿ç”¨åˆ†æå€å¡Šçš„æ™‚é–“é¸æ“‡å™¨)
                    const analyticsDays = parseInt(document.getElementById('analyticsDaysSelect')?.value || '30');
                    await loadAnalyticsData(analyticsDays);

                } catch (error) {
                    console.error('Failed to load statistics summary:', error);
                    showAlert('dashboardAlert', 'çµ±è¨ˆæ•¸æ“šè¼‰å…¥å¤±æ•—', 'danger');
                }
            }

            // Handle analytics time range change
            function onAnalyticsDaysChange() {
                const days = parseInt(document.getElementById('analyticsDaysSelect').value);
                loadAnalyticsData(days);
            }

            // Load and render analytics data
            async function loadAnalyticsData(days) {
                const containers = ['bestHoursChart', 'bestDaysChart', 'topPostsList', 'contentLengthAnalysis'];

                try {
                    const response = await fetch(`${API_BASE}/statistics/analytics?days=${days}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Analytics API error:', response.status, errorText);
                        containers.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">è¼‰å…¥å¤±æ•— (${response.status})</p>`;
                        });
                        return;
                    }

                    const result = await response.json();
                    if (!result.success) {
                        console.error('Analytics API returned error:', result.error);
                        containers.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">${result.error || 'è¼‰å…¥å¤±æ•—'}</p>`;
                        });
                        return;
                    }

                    const { hourlyAnalysis, dayAnalysis, topPosts, contentAnalysis } = result.data;

                    // Render best hours chart
                    renderBestHoursChart(hourlyAnalysis);

                    // Render best days chart
                    renderBestDaysChart(dayAnalysis);

                    // Render top posts
                    renderTopPosts(topPosts);

                    // Render content length analysis
                    renderContentLengthAnalysis(contentAnalysis);

                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    containers.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                    });
                }
            }

            // Render best hours chart
            function renderBestHoursChart(data) {
                const container = document.getElementById('bestHoursChart');
                if (!container) return;

                if (!data.hours || data.hours.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                    return;
                }

                // Find top 5 hours by engagement
                const sortedHours = [...data.hours].filter(h => h.posts >= 1).sort((a, b) => b.avgEngagement - a.avgEngagement).slice(0, 5);

                if (sortedHours.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                    return;
                }

                const maxEngagement = Math.max(...sortedHours.map(h => h.avgEngagement));

                container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ğŸ† æœ€ä½³æ™‚æ®µ: <strong style="color: #059669;">${data.bestHour}:00</strong>
                </div>
                ${sortedHours.map(h => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 50px; font-size: 11px; color: #666;">${h.hour}:00</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${(h.avgEngagement / maxEngagement * 100).toFixed(0)}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 60px; text-align: right; font-size: 10px; color: #666;">${h.avgEngagement.toFixed(1)}%</div>
                    </div>
                `).join('')}
                <div style="font-size: 10px; color: #999; margin-top: 8px;">ä¾åƒèˆ‡ç‡æ’åºï¼Œæœ€å°‘ 1 ç¯‡è²¼æ–‡</div>
            `;
            }

            // Render best days chart
            function renderBestDaysChart(data) {
                const container = document.getElementById('bestDaysChart');
                if (!container) return;

                if (!data.days || data.days.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                    return;
                }

                const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                const maxEngagement = Math.max(...data.days.map(d => d.avgEngagement));

                container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ğŸ† æœ€ä½³æ˜ŸæœŸ: <strong style="color: #059669;">${dayNames[data.bestDay]}</strong>
                </div>
                ${data.days.map(d => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 40px; font-size: 11px; color: #666;">${dayNames[d.day]}</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${maxEngagement > 0 ? (d.avgEngagement / maxEngagement * 100).toFixed(0) : 0}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 50px; text-align: right; font-size: 10px; color: #666;">${d.avgEngagement.toFixed(1)}%</div>
                        <div style="width: 40px; text-align: right; font-size: 9px; color: #999;">(${d.posts}ç¯‡)</div>
                    </div>
                `).join('')}
            `;
            }

            // Render top posts
            function renderTopPosts(posts) {
                const container = document.getElementById('topPostsList');
                if (!container) return;

                if (!posts || posts.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                    return;
                }

                container.innerHTML = posts.map((post, index) => `
                <div style="display: flex; align-items: flex-start; padding: 10px; background: ${index === 0 ? '#fef3c7' : '#f9fafb'}; border-radius: 6px; margin-bottom: 8px; gap: 10px;">
                    <div style="width: 24px; height: 24px; background: ${index === 0 ? '#f59e0b' : '#9ca3af'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 12px; color: #333; line-height: 1.4; word-break: break-word;">
                            ${escapeHtml(post.content || '(ç„¡å…§å®¹)')}
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: #666;">
                            <span>ğŸ‘ï¸ ${post.views.toLocaleString()}</span>
                            <span>â¤ï¸ ${post.likes}</span>
                            <span>ğŸ’¬ ${post.replies}</span>
                            <span style="color: #059669; font-weight: bold;">ğŸ“Š ${post.engagementRate.toFixed(2)}%</span>
                        </div>
                    </div>
                    ${post.postUrl ? `<a href="${post.postUrl}" target="_blank" style="color: #667eea; font-size: 10px; text-decoration: none;">æŸ¥çœ‹ â†—</a>` : ''}
                </div>
            `).join('');
            }

            // Render content length analysis
            function renderContentLengthAnalysis(data) {
                const container = document.getElementById('contentLengthAnalysis');
                if (!container) return;

                if (!data || (data.short.count === 0 && data.medium.count === 0 && data.long.count === 0)) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                    return;
                }

                const categories = [
                    { name: 'çŸ­æ–‡', label: '< 100 å­—', ...data.short, color: '#3b82f6' },
                    { name: 'ä¸­ç­‰', label: '100-300 å­—', ...data.medium, color: '#8b5cf6' },
                    { name: 'é•·æ–‡', label: '> 300 å­—', ...data.long, color: '#ec4899' },
                ];

                const totalPosts = categories.reduce((sum, c) => sum + c.count, 0);

                container.innerHTML = `
                <div style="font-size: 10px; color: #666; margin-bottom: 8px; text-align: center;">
                    ğŸ“Š åˆ†æ ${totalPosts} ç¯‡è²¼æ–‡çš„<strong>å¹³å‡åƒèˆ‡ç‡</strong>ï¼ˆéåˆ†ä½ˆæ¯”ä¾‹ï¼‰
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                    ${categories.map(c => `
                        <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">${c.name} ${c.label}</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${c.color};">${c.avgEngagement.toFixed(1)}%</div>
                            <div style="font-size: 9px; color: #999;">å¹³å‡åƒèˆ‡ç‡</div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${c.count} ç¯‡</div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 8px 12px; background: #ecfdf5; border-radius: 6px; font-size: 11px; color: #065f46;">
                    ğŸ’¡ ${data.recommendation}
                </div>
            `
            }

            // Sync Threads posts from account
            async function syncThreadsPosts(fetchAll = false) {
                const message = fetchAll
                    ? 'æ­¤æ“ä½œå°‡å¾æ‚¨çš„ Threads å¸³è™ŸåŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ã€‚\n\né€™å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œç¹¼çºŒå—ï¼Ÿ'
                    : 'æ­¤æ“ä½œå°‡å¾æ‚¨çš„ Threads å¸³è™ŸåŒ¯å…¥æœ€è¿‘ 50 ç¯‡è²¼æ–‡åŠå…¶äº’å‹•æ•¸æ“šã€‚\n\nç¹¼çºŒå—ï¼Ÿ';

                if (!confirm(message)) {
                    return;
                }

                try {
                    const loadingMessage = fetchAll
                        ? 'æ­£åœ¨å®Œæ•´åŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ï¼Œé€™å¯èƒ½éœ€è¦æ•¸åˆ†é˜ï¼Œè«‹ç¨å€™...'
                        : 'æ­£åœ¨å¾ Threads åŒ¯å…¥æ­·å²è²¼æ–‡ï¼Œè«‹ç¨å€™...';
                    showAlert('dashboardAlert', loadingMessage, 'info');

                    const response = await fetch(`${API_BASE}/statistics/sync-threads-posts`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ limit: 50, fetchAll: fetchAll })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadStatsSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                    loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
                } catch (error) {
                    console.error('Failed to sync Threads posts:', error);
                    showAlert('dashboardAlert', 'åŒ¯å…¥å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Clear all pending review posts
            async function clearPendingPosts() {
                if (!confirm('æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰å¾…å¯©æ ¸ã€è‰ç¨¿ç‹€æ…‹çš„è²¼æ–‡ã€‚\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'æ­£åœ¨æ¸…é™¤å¾…å¯©æ ¸è²¼æ–‡...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/clear-pending`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'æ¸…é™¤å¤±æ•—');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
                } catch (error) {
                    console.error('Failed to clear pending posts:', error);
                    showAlert('dashboardAlert', 'æ¸…é™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Clear all scheduled (APPROVED) posts
            async function clearScheduledPosts() {
                if (!confirm('æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰æ’ç¨‹ä¸­ï¼ˆå·²å¯©æ ¸å¾…ç™¼å¸ƒï¼‰çš„è²¼æ–‡ã€‚\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'æ­£åœ¨æ¸…é™¤æ’ç¨‹ä¸­è²¼æ–‡...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/clear-scheduled`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'æ¸…é™¤å¤±æ•—');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
                } catch (error) {
                    console.error('Failed to clear scheduled posts:', error);
                    showAlert('dashboardAlert', 'æ¸…é™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Reclassify templates for posts without template
            async function reclassifyTemplates() {
                if (!confirm('æ­¤æ“ä½œå°‡ç‚ºæ‰€æœ‰æ²’æœ‰æ¨¡æ¿åˆ†é¡çš„è²¼æ–‡è‡ªå‹•åˆ†é¡ã€‚\n\nç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'æ­£åœ¨é‡æ–°åˆ†é¡è²¼æ–‡æ¨¡æ¿...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/reclassify-templates`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'åˆ†é¡å¤±æ•—');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadStatsSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                    loadStatsTemplates(); // é‡æ–°è¼‰å…¥æ¨¡æ¿çµ±è¨ˆ
                } catch (error) {
                    console.error('Failed to reclassify templates:', error);
                    showAlert('dashboardAlert', 'é‡æ–°åˆ†é¡å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Load pending posts (æ’ç¨‹ä¸­è²¼æ–‡) - æŸ¥è©¢ UCB æ’ç¨‹ä¸­çš„å·²æ ¸å‡†è²¼æ–‡
            async function loadPendingPosts() {
                const container = document.getElementById('pendingPostsList');
                if (!container) return;

                try {
                    container.innerHTML = '<p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>';

                    // æŸ¥è©¢ UCB è‡ªå‹•æ’ç¨‹ï¼ˆå·²æ ¸å‡†ç‹€æ…‹ï¼‰
                    const response = await fetch(`${API_BASE}/auto-schedules`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
                    }

                    // éæ¿¾å‡ºå·²æ ¸å‡†çš„æ’ç¨‹ï¼ˆstatus = APPROVED æˆ– GENERATED ä¸”æœªåŸ·è¡Œï¼‰
                    const schedules = (data.schedules || []).filter(s =>
                        s.status === 'APPROVED' || s.status === 'GENERATED'
                    );

                    if (schedules.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</p>
                            <p>ç›®å‰æ²’æœ‰æ’ç¨‹ä¸­çš„è²¼æ–‡</p>
                        </div>`;
                        return;
                    }

                    // å­˜å„²æ’ç¨‹è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨
                    window.pendingSchedulesData = {};
                    window.pendingSchedulesMeta = {};

                    container.innerHTML = schedules.map(schedule => {
                        const scheduledTime = schedule.scheduled_time
                            ? new Date(schedule.scheduled_time).toLocaleString('zh-TW')
                            : 'æœªè¨­å®š';
                        const templateName = schedule.template_name || 'æœªçŸ¥æ¨¡æ¿';
                        const statusText = schedule.status === 'APPROVED' ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸';
                        const statusColor = schedule.status === 'APPROVED' ? '#10b981' : '#f59e0b';

                        // å–å¾—è²¼æ–‡å…§å®¹
                        const postContent = schedule.revision_content || schedule.post_content || '';
                        const preview = postContent.length > 150 ? postContent.substring(0, 150) + '...' : postContent;

                        // å­˜å„²å®Œæ•´å…§å®¹ä¾›ç·¨è¼¯ä½¿ç”¨
                        if (schedule.post_id) {
                            window.pendingSchedulesData[schedule.post_id] = postContent;
                            window.pendingSchedulesMeta[schedule.post_id] = {
                                scheduleId: schedule.id,
                                scheduledTime: schedule.scheduled_time
                            };
                        }

                        return `
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <span style="background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${statusText}</span>
                                    <span style="margin-left: 10px; color: #666; font-size: 13px;">â° é å®šç™¼å¸ƒï¼š${scheduledTime}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${schedule.post_id ? `
                                    <button onclick="editPendingPost('${schedule.post_id}')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        âœï¸ ç·¨è¼¯
                                    </button>
                                    ` : ''}
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" 
                                        style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            </div>
                            ${postContent ? `
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                                ${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: #666;">
                                <div>ğŸ“ æ¨¡æ¿ï¼š<strong>${templateName}</strong></div>
                                <div>ğŸ“… æ’ç¨‹æ—¥æœŸï¼š<strong>${schedule.schedule_date ? new Date(schedule.schedule_date).toLocaleDateString('zh-TW') : 'æœªçŸ¥'}</strong></div>
                            </div>
                            ${schedule.selection_reason ? `
                            <div style="background: #f3e8ff; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px; color: #7c3aed;">
                                ğŸ¤– ${schedule.selection_reason}
                            </div>
                            ` : ''}
                        </div>`;
                    }).join('');

                } catch (error) {
                    console.error('Failed to load pending posts:', error);
                    container.innerHTML = `<p style="text-align: center; color: #ef4444;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
                }
            }

            // Delete auto schedule
            async function deleteAutoSchedule(scheduleId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ’ç¨‹å—ï¼Ÿ')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                    }

                    showAlert('dashboardAlert', 'æ’ç¨‹å·²åˆªé™¤', 'success');
                    loadPendingPosts();
                    loadScheduleHistory(); // æ›´æ–°æ’ç¨‹æ­·å²
                } catch (error) {
                    console.error('Failed to delete auto schedule:', error);
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Edit pending post - ä½¿ç”¨ Modal å°è©±æ¡†
            async function editPendingPost(postId) {
                console.log('[Edit] editPendingPost called with postId:', postId);
                try {
                    // å„ªå…ˆä½¿ç”¨å·²å­˜å„²çš„å…§å®¹
                    let content = window.pendingSchedulesData?.[postId] || '';
                    console.log('[Edit] Content from pendingSchedulesData:', content ? `${content.length} chars` : 'empty');

                    // å¦‚æœæ²’æœ‰å­˜å„²çš„å…§å®¹ï¼Œå¾ API å–å¾— revision å…§å®¹
                    if (!content) {
                        console.log('[Edit] Fetching from API...');
                        const response = await fetch(`${API_BASE}/posts/${postId}/revisions`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            // å–æœ€æ–° revision çš„ content
                            if (data.revisions && data.revisions.length > 0) {
                                content = data.revisions[0].content || '';
                            }
                        }

                        // å†è©¦ posts API
                        if (!content) {
                            const response2 = await fetch(`${API_BASE}/posts/${postId}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const data2 = await response2.json();
                            if (response2.ok) {
                                const post = data2.post || data2;
                                content = post.content || post.generated_content || '';
                            }
                        }
                    }

                    if (!content) {
                        alert('æ‰¾ä¸åˆ°è²¼æ–‡å…§å®¹');
                        return;
                    }

                    // å–å¾—æ’ç¨‹æ™‚é–“è³‡æ–™
                    const meta = window.pendingSchedulesMeta?.[postId] || {};

                    // æ‰“é–‹ç·¨è¼¯ Modal
                    console.log('[Edit] Opening modal with content:', content.length, 'chars');
                    openEditPostModal(postId, content, meta.scheduledTime, meta.scheduleId);
                } catch (error) {
                    console.error('[Edit] Failed to load post for editing:', error);
                    alert('è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message);
                }
            }

            // æ‰“é–‹ç·¨è¼¯è²¼æ–‡ Modal
            function openEditPostModal(postId, content, scheduledTime, scheduleId) {
                const modal = document.getElementById('editPostModal');
                const idInput = document.getElementById('editPostId');
                const textarea = document.getElementById('editPostContent');
                const charCount = document.getElementById('editPostCharCount');
                const scheduleTimeInput = document.getElementById('editPostScheduleTime');
                const scheduleIdInput = document.getElementById('editPostScheduleId');

                if (!modal || !idInput || !textarea) {
                    console.error('[Edit] Modal elements not found!');
                    alert('ç·¨è¼¯è¦–çª—å…ƒç´ ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    return;
                }

                idInput.value = postId;
                textarea.value = content;
                if (charCount) charCount.textContent = content.length;

                // è¨­å®šç™¼æ–‡æ™‚é–“
                if (scheduleTimeInput && scheduledTime) {
                    const dt = new Date(scheduledTime);
                    // è½‰æ›ç‚º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
                    const pad = n => String(n).padStart(2, '0');
                    scheduleTimeInput.value = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
                } else if (scheduleTimeInput) {
                    scheduleTimeInput.value = '';
                }
                if (scheduleIdInput) scheduleIdInput.value = scheduleId || '';

                // ç§»åˆ° body å±¤ç´šç¢ºä¿ä¸è¢«çˆ¶å®¹å™¨é®æ“‹
                document.body.appendChild(modal);
                modal.style.cssText = 'display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99999; align-items:center; justify-content:center;';

                // ç›£è½è¼¸å…¥æ›´æ–°å­—æ•¸
                textarea.oninput = function () {
                    if (charCount) charCount.textContent = this.value.length;
                };

                // èšç„¦åˆ°æ–‡å­—å€åŸŸ
                setTimeout(() => textarea.focus(), 100);
                console.log('[Edit] Modal opened and moved to body');
            }

            // é—œé–‰ç·¨è¼¯è²¼æ–‡ Modal
            function closeEditPostModal() {
                const modal = document.getElementById('editPostModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                const idInput = document.getElementById('editPostId');
                const textarea = document.getElementById('editPostContent');
                const scheduleTimeInput = document.getElementById('editPostScheduleTime');
                const scheduleIdInput = document.getElementById('editPostScheduleId');
                if (idInput) idInput.value = '';
                if (textarea) textarea.value = '';
                if (scheduleTimeInput) scheduleTimeInput.value = '';
                if (scheduleIdInput) scheduleIdInput.value = '';
            }

            // å„²å­˜ç·¨è¼¯çš„è²¼æ–‡
            async function saveEditedPost(event) {
                event.preventDefault();

                const postId = document.getElementById('editPostId').value;
                const newContent = document.getElementById('editPostContent').value;
                const scheduleTimeValue = document.getElementById('editPostScheduleTime')?.value || '';
                const scheduleId = document.getElementById('editPostScheduleId')?.value || '';

                if (!postId || !newContent.trim()) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½ç‚ºç©º', 'danger');
                    return;
                }

                try {
                    const body = { content: newContent };
                    if (scheduleTimeValue) {
                        body.scheduled_time = new Date(scheduleTimeValue).toISOString();
                        body.schedule_id = scheduleId;
                    }

                    const updateResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (!updateResponse.ok) {
                        const updateData = await updateResponse.json();
                        throw new Error(updateData.error || 'æ›´æ–°å¤±æ•—');
                    }

                    closeEditPostModal();
                    showAlert('dashboardAlert', 'âœ… è²¼æ–‡å·²æ›´æ–°ï¼Œå°‡æœƒåœ¨æ’ç¨‹æ™‚é–“ç™¼å¸ƒåˆ° Threads', 'success');
                    loadPendingPosts();
                } catch (error) {
                    console.error('Failed to save edited post:', error);
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // Delete pending post
            async function deletePendingPost(postId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ’ç¨‹ä¸­çš„è²¼æ–‡å—ï¼Ÿ')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                    }

                    showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                    loadPendingPosts();
                    loadOverview(); // æ›´æ–°ç¸½è¦½æ•¸å­—
                } catch (error) {
                    console.error('Failed to delete pending post:', error);
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // ========== AI ç™¼æ–‡é…ç½®ç›¸é—œå‡½æ•¸ ==========

            // è¼‰å…¥ AI ç™¼æ–‡é…ç½®
            async function loadAIConfig() {
                try {
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const data = await response.json();
                    const config = data.config || {};

                    // è¨­å®šè¡¨å–®å€¼
                    document.getElementById('posts-per-day').value = config.posts_per_day || 1;
                    document.getElementById('time-range-start').value = config.time_range_start || '09:00';
                    document.getElementById('time-range-end').value = config.time_range_end || '21:00';
                    document.getElementById('auto-schedule-enabled').checked = config.auto_schedule_enabled !== false;

                    // è¨­å®šå•Ÿç”¨æ˜ŸæœŸ
                    const activeDays = config.active_days || [1, 2, 3, 4, 5, 6, 7];
                    document.querySelectorAll('.active-day').forEach(checkbox => {
                        checkbox.checked = activeDays.includes(parseInt(checkbox.value));
                    });
                } catch (error) {
                    console.error('Failed to load AI config:', error);
                }
            }

            // å„²å­˜ AI ç™¼æ–‡é…ç½®
            async function saveAIConfig(event) {
                event.preventDefault();

                try {
                    showLoading(true);

                    const activeDays = [];
                    document.querySelectorAll('.active-day:checked').forEach(checkbox => {
                        activeDays.push(parseInt(checkbox.value));
                    });

                    const config = {
                        posts_per_day: parseInt(document.getElementById('posts-per-day').value) || 1,
                        time_range_start: document.getElementById('time-range-start').value || '09:00',
                        time_range_end: document.getElementById('time-range-end').value || '21:00',
                        auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                        active_days: activeDays
                    };

                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', 'âœ… AI ç™¼æ–‡è¨­å®šå·²å„²å­˜', 'success');
                    } else {
                        throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                    }
                } catch (error) {
                    console.error('Failed to save AI config:', error);
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // è¼‰å…¥ AI æç¤ºè©è¨­å®š
            async function loadAIPrompt() {
                try {
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const data = await response.json();
                    const config = data.config || {};

                    // è¨­å®šæç¤ºè©å’Œå¼•æ“
                    document.getElementById('ai-prompt').value = config.ai_prompt || '';
                    document.getElementById('ai-engine').value = config.ai_engine || 'GPT5_2';
                } catch (error) {
                    console.error('Failed to load AI prompt:', error);
                }
            }

            // å„²å­˜ AI æç¤ºè©è¨­å®š
            async function saveAIPrompt(event) {
                event.preventDefault();

                try {
                    showLoading(true);

                    const aiPrompt = document.getElementById('ai-prompt').value;
                    const aiEngine = document.getElementById('ai-engine').value;

                    if (!aiPrompt.trim()) {
                        showAlert('dashboardAlert', 'è«‹è¼¸å…¥ AI æç¤ºè©', 'danger');
                        return;
                    }

                    // å…ˆå–å¾—ç¾æœ‰é…ç½®
                    const configResponse = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    let currentConfig = {};
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        currentConfig = configData.config || {};
                    }

                    // æ›´æ–°é…ç½®
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...currentConfig,
                            ai_prompt: aiPrompt,
                            ai_engine: aiEngine
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', 'âœ… æç¤ºè©è¨­å®šå·²å„²å­˜', 'success');
                    } else {
                        throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                    }
                } catch (error) {
                    console.error('Failed to save AI prompt:', error);
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // æ¸¬è©¦ AI æç¤ºè©ç”Ÿæˆ
            async function testAIPrompt() {
                const prompt = document.getElementById('ai-prompt').value;
                const engine = document.getElementById('ai-engine').value;

                if (!prompt.trim()) {
                    showAlert('dashboardAlert', 'è«‹å…ˆè¼¸å…¥ AI æç¤ºè©', 'danger');
                    return;
                }

                const resultContainer = document.getElementById('ai-prompt-test-result');
                const contentDiv = document.getElementById('ai-prompt-test-content');

                resultContainer.style.display = 'block';
                contentDiv.innerHTML = '<div style="text-align: center; padding: 30px;"><div class="spinner"></div><p style="margin-top: 15px; color: #666;">AI æ­£åœ¨ç”Ÿæˆå…§å®¹...</p></div>';

                try {
                    const response = await fetch(`${API_BASE}/generate/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            engine: engine
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'ç”Ÿæˆå¤±æ•—');
                    }

                    const data = await response.json();

                    contentDiv.innerHTML = `
                    <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                        <strong>ä½¿ç”¨å¼•æ“ï¼š</strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
                } catch (error) {
                    contentDiv.innerHTML = `<div style="color: #ef4444;">ç”Ÿæˆå¤±æ•—: ${error.message}</div>`;
                }
            }

            // è¼‰å…¥æç¤ºè©è¨­å®šé é¢
            function loadTemplates() {
                loadAIPrompt();
                loadDimensions();
                loadDimensionStats();
            }

            // ========================================
            // ç¶­åº¦è¨­å®šç›¸é—œå‡½æ•¸
            // ========================================

            let dimensionsData = {};
            const dimensionExpanded = {
                module: true,
                angle: false,
                outlet: false,
                tone_bias: false,
                ending_style: false,
                length_target: false
            };

            // è¼‰å…¥æ‰€æœ‰ç¶­åº¦è¨­å®š
            async function loadDimensions() {
                try {
                    const response = await fetch(`${API_BASE}/dimensions`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('è¼‰å…¥å¤±æ•—');
                    }

                    const result = await response.json();
                    if (result.success) {
                        dimensionsData = result.data;
                        renderAllDimensions();
                    }
                } catch (error) {
                    console.error('Failed to load dimensions:', error);
                    document.querySelectorAll('.dimension-options').forEach(el => {
                        el.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
                    });
                }
            }

            // è¼‰å…¥ç¶­åº¦ä½¿ç”¨çµ±è¨ˆ
            async function loadDimensionStats() {
                try {
                    const response = await fetch(`${API_BASE}/generation/stats`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const result = await response.json();
                    if (result.success) {
                        renderDimensionStats(result.data);
                    }
                } catch (error) {
                    console.error('Failed to load dimension stats:', error);
                }
            }

            // æ¸²æŸ“æ‰€æœ‰ç¶­åº¦
            function renderAllDimensions() {
                const dimensions = ['module', 'angle', 'outlet', 'tone_bias', 'ending_style', 'length_target'];
                dimensions.forEach(dim => renderDimensionOptions(dim));
            }

            // æ¸²æŸ“å–®ä¸€ç¶­åº¦çš„é¸é …
            function renderDimensionOptions(dimension) {
                const container = document.getElementById(`${dimension}-options`);
                if (!container) return;

                const options = dimensionsData[dimension] || [];

                if (options.length === 0) {
                    container.innerHTML = '<p style="color: #999; font-size: 13px;">å°šç„¡é¸é …</p>';
                    return;
                }

                let html = '';
                options.forEach(opt => {
                    const weightPercent = Math.round(opt.weight * 100);
                    const activeClass = opt.isActive ? '' : 'opacity: 0.5;';

                    html += `
                    <div class="dimension-option" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; ${activeClass}">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${escapeHtml(opt.name)}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${escapeHtml(opt.code)}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="100" value="${weightPercent}" 
                                onchange="updateDimensionWeight('${opt.id}', this.value)"
                                style="width: 60px; cursor: pointer;">
                            <span style="font-size: 12px; width: 35px; text-align: right;">${weightPercent}%</span>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${opt.isActive ? 'checked' : ''} 
                                    onchange="toggleDimensionActive('${opt.id}', this.checked)"
                                    style="margin: 0;">
                            </label>
                        </div>
                    </div>
                `;
                });

                html += `
                <div style="padding: 10px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showAddDimensionModal('${dimension}')" 
                        style="font-size: 12px; padding: 6px 12px;">
                        â• æ–°å¢é¸é …
                    </button>
                </div>
            `;

                container.innerHTML = html;
            }

            // åˆ‡æ›ç¶­åº¦å±•é–‹/æ”¶åˆ
            function toggleDimension(dimension) {
                dimensionExpanded[dimension] = !dimensionExpanded[dimension];

                const optionsEl = document.getElementById(`${dimension}-options`);
                const toggleEl = document.getElementById(`${dimension}-toggle`);

                if (optionsEl) {
                    optionsEl.style.display = dimensionExpanded[dimension] ? 'block' : 'none';
                }
                if (toggleEl) {
                    toggleEl.textContent = dimensionExpanded[dimension] ? 'â–¼' : 'â–¶';
                }
            }

            // æ›´æ–°ç¶­åº¦æ¬Šé‡
            async function updateDimensionWeight(id, value) {
                try {
                    const weight = parseFloat(value) / 100;

                    const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ weight })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±æ•—');
                    }
                } catch (error) {
                    console.error('Failed to update dimension weight:', error);
                    showAlert('dashboardAlert', 'æ¬Šé‡æ›´æ–°å¤±æ•—', 'danger');
                }
            }

            // åˆ‡æ›ç¶­åº¦å•Ÿç”¨ç‹€æ…‹
            async function toggleDimensionActive(id, isActive) {
                try {
                    const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isActive })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±æ•—');
                    }

                    // é‡æ–°è¼‰å…¥ç¶­åº¦
                    loadDimensions();
                } catch (error) {
                    console.error('Failed to toggle dimension active:', error);
                    showAlert('dashboardAlert', 'ç‹€æ…‹æ›´æ–°å¤±æ•—', 'danger');
                }
            }

            // é¡¯ç¤ºæ–°å¢ç¶­åº¦é¸é …çš„å°è©±æ¡†
            function showAddDimensionModal(dimensionType) {
                const dimensionNames = {
                    module: 'å…§å®¹æ¨¡çµ„',
                    angle: 'æƒ…å¢ƒåˆ‡è§’',
                    outlet: 'è™•ç†å‡ºå£',
                    tone_bias: 'èªæ°£åå£“',
                    ending_style: 'æ”¶å°¾æ„åœ–',
                    length_target: 'å­—æ•¸ç›®æ¨™'
                };

                const code = prompt(`è«‹è¼¸å…¥æ–°ã€${dimensionNames[dimensionType]}ã€‘é¸é …çš„ä»£ç¢¼ï¼ˆè‹±æ–‡ï¼Œä¾‹å¦‚ï¼šnew_optionï¼‰ï¼š`);
                if (!code) return;

                const name = prompt('è«‹è¼¸å…¥é¸é …çš„ä¸­æ–‡åç¨±ï¼š');
                if (!name) return;

                addDimensionOption(dimensionType, code, name);
            }

            // æ–°å¢ç¶­åº¦é¸é …
            async function addDimensionOption(dimensionType, code, name) {
                try {
                    const response = await fetch(`${API_BASE}/dimensions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            dimensionType,
                            code,
                            name,
                            weight: 0.10
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'æ–°å¢å¤±æ•—');
                    }

                    showAlert('dashboardAlert', 'âœ… é¸é …å·²æ–°å¢', 'success');
                    loadDimensions();
                } catch (error) {
                    console.error('Failed to add dimension option:', error);
                    showAlert('dashboardAlert', 'æ–°å¢å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // æ¸²æŸ“çµ±è¨ˆè³‡æ–™ - é¡¯ç¤ºæ‰€æœ‰å…­ç¨®ç¶­åº¦
            function renderDimensionStats(stats) {
                const container = document.getElementById('dimension-stats');
                if (!container) return;

                const moduleStats = stats.module || {};
                const total = Object.values(moduleStats).reduce((a, b) => a + b, 0);

                if (total === 0) {
                    container.innerHTML = '<p style="color: #999;">å°šç„¡çµ±è¨ˆè³‡æ–™ï¼ˆéœ€æœ‰å·²ç™¼å¸ƒçš„ AI è²¼æ–‡ï¼‰</p>';
                    return;
                }

                // ç¶­åº¦åç¨±å°ç…§è¡¨
                const dimensionMeta = {
                    module: {
                        title: 'ğŸ“¦ å…§å®¹æ¨¡çµ„', color: '#667eea', names: {
                            pleasure_relief: 'çˆ½èˆ‡è§£å£“', practical: 'å‹™å¯¦è™•ç†',
                            uncomfortable_truth: 'ä¸èˆ’æœçœŸå¯¦', controversial: 'çˆ­è­°æå•'
                        }
                    },
                    angle: {
                        title: 'ğŸ¬ æƒ…å¢ƒåˆ‡è§’', color: '#f093fb', names: {
                            morning_wake: 'æ—©æ™¨æå•', late_night: 'éš¨ä¾¿åš', confession_anon: 'ä¸å¥½æ„æ€å•',
                            work_break: 'åˆä¼‘æ™‚é–“', before_sleep: 'ç¡å‰ç™¼å•'
                        }
                    },
                    outlet: {
                        title: 'ğŸ’¡ è™•ç†å‡ºå£', color: '#4facfe', names: {
                            solo_quick: 'è‡ªæ…°-å¿«æˆ°é€Ÿæ±º', solo_slow: 'è‡ªæ…°-æ…¢æ…¢äº«å—',
                            partner_simple: 'æœ‰å°è±¡-è¼•é‡é¸é …', partner_full: 'æœ‰å°è±¡-å®Œæ•´æ–¹æ¡ˆ',
                            mindset_shift: 'å¿ƒæ…‹è½‰æ›'
                        }
                    },
                    tone_bias: {
                        title: 'ğŸ—£ï¸ èªæ°£åå£“', color: '#fa709a', names: {
                            blunt_raw: 'ç›´ç™½ç²—æš´', playful_mean: 'èª¿çš®å˜´è³¤',
                            cold_practical: 'å†·æ·¡å‹™å¯¦', warm_body: 'æº«æš–è‚‰é«”æ´¾'
                        }
                    },
                    ending_style: {
                        title: 'ğŸ”š æ”¶å°¾æ„åœ–', color: '#a8edea', names: {
                            done_sleep: 'æ”¶å·¥å‹', question_back: 'åå•æ‡¸å¿µå‹', tease_more: 'æŒ‘é€—å»¶çºŒå‹',
                            reader_agency: 'è®€è€…æ±ºå®šå‹', self_call: 'è‡ªæˆ‘å–Šè©±å‹',
                            relief_done: 'è§£æ”¾å®Œæˆ', no_wait: 'ä¸ç”¨ç­‰å‹'
                        }
                    },
                    length_target: {
                        title: 'ğŸ“ å­—æ•¸ç›®æ¨™', color: '#30cfd0', names: {
                            '50-70': 'çŸ­ç‹  (50-70å­—)', '70-95': 'ä¸­ç­‰ (70-95å­—)', '95-120': 'æ…¢æ…¢æˆ³ (95-120å­—)'
                        }
                    }
                };

                let html = '<div style="display: grid; gap: 20px;">';

                for (const [dimKey, dimInfo] of Object.entries(dimensionMeta)) {
                    const dimStats = stats[dimKey] || {};
                    const dimTotal = Object.values(dimStats).reduce((a, b) => a + b, 0);

                    html += `<div>
                        <h5 style="margin-bottom: 8px; font-size: 13px; color: #374151;">${dimInfo.title}</h5>
                        <div style="display: grid; gap: 4px;">`;

                    if (dimTotal === 0) {
                        html += `<p style="color: #999; font-size: 12px;">å°šç„¡è³‡æ–™</p>`;
                    } else {
                        for (const [code, count] of Object.entries(dimStats)) {
                            const percent = Math.round((count / dimTotal) * 100);
                            const name = dimInfo.names[code] || code;

                            html += `
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 12px;">
                                    <span>${escapeHtml(name)}</span>
                                    <span>${count} ç¯‡ (${percent}%)</span>
                                </div>
                                <div style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                                    <div style="width: ${percent}%; height: 100%; background: ${dimInfo.color};"></div>
                                </div>
                            </div>
                            `;
                        }
                    }

                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html;
            }

            // è¼‰å…¥ç™¼æ–‡æ’ç¨‹é é¢
            function loadScheduling() {
                loadAIConfig();
                loadScheduleHistory();
            }

            // Save account settings (UCB account and LINE ID)
            async function saveAccountSettings() {
                try {
                    showLoading(true);

                    const threadsAccountId = document.getElementById('ucbThreadsAccount')?.value || '';
                    const lineUserId = document.getElementById('ucbLineNotifyUserId')?.value || '';

                    // å–å¾—ç¾æœ‰çš„ UCB é…ç½®
                    const configResponse = await fetch(`${API_BASE}/schedule-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    let currentConfig = {};
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        currentConfig = configData.config || {};
                    }

                    // æ›´æ–°é…ç½®ï¼ˆä½¿ç”¨ PUT æ–¹æ³•ï¼‰
                    const response = await fetch(`${API_BASE}/schedule-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            exploration_factor: currentConfig.exploration_factor || 1.5,
                            min_trials_per_template: currentConfig.min_trials_per_template || 5,
                            posts_per_day: currentConfig.posts_per_day || 1,
                            auto_schedule_enabled: currentConfig.auto_schedule_enabled !== false,
                            threads_account_id: threadsAccountId,
                            line_user_id: lineUserId,
                            time_range_start: currentConfig.time_range_start || '09:00',
                            time_range_end: currentConfig.time_range_end || '21:00',
                            active_days: currentConfig.active_days || []
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', 'å¸³è™Ÿè¨­å®šå·²å„²å­˜', 'success');
                    } else {
                        throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                    }
                } catch (error) {
                    console.error('Failed to save account settings:', error);
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // Auto sync on page load (silent, no alert)
            async function autoSyncOnLoad() {
                try {
                    // éœé»˜åŒæ­¥äº’å‹•æ•¸æ“šï¼Œä¸é¡¯ç¤ºæç¤º
                    await fetch(`${API_BASE}/statistics/sync`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: 7, limit: 100 })
                    });
                    console.log('Auto sync triggered on page load');
                } catch (error) {
                    console.warn('Auto sync failed:', error);
                }
            }

            // Load template statistics
            async function loadStatsTemplates() {
                const container = document.getElementById('statsTemplatesList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/templates?days=30`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load templates');
                    }

                    const templates = result.data;

                    if (templates.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ¨£æ¿æ•¸æ“š</p>';
                        return;
                    }

                    let html = '';
                    templates.forEach(template => {
                        html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${template.name}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                <div>ä½¿ç”¨æ¬¡æ•¸: ${template.total_uses || 0}</div>
                                <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(template.avg_likes) || 0)}</div>
                                <div>åƒèˆ‡ç‡: ${(parseFloat(template.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(template.avg_views) || 0)}</div>
                            </div>
                            ${template.best_performing_time ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #28a745;">
                                    â­ æœ€ä½³æ™‚æ®µ: ${template.best_performing_time}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    });

                    container.innerHTML = html;

                    // åŒæ™‚è¼‰å…¥ç¶­åº¦çµ±è¨ˆ
                    loadOverviewDimensionStats();

                } catch (error) {
                    console.error('Failed to load template statistics:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            // è¼‰å…¥ç¸½è¦½ä¸­çš„ç¶­åº¦çµ±è¨ˆ
            async function loadOverviewDimensionStats() {
                const container = document.getElementById('dimension-stats-overview');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE}/generation/stats`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        container.innerHTML = '<p style="color: #999;">ç„¡æ³•è¼‰å…¥ç¶­åº¦çµ±è¨ˆ</p>';
                        return;
                    }

                    const result = await response.json();
                    if (result.success) {
                        renderDimensionStatsOverview(result.data, container);
                    }
                } catch (error) {
                    console.error('Failed to load overview dimension stats:', error);
                    container.innerHTML = '<p style="color: #999;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            // æ¸²æŸ“ç¸½è¦½ä¸­çš„ç¶­åº¦çµ±è¨ˆ
            function renderDimensionStatsOverview(stats, container) {
                const moduleStats = stats.module || {};
                const total = Object.values(moduleStats).reduce((a, b) => a + b, 0);

                if (total === 0) {
                    container.innerHTML = '<p style="color: #999;">å°šç„¡ AI ç™¼æ–‡çµ±è¨ˆè³‡æ–™</p>';
                    return;
                }

                const dimensionMeta = {
                    module: {
                        title: 'ğŸ“¦ å…§å®¹æ¨¡çµ„', color: '#667eea', names: {
                            pleasure_relief: 'çˆ½èˆ‡è§£å£“', practical: 'å‹™å¯¦è™•ç†',
                            uncomfortable_truth: 'ä¸èˆ’æœçœŸå¯¦', controversial: 'çˆ­è­°æå•'
                        }
                    },
                    angle: {
                        title: 'ğŸ¬ æƒ…å¢ƒåˆ‡è§’', color: '#f093fb', names: {
                            morning_wake: 'æ—©æ™¨æå•', late_night: 'éš¨ä¾¿åš', confession_anon: 'ä¸å¥½æ„æ€å•',
                            work_break: 'åˆä¼‘æ™‚é–“', before_sleep: 'ç¡å‰ç™¼å•'
                        }
                    },
                    outlet: {
                        title: 'ğŸ’¡ è™•ç†å‡ºå£', color: '#4facfe', names: {
                            solo_quick: 'è‡ªæ…°-å¿«æˆ°é€Ÿæ±º', solo_slow: 'è‡ªæ…°-æ…¢æ…¢äº«å—',
                            partner_simple: 'æœ‰å°è±¡-è¼•é‡é¸é …', partner_full: 'æœ‰å°è±¡-å®Œæ•´æ–¹æ¡ˆ',
                            mindset_shift: 'å¿ƒæ…‹è½‰æ›'
                        }
                    },
                    tone_bias: {
                        title: 'ğŸ—£ï¸ èªæ°£åå£“', color: '#fa709a', names: {
                            blunt_raw: 'ç›´ç™½ç²—æš´', playful_mean: 'èª¿çš®å˜´è³¤',
                            cold_practical: 'å†·æ·¡å‹™å¯¦', warm_body: 'æº«æš–è‚‰é«”æ´¾'
                        }
                    },
                    ending_style: {
                        title: 'ğŸ”š æ”¶å°¾æ„åœ–', color: '#43e97b', names: {
                            done_sleep: 'æ”¶å·¥å‹', question_back: 'åå•æ‡¸å¿µå‹', tease_more: 'æŒ‘é€—å»¶çºŒå‹',
                            reader_agency: 'è®€è€…æ±ºå®šå‹', self_call: 'è‡ªæˆ‘å–Šè©±å‹',
                            relief_done: 'è§£æ”¾å®Œæˆ', no_wait: 'ä¸ç”¨ç­‰å‹'
                        }
                    },
                    length_target: {
                        title: 'ğŸ“ å­—æ•¸ç›®æ¨™', color: '#38f9d7', names: {
                            '50-70': 'çŸ­ç‹  (50-70å­—)', '70-95': 'ä¸­ç­‰ (70-95å­—)', '95-120': 'æ…¢æ…¢æˆ³ (95-120å­—)'
                        }
                    }
                };

                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

                for (const [dimKey, dimInfo] of Object.entries(dimensionMeta)) {
                    const dimStats = stats[dimKey] || {};
                    const dimTotal = Object.values(dimStats).reduce((a, b) => a + b, 0);

                    html += `<div style="background: white; padding: 12px; border-radius: 8px;">
                        <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #374151;">${dimInfo.title}</h5>
                        <div style="display: grid; gap: 4px;">`;

                    if (dimTotal === 0) {
                        html += `<p style="color: #999; font-size: 11px; margin: 0;">å°šç„¡è³‡æ–™</p>`;
                    } else {
                        for (const [code, count] of Object.entries(dimStats)) {
                            const percent = Math.round((count / dimTotal) * 100);
                            const name = dimInfo.names[code] || code;

                            html += `
                            <div>
                                <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                                    <span>${escapeHtml(name)}</span>
                                    <span>${percent}%</span>
                                </div>
                                <div style="height: 3px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                                    <div style="width: ${percent}%; height: 100%; background: ${dimInfo.color};"></div>
                                </div>
                            </div>
                            `;
                        }
                    }

                    html += '</div></div>';
                }

                html += '</div>';
                container.innerHTML = html;
            }

            // Load timeslot statistics
            async function loadStatsTimeslots() {
                const container = document.getElementById('statsTimeslotsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/timeslots?days=30`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load timeslots');
                    }

                    const timeslots = result.data;

                    if (timeslots.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ™‚æ®µæ•¸æ“š</p>';
                        return;
                    }

                    let html = '';
                    timeslots.forEach(slot => {
                        // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ name æ¬„ä½ï¼ˆä¾‹å¦‚ "08:00 - 08:59"ï¼‰
                        const label = slot.name || `${String(slot.start_hour || 0).padStart(2, '0')}:00`;
                        const hour = slot.start_hour || slot.id || 0;
                        html += `
                        <div style="background: white; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                            <div onclick="toggleTimeslotDetail(${hour}, this)" 
                                 style="padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                 onmouseover="this.style.background='#f5f5f5'" 
                                 onmouseout="this.style.background='white'">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ• ${label}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                        <div>è²¼æ–‡æ•¸: ${slot.posts_count || 0}</div>
                                        <div>åƒèˆ‡ç‡: ${(parseFloat(slot.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                        <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(slot.avg_likes) || 0)}</div>
                                        <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(slot.avg_views) || 0)}</div>
                                    </div>
                                </div>
                                <span style="font-size: 18px; color: #999; transition: transform 0.2s;">â–¼</span>
                            </div>
                            <div id="timeslot-detail-${hour}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid #eee;">
                                <p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">é»æ“Šè¼‰å…¥è²¼æ–‡...</p>
                            </div>
                        </div>
                    `;
                    });

                    container.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load timeslot statistics:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            // Toggle timeslot detail
            async function toggleTimeslotDetail(hour, headerEl) {
                const detailEl = document.getElementById(`timeslot-detail-${hour}`);
                const arrowEl = headerEl.querySelector('span');

                if (detailEl.style.display === 'none') {
                    detailEl.style.display = 'block';
                    arrowEl.style.transform = 'rotate(180deg)';

                    // è¼‰å…¥è©²æ™‚æ®µçš„è²¼æ–‡
                    detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>';

                    try {
                        const response = await fetch(`${API_BASE}/statistics/posts-by-hour?hour=${hour}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const result = await response.json();
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to load posts');
                        }

                        const posts = result.data.posts || [];

                        if (posts.length === 0) {
                            detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">æ­¤æ™‚æ®µç„¡è²¼æ–‡</p>';
                            return;
                        }

                        let html = '<div style="font-size: 12px;">';
                        posts.forEach(post => {
                            const content = post.content_preview || post.content || '(ç„¡å…§å®¹)';
                            const truncated = content.length > 40 ? content.substring(0, 40) + '...' : content;
                            const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                            }) : '-';

                            html += `
                            <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #666;">${postedAt}</span>
                                    <span style="color: #667eea;">ğŸ‘ ${(post.views || 0).toLocaleString()} Â· â¤ï¸ ${post.likes || 0}</span>
                                </div>
                                <div style="color: #333;">${truncated}</div>
                            </div>
                        `;
                        });
                        html += '</div>';

                        detailEl.innerHTML = html;

                    } catch (error) {
                        console.error('Failed to load posts for hour:', error);
                        detailEl.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 10px 0; font-size: 12px;">è¼‰å…¥å¤±æ•—</p>';
                    }
                } else {
                    detailEl.style.display = 'none';
                    arrowEl.style.transform = 'rotate(0deg)';
                }
            }

            // Load post details
            async function loadStatsDetails() {
                const container = document.getElementById('statsDetailsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/posts?limit=20&sortBy=posted_at&sortOrder=DESC`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load posts');
                    }

                    const posts = result.data.posts;

                    if (posts.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡è²¼æ–‡æ•¸æ“š</p>';
                        return;
                    }

                    let html = `
                    <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left;">ç™¼å¸ƒæ™‚é–“</th>
                                <th style="padding: 10px; text-align: left;">å…§å®¹</th>
                                <th style="padding: 10px; text-align: center;">ğŸ‘ï¸ è§€çœ‹</th>
                                <th style="padding: 10px; text-align: center;">â¤ï¸ æŒ‰è®š</th>
                                <th style="padding: 10px; text-align: center;">ğŸ“Š åƒèˆ‡ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                    posts.forEach(post => {
                        const content = post.content_preview || post.content || '(ç„¡å…§å®¹)';
                        const truncated = content.length > 25 ? content.substring(0, 25) + '...' : content;
                        const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '-';
                        html += `
                        <tr style="border-top: 1px solid #e5e7eb;">
                            <td style="padding: 10px; white-space: nowrap;">${postedAt}</td>
                            <td style="padding: 10px;">${truncated}</td>
                            <td style="padding: 10px; text-align: center;">${(post.views || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: center;">${post.likes || 0}</td>
                            <td style="padding: 10px; text-align: center;">${(parseFloat(post.engagement_rate) || 0).toFixed(1)}%</td>
                        </tr>
                    `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load post details:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            // Export statistics to CSV
            function exportStatsToCSV() {
                // TODO: Implement CSV export functionality
                showAlert('dashboardAlert', 'CSV åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
            }

            // Trigger manual sync
            async function triggerManualSync() {
                try {
                    showAlert('dashboardAlert', 'é–‹å§‹åŒæ­¥ Insights æ•¸æ“š...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/sync`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: 7, limit: 50 })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Sync failed');
                    }

                    showAlert('dashboardAlert', 'âœ… ' + result.message, 'success');

                    // ç­‰å¾… 2 ç§’å¾Œé‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                    setTimeout(() => {
                        loadStatsSummary();
                        if (currentStatsTab === 'templates') loadStatsTemplates();
                        if (currentStatsTab === 'timeslots') loadStatsTimeslots();
                        if (currentStatsTab === 'details') loadStatsDetails();
                    }, 2000);

                } catch (error) {
                    console.error('Failed to trigger sync:', error);
                    showAlert('dashboardAlert', 'åŒæ­¥å¤±æ•—', 'danger');
                }
            }

            // Initialize statistics on page load
            document.addEventListener('DOMContentLoaded', function () {
                if (token) {
                    // è‡ªå‹•åŒæ­¥äº’å‹•æ•¸æ“šï¼ˆéœé»˜åŸ·è¡Œï¼‰
                    autoSyncOnLoad();
                    // è¼‰å…¥çµ±è¨ˆæ‘˜è¦
                    loadStatsSummary();
                }
            });

            // ========================================
            // è²é‡ç›£æ§åŠŸèƒ½
            // ========================================

            let currentMonitorTab = 'stats';

            // åˆ‡æ›ç›£æ§åŠŸèƒ½ç¸½è¦½å±•é–‹/æ”¶èµ·
            function toggleMonitorOverview() {
                const content = document.getElementById('monitorOverviewContent');
                const toggle = document.getElementById('monitorOverviewToggle');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = 'â–² æ”¶èµ·èªªæ˜';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¼ å±•é–‹èªªæ˜';
                }
            }

            function switchMonitorTab(tabName) {
                currentMonitorTab = tabName;

                // æ›´æ–° sub-tab æŒ‰éˆ•æ¨£å¼
                document.querySelectorAll('#monitorTab .monitor-sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#333';
                });
                event.target.classList.add('active');
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';

                // éš±è—æ‰€æœ‰ sub-tab å…§å®¹
                document.getElementById('monitorMentionsTab').style.display = 'none';
                document.getElementById('monitorBrandsTab').style.display = 'none';
                document.getElementById('monitorSourcesTab').style.display = 'none';
                document.getElementById('monitorStatsTab').style.display = 'none';
                document.getElementById('monitorCrisisTab').style.display = 'none';
                document.getElementById('monitorRecommendTab').style.display = 'none';

                // é¡¯ç¤ºé¸ä¸­çš„ sub-tab
                if (tabName === 'mentions') {
                    document.getElementById('monitorMentionsTab').style.display = 'block';
                    loadMentions();
                } else if (tabName === 'brands') {
                    document.getElementById('monitorBrandsTab').style.display = 'block';
                    loadBrands();
                    loadClassifierConfig(); // åŒæ™‚è¼‰å…¥åˆ†é¡è¨­å®š
                } else if (tabName === 'sources') {
                    document.getElementById('monitorSourcesTab').style.display = 'block';
                    loadSources();
                    loadSourceTemplates(); // è¼‰å…¥é è¨­ä¾†æºå¤šé¸
                } else if (tabName === 'stats') {
                    document.getElementById('monitorStatsTab').style.display = 'block';
                    loadMonitorStats();
                } else if (tabName === 'crisis') {
                    document.getElementById('monitorCrisisTab').style.display = 'block';
                    loadCrisisData();
                } else if (tabName === 'recommend') {
                    document.getElementById('monitorRecommendTab').style.display = 'block';
                    loadRecommendData();
                }
            }

            async function loadMentions() {
                const container = document.getElementById('mentionsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const brandId = document.getElementById('mentionBrandFilter').value;
                    const topicFilter = document.getElementById('mentionTopicFilter').value;
                    const isRead = document.getElementById('mentionReadFilter').value;

                    let url = `${API_BASE}/monitor/mentions?limit=20`;
                    if (brandId) url += `&brand_id=${brandId}`;
                    if (topicFilter) url += `&primary_topic=${topicFilter}`;
                    if (isRead) url += `&is_read=${isRead}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const mentions = result.data.mentions || [];

                    if (mentions.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">å°šç„¡æåŠè¨˜éŒ„</p>';
                        return;
                    }

                    container.innerHTML = mentions.map(m => {
                        // åˆ†é¡æ¨™ç±¤
                        const topicLabels = {
                            'pain_point': { label: 'ç”¢å“ç—›é»', color: '#ef4444', icon: 'ğŸ”´' },
                            'need_context': { label: 'éœ€æ±‚æƒ…å¢ƒ', color: '#3b82f6', icon: 'ğŸ”µ' },
                            'other': { label: '', color: '', icon: '' }
                        };
                        const topic = topicLabels[m.primary_topic] || topicLabels.other;
                        const hasStrongHit = m.has_strong_hit;

                        // è§£æå‘½ä¸­è©³æƒ…
                        let hitDetails = '';
                        if (m.classification_hits) {
                            try {
                                const hits = JSON.parse(m.classification_hits);
                                const strongHits = hits.filter(h => h.strength === 'strong').map(h => h.rule_name);
                                if (strongHits.length > 0) {
                                    hitDetails = strongHits.filter((v, i, a) => a.indexOf(v) === i).join('ã€');
                                }
                            } catch(e) {}
                        }

                        return `
                    <div style="background: ${m.is_read ? '#f8f9fa' : 'white'}; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${topic.color || m.brand_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                <span style="background: ${m.brand_color || '#667eea'}; color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px;">${m.brand_name}</span>
                                ${topic.label ? `<span style="background: ${topic.color}; color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px;">${topic.icon} ${topic.label}${hasStrongHit ? ' (å¼·)' : ''}</span>` : ''}
                                <span style="color: #666; font-size: 12px;">${m.source_name}</span>
                            </div>
                            <span style="color: #999; font-size: 12px; white-space: nowrap;">${new Date(m.discovered_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <h4 style="margin-bottom: 10px; color: #333;">${m.title || '(ç„¡æ¨™é¡Œ)'}</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">${m.content_preview || ''}</p>
                        ${hitDetails ? `<p style="font-size: 12px; color: ${topic.color}; margin-bottom: 10px;">ğŸ“Œ ${hitDetails}</p>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="font-size: 12px; color: #888;">
                                ğŸ”‘ ${JSON.parse(m.matched_keywords || '[]').join(', ')}
                                ${m.likes_count ? ` Â· â¤ï¸ ${m.likes_count}` : ''}
                                ${m.comments_count ? ` Â· ğŸ’¬ ${m.comments_count}` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <a href="${m.url}" target="_blank" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;">ğŸ”— æŸ¥çœ‹åŸæ–‡</a>
                                ${!m.is_read ? `<button class="btn btn-primary" style="padding: 5px 15px; font-size: 12px;" onclick="markMentionRead('${m.id}', this)">âœ“ æ¨™ç‚ºå·²è®€</button>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                    }).join('');

                } catch (error) {
                    console.error('Failed to load mentions:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            async function markMentionRead(mentionId, btn) {
                try {
                    await fetch(`${API_BASE}/monitor/mentions/${mentionId}/read`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    btn.closest('div[style*="background"]').style.background = '#f8f9fa';
                    btn.remove();
                } catch (error) {
                    console.error('Failed to mark as read:', error);
                }
            }

            async function reclassifyAll() {
                if (!confirm('ç¢ºå®šè¦é‡æ–°åˆ†é¡æ‰€æœ‰æåŠè¨˜éŒ„å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) return;

                try {
                    showAlert('dashboardAlert', 'æ­£åœ¨é‡æ–°åˆ†é¡...', 'info');

                    const response = await fetch(`${API_BASE}/monitor/reclassify`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', `é‡æ–°åˆ†é¡å®Œæˆï¼š${result.data.processed} ç­†`, 'success');
                    loadMentions();
                } catch (error) {
                    showAlert('dashboardAlert', 'é‡æ–°åˆ†é¡å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // ========================================
            // åˆ†é¡è¨­å®šç®¡ç†
            // ========================================

            let classifierConfig = null;

            async function loadClassifierConfig() {
                const painPointContainer = document.getElementById('painPointRulesList');
                const needContextContainer = document.getElementById('needContextRulesList');

                try {
                    const response = await fetch(`${API_BASE}/monitor/classifier-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');

                    classifierConfig = result.data;

                    // æ›´æ–°ç‰ˆæœ¬
                    const versionEl = document.getElementById('classifierVersion');
                    if (versionEl) versionEl.textContent = `ç‰ˆæœ¬: ${classifierConfig.version}`;

                    // å¡«å…¥æ’é™¤è©
                    const excludeInput = document.getElementById('excludePatternsInput');
                    if (excludeInput && classifierConfig.exclude_patterns) {
                        excludeInput.value = classifierConfig.exclude_patterns.join('\n');
                    }

                    // é¡¯ç¤ºç—›é»è¦å‰‡
                    renderRulesList('pain_point', 'painPointRulesList');

                    // é¡¯ç¤ºéœ€æ±‚æƒ…å¢ƒè¦å‰‡
                    renderRulesList('need_context', 'needContextRulesList');

                } catch (error) {
                    console.error('Failed to load classifier config:', error);

                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯åœ¨è¦å‰‡åˆ—è¡¨ä¸­
                    if (painPointContainer) {
                        painPointContainer.innerHTML = `<p style="color: #dc3545; text-align: center; font-size: 12px;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                    }
                    if (needContextContainer) {
                        needContextContainer.innerHTML = `<p style="color: #dc3545; text-align: center; font-size: 12px;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                    }
                }
            }

            function renderRulesList(topicName, containerId) {
                const container = document.getElementById(containerId);
                const topic = classifierConfig?.topics?.[topicName];

                if (!topic || !topic.rules || topic.rules.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; font-size: 12px;">å°šç„¡è¦å‰‡</p>';
                    return;
                }

                container.innerHTML = topic.rules.map(rule => `
                    <div style="background: #f9fafb; padding: 10px 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <strong style="font-size: 13px;">${rule.name}</strong>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editRule('${topicName}', '${rule.id}')" style="padding: 2px 8px; font-size: 10px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">âœï¸</button>
                                <button onclick="deleteRule('${topicName}', '${rule.id}')" style="padding: 2px 8px; font-size: 10px; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; cursor: pointer;">âœ•</button>
                            </div>
                        </div>
                        <code style="font-size: 11px; color: #666; word-break: break-all; display: block;">${escapeHtml(rule.pattern)}</code>
                    </div>
                `).join('');
            }

            async function saveExcludePatterns() {
                const input = document.getElementById('excludePatternsInput').value.trim();
                const patterns = input.split('\n').map(p => p.trim()).filter(p => p);

                try {
                    const response = await fetch(`${API_BASE}/monitor/classifier-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ exclude_patterns: patterns })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'æ’é™¤è©å·²å„²å­˜', 'success');
                    loadClassifierConfig();
                } catch (error) {
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                }
            }

            function showAddRuleModal(topicName) {
                const ruleName = prompt('è«‹è¼¸å…¥è¦å‰‡åç¨±ï¼ˆå¦‚ï¼šå™ªéŸ³å•é¡Œï¼‰');
                if (!ruleName) return;

                const rulePattern = prompt('è«‹è¼¸å…¥æ­£å‰‡è¡¨é”å¼ï¼ˆå¦‚ï¼š(å¤ª\\s*åµ|å¾ˆ\\s*åµ|å™ª\\s*éŸ³)ï¼‰');
                if (!rulePattern) return;

                addRule(topicName, ruleName, rulePattern);
            }

            async function addRule(topicName, name, pattern) {
                // ç”¢ç”Ÿè¦å‰‡ ID
                const prefix = topicName === 'pain_point' ? 'PP' : 'NC';
                const existingRules = classifierConfig?.topics?.[topicName]?.rules || [];
                const nextNum = existingRules.length + 1;
                const ruleId = `${prefix}${String(nextNum).padStart(3, '0')}`;

                try {
                    const response = await fetch(`${API_BASE}/monitor/classifier-rules`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            topic: topicName,
                            rule: {
                                id: ruleId,
                                name: name,
                                pattern: pattern,
                                flags: 'iu'
                            }
                        })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'è¦å‰‡å·²æ–°å¢', 'success');
                    loadClassifierConfig();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ–°å¢å¤±æ•—: ' + error.message, 'danger');
                }
            }

            function editRule(topicName, ruleId) {
                const topic = classifierConfig?.topics?.[topicName];
                const rule = topic?.rules?.find(r => r.id === ruleId);
                if (!rule) return;

                const newName = prompt('è¦å‰‡åç¨±:', rule.name);
                if (newName === null) return;

                const newPattern = prompt('æ­£å‰‡è¡¨é”å¼:', rule.pattern);
                if (newPattern === null) return;

                updateRule(topicName, ruleId, {
                    name: newName || rule.name,
                    pattern: newPattern || rule.pattern
                });
            }

            async function updateRule(topicName, ruleId, updates) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/classifier-rules/${topicName}/${ruleId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'è¦å‰‡å·²æ›´æ–°', 'success');
                    loadClassifierConfig();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ›´æ–°å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function deleteRule(topicName, ruleId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`${API_BASE}/monitor/classifier-rules/${topicName}/${ruleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'è¦å‰‡å·²åˆªé™¤', 'success');
                    loadClassifierConfig();
                } catch (error) {
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function loadBrands() {
                const container = document.getElementById('brandsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const brands = result.data || [];

                    // æ›´æ–°é—œéµå­—çµ„éæ¿¾ä¸‹æ‹‰é¸å–®
                    const brandFilter = document.getElementById('mentionBrandFilter');
                    brandFilter.innerHTML = '<option value="">å…¨éƒ¨é—œéµå­—çµ„</option>' +
                        brands.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                    if (brands.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">å°šæœªè¨­å®šé—œéµå­—çµ„</p>
                            <button class="btn btn-primary" onclick="showAddBrandModal()">â• æ–°å¢é—œéµå­—çµ„</button>
                        </div>
                    `;
                        return;
                    }

                    // å„²å­˜å“ç‰Œè³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨
                    window.brandsData = {};
                    brands.forEach(b => {
                        const kw = Array.isArray(b.keywords) ? b.keywords : (typeof b.keywords === 'string' ? JSON.parse(b.keywords) : []);
                        window.brandsData[b.id] = { ...b, keywords: kw };
                    });

                    container.innerHTML = brands.map(b => {
                        const keywords = Array.isArray(b.keywords) ? b.keywords : (typeof b.keywords === 'string' ? JSON.parse(b.keywords) : []);
                        return `
                    <div id="brand-card-${b.id}" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${b.display_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 5px;">${b.name}
                                    <span style="background: ${b.brand_type === 'own' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">
                                        ${b.brand_type === 'own' ? 'è‡ªæœ‰' : 'ç«¶å“'}
                                    </span>
                                    <span style="background: ${b.is_active ? '#d1fae5' : '#fee2e2'}; color: ${b.is_active ? '#065f46' : '#991b1b'}; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">
                                        ${b.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}
                                    </span>
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                    ${keywords.map(kw => `<span style="background: #e5e7eb; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${kw}</span>`).join('')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="toggleBrandEdit('${b.id}')">âœï¸ ç·¨è¼¯</button>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteBrand('${b.id}')">åˆªé™¤</button>
                            </div>
                        </div>
                        <!-- ç·¨è¼¯å€åŸŸ (é è¨­éš±è—) -->
                        <div id="brand-edit-${b.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">é—œéµå­—ï¼ˆé»æ“Š Ã— å¯åˆªé™¤ï¼‰</label>
                                <div id="brand-keywords-${b.id}" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 36px; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    ${keywords.map(kw => `
                                        <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
                                            ${kw}
                                            <button onclick="removeKeyword('${b.id}', '${kw.replace(/'/g, "\\'")}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; padding: 0; line-height: 1;">Ã—</button>
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                <input type="text" id="brand-new-keyword-${b.id}" placeholder="è¼¸å…¥æ–°é—œéµå­—å¾ŒæŒ‰ Enter æˆ–é»æ“Šæ–°å¢"
                                    style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;"
                                    onkeypress="if(event.key==='Enter'){addKeyword('${b.id}');event.preventDefault();}">
                                <button onclick="addKeyword('${b.id}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    ï¼‹ æ–°å¢
                                </button>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div>
                                    <label style="font-size: 12px; color: #666; margin-right: 8px;">ç‹€æ…‹ï¼š</label>
                                    <select id="brand-active-${b.id}" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="true" ${b.is_active ? 'selected' : ''}>å•Ÿç”¨</option>
                                        <option value="false" ${!b.is_active ? 'selected' : ''}>åœç”¨</option>
                                    </select>
                                </div>
                                <button onclick="saveBrandEdit('${b.id}')" style="padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    ğŸ’¾ å„²å­˜è®Šæ›´
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                    }).join('');

                } catch (error) {
                    console.error('Failed to load brands:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            async function loadSources() {
                const container = document.getElementById('sourcesList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/sources`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const sources = result.data || [];

                    if (sources.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">å°šæœªè¨­å®šç›£æ§ä¾†æº</p>
                            <button class="btn btn-primary" onclick="showSourceTemplates()">ğŸ“‹ å¾é è¨­ä¾†æºæ–°å¢</button>
                        </div>
                    `;
                        return;
                    }

                    const healthColors = {
                        healthy: '#10b981',
                        warning: '#f59e0b',
                        error: '#dc3545',
                        unknown: '#999'
                    };

                    container.innerHTML = sources.map(s => `
                    <div id="source-card-${s.id}" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 5px;">
                                    <span style="color: ${healthColors[s.health_status] || '#999'};">â—</span>
                                    ${s.name}
                                    <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">${s.platform}</span>
                                    <span style="background: ${s.is_active ? '#d1fae5' : '#fee2e2'}; color: ${s.is_active ? '#065f46' : '#991b1b'}; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">
                                        ${s.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}
                                    </span>
                                </h4>
                                <p style="color: #666; font-size: 12px; word-break: break-all;">${s.url}</p>
                                <p style="color: #888; font-size: 11px; margin-top: 5px;">
                                    æª¢æŸ¥é–“éš”: ${s.check_interval_hours} å°æ™‚ Â·
                                    ä¸Šæ¬¡æª¢æŸ¥: ${s.last_checked_at ? new Date(s.last_checked_at).toLocaleString('zh-TW') : 'å¾æœª'}
                                    ${s.platform === 'dcard' ? '<span style="color: #059669; margin-left: 8px;">âœ“ è‡ªå‹•æŠ“å–æœ€æ–°æ–‡ç« </span>' : ''}
                                </p>
                                <!-- çµ±è¨ˆæ‘˜è¦ -->
                                <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 12px;">
                                    <div style="display: flex; align-items: center; gap: 5px; color: #666;">
                                        <span style="background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 10px; font-weight: bold;">${s.total_mentions || 0}</span>
                                        ç´¯è¨ˆæåŠ
                                    </div>
                                    ${s.last_checked_at ? `
                                    <div style="display: flex; align-items: center; gap: 5px; color: #666;">
                                        ä¸Šæ¬¡æƒæ <strong>${s.last_articles_found || 0}</strong> ç¯‡ï¼Œ
                                        æ–°å¢ <strong style="color: ${(s.last_new_mentions || 0) > 0 ? '#059669' : '#666'};">${s.last_new_mentions || 0}</strong> ç­†æåŠ
                                    </div>
                                    ` : '<span style="color: #999;">å°šæœªåŸ·è¡Œçˆ¬å–</span>'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="toggleSourceEdit('${s.id}')">âš™ï¸ ç·¨è¼¯</button>
                                <button id="crawl-btn-${s.id}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="triggerCrawl('${s.id}')">ğŸ”„ çˆ¬å–</button>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSource('${s.id}')">åˆªé™¤</button>
                            </div>
                        </div>
                        <!-- ä¸Šæ¬¡çˆ¬å–çµæœï¼ˆæ°¸ä¹…é¡¯ç¤ºï¼‰ -->
                        ${s.last_crawl_at ? `
                        <div style="margin-top: 12px; padding: 12px 15px; border-radius: 8px; font-size: 13px; background: ${s.last_crawl_status === 'success' ? '#f0fdf4' : s.last_crawl_status === 'failed' ? '#fef2f2' : '#fefce8'}; border: 1px solid ${s.last_crawl_status === 'success' ? '#86efac' : s.last_crawl_status === 'failed' ? '#fecaca' : '#fde047'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: ${s.last_crawl_status === 'success' ? '#166534' : s.last_crawl_status === 'failed' ? '#991b1b' : '#854d0e'};">
                                    ${s.last_crawl_status === 'success' ? 'âœ… ä¸Šæ¬¡çˆ¬å–æˆåŠŸ' : s.last_crawl_status === 'failed' ? 'âŒ ä¸Šæ¬¡çˆ¬å–å¤±æ•—' : 'âš ï¸ ä¸Šæ¬¡çˆ¬å–'}
                                </span>
                                <span style="font-size: 11px; color: #666;">
                                    ${new Date(s.last_crawl_at).toLocaleString('zh-TW')}
                                </span>
                            </div>
                            ${s.last_crawl_status === 'success' ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                                    <div style="font-size: 16px; font-weight: bold;">${s.last_articles_found || 0}</div>
                                    <div style="font-size: 10px; color: #666;">æŠ“åˆ°æ–‡ç« </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                                    <div style="font-size: 16px; font-weight: bold; color: ${(s.last_new_mentions || 0) > 0 ? '#059669' : '#666'};">${s.last_new_mentions || 0}</div>
                                    <div style="font-size: 10px; color: #666;">æ–°æåŠ</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                                    <div style="font-size: 16px; font-weight: bold;">${s.last_duplicate_skipped || 0}</div>
                                    <div style="font-size: 10px; color: #666;">é‡è¤‡è·³é</div>
                                </div>
                            </div>
                            ` : `
                            <div style="font-size: 12px; color: #991b1b;">${s.last_error_message || 'æœªçŸ¥éŒ¯èª¤'}</div>
                            `}
                        </div>
                        ` : `
                        <div style="margin-top: 12px; padding: 10px 15px; border-radius: 8px; font-size: 12px; background: #f3f4f6; color: #6b7280; text-align: center;">
                            å°šæœªåŸ·è¡Œçˆ¬å–ï¼Œé»æ“Šã€ŒğŸ”„ çˆ¬å–ã€é–‹å§‹
                        </div>
                        `}
                        <!-- å³æ™‚çˆ¬å–çµæœï¼ˆé»æ“ŠæŒ‰éˆ•å¾Œé¡¯ç¤ºï¼‰ -->
                        <div id="crawl-result-${s.id}" style="display: none; margin-top: 10px; padding: 10px 15px; border-radius: 8px; font-size: 13px;"></div>
                        <!-- ç·¨è¼¯å€åŸŸ (é è¨­éš±è—) -->
                        <div id="source-edit-${s.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">æª¢æŸ¥é–“éš”</label>
                                    <select id="source-interval-${s.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="1" ${s.check_interval_hours == 1 ? 'selected' : ''}>æ¯å°æ™‚</option>
                                        <option value="2" ${s.check_interval_hours == 2 ? 'selected' : ''}>æ¯ 2 å°æ™‚</option>
                                        <option value="6" ${s.check_interval_hours == 6 ? 'selected' : ''}>æ¯ 6 å°æ™‚</option>
                                        <option value="12" ${s.check_interval_hours == 12 ? 'selected' : ''}>æ¯ 12 å°æ™‚</option>
                                        <option value="24" ${s.check_interval_hours == 24 ? 'selected' : ''}>æ¯å¤©</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ç‹€æ…‹</label>
                                    <select id="source-active-${s.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="true" ${s.is_active ? 'selected' : ''}>å•Ÿç”¨</option>
                                        <option value="false" ${!s.is_active ? 'selected' : ''}>åœç”¨</option>
                                    </select>
                                </div>
                                <div>
                                    <button onclick="saveSourceEdit('${s.id}')" style="width: 100%; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                        ğŸ’¾ å„²å­˜
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                } catch (error) {
                    console.error('Failed to load sources:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            async function loadMonitorStats() {
                try {
                    const days = document.getElementById('monitorStatsDays').value;
                    const response = await fetch(`${API_BASE}/monitor/stats/overview?days=${days}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const data = result.data;

                    document.getElementById('monitorTotalMentions').textContent = data.total_mentions || 0;
                    document.getElementById('monitorUnreadCount').textContent = data.unread_count || 0;
                    document.getElementById('monitorBrandCount').textContent = (data.brand_stats || []).length;

                    // å“ç‰Œçµ±è¨ˆ
                    const brandStats = document.getElementById('monitorBrandStats');
                    if (data.brand_stats && data.brand_stats.length > 0) {
                        brandStats.innerHTML = data.brand_stats.map(b => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span style="color: ${b.display_color || '#667eea'};">â— ${b.name}</span>
                            <span><strong>${b.mention_count}</strong> æ¬¡</span>
                        </div>
                    `).join('');
                    } else {
                        brandStats.innerHTML = '<p style="color: #999; text-align: center;">ç„¡è³‡æ–™</p>';
                    }

                    // ä¾†æºçµ±è¨ˆ
                    const sourceStats = document.getElementById('monitorSourceStats');
                    if (data.source_stats && data.source_stats.length > 0) {
                        sourceStats.innerHTML = data.source_stats.map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span>${s.name} <small style="color: #888;">(${s.platform})</small></span>
                            <span><strong>${s.mention_count}</strong> æ¬¡</span>
                        </div>
                    `).join('');
                    } else {
                        sourceStats.innerHTML = '<p style="color: #999; text-align: center;">ç„¡è³‡æ–™</p>';
                    }

                } catch (error) {
                    console.error('Failed to load monitor stats:', error);
                }
            }

            // ========================================
            // å±æ©Ÿé è­¦åŠŸèƒ½
            // ========================================
            async function loadCrisisData() {
                await Promise.all([
                    loadCrisisConfig(),
                    loadCrisisLogs(),
                    loadCrisisStats()
                ]);
            }

            async function loadCrisisStats() {
                try {
                    // å–å¾—ä»Šæ—¥è² é¢æåŠæ•¸
                    const mentionsRes = await fetch(`${API_BASE}/monitor/mentions?topic_filter=pain_point&limit=1`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const mentionsData = await mentionsRes.json();

                    // å–å¾—è­¦å ±æ—¥èªŒ
                    const logsRes = await fetch(`${API_BASE}/monitor/crisis/logs?limit=100`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const logsData = await logsRes.json();

                    if (logsData.success) {
                        const logs = logsData.data.logs || [];
                        const newAlerts = logs.filter(l => l.status === 'new').length;
                        const resolved = logs.filter(l => l.status === 'resolved').length;
                        document.getElementById('crisisStatAlerts').textContent = newAlerts;
                        document.getElementById('crisisStatResolved').textContent = resolved;
                    }

                    if (mentionsData.success) {
                        document.getElementById('crisisStatToday').textContent = mentionsData.data.total || 0;
                    }
                } catch (error) {
                    console.error('Failed to load crisis stats:', error);
                }
            }

            async function loadCrisisConfig() {
                try {
                    // å…ˆå–å¾—å“ç‰Œåˆ—è¡¨ï¼Œå–ç¬¬ä¸€å€‹å“ç‰Œçš„è¨­å®š
                    const brandsRes = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const brandsData = await brandsRes.json();

                    if (brandsData.success && brandsData.data.length > 0) {
                        const brandId = brandsData.data[0].id;
                        const configRes = await fetch(`${API_BASE}/monitor/crisis/config/${brandId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const configData = await configRes.json();

                        if (configData.success && configData.data) {
                            const config = configData.data;
                            document.getElementById('crisisBaselineDays').value = config.baseline_days || 7;
                            document.getElementById('crisisTriggerMultiplier').value = config.trigger_multiplier || 2.0;
                            document.getElementById('crisisCooldownMinutes').value = config.cooldown_minutes || 60;
                            document.getElementById('crisisOnlyNegative').checked = config.only_negative !== false;
                            document.getElementById('crisisAlertEnabled').checked = config.alert_enabled !== false;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load crisis config:', error);
                }
            }

            async function saveCrisisConfig() {
                try {
                    // å–å¾—ç¬¬ä¸€å€‹å“ç‰Œ
                    const brandsRes = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const brandsData = await brandsRes.json();

                    if (!brandsData.success || brandsData.data.length === 0) {
                        showAlert('dashboardAlert', 'è«‹å…ˆå»ºç«‹è‡³å°‘ä¸€å€‹é—œéµå­—çµ„', 'warning');
                        return;
                    }

                    const brandId = brandsData.data[0].id;
                    const config = {
                        baseline_days: parseInt(document.getElementById('crisisBaselineDays').value),
                        trigger_multiplier: parseFloat(document.getElementById('crisisTriggerMultiplier').value),
                        cooldown_minutes: parseInt(document.getElementById('crisisCooldownMinutes').value),
                        only_negative: document.getElementById('crisisOnlyNegative').checked,
                        alert_enabled: document.getElementById('crisisAlertEnabled').checked
                    };

                    const response = await fetch(`${API_BASE}/monitor/crisis/config/${brandId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('dashboardAlert', 'å±æ©Ÿé è­¦è¨­å®šå·²å„²å­˜', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function loadCrisisLogs() {
                const container = document.getElementById('crisisLogsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const status = document.getElementById('crisisLogStatusFilter').value;
                    let url = `${API_BASE}/monitor/crisis/logs?limit=50`;
                    if (status) url += `&status=${status}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) throw new Error(result.error);

                    const logs = result.data.logs || [];

                    if (logs.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ç›®å‰æ²’æœ‰è­¦å ±è¨˜éŒ„</p>';
                        return;
                    }

                    container.innerHTML = logs.map(log => {
                        const statusBadge = {
                            'new': '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">ğŸ”´ æ–°è­¦å ±</span>',
                            'acknowledged': '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">ğŸŸ¡ å·²ç¢ºèª</span>',
                            'resolved': '<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">ğŸŸ¢ å·²è§£æ±º</span>'
                        }[log.status] || log.status;

                        const alertType = log.alert_type === 'negative_surge' ? 'è² é¢è²é‡çªå¢' : 'é«˜äº’å‹•è² é¢å…§å®¹';

                        return `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${log.status === 'new' ? '#ef4444' : log.status === 'acknowledged' ? '#f59e0b' : '#22c55e'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 14px;">ğŸš¨ ${alertType}</strong>
                                        ${statusBadge}
                                    </div>
                                    <span style="color: #666; font-size: 12px;">${new Date(log.created_at).toLocaleString('zh-TW')}</span>
                                </div>
                                <div style="font-size: 13px; color: #333; margin-bottom: 10px;">
                                    <span>ä»Šæ—¥: <strong>${log.current_count}</strong> ç¯‡</span>
                                    <span style="margin-left: 15px;">åŸºæº–: <strong>${parseFloat(log.baseline_avg).toFixed(1)}</strong> ç¯‡</span>
                                    <span style="margin-left: 15px;">å€æ•¸: <strong style="color: #ef4444;">${parseFloat(log.trigger_ratio).toFixed(1)}x</strong></span>
                                </div>
                                ${log.status !== 'resolved' ? `
                                    <button onclick="resolveCrisisAlert('${log.id}')" class="btn btn-sm" style="padding: 5px 12px; font-size: 12px; background: #22c55e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        âœ“ æ¨™è¨˜å·²è§£æ±º
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    container.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 40px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }

            async function triggerCrisisCheck() {
                try {
                    showLoading(true);
                    const response = await fetch(`${API_BASE}/monitor/crisis/check`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    showLoading(false);

                    if (result.success) {
                        showAlert('dashboardAlert', `å±æ©Ÿæª¢æŸ¥å®Œæˆï¼šæª¢æŸ¥ ${result.data.checked} å€‹å“ç‰Œï¼Œè§¸ç™¼ ${result.data.alerts} å€‹è­¦å ±`, 'success');
                        loadCrisisData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showLoading(false);
                    showAlert('dashboardAlert', 'æª¢æŸ¥å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function resolveCrisisAlert(alertId) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/crisis/logs/${alertId}/resolve`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('dashboardAlert', 'è­¦å ±å·²æ¨™è¨˜ç‚ºå·²è§£æ±º', 'success');
                        loadCrisisLogs();
                        loadCrisisStats();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'æ“ä½œå¤±æ•—: ' + error.message, 'danger');
                }
            }

            // ========================================
            // å…§å®¹æ¨è–¦åŠŸèƒ½
            // ========================================
            async function loadRecommendData() {
                await Promise.all([
                    loadBrandProfile(),
                    loadTopics(),
                    loadSuggestions(),
                    loadRecommendStats()
                ]);
            }

            async function loadRecommendStats() {
                try {
                    const [topicsRes, suggestionsRes] = await Promise.all([
                        fetch(`${API_BASE}/monitor/recommendations/topics?status=new&limit=100`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        fetch(`${API_BASE}/monitor/recommendations/suggestions?limit=100`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);

                    const topicsData = await topicsRes.json();
                    const suggestionsData = await suggestionsRes.json();

                    if (topicsData.success) {
                        document.getElementById('recommendStatTopics').textContent = topicsData.data.total || 0;
                    }

                    if (suggestionsData.success) {
                        const suggestions = suggestionsData.data.suggestions || [];
                        document.getElementById('recommendStatSuggestions').textContent = suggestionsData.data.total || 0;
                        document.getElementById('recommendStatAdopted').textContent = suggestions.filter(s => s.status === 'adopted').length;
                    }
                } catch (error) {
                    console.error('Failed to load recommend stats:', error);
                }
            }

            async function loadBrandProfile() {
                try {
                    const response = await fetch(`${API_BASE}/monitor/recommendations/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        const profile = result.data;
                        document.getElementById('profileName').value = profile.name || '';
                        document.getElementById('profileIndustry').value = profile.industry || '';
                        document.getElementById('profileProducts').value = (profile.products || []).join(', ');
                        document.getElementById('profileProductKeywords').value = (profile.product_keywords || []).join(', ');
                        document.getElementById('profileAgeRange').value = profile.age_range || '';
                        document.getElementById('profileToneStyle').value = profile.tone_style || '';
                        document.getElementById('profileRelevantTopics').value = (profile.relevant_topics || []).join(', ');
                        document.getElementById('profileTopicExclusions').value = (profile.topic_exclusions || []).join(', ');
                        document.getElementById('profileContentTaboos').value = (profile.content_taboos || []).join(', ');
                    }
                } catch (error) {
                    console.error('Failed to load brand profile:', error);
                }
            }

            async function saveBrandProfile() {
                try {
                    const profile = {
                        name: document.getElementById('profileName').value.trim(),
                        industry: document.getElementById('profileIndustry').value.trim(),
                        products: document.getElementById('profileProducts').value.split(',').map(s => s.trim()).filter(s => s),
                        product_keywords: document.getElementById('profileProductKeywords').value.split(',').map(s => s.trim()).filter(s => s),
                        age_range: document.getElementById('profileAgeRange').value.trim(),
                        tone_style: document.getElementById('profileToneStyle').value.trim(),
                        relevant_topics: document.getElementById('profileRelevantTopics').value.split(',').map(s => s.trim()).filter(s => s),
                        topic_exclusions: document.getElementById('profileTopicExclusions').value.split(',').map(s => s.trim()).filter(s => s),
                        content_taboos: document.getElementById('profileContentTaboos').value.split(',').map(s => s.trim()).filter(s => s)
                    };

                    const response = await fetch(`${API_BASE}/monitor/recommendations/profile`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(profile)
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('dashboardAlert', 'Brand Profile å·²å„²å­˜', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function loadTopics() {
                const container = document.getElementById('topicsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const status = document.getElementById('topicStatusFilter').value;
                    let url = `${API_BASE}/monitor/recommendations/topics?limit=20`;
                    if (status) url += `&status=${status}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) throw new Error(result.error);

                    const topics = result.data.topics || [];

                    if (topics.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ç›®å‰æ²’æœ‰ç†±é–€è©±é¡Œï¼Œè«‹å…ˆåŸ·è¡Œã€Œç«‹å³ç”Ÿæˆæ¨è–¦ã€</p>';
                        return;
                    }

                    container.innerHTML = topics.map(topic => {
                        const relevanceColor = topic.relevance_score >= 0.8 ? '#22c55e' : topic.relevance_score >= 0.6 ? '#f59e0b' : '#ef4444';
                        const statusBadge = {
                            'new': '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">ğŸ†• æ–°è©±é¡Œ</span>',
                            'used': '<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">âœ… å·²ä½¿ç”¨</span>',
                            'rejected': '<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">âŒ å·²æ‹’çµ•</span>'
                        }[topic.status] || topic.status;

                        const hooks = topic.suggested_hooks ? (typeof topic.suggested_hooks === 'string' ? JSON.parse(topic.suggested_hooks) : topic.suggested_hooks) : [];

                        return `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${relevanceColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 15px;">ğŸ”¥ ${topic.topic_title}</strong>
                                        ${statusBadge}
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: ${relevanceColor};">${(topic.relevance_score * 100).toFixed(0)}%</div>
                                        <div style="font-size: 11px; color: #666;">ç›¸é—œæ€§</div>
                                    </div>
                                </div>
                                ${topic.content_angle ? `
                                    <div style="font-size: 13px; color: #333; margin-bottom: 8px;">
                                        ğŸ’¡ <strong>åˆ‡å…¥è§’åº¦:</strong> ${topic.content_angle}
                                    </div>
                                ` : ''}
                                ${hooks.length > 0 ? `
                                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                        ğŸ“ <strong>å»ºè­°é–‹é ­:</strong> ${hooks.slice(0, 2).map(h => `ã€Œ${h}...ã€`).join(' ')}
                                    </div>
                                ` : ''}
                                <div style="font-size: 11px; color: #888;">
                                    æåŠæ•¸: ${topic.mention_count} | ç™¼ç¾æ™‚é–“: ${new Date(topic.discovered_at).toLocaleDateString('zh-TW')}
                                </div>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    container.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 40px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }

            async function loadSuggestions() {
                const container = document.getElementById('suggestionsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const status = document.getElementById('suggestionStatusFilter').value;
                    let url = `${API_BASE}/monitor/recommendations/suggestions?limit=20`;
                    if (status) url += `&status=${status}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) throw new Error(result.error);

                    const suggestions = result.data.suggestions || [];

                    if (suggestions.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ç›®å‰æ²’æœ‰å…§å®¹å»ºè­°</p>';
                        return;
                    }

                    container.innerHTML = suggestions.map(sug => {
                        const statusBadge = {
                            'new': '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">ğŸ†• å¾…è™•ç†</span>',
                            'adopted': '<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">âœ… å·²æ¡ç”¨</span>',
                            'rejected': '<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">âŒ å·²æ‹’çµ•</span>'
                        }[sug.status] || sug.status;

                        return `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 15px;">ğŸ“ ${sug.title}</strong>
                                        ${statusBadge}
                                    </div>
                                    <span style="color: #666; font-size: 12px;">${new Date(sug.created_at).toLocaleDateString('zh-TW')}</span>
                                </div>
                                ${sug.description ? `
                                    <div style="font-size: 13px; color: #333; margin-bottom: 10px;">
                                        ${sug.description}
                                    </div>
                                ` : ''}
                                ${sug.example_post ? `
                                    <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #888; margin-bottom: 5px;">ğŸ’¬ AI ç”Ÿæˆç¯„ä¾‹:</div>
                                        <div style="font-size: 13px; line-height: 1.6; white-space: pre-line;">${sug.example_post.substring(0, 200)}${sug.example_post.length > 200 ? '...' : ''}</div>
                                    </div>
                                ` : ''}
                                ${sug.status === 'new' ? `
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="adoptSuggestion('${sug.id}')" class="btn" style="padding: 6px 14px; font-size: 12px; background: #22c55e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                            âœ“ æ¡ç”¨
                                        </button>
                                        <button onclick="rejectSuggestion('${sug.id}')" class="btn" style="padding: 6px 14px; font-size: 12px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                            âœ— æ‹’çµ•
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    container.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 40px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }

            async function triggerRecommendation() {
                try {
                    showLoading(true);
                    const response = await fetch(`${API_BASE}/monitor/recommendations/generate`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    showLoading(false);

                    if (result.success) {
                        showAlert('dashboardAlert', `æ¨è–¦ç”Ÿæˆå®Œæˆï¼šåˆ†æ ${result.data.topics} å€‹è©±é¡Œï¼Œç”¢ç”Ÿ ${result.data.suggestions} å€‹å»ºè­°`, 'success');
                        loadRecommendData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showLoading(false);
                    showAlert('dashboardAlert', 'ç”Ÿæˆå¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function adoptSuggestion(suggestionId) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/recommendations/suggestions/${suggestionId}/adopt`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('dashboardAlert', 'å·²æ¡ç”¨æ­¤å»ºè­°', 'success');
                        loadSuggestions();
                        loadRecommendStats();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'æ“ä½œå¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function rejectSuggestion(suggestionId) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/recommendations/suggestions/${suggestionId}/reject`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('dashboardAlert', 'å·²æ‹’çµ•æ­¤å»ºè­°', 'success');
                        loadSuggestions();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'æ“ä½œå¤±æ•—: ' + error.message, 'danger');
                }
            }

            // å¾è¡¨å–®å‰µå»ºé—œéµå­—çµ„
            async function createBrandFromForm() {
                const name = document.getElementById('newBrandName').value.trim();
                const keywordsStr = document.getElementById('newBrandKeywords').value.trim();
                const brandType = document.querySelector('input[name="brandType"]:checked').value;

                if (!name || !keywordsStr) {
                    showAlert('dashboardAlert', 'è«‹å¡«å¯«ä¸»é¡Œåç¨±å’Œé—œéµå­—', 'warning');
                    return;
                }

                const keywords = keywordsStr.split(',').map(k => k.trim()).filter(k => k);
                await createBrand(name, keywords, brandType);

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('newBrandName').value = '';
                document.getElementById('newBrandKeywords').value = '';
            }

            // ä¿ç•™èˆŠå‡½æ•¸ä»¥å…¼å®¹ï¼ˆä½†ä¸å†ä½¿ç”¨ï¼‰
            function showAddBrandModal() {
                document.getElementById('newBrandName').focus();
            }

            async function createBrand(name, keywords, brandType) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/brands`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, keywords, brand_type: brandType })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'é—œéµå­—çµ„å·²å»ºç«‹', 'success');
                    loadBrands();
                } catch (error) {
                    showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function deleteBrand(brandId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é—œéµå­—çµ„å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„æåŠè¨˜éŒ„ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) return;

                try {
                    await fetch(`${API_BASE}/monitor/brands/${brandId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadBrands();
                } catch (error) {
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—', 'danger');
                }
            }

            // åˆ‡æ›é—œéµå­—çµ„ç·¨è¼¯å€åŸŸ
            function toggleBrandEdit(brandId) {
                const editDiv = document.getElementById(`brand-edit-${brandId}`);
                if (editDiv) {
                    editDiv.style.display = editDiv.style.display === 'none' ? 'block' : 'none';
                }
            }

            // ç§»é™¤å–®ä¸€é—œéµå­—
            function removeKeyword(brandId, keyword) {
                const brand = window.brandsData[brandId];
                if (!brand) return;

                brand.keywords = brand.keywords.filter(k => k !== keyword);
                renderBrandKeywords(brandId);
            }

            // æ–°å¢é—œéµå­—
            function addKeyword(brandId) {
                const input = document.getElementById(`brand-new-keyword-${brandId}`);
                const keyword = input.value.trim();

                if (!keyword) return;

                const brand = window.brandsData[brandId];
                if (!brand) return;

                if (!brand.keywords.includes(keyword)) {
                    brand.keywords.push(keyword);
                    renderBrandKeywords(brandId);
                }

                input.value = '';
                input.focus();
            }

            // é‡æ–°æ¸²æŸ“é—œéµå­—æ¨™ç±¤
            function renderBrandKeywords(brandId) {
                const container = document.getElementById(`brand-keywords-${brandId}`);
                const brand = window.brandsData[brandId];
                if (!container || !brand) return;

                container.innerHTML = brand.keywords.map(kw => `
                    <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
                        ${escapeHtml(kw)}
                        <button onclick="removeKeyword('${brandId}', '${kw.replace(/'/g, "\\'")}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; padding: 0; line-height: 1;">Ã—</button>
                    </span>
                `).join('');
            }

            // å„²å­˜é—œéµå­—çµ„ç·¨è¼¯
            async function saveBrandEdit(brandId) {
                const brand = window.brandsData[brandId];
                if (!brand) return;

                if (brand.keywords.length === 0) {
                    showAlert('dashboardAlert', 'è‡³å°‘éœ€è¦ä¸€å€‹é—œéµå­—', 'warning');
                    return;
                }

                const isActive = document.getElementById(`brand-active-${brandId}`).value === 'true';

                try {
                    const response = await fetch(`${API_BASE}/monitor/brands/${brandId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            keywords: brand.keywords,
                            is_active: isActive
                        })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'é—œéµå­—çµ„å·²æ›´æ–°', 'success');
                    loadBrands();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ›´æ–°å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // è¼‰å…¥é è¨­ä¾†æºæ¨¡æ¿ï¼ˆå¤šé¸ï¼‰
            async function loadSourceTemplates() {
                const container = document.getElementById('sourceTemplatesList');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE}/monitor/templates`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    const templates = result.data || [];

                    if (templates.length === 0) {
                        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); grid-column: span 2; text-align: center; margin: 0;">å°šç„¡é è¨­ä¾†æº</p>';
                        return;
                    }

                    container.innerHTML = templates.map(t => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.15); border-radius: 6px; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" value="${t.id}" data-name="${escapeHtml(t.name)}" data-url="${escapeHtml(t.url)}" data-platform="${t.platform}" style="width: 16px; height: 16px;">
                            <span>${escapeHtml(t.name)}</span>
                        </label>
                    `).join('');
                } catch (error) {
                    container.innerHTML = '<p style="color: #ff6b6b; grid-column: span 2; text-align: center; margin: 0;">è¼‰å…¥å¤±æ•—</p>';
                }
            }

            // æ–°å¢é¸å–çš„é è¨­ä¾†æºï¼ˆå¯å¤šé¸ï¼‰
            async function addSelectedSources() {
                const checkboxes = document.querySelectorAll('#sourceTemplatesList input[type="checkbox"]:checked');

                if (checkboxes.length === 0) {
                    showAlert('dashboardAlert', 'è«‹å…ˆå‹¾é¸è¦æ–°å¢çš„ä¾†æº', 'warning');
                    return;
                }

                let successCount = 0;
                for (const checkbox of checkboxes) {
                    try {
                        await createSource(checkbox.dataset.name, checkbox.dataset.url, checkbox.dataset.platform);
                        successCount++;
                        checkbox.checked = false; // å–æ¶ˆå‹¾é¸
                    } catch (error) {
                        console.error('Failed to add source:', error);
                    }
                }

                showAlert('dashboardAlert', `æˆåŠŸæ–°å¢ ${successCount} å€‹ä¾†æº`, 'success');
                loadSources();
            }

            // è¡¨å–®å‰µå»ºä¾†æº
            async function createSourceFromForm() {
                const name = document.getElementById('newSourceName').value.trim();
                const url = document.getElementById('newSourceUrl').value.trim();
                const platform = document.getElementById('newSourcePlatform').value;
                const checkInterval = parseInt(document.getElementById('newSourceInterval').value) || 24;

                if (!name || !url) {
                    showAlert('dashboardAlert', 'è«‹å¡«å¯«åç¨±å’Œç¶²å€', 'warning');
                    return;
                }

                await createSource(name, url, platform, checkInterval);

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('newSourceName').value = '';
                document.getElementById('newSourceUrl').value = '';
                document.getElementById('newSourceInterval').value = '24';
            }

            // ä¿ç•™èˆŠå‡½æ•¸ï¼ˆä½†æ”¹ç‚ºå‘¼å«æ–°å‡½æ•¸ï¼‰
            async function showSourceTemplates() {
                loadSourceTemplates();
            }

            function showAddSourceModal() {
                document.getElementById('newSourceName').focus();
            }

            async function createSource(name, url, platform, checkInterval = 24) {
                try {
                    // å–å¾—æ‰€æœ‰é—œéµå­—çµ„ ID
                    const brandsRes = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const brandsResult = await brandsRes.json();
                    const brandIds = (brandsResult.data || []).map(b => b.id);

                    const response = await fetch(`${API_BASE}/monitor/sources`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            url,
                            platform,
                            brand_ids: brandIds,
                            check_interval_hours: checkInterval
                        })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'ä¾†æºå·²å»ºç«‹', 'success');
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'danger');
                }
            }

            async function deleteSource(sourceId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä¾†æºå—ï¼Ÿ')) return;

                try {
                    await fetch(`${API_BASE}/monitor/sources/${sourceId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—', 'danger');
                }
            }

            // åˆ‡æ›ä¾†æºç·¨è¼¯å€åŸŸ
            function toggleSourceEdit(sourceId) {
                const editDiv = document.getElementById(`source-edit-${sourceId}`);
                if (editDiv) {
                    editDiv.style.display = editDiv.style.display === 'none' ? 'block' : 'none';
                }
            }

            // å„²å­˜ä¾†æºç·¨è¼¯
            async function saveSourceEdit(sourceId) {
                const interval = parseInt(document.getElementById(`source-interval-${sourceId}`).value);
                const isActive = document.getElementById(`source-active-${sourceId}`).value === 'true';

                try {
                    const response = await fetch(`${API_BASE}/monitor/sources/${sourceId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            check_interval_hours: interval,
                            is_active: isActive
                        })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', 'ä¾†æºè¨­å®šå·²æ›´æ–°', 'success');
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ›´æ–°å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // é˜²æ­¢é‡è¤‡é»æ“Šçš„ç‹€æ…‹è¿½è¹¤
            const crawlingSourceIds = new Set();

            async function triggerCrawl(sourceId) {
                // é˜²æ­¢é‡è¤‡é»æ“Š
                if (crawlingSourceIds.has(sourceId)) {
                    return;
                }

                crawlingSourceIds.add(sourceId);

                // ç¦ç”¨æŒ‰éˆ•
                const btn = document.getElementById(`crawl-btn-${sourceId}`);
                const resultDiv = document.getElementById(`crawl-result-${sourceId}`);

                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = 'â³ çˆ¬å–ä¸­...';
                }

                // é¡¯ç¤ºçˆ¬å–ä¸­ç‹€æ…‹
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#fef3c7';
                    resultDiv.style.color = '#92400e';
                    resultDiv.innerHTML = 'â³ æ­£åœ¨çˆ¬å–ä¸­ï¼Œè«‹ç¨å€™...';
                }

                try {
                    showAlert('dashboardAlert', 'æ­£åœ¨çˆ¬å–ï¼Œè«‹ç¨å€™...', 'info');

                    const response = await fetch(`${API_BASE}/monitor/crawl`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ source_id: sourceId })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    // é¡¯ç¤ºè©³ç´°çµæœ
                    const data = result.data || {};
                    let bgColor = '#d1fae5';
                    let textColor = '#065f46';
                    let statusIcon = 'âœ…';
                    let statusText = 'çˆ¬å–æˆåŠŸ';

                    // æ ¹æ“š crawlStatus æ±ºå®šé¡¯ç¤ºæ¨£å¼
                    const crawlStatus = data.crawlStatus || 'success';

                    if (crawlStatus === 'queued_for_local') {
                        statusIcon = 'ğŸ“¡';
                        statusText = 'å·²æ’å…¥æœ¬æ©Ÿçˆ¬èŸ²ä½‡åˆ—';
                        bgColor = '#e0f2fe';
                        textColor = '#0369a1';
                    } else if (crawlStatus === 'no_brands') {
                        statusIcon = 'âš ï¸';
                        statusText = 'æœªè¨­å®šé—œéµå­—çµ„';
                        bgColor = '#fef3c7';
                        textColor = '#92400e';
                    } else if (crawlStatus === 'failed') {
                        statusIcon = 'âŒ';
                        statusText = 'çˆ¬å–å¤±æ•—';
                        bgColor = '#fee2e2';
                        textColor = '#991b1b';
                    } else if (crawlStatus === 'no_content') {
                        statusIcon = 'âš ï¸';
                        statusText = 'æŠ“åˆ°é€£çµä½†æ²’æœ‰å…§å®¹';
                        bgColor = '#fef3c7';
                        textColor = '#92400e';
                    } else if (crawlStatus === 'partial') {
                        statusIcon = 'âš¡';
                        statusText = 'éƒ¨åˆ†æˆåŠŸ';
                        bgColor = '#e0f2fe';
                        textColor = '#0369a1';
                    } else if (data.newMentions > 0) {
                        statusIcon = 'ğŸ‰';
                        statusText = 'ç™¼ç¾æ–°æåŠï¼';
                        loadMentions();
                    } else if (data.articlesFound === 0) {
                        statusIcon = 'âš ï¸';
                        statusText = 'æœªæŠ“åˆ°æ–‡ç« ';
                        bgColor = '#fef3c7';
                        textColor = '#92400e';
                    } else {
                        bgColor = '#e0f2fe';
                        textColor = '#0369a1';
                    }

                    // æ§‹å»ºè©³ç´°çµ±è¨ˆ
                    const articlesWithContent = data.articlesWithContent || 0;
                    const articlesUrlOnly = data.articlesUrlOnly || 0;

                    let statsHtml = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">${statusIcon}</span>
                            <div>
                                <strong style="font-size: 15px;">${statusText}</strong>
                                ${data.statusMessage ? `<div style="font-size: 12px; margin-top: 3px; opacity: 0.9;">${data.statusMessage}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; text-align: center;">
                            <div style="background: rgba(255,255,255,0.5); padding: 8px 4px; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold;">${data.articlesFound || 0}</div>
                                <div style="font-size: 10px; opacity: 0.8;">æŠ“åˆ°æ–‡ç« </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.5); padding: 8px 4px; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: ${articlesWithContent > 0 ? '#059669' : '#dc2626'};">${articlesWithContent}</div>
                                <div style="font-size: 10px; opacity: 0.8;">æœ‰å…§å®¹</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.5); padding: 8px 4px; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: ${articlesUrlOnly > 0 ? '#dc2626' : 'inherit'};">${articlesUrlOnly}</div>
                                <div style="font-size: 10px; opacity: 0.8;">åƒ…é€£çµ</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.5); padding: 8px 4px; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: ${data.newMentions > 0 ? '#059669' : 'inherit'};">${data.newMentions || 0}</div>
                                <div style="font-size: 10px; opacity: 0.8;">æ–°æåŠ</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.5); padding: 8px 4px; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold;">${data.duplicateSkipped || 0}</div>
                                <div style="font-size: 10px; opacity: 0.8;">é‡è¤‡</div>
                            </div>
                        </div>
                    `;

                    // é¡¯ç¤ºé—œéµå­—åˆ—è¡¨
                    if (data.keywordsChecked && data.keywordsChecked.length > 0) {
                        const keywordsList = data.keywordsChecked.slice(0, 5).join('ã€');
                        const moreCount = data.keywordsChecked.length > 5 ? ` ç­‰ ${data.keywordsChecked.length} å€‹` : '';
                        statsHtml += `<div style="margin-top: 8px; font-size: 11px; opacity: 0.8;">ğŸ” æ¯”å°é—œéµå­—ï¼š${keywordsList}${moreCount}</div>`;
                    }

                    if (data.newMentions > 0) {
                        statsHtml += `<div style="margin-top: 8px; font-size: 12px; font-weight: bold;">ğŸ‘‰ å‰å¾€ã€ŒæåŠåˆ—è¡¨ã€æŸ¥çœ‹è©³æƒ…</div>`;
                    }

                    // é¡¯ç¤ºåœ¨ä¾†æºå¡ç‰‡ä¸‹æ–¹
                    if (resultDiv) {
                        resultDiv.style.display = 'block';
                        resultDiv.style.background = bgColor;
                        resultDiv.style.color = textColor;
                        resultDiv.innerHTML = statsHtml;
                    }

                    loadSources();
                } catch (error) {
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯åœ¨ä¾†æºå¡ç‰‡ä¸‹æ–¹
                    if (resultDiv) {
                        resultDiv.style.display = 'block';
                        resultDiv.style.background = '#fee2e2';
                        resultDiv.style.color = '#991b1b';
                        resultDiv.innerHTML = `âŒ çˆ¬å–å¤±æ•—: ${error.message}`;
                    }
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    crawlingSourceIds.delete(sourceId);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ”„ çˆ¬å–';
                    }
                }
            }

            // ä¿®å¾©æ‰€æœ‰å“ç‰Œèˆ‡ä¾†æºçš„é—œè¯
            async function relinkAllBrandsSources() {
                const btn = document.getElementById('relinkBtn');
                if (btn.disabled) return;

                if (!confirm('é€™æœƒå°‡æ‰€æœ‰é—œéµå­—çµ„é—œè¯åˆ°æ‰€æœ‰ä¾†æºã€‚\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;

                btn.disabled = true;
                btn.innerHTML = 'â³ è™•ç†ä¸­...';

                try {
                    const response = await fetch(`${API_BASE}/monitor/relink-all`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const data = result.data || {};
                    showAlert('dashboardAlert',
                        `âœ… é—œè¯ä¿®å¾©å®Œæˆ\n` +
                        `ğŸ“¦ é—œéµå­—çµ„: ${data.brands} å€‹\n` +
                        `ğŸŒ ä¾†æº: ${data.sources} å€‹\n` +
                        `ğŸ”— æ–°å¢é—œè¯: ${data.linksCreated} å€‹\n` +
                        `â­ï¸ å·²å­˜åœ¨: ${data.linksSkipped} å€‹`,
                        'success'
                    );

                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'ä¿®å¾©å¤±æ•—: ' + error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ”— ä¿®å¾©é—œè¯';
                }
            }

            // æ¸…é™¤æ‰€æœ‰ Dcard ä¾†æº
            async function deleteAllDcardSources() {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ Dcard ä¾†æºå—ï¼Ÿ\n\nåˆªé™¤å¾Œå¯ä»¥å¾ã€Œé è¨­ä¾†æºã€é‡æ–°æ–°å¢ï¼ˆåç¨±æœƒæ¨™ç¤ºã€Œæœ€æ–°ã€ï¼‰')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/monitor/sources/delete-by-platform`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ platform: 'dcard' })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', `âœ… å·²åˆªé™¤ ${result.data.deleted} å€‹ Dcard ä¾†æº`, 'success');
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
                }
            }

            // ç•¶åˆ‡æ›åˆ° monitor tab æ™‚è¼‰å…¥è³‡æ–™
            const originalSwitchTab = switchTab;
            switchTab = function (tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'monitor') {
                    loadMentions();
                    loadBrands();
                }
            };

            // ========================================
            // è²é‡é€±å ±åŠŸèƒ½
            // ========================================

            async function loadWeeklyReport() {
                const container = document.getElementById('weeklyReportContent');
                const weeksAgo = document.getElementById('weeklyReportWeeks').value;
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/weekly-report?weeks_ago=${weeksAgo}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const report = result.data;
                    const { period, summary, by_brand, by_source, top_keywords, top_titles } = report;

                    const changeIcon = summary.change_percent >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                    const changeColor = summary.change_percent >= 0 ? '#22c55e' : '#ef4444';
                    const changeText = summary.change_percent >= 0 ? `+${summary.change_percent}%` : `${summary.change_percent}%`;

                    container.innerHTML = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">ğŸ“… ${period.start} ~ ${period.end}</div>
                            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 28px; font-weight: bold; color: #333;">${summary.total_mentions}</div>
                                    <div style="font-size: 12px; color: #666;">æœ¬é€±æåŠæ•¸</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold; color: ${changeColor};">${changeIcon} ${changeText}</div>
                                    <div style="font-size: 12px; color: #666;">ç›¸æ¯”ä¸Šé€± (${summary.prev_week_mentions} ç¯‡)</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- å“ç‰Œè²é‡ -->
                            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                                <h5 style="margin: 0 0 15px 0; font-size: 14px;">ğŸ·ï¸ å“ç‰Œè²é‡</h5>
                                ${by_brand.length > 0 ? by_brand.slice(0, 5).map(b => {
                                    const icon = b.change_percent >= 0 ? 'â†‘' : 'â†“';
                                    const color = b.change_percent >= 0 ? '#22c55e' : '#ef4444';
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                                            <span>${b.brand_name}</span>
                                            <span><strong>${b.mention_count}</strong> <span style="color: ${color}; font-size: 12px;">${icon}${Math.abs(b.change_percent)}%</span></span>
                                        </div>
                                    `;
                                }).join('') : '<p style="color: #999;">æš«ç„¡æ•¸æ“š</p>'}
                            </div>

                            <!-- ä¾†æºåˆ†å¸ƒ -->
                            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                                <h5 style="margin: 0 0 15px 0; font-size: 14px;">ğŸŒ ä¾†æºåˆ†å¸ƒ</h5>
                                ${by_source.length > 0 ? by_source.slice(0, 5).map(s => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                                        <span>${s.source_name} <span style="font-size: 11px; color: #999;">(${s.platform})</span></span>
                                        <strong>${s.mention_count}</strong>
                                    </div>
                                `).join('') : '<p style="color: #999;">æš«ç„¡æ•¸æ“š</p>'}
                            </div>
                        </div>

                        <!-- ç†±é–€é—œéµè© -->
                        <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h5 style="margin: 0 0 15px 0; font-size: 14px;">ğŸ”¥ ç†±é–€é—œéµè©</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${top_keywords.length > 0 ? top_keywords.map(k => `
                                    <span style="background: #f3f4f6; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                                        ${k.keyword} <span style="color: #666;">(${k.count})</span>
                                    </span>
                                `).join('') : '<p style="color: #999;">æš«ç„¡æ•¸æ“š</p>'}
                            </div>
                        </div>

                        <!-- ç†±é–€æ–‡ç«  -->
                        ${top_titles.length > 0 ? `
                        <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                            <h5 style="margin: 0 0 15px 0; font-size: 14px;">ğŸ“° ç†±é–€æ–‡ç« </h5>
                            ${top_titles.slice(0, 5).map(t => `
                                <div style="padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                                    <a href="${t.url}" target="_blank" style="color: #2563eb; text-decoration: none;">${t.title}</a>
                                    <span style="font-size: 11px; color: #999; margin-left: 10px;">${t.brand}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    `;

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }

            async function sendWeeklyReportToLine() {
                const weeksAgo = document.getElementById('weeklyReportWeeks').value;

                if (!confirm('ç¢ºå®šè¦å°‡é€±å ±ç™¼é€åˆ° LINE å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`${API_BASE}/monitor/weekly-report/send`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ weeks_ago: Number(weeksAgo) })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    alert('âœ… é€±å ±å·²ç™¼é€åˆ° LINEï¼');
                } catch (error) {
                    alert('ç™¼é€å¤±æ•—: ' + error.message);
                }
            }

            // ========================================
            // çˆ¬å–æ—¥èªŒåŠŸèƒ½
            // ========================================

            async function loadCrawlLogs() {
                const container = document.getElementById('crawlLogsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/crawl-logs?limit=20`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const logs = result.data || [];

                    if (logs.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">å°šç„¡çˆ¬å–è¨˜éŒ„</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 10px; text-align: left;">æ™‚é–“</th>
                                    <th style="padding: 10px; text-align: left;">ä¾†æº</th>
                                    <th style="padding: 10px; text-align: center;">ç‹€æ…‹</th>
                                    <th style="padding: 10px; text-align: center;">æ‰¾åˆ°æ–‡ç« </th>
                                    <th style="padding: 10px; text-align: center;">æ–°æåŠ</th>
                                    <th style="padding: 10px; text-align: left;">éŒ¯èª¤è¨Šæ¯</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => {
                                    const statusColor = log.status === 'success' ? '#22c55e' :
                                                       log.status === 'failed' ? '#ef4444' :
                                                       log.status === 'skipped' ? '#f59e0b' : '#6b7280';
                                    const statusText = log.status === 'success' ? 'æˆåŠŸ' :
                                                      log.status === 'failed' ? 'å¤±æ•—' :
                                                      log.status === 'skipped' ? 'è·³é' :
                                                      log.status === 'running' ? 'åŸ·è¡Œä¸­' : log.status;
                                    return `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 10px;">${new Date(log.started_at).toLocaleString('zh-TW')}</td>
                                            <td style="padding: 10px;">${log.source_name || '-'}</td>
                                            <td style="padding: 10px; text-align: center;">
                                                <span style="padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; color: white; background: ${statusColor};">
                                                    ${statusText}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; text-align: center;">${log.articles_found || 0}</td>
                                            <td style="padding: 10px; text-align: center; font-weight: 600; color: ${log.new_mentions > 0 ? '#22c55e' : '#6b7280'};">
                                                ${log.new_mentions || 0}
                                            </td>
                                            <td style="padding: 10px; color: #ef4444; font-size: 12px;">${log.error_message || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }

            // ========================================
            // Google Trends åŠŸèƒ½

            // ========================================
            // Google OAuth ç™»å…¥
            // ========================================

            let googleTokenClient = null;

            async function initGoogleLogin() {
                try {
                    const res = await fetch(`${API_BASE}/config/public`);
                    const data = await res.json();
                    if (!data.googleClientId) return;

                    // ç­‰å¾… Google SDK è¼‰å…¥
                    function tryInit() {
                        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                            setTimeout(tryInit, 200);
                            return;
                        }
                        // ä½¿ç”¨ oauth2 token clientï¼ˆé¿å… GSI renderButton çš„ postMessage bugï¼‰
                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: data.googleClientId,
                            scope: 'email profile openid',
                            callback: handleGoogleTokenResponse,
                        });
                        // é¡¯ç¤ºè‡ªè¨‚æŒ‰éˆ•
                        const btn = document.getElementById('googleSignInBtn');
                        if (btn) btn.style.display = 'inline-flex';
                    }
                    tryInit();
                } catch (e) {
                    console.warn('Google login init failed:', e);
                }
            }

            function googleSignIn() {
                if (googleTokenClient) {
                    googleTokenClient.requestAccessToken();
                }
            }

            async function handleGoogleTokenResponse(tokenResponse) {
                if (!tokenResponse || !tokenResponse.access_token) {
                    showAlert('loginAlert', 'Google ç™»å…¥å¤±æ•—ï¼šæœªå–å¾—æ†‘è­‰', 'error');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/auth/google`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ access_token: tokenResponse.access_token })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        token = data.token;
                        localStorage.setItem('token', token);
                        showDashboard(data.user);
                    } else if (res.status === 403 && data.pendingApproval) {
                        showAlert('loginAlert', 'å¸³è™Ÿå·²å»ºç«‹ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸å¾Œæ‰èƒ½ç™»å…¥ã€‚', 'error');
                    } else {
                        showAlert('loginAlert', data.error || 'Google ç™»å…¥å¤±æ•—', 'error');
                    }
                } catch (error) {
                    showAlert('loginAlert', 'Google ç™»å…¥å¤±æ•—: ' + error.message, 'error');
                }
            }

            // ========================================
            // ä½¿ç”¨è€…ç®¡ç†ï¼ˆAdminï¼‰
            // ========================================

            async function loadUsers() {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>';

                try {
                    const res = await fetch(`${API_BASE}/admin/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
                    const data = await res.json();

                    if (!data.users || data.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:#999;">æ²’æœ‰ä½¿ç”¨è€…</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.users.map(u => `
                        <tr style="border-bottom:1px solid #e1e8ed;">
                            <td style="padding:12px;font-weight:500;">${escapeHtml(u.name)}</td>
                            <td style="padding:12px;">${escapeHtml(u.email)}</td>
                            <td style="padding:12px;">${u.google_id ? '<span style="color:#4285F4;">Google</span>' : 'å¯†ç¢¼'}</td>
                            <td style="padding:12px;">
                                <span class="status-badge status-${u.status}">${u.status === 'ACTIVE' ? 'å•Ÿç”¨' : 'åœç”¨'}</span>
                            </td>
                            <td style="padding:12px;">${u.roles.length > 0 ? u.roles.join(', ') : '<span style="color:#999;">ç„¡è§’è‰²</span>'}</td>
                            <td style="padding:12px;font-size:13px;color:#666;">${new Date(u.created_at).toLocaleString('zh-TW')}</td>
                            <td style="padding:12px;">
                                ${u.status === 'DISABLED' ? `<button class="btn btn-success btn-small" onclick="approveUser('${u.id}')">æ ¸å‡†</button>` : ''}
                                ${u.status === 'ACTIVE' ? `<button class="btn btn-danger btn-small" onclick="disableUser('${u.id}')">åœç”¨</button>` : ''}
                                <button class="btn btn-secondary btn-small" onclick="showRoleEditor('${u.id}', ${JSON.stringify(u.roles).replace(/"/g, '&quot;')})">è§’è‰²</button>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    tbody.innerHTML = `<tr><td colspan="7" style="padding:40px;text-align:center;color:#dc3545;">${error.message}</td></tr>`;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function approveUser(userId) {
                try {
                    const res = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ status: 'ACTIVE' })
                    });
                    if (!res.ok) throw new Error((await res.json()).error);
                    showAlert('dashboardAlert', 'ä½¿ç”¨è€…å·²æ ¸å‡†', 'success');
                    loadUsers();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
                }
            }

            async function disableUser(userId) {
                if (!confirm('ç¢ºå®šè¦åœç”¨æ­¤ä½¿ç”¨è€…å—ï¼Ÿ')) return;
                try {
                    const res = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ status: 'DISABLED' })
                    });
                    if (!res.ok) throw new Error((await res.json()).error);
                    showAlert('dashboardAlert', 'ä½¿ç”¨è€…å·²åœç”¨', 'success');
                    loadUsers();
                } catch (error) {
                    showAlert('dashboardAlert', 'åœç”¨å¤±æ•—: ' + error.message, 'error');
                }
            }

            function showRoleEditor(userId, currentRoles) {
                const allRoles = ['admin', 'content_creator', 'reviewer'];
                const checkboxes = allRoles.map(r =>
                    `<label style="display:block;margin:8px 0;cursor:pointer;">
                        <input type="checkbox" value="${r}" ${currentRoles.includes(r) ? 'checked' : ''} style="margin-right:8px;">
                        ${r}
                    </label>`
                ).join('');

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:400px;">
                        <div class="modal-header">
                            <h2>ç·¨è¼¯è§’è‰²</h2>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                        </div>
                        <div id="roleCheckboxes">${checkboxes}</div>
                        <div style="margin-top:20px;text-align:right;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                            <button class="btn" onclick="updateUserRoles('${userId}', this.closest('.modal'))">å„²å­˜</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function updateUserRoles(userId, modalEl) {
                const checkboxes = modalEl.querySelectorAll('#roleCheckboxes input[type=checkbox]:checked');
                const roles = Array.from(checkboxes).map(cb => cb.value);

                try {
                    const res = await fetch(`${API_BASE}/admin/users/${userId}/roles`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ roles })
                    });
                    if (!res.ok) throw new Error((await res.json()).error);
                    modalEl.remove();
                    showAlert('dashboardAlert', 'è§’è‰²å·²æ›´æ–°', 'success');
                    loadUsers();
                } catch (error) {
                    showAlert('dashboardAlert', 'æ›´æ–°è§’è‰²å¤±æ•—: ' + error.message, 'error');
                }
            }
        </script>
</body>

</html>