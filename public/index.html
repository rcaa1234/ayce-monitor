<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ± - ç®¡ç†ä»‹é¢</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .user-info {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .user-info p {
            color: #333;
            margin: 5px 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-section,
        .dashboard {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sub-tabs styling */
        .sub-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 15px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .sub-tab-content {
            display: none;
            padding-top: 20px;
        }

        .sub-tab-content.active {
            display: block;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .post-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .post-card .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-DRAFT {
            background: #e9ecef;
            color: #495057;
        }

        .status-GENERATING {
            background: #fff3cd;
            color: #856404;
        }

        .status-PENDING_REVIEW {
            background: #cce5ff;
            color: #004085;
        }

        .status-APPROVED {
            background: #d4edda;
            color: #155724;
        }

        .status-POSTED {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-FAILED {
            background: #f8d7da;
            color: #721c24;
        }

        .post-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            min-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Smart Scheduling Styles */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .template-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .template-card.disabled {
            opacity: 0.6;
            background: #f9fafb;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .template-description {
            font-size: 14px;
            color: #6b7280;
        }

        .template-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-enabled {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .template-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .template-prompt {
            font-size: 14px;
            color: #374151;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            max-height: 80px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-actions .btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 13px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        .config-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
        }

        .config-card h3 {
            color: #111827;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h4 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 13px;
            opacity: 0.9;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .schedule-date {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .schedule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-generated {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-posted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .schedule-info-item {
            color: #6b7280;
        }

        .schedule-info-item strong {
            color: #111827;
        }

        .schedule-reason {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
            border-left: 3px solid #667eea;
        }

        .schedule-reason strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .preview-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
            color: #1f2937;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }

        .preview-loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .preview-loading .spinner-small {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-test {
            background: #10b981;
            color: white;
        }

        .btn-test:hover {
            background: #059669;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸš€ Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ±</h1>
            <p>AI é©…å‹•çš„å…§å®¹ç”Ÿæˆèˆ‡ç™¼å¸ƒç®¡ç†å¹³å°</p>
            <div id="userInfo" class="user-info">
                <p><strong>ä½¿ç”¨è€…:</strong> <span id="userName"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>è§’è‰²:</strong> <span id="userRoles"></span></p>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px;">ç™»å…¥ç³»çµ±</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">ç™»å…¥</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">ğŸ“Š ç¸½è¦½</button>
                <button class="tab" onclick="switchTab('scheduling')">ğŸ“… ç™¼æ–‡æ’ç¨‹</button>
                <button class="tab" onclick="switchTab('templates')">ğŸ“ æ¨¡æ¿è¨­å®š</button>
                <button class="tab" onclick="switchTab('accounts')">ğŸ‘¤ Threads å¸³è™Ÿ</button>
            </div>

            <!-- Alert Area -->
            <div id="dashboardAlert"></div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">è™•ç†ä¸­...</p>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <!-- System Overview -->
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px;">ç³»çµ±ç¸½è¦½</h2>
                    <div class="stats" id="stats">
                        <div class="stat-card">
                            <h3 id="totalPosts">0</h3>
                            <p>ç¸½è²¼æ–‡æ•¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="draftPosts">0</h3>
                            <p>è‰ç¨¿</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingPosts">0</h3>
                            <p>å¾…å¯©æ ¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="postedPosts">0</h3>
                            <p>å·²ç™¼å¸ƒ</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div>
                    <h2 style="margin-bottom: 20px;">è²¼æ–‡çµ±è¨ˆ</h2>

                    <!-- Statistics Sub-tabs -->
                    <div
                        style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                        <button class="stats-sub-tab active" onclick="switchStatsTab('summary')"
                            style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“Š æ‘˜è¦
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('templates')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“ æ¨£æ¿
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('timeslots')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            â° æ™‚æ®µ
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('details')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“‹ æ˜ç´°
                        </button>
                    </div>

                    <!-- Statistics Summary Sub-tab -->
                    <div id="statsSummaryTab" class="stats-sub-content active"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">æ•´é«”è¡¨ç¾</h3>

                        <!-- Key Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalPosts">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å·²ç™¼å¸ƒè²¼æ–‡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalViews">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½è§€çœ‹æ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalLikes">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½æŒ‰è®šæ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;"
                                    id="statsAvgEngagement">-</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å¹³å‡åƒèˆ‡ç‡</div>
                            </div>
                        </div>

                        <!-- Trend Chart -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0;">è¶¨å‹¢åœ–</h4>
                                <select id="trendDaysSelect" onchange="loadStatsSummary()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                                    <option value="30">æœ€è¿‘ 30 å¤©</option>
                                    <option value="90">æœ€è¿‘ 90 å¤©</option>
                                    <option value="180">æœ€è¿‘ 180 å¤©</option>
                                </select>
                            </div>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="stats7DayChart"></canvas>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div id="statsSyncStatus"
                            style="background: white; padding: 15px; border-radius: 8px; font-size: 13px; color: #666;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div>ä¸Šæ¬¡åŒæ­¥: <span id="statsLastSync">-</span></div>
                                    <div style="margin-top: 5px;">å·²åŒæ­¥è²¼æ–‡: <span id="statsSyncedCount">-</span> ç¯‡</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="syncThreadsPosts()"
                                        style="padding: 5px 12px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ“¥ åŒ¯å…¥æ­·å²è²¼æ–‡
                                    </button>
                                    <button onclick="triggerManualSync()"
                                        style="padding: 5px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ”„ åŒæ­¥äº’å‹•æ•¸æ“š
                                    </button>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #999;">
                                ğŸ’¡ æç¤ºï¼šã€ŒåŒ¯å…¥æ­·å²è²¼æ–‡ã€æœƒå¾æ‚¨çš„ Threads å¸³è™ŸæŠ“å–æœ€è¿‘ 50 ç¯‡è²¼æ–‡åŠå…¶äº’å‹•æ•¸æ“šã€‚
                            </p>
                        </div>
                    </div>

                    <!-- Statistics Templates Sub-tab -->
                    <div id="statsTemplatesTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">æ¨£æ¿åˆ†æ</h3>
                        <div id="statsTemplatesList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- Statistics Timeslots Sub-tab -->
                    <div id="statsTimeslotsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">æ™‚æ®µåˆ†æ</h3>
                        <div id="statsTimeslotsList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- Statistics Details Sub-tab -->
                    <div id="statsDetailsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">è²¼æ–‡æ˜ç´°</h3>

                        <!-- Export Button -->
                        <div style="margin-bottom: 15px; text-align: right;">
                            <button onclick="exportStatsToCSV()"
                                style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                ğŸ“¥ åŒ¯å‡º CSV
                            </button>
                        </div>

                        <div id="statsDetailsList" style="max-height: 450px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- Scheduling Tab (NEW - with sub-tabs) -->
                <div id="schedulingTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">ç™¼æ–‡æ’ç¨‹ç®¡ç†</h2>

                    <!-- Internal Sub-tabs -->
                    <div class="sub-tabs"
                        style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                        <button class="sub-tab active" onclick="switchSchedulingSubTab('ucb')">ğŸ¤– UCBæ™ºèƒ½æ’ç¨‹</button>
                        <button class="sub-tab" onclick="switchSchedulingSubTab('manual')">ğŸ–Šï¸ æ‰‹å‹•å»ºç«‹</button>
                    </div>

                    <!-- UCB Smart Schedule Sub-tab -->
                    <div id="ucbSubTab" class="sub-tab-content active">
                        <h3 style="margin-bottom: 20px;">UCB æ™ºèƒ½æ’ç¨‹é…ç½®</h3>
                        <p style="color: #666; margin-bottom: 20px;">ä½¿ç”¨ UCB (Upper Confidence Bound) æ¼”ç®—æ³•è‡ªå‹•å„ªåŒ–æ¨¡æ¿é¸æ“‡èˆ‡ç™¼æ–‡æ™‚é–“
                        </p>

                        <!-- Threads Account Selection (Shared) -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">ç™¼å¸ƒå¸³è™Ÿ</h3>
                            <div class="form-group">
                                <label>é¸æ“‡ Threads å¸³è™Ÿ</label>
                                <select id="ucbThreadsAccount" class="form-control"
                                    style="padding: 12px; font-size: 16px;">
                                    <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                                </select>
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                    UCB æ™ºèƒ½æ’ç¨‹å°‡ç™¼å¸ƒåˆ°æ­¤å¸³è™Ÿã€‚æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                                </p>
                            </div>
                        </div>

                        <!-- LINE Notification Settings (Shared) -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">LINE é€šçŸ¥è¨­å®š</h3>
                            <div class="form-group">
                                <label>LINE User ID (æ¥æ”¶å¯©æ ¸é€šçŸ¥)</label>
                                <input type="text" id="ucbLineNotifyUserId" class="form-control"
                                    placeholder="è«‹è¼¸å…¥ LINE User ID" style="padding: 12px; font-size: 16px;">
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                    UCB ç”Ÿæˆæ–‡ç« å¾Œï¼Œç³»çµ±æœƒç™¼é€ LINE è¨Šæ¯åˆ°æ­¤å¸³è™Ÿé€²è¡Œå¯©æ ¸ã€‚<br>
                                    å¦‚ä½•å–å¾— LINE User ID: è«‹åŠ å…¥ LINE Bot ç‚ºå¥½å‹ï¼Œç™¼é€ã€Œ/myidã€æˆ–ã€Œæˆ‘çš„IDã€æˆ–ã€ŒæŸ¥è©¢IDã€å³å¯å–å¾—
                                </p>
                            </div>
                            <button class="btn btn-secondary" onclick="testUCBLineNotification()"
                                style="margin-top: 10px;">æ¸¬è©¦ LINE é€šçŸ¥</button>
                        </div>

                        <div class="config-grid">
                            <!-- Left: Configuration Form -->
                            <div class="config-card">
                                <h3>UCB åƒæ•¸è¨­å®š</h3>
                                <form id="ucb-config-form" onsubmit="saveUCBConfig(event)">
                                    <div class="form-group">
                                        <label>åƒèˆ‡ UCB çš„æ¨¡æ¿</label>
                                        <div id="ucb-templates-selector"
                                            style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fafafa;">
                                            <p style="color: #999; text-align: center;">è¼‰å…¥ä¸­...</p>
                                        </div>
                                        <small style="color: #0066cc; margin-top: 5px; display: block;">
                                            âš ï¸ åªæœ‰ã€Œå•Ÿç”¨ã€ä¸”ã€Œè¢«å‹¾é¸ã€çš„æ¨¡æ¿æ‰æœƒåƒèˆ‡ UCB æ¼”ç®—æ³•ã€‚å»ºè­°è‡³å°‘é¸æ“‡ 3 å€‹æ¨¡æ¿ä»¥ç²å¾—æ›´å¥½çš„å„ªåŒ–æ•ˆæœ
                                        </small>
                                    </div>

                                    <div class="form-group">
                                        <label for="exploration-factor">æ¢ç´¢ä¿‚æ•¸ (1.0-2.0)</label>
                                        <input type="number" id="exploration-factor" min="1.0" max="2.0" step="0.1"
                                            value="1.5" required>
                                        <small>æ•¸å€¼è¶Šé«˜ï¼Œç³»çµ±è¶Šé¡˜æ„å˜—è©¦æ–°æ¨¡æ¿ï¼ˆæ¢ç´¢æ€§å¼·ï¼‰</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="min-trials">æœ€å°‘è©¦é©—æ¬¡æ•¸</label>
                                        <input type="number" id="min-trials" min="1" max="20" value="5" required>
                                        <small>æ¯å€‹æ¨¡æ¿è‡³å°‘å˜—è©¦å¹¾æ¬¡å¾Œæ‰é–‹å§‹å„ªåŒ–é¸æ“‡</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="posts-per-day">æ¯å¤©ç™¼æ–‡æ¬¡æ•¸</label>
                                        <input type="number" id="posts-per-day" min="1" max="10" value="1" required>
                                        <small>ç³»çµ±æ¯å¤©è‡ªå‹•å»ºç«‹å¹¾å€‹æ’ç¨‹</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="time-range-start">ç™¼æ–‡æ™‚æ®µ - é–‹å§‹æ™‚é–“</label>
                                        <input type="time" id="time-range-start" value="09:00" class="form-control"
                                            style="padding: 12px; font-size: 16px;">
                                        <small>UCB å°‡åœ¨æ­¤æ™‚é–“ä¹‹å¾Œé¸æ“‡æœ€ä½³æ™‚æ®µç™¼æ–‡</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="time-range-end">ç™¼æ–‡æ™‚æ®µ - çµæŸæ™‚é–“</label>
                                        <input type="time" id="time-range-end" value="21:00" class="form-control"
                                            style="padding: 12px; font-size: 16px;">
                                        <small>UCB å°‡åœ¨æ­¤æ™‚é–“ä¹‹å‰é¸æ“‡æœ€ä½³æ™‚æ®µç™¼æ–‡</small>
                                    </div>

                                    <div class="form-group">
                                        <label>å•Ÿç”¨æ˜ŸæœŸ</label>
                                        <div
                                            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="1" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±ä¸€</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="2" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±äºŒ</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="3" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±ä¸‰</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="4" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±å››</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="5" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±äº”</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="6" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±å…­</span>
                                            </label>
                                            <label
                                                style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                                <input type="checkbox" class="active-day" value="7" checked
                                                    style="margin-bottom: 4px;">
                                                <span style="font-size: 12px;">é€±æ—¥</span>
                                            </label>
                                        </div>
                                        <small style="margin-top: 8px; display: block;">é¸æ“‡ UCB
                                            è‡ªå‹•å»ºç«‹æ’ç¨‹çš„æ˜ŸæœŸï¼Œæœªé¸æ“‡çš„æ˜ŸæœŸä¸æœƒå»ºç«‹æ’ç¨‹</small>
                                    </div>

                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="auto-schedule-enabled" checked>
                                            <label for="auto-schedule-enabled" style="margin-bottom: 0;">å•Ÿç”¨è‡ªå‹•æ’ç¨‹</label>
                                        </div>
                                        <small>æ¯å¤© 00:00 è‡ªå‹•ä½¿ç”¨ UCB å»ºç«‹æ’ç¨‹ä¸¦ç™¼é€åˆ° LINE å¯©æ ¸</small>
                                    </div>

                                    <button type="submit" class="btn btn-success" style="width: 100%;">å„²å­˜é…ç½®</button>
                                </form>
                            </div>

                            <!-- Right: Quick Actions & Info -->
                            <div class="config-card">
                                <h3>å¿«é€Ÿæ“ä½œ</h3>

                                <div
                                    style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                                    <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">ğŸ“Œ ä½¿ç”¨èªªæ˜</h4>
                                    <ul
                                        style="margin: 0; padding-left: 20px; font-size: 13px; color: #334155; line-height: 1.8;">
                                        <li><strong>å•Ÿç”¨è‡ªå‹•æ’ç¨‹</strong>ï¼šæ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹</li>
                                        <li><strong>ç«‹å³è§¸ç™¼</strong>ï¼šæ¸¬è©¦ç”¨ï¼Œç«‹å³å»ºç«‹ä»Šå¤©çš„æ’ç¨‹</li>
                                        <li><strong>æ’ç¨‹æ­·å²</strong>ï¼šä¸‹æ–¹é¡¯ç¤ºæ‰€æœ‰ UCB å»ºç«‹çš„æ’ç¨‹</li>
                                        <li><strong>åŸ·è¡Œæµç¨‹</strong>ï¼šå»ºç«‹æ’ç¨‹ â†’ åˆ°é”æ™‚é–“ â†’ ç”Ÿæˆæ–‡ç«  â†’ LINE é€šçŸ¥å¯©æ ¸</li>
                                    </ul>
                                </div>

                                <div
                                    style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                    <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">âš ï¸ é‡è¦æé†’</h4>
                                    <ul
                                        style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f; line-height: 1.8;">
                                        <li>æ¯å¤©åªèƒ½å»ºç«‹ä¸€å€‹æ’ç¨‹ï¼ˆé¿å…é‡è¤‡ï¼‰</li>
                                        <li>å¿…é ˆé¸æ“‡ Threads å¸³è™Ÿå’Œ LINE User ID</li>
                                        <li>è‡³å°‘é¸æ“‡ä¸€å€‹å•Ÿç”¨çš„æ¨¡æ¿</li>
                                        <li>UCB æœƒæ ¹æ“šæ­·å²æ•¸æ“šè‡ªå‹•å„ªåŒ–é¸æ“‡</li>
                                    </ul>
                                </div>

                                <button class="btn btn-primary" onclick="triggerDailySchedule()"
                                    style="width: 100%; padding: 15px; font-size: 16px;">
                                    ğŸ§ª æ¸¬è©¦ç”Ÿæˆç™¼é€
                                </button>
                                <small
                                    style="display: block; margin-top: 10px; color: #6b7280; text-align: center; font-size: 12px;">
                                    ç³»çµ±æœƒç«‹å³ç”Ÿæˆæ–‡ç« ä¸¦ç™¼é€ LINE é€šçŸ¥
                                </small>
                            </div>
                        </div>

                        <div id="ucb-message"></div>

                        <div style="margin-top: 40px;">
                            <div class="action-bar">
                                <h3>è‡ªå‹•æ’ç¨‹æ­·å²</h3>
                                <button class="btn btn-secondary" onclick="loadScheduleHistory()">é‡æ–°æ•´ç†</button>
                            </div>
                            <div id="schedule-history-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Threads Accounts Tab -->
                <div id="accountsTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Threads å¸³è™Ÿç®¡ç†</h2>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“± æ–°å¢ Threads å¸³è™Ÿ</h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            ç”±æ–¼ Threads API éœ€è¦ OAuth æˆæ¬Š,è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œ:
                        </p>
                        <ol style="color: #666; line-height: 1.8;">
                            <li>å‰å¾€ <a href="https://developers.facebook.com/" target="_blank"
                                    style="color: #667eea;">Meta
                                    Developers</a> å»ºç«‹æ‡‰ç”¨ç¨‹å¼</li>
                            <li>å–å¾— Client ID å’Œ Client Secret</li>
                            <li>è¨­å®š Redirect URI ç‚º: <code
                                    style="background: #e1e8ed; padding: 2px 6px; border-radius: 3px;">http://localhost:3000/api/threads/oauth/callback</code>
                            </li>
                            <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æˆæ¬Š</li>
                        </ol>
                        <button class="btn" onclick="startThreadsOAuth()" style="margin-top: 15px;">ğŸ”— é–‹å§‹ Threads
                            æˆæ¬Š</button>
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">å·²é€£çµçš„ Threads å¸³è™Ÿ</h3>
                        <button class="btn" onclick="runDiagnostics()"
                            style="background: #17a2b8; padding: 8px 16px;">ğŸ”
                            è¨ºæ–·ç™¼å¸ƒå•é¡Œ</button>
                    </div>
                    <div id="threadsAccountsList" class="posts-grid"></div>

                    <!-- Diagnostics Result -->
                    <div id="diagnosticsResult"
                        style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                        <h3 style="margin-bottom: 15px;">ğŸ” è¨ºæ–·çµæœ</h3>
                        <div id="diagnosticsContent"></div>
                    </div>
                </div>

                <!-- Manual Post Sub-tab -->
                <div id="manualSubTab" class="sub-tab-content">
                    <h3 style="margin-bottom: 20px;">æ‰‹å‹•å»ºç«‹è²¼æ–‡</h3>
                    <p style="color: #666; margin-bottom: 20px;">ç›´æ¥è¼¸å…¥è²¼æ–‡å…§å®¹ï¼Œç„¡éœ€ AI ç”Ÿæˆ</p>

                    <form onsubmit="createManualPost(event)">
                        <div class="form-group">
                            <label>è²¼æ–‡å…§å®¹ *</label>
                            <textarea id="manualPostContent" rows="10" placeholder="ç›´æ¥è¼¸å…¥æ‚¨æƒ³ç™¼å¸ƒçš„å…§å®¹..." required
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; line-height: 1.6;"></textarea>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                å­—æ•¸: <span id="contentCharCount">0</span> / 500 (Threads å»ºè­°)
                            </p>
                        </div>

                        <div class="form-group">
                            <label>ç™¼å¸ƒåˆ° Threads å¸³è™Ÿ *</label>
                            <select id="manualPostThreadsAccount" required style="padding: 12px; font-size: 15px;">
                                <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                            </select>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                            </p>
                        </div>

                        <div class="form-group">
                            <label>ç™¼å¸ƒæ™‚é–“</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="publishTime" value="now" checked
                                        onchange="toggleScheduleInput()">
                                    ç«‹å³ç™¼å¸ƒ
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="publishTime" value="scheduled"
                                        onchange="toggleScheduleInput()">
                                    æ’ç¨‹ç™¼å¸ƒ
                                </label>
                            </div>
                            <input type="datetime-local" id="manualPostSchedule"
                                style="padding: 12px; font-size: 15px; display: none;">
                        </div>

                        <button type="submit" class="btn" style="padding: 15px 30px; font-size: 16px;">ç™¼å¸ƒè²¼æ–‡</button>
                    </form>
                </div>
            </div>

            <!-- Templates Tab (Renamed from Smart Scheduling Tab) -->
            <div id="templatesTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">æ¨¡æ¿è¨­å®š</h2>
                <p style="color: #666; margin-bottom: 20px;">å»ºç«‹å’Œç®¡ç† AI ç”Ÿæˆæç¤ºè©æ¨¡æ¿ï¼Œç”¨æ–¼æ™ºèƒ½æ’ç¨‹ç³»çµ±</p>

                <div class="action-bar">
                    <h3>æˆ‘çš„æ¨¡æ¿</h3>
                    <button class="btn btn-primary" onclick="openCreateModal()">+ æ–°å¢æ¨¡æ¿</button>
                </div>
                <div id="templates-container"></div>
            </div>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è²¼æ–‡è©³æƒ…</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ–°å¢æ¨¡æ¿</h2>
                <button class="close-modal" onclick="closeTemplateModal()">Ã—</button>
            </div>
            <form id="template-form" onsubmit="saveTemplate(event)">
                <div class="form-group">
                    <label for="template-name">æ¨¡æ¿åç¨± *</label>
                    <input type="text" id="template-name" required placeholder="ä¾‹å¦‚ï¼šçŸ¥è­˜åˆ†äº«å‹">
                </div>

                <div class="form-group">
                    <label for="template-description">æ¨¡æ¿æè¿°</label>
                    <input type="text" id="template-description" placeholder="ç°¡çŸ­èªªæ˜é€™å€‹æ¨¡æ¿çš„ç”¨é€”">
                </div>

                <div class="form-group">
                    <label for="template-engine">AI å¼•æ“ *</label>
                    <select id="template-engine" required>
                        <option value="GPT5_2">GPT-5.2 (æ¨è–¦)</option>
                        <option value="GPT5_2_INSTANT">GPT-5.2 Instant (å¿«é€Ÿ)</option>
                        <option value="GPT4O">GPT-4o</option>
                        <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                        <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                        <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                    </select>
                    <small>æ­¤æ¨¡æ¿ç”Ÿæˆå…§å®¹æ™‚å°‡ä½¿ç”¨çš„ AI å¼•æ“</small>
                </div>

                <div class="form-group">
                    <label for="template-prompt">æç¤ºè©å…§å®¹ *</label>
                    <textarea id="template-prompt" required placeholder="è«‹ç”¢ç”Ÿä¸€ç¯‡ Threads è²¼æ–‡..."></textarea>
                    <small>é€™æ˜¯çµ¦ AI çš„æŒ‡ä»¤ï¼Œè«‹è©³ç´°æè¿°ä½ å¸Œæœ› AI ç”Ÿæˆä»€éº¼æ¨£çš„å…§å®¹</small>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="template-enabled" checked>
                        <label for="template-enabled" style="margin-bottom: 0;">å•Ÿç”¨æ­¤æ¨¡æ¿</label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-test" onclick="testCurrentTemplate()">ğŸ§ª æ¸¬è©¦ç”Ÿæˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ å…§å®¹é è¦½</h2>
                <button class="close-modal" onclick="closePreviewModal()">Ã—</button>
            </div>

            <div id="preview-result"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePreviewModal()">é—œé–‰</button>
                <button class="btn btn-primary" onclick="regeneratePreview()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let token = localStorage.getItem('token');
        const API_BASE = '/api';

        // Initialize
        if (token) {
            checkAuth();
        }

        // Authentication
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showDashboard(data.user);
                } else {
                    showAlert('loginAlert', data.error || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'é€£ç·šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/posts?limit=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('userInfo').classList.remove('active');
        }

        function showDashboard(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userInfo').classList.add('active');

            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRoles').textContent = user.roles.join(', ');
            }

            loadOverview();
            loadPosts();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');

            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'overview') loadOverview();
            if (tabName === 'posts') loadPosts();
            if (tabName === 'scheduling') {
                loadScheduling();
            }
            if (tabName === 'templates') {
                loadTemplates();
            }
            if (tabName === 'accounts') loadThreadsAccountsList();
        }

        // Sub-tab switching for scheduling tab
        function switchSchedulingSubTab(subTabName) {
            // Remove active class from all sub-tabs
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to clicked sub-tab
            event.target.classList.add('active');

            // Show corresponding sub-tab content
            if (subTabName === 'manual') {
                document.getElementById('manualSubTab').classList.add('active');
                loadThreadsAccountsForDropdowns();
            } else if (subTabName === 'ucb') {
                document.getElementById('ucbSubTab').classList.add('active');
                // å…ˆè¼‰å…¥ Threads å¸³è™Ÿåˆ—è¡¨å’Œæ¨¡æ¿é¸æ“‡å™¨ï¼Œç„¶å¾Œå†è¼‰å…¥ UCB é…ç½®ï¼ˆé€™æ¨£æ‰èƒ½æ­£ç¢ºè¨­å®šé¸ä¸­çš„å¸³è™Ÿï¼‰
                Promise.all([
                    loadThreadsAccountsForDropdowns(),
                    loadUCBTemplatesSelector()
                ]).then(() => {
                    loadUCBConfig();
                });
                loadScheduleHistory();
            }
        }

        // Load overview
        async function loadOverview() {
            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();

                // Update stats
                document.getElementById('totalPosts').textContent = data.total || 0;

                // Safely handle data array
                const posts = data.data || data.posts || [];

                const statuses = posts.reduce((acc, post) => {
                    acc[post.status] = (acc[post.status] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('draftPosts').textContent = statuses.DRAFT || 0;
                document.getElementById('pendingPosts').textContent = statuses.PENDING_REVIEW || 0;
                document.getElementById('postedPosts').textContent = statuses.POSTED || 0;
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥ç¸½è¦½å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Load posts
        async function loadPosts() {
            const status = document.getElementById('filterStatus')?.value || '';
            const url = status ? `${API_BASE}/posts?status=${status}` : `${API_BASE}/posts`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                const posts = data.data || data.posts || [];
                renderPosts(posts, 'postsGrid');
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Render posts
        function renderPosts(posts, containerId) {
            const container = document.getElementById(containerId);

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px;">æš«ç„¡è²¼æ–‡</p>
                        <p style="margin-top: 10px;">å»ºç«‹ç¬¬ä¸€ç¯‡è²¼æ–‡é–‹å§‹ä½¿ç”¨!</p>
                    </div>
                `;
                // Hide batch delete button when no posts
                const batchBtn = document.getElementById('batchDeleteBtn');
                if (batchBtn) batchBtn.style.display = 'none';
                return;
            }

            // Show checkboxes only in postsGrid (not in recentPosts)
            const showCheckbox = containerId === 'postsGrid';

            container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${showCheckbox ? `<input type="checkbox" class="post-checkbox" data-post-id="${post.id}" onchange="updateBatchDeleteButton()" style="width: 18px; height: 18px; cursor: pointer;">` : ''}
                            <h3>æ–‡ç«  #${post.id.substring(0, 8)}</h3>
                        </div>
                        <span class="status-badge status-${post.status}">${getStatusText(post.status)}</span>
                    </div>

                    <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.created_at).toLocaleString('zh-TW')}</p>
                    ${post.posted_at ? `<p><strong>ç™¼å¸ƒæ™‚é–“:</strong> ${new Date(post.posted_at).toLocaleString('zh-TW')}</p>` : ''}
                    ${post.post_url ? `<p><strong>è²¼æ–‡é€£çµ:</strong> <a href="${post.post_url}" target="_blank">æŸ¥çœ‹</a></p>` : ''}

                    <div class="post-actions">
                        <button class="btn btn-small btn-secondary" onclick="viewPost('${post.id}')">æŸ¥çœ‹è©³æƒ…</button>
                        ${post.status === 'DRAFT' ? `<button class="btn btn-small btn-success" onclick="generateContent('${post.id}')">ç”Ÿæˆå…§å®¹</button>` : ''}
                        ${post.status === 'APPROVED' ? `<button class="btn btn-small btn-success" onclick="publishPost('${post.id}')">ç™¼å¸ƒ</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-success" onclick="approvePost('${post.id}')">æ ¸å‡†</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-warning" onclick="regenerateContent('${post.id}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePost('${post.id}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // Create post
        async function createPost(event) {
            event.preventDefault();
            showLoading(true);

            const topic = document.getElementById('postTopic').value;
            const keywords = document.getElementById('postKeywords').value.split(',').map(k => k.trim());
            const targetTone = document.getElementById('postTone').value;
            const targetLength = parseInt(document.getElementById('postLength').value);
            const scheduledFor = document.getElementById('postSchedule').value;
            const autoGenerate = document.getElementById('autoGenerate').checked;

            const postData = {
                topic,
                keywords,
                targetTone,
                targetLength,
                ...(scheduledFor && { scheduledFor: new Date(scheduledFor).toISOString() })
            };

            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å»ºç«‹æˆåŠŸ!', 'success');
                    event.target.reset();

                    if (autoGenerate) {
                        await generateContent(data.id);
                    }

                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', data.error || 'å»ºç«‹å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Generate content
        async function generateContent(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'å…§å®¹ç”Ÿæˆä»»å‹™å·²åŠ å…¥ä½‡åˆ—,è«‹ç¨å¾ŒæŸ¥çœ‹', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç”Ÿæˆå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // View post detail
        async function viewPost(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const post = await response.json();

                if (response.ok) {
                    const modalBody = document.getElementById('modalBody');
                    modalBody.innerHTML = `
                        <h3>${post.topic}</h3>
                        <p><span class="status-badge status-${post.status}">${getStatusText(post.status)}</span></p>

                        <div style="margin: 20px 0;">
                            <p><strong>é—œéµå­—:</strong> ${post.keywords.join(', ')}</p>
                            <p><strong>èªæ°£:</strong> ${post.targetTone}</p>
                            <p><strong>ç›®æ¨™é•·åº¦:</strong> ${post.targetLength} å­—</p>
                            <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>
                            ${post.scheduledFor ? `<p><strong>æ’ç¨‹æ™‚é–“:</strong> ${new Date(post.scheduledFor).toLocaleString('zh-TW')}</p>` : ''}
                        </div>

                        ${post.latestRevision ? `
                            <h4>æœ€æ–°å…§å®¹ç‰ˆæœ¬</h4>
                            <div class="content-preview">${post.latestRevision.content}</div>
                            <p><strong>å­—æ•¸:</strong> ${post.latestRevision.wordCount}</p>
                            <p><strong>AI å¼•æ“:</strong> ${post.latestRevision.aiEngine}</p>
                            <p><strong>ç”Ÿæˆæ™‚é–“:</strong> ${new Date(post.latestRevision.createdAt).toLocaleString('zh-TW')}</p>
                        ` : '<p style="color: #666;">å°šæœªç”Ÿæˆå…§å®¹</p>'}
                    `;

                    document.getElementById('postModal').classList.add('active');
                } else {
                    showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Approve post
        async function approvePost(postId) {
            if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤è²¼æ–‡å—?')) return;

            showLoading(true);

            try {
                // Get post detail first to get revision ID
                const postResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const post = await postResponse.json();

                if (!post.latestRevision) {
                    throw new Error('æ‰¾ä¸åˆ°å…§å®¹ç‰ˆæœ¬');
                }

                const response = await fetch(`${API_BASE}/review/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        postId: postId,
                        revisionId: post.latestRevision.id,
                        action: 'approve'
                    })
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²æ ¸å‡†', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'æ ¸å‡†å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Regenerate content
        async function regenerateContent(postId) {
            if (!confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆå…§å®¹å—?')) return;
            await generateContent(postId);
        }

        // Publish post
        async function publishPost(postId) {
            if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒæ­¤è²¼æ–‡åˆ° Threads å—?')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/publish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'ç™¼å¸ƒä»»å‹™å·²åŠ å…¥ä½‡åˆ—', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Delete post
        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.post-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            updateBatchDeleteButton();
        }

        // Update batch delete button visibility
        function updateBatchDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
            const batchBtn = document.getElementById('batchDeleteBtn');

            if (batchBtn) {
                if (checkedBoxes.length > 0) {
                    batchBtn.style.display = 'inline-block';
                    batchBtn.textContent = `ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤ (${checkedBoxes.length})`;
                } else {
                    batchBtn.style.display = 'none';
                }
            }
        }

        // Batch delete posts
        async function batchDeletePosts() {
            const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
            const postIds = Array.from(checkedBoxes).map(cb => cb.dataset.postId);

            if (postIds.length === 0) {
                showAlert('dashboardAlert', 'è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è²¼æ–‡', 'error');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${postIds.length} ç¯‡è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            showLoading(true);
            let successCount = 0;
            let failCount = 0;

            try {
                // Delete posts one by one
                for (const postId of postIds) {
                    try {
                        const response = await fetch(`${API_BASE}/posts/${postId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }

                // Show result
                if (successCount > 0 && failCount === 0) {
                    showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡è²¼æ–‡`, 'success');
                } else if (successCount > 0 && failCount > 0) {
                    showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡,å¤±æ•— ${failCount} ç¯‡`, 'error');
                } else {
                    showAlert('dashboardAlert', `åˆªé™¤å¤±æ•—`, 'error');
                }

                // Reload posts
                loadPosts();
                loadOverview();
            } catch (error) {
                showAlert('dashboardAlert', 'æ‰¹æ¬¡åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Utilities
        function getStatusText(status) {
            const statusMap = {
                'DRAFT': 'è‰ç¨¿',
                'GENERATING': 'ç”¢ç”Ÿä¸­',
                'PENDING_REVIEW': 'å¾…å¯©æ ¸',
                'APPROVED': 'å·²æ ¸å‡†',
                'PUBLISHING': 'ç™¼å¸ƒä¸­',
                'POSTED': 'å·²ç™¼å¸ƒ',
                'FAILED': 'å¤±æ•—',
                'ACTION_REQUIRED': 'éœ€è¦è™•ç†',
                'SKIPPED': 'å·²è·³é'
            };
            return statusMap[status] || status;
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function closeModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        // Threads Accounts Management
        async function loadThreadsAccounts() {
            // Load accounts for dropdown in create form
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const accounts = await response.json();
                    const select = document.getElementById('postThreadsAccount');
                    select.innerHTML = '<option value="">ç¨å¾Œé¸æ“‡</option>';

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = `@${acc.username}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
        }

        async function loadThreadsAccountsList() {
            const container = document.getElementById('threadsAccountsList');

            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const accounts = data.accounts || [];

                    if (accounts.length === 0) {
                        container.innerHTML = '<div class="empty-state"><p>å°šæœªé€£çµä»»ä½• Threads å¸³è™Ÿ</p></div>';
                        return;
                    }

                    container.innerHTML = accounts.map(acc => `
                        <div class="post-card" style="${acc.is_default ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3>@${acc.username}</h3>
                                ${acc.is_default ? '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">é è¨­å¸³è™Ÿ</span>' : ''}
                            </div>
                            <p><strong>å¸³è™Ÿ ID:</strong> ${acc.account_id || '(æœªè¨­å®š)'}</p>
                            <p><strong>ç‹€æ…‹:</strong> ${acc.status === 'ACTIVE' ? '<span style="color: #28a745;">âœ“ å•Ÿç”¨ä¸­</span>' : '<span style="color: #dc3545;">å·²é–å®š</span>'}</p>
                            <p><strong>é€£çµæ™‚é–“:</strong> ${new Date(acc.created_at).toLocaleString('zh-TW')}</p>
                            <div class="post-actions">
                                ${!acc.is_default ? `<button class="btn btn-small" style="background: #28a745;" onclick="setDefaultAccount('${acc.id}')">è¨­ç‚ºé è¨­</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="removeThreadsAccount('${acc.id}')">è§£é™¤é€£çµ</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—: ' + error.message + '</p></div>';
            }
        }

        async function startThreadsOAuth() {
            try {
                // Get OAuth URL from backend with authentication
                const response = await fetch(`${API_BASE}/threads/oauth/authorize`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authUrl) {
                        // Redirect to Threads authorization page
                        window.location.href = data.authUrl;
                    }
                } else {
                    const error = await response.json();
                    showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function setDefaultAccount(accountId) {
            try {
                const response = await fetch(`${API_BASE}/threads/accounts/${accountId}/set-default`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'âœ… å·²è¨­ç‚ºé è¨­å¸³è™Ÿ', 'success');
                    loadThreadsAccountsList();
                    // Reload UCB config to refresh account selector
                    if (typeof loadUcbConfig === 'function') {
                        loadUcbConfig();
                    }
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'è¨­å®šå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function removeThreadsAccount(accountId) {
            if (!confirm('ç¢ºå®šè¦è§£é™¤é€£çµæ­¤ Threads å¸³è™Ÿå—?')) return;

            try {
                const response = await fetch(`${API_BASE}/threads/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'Threads å¸³è™Ÿå·²è§£é™¤é€£çµ', 'success');
                    loadThreadsAccountsList();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'è§£é™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è§£é™¤å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            const contentDiv = document.getElementById('diagnosticsContent');

            // Show loading
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<p style="color: #666;">ğŸ”„ è¨ºæ–·ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/diagnose`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('è¨ºæ–·è«‹æ±‚å¤±æ•—');
                }

                const data = await response.json();

                // Build diagnostic HTML
                let html = '';

                // Threads Accounts
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ“± Threads å¸³è™Ÿç‹€æ…‹</h4>';
                if (data.checks.threadsAccounts.total === 0) {
                    html += '<p style="color: #dc3545;">âŒ æ‰¾ä¸åˆ°ä»»ä½• Threads å¸³è™Ÿ</p>';
                } else {
                    data.checks.threadsAccounts.accounts.forEach((acc, i) => {
                        html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${acc.issues.length > 0 ? '#ffc107' : '#28a745'}">`;
                        html += `<p style="margin: 5px 0;"><strong>å¸³è™Ÿ ${i + 1}:</strong> ${acc.username}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Account ID: ${acc.accountId || 'âŒ æœªè¨­å®š'}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç‹€æ…‹: ${acc.status}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">é è¨­å¸³è™Ÿ: ${acc.isDefault ? 'âœ“ æ˜¯' : 'å¦'}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Token ç‹€æ…‹: ${acc.tokenStatus || 'ç„¡'}</p>`;
                        if (acc.issues.length > 0) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                            acc.issues.forEach(issue => {
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += '</div>';

                // Recent Posts
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ“ æœ€è¿‘çš„æ–‡ç« </h4>';
                if (data.checks.recentPosts.total === 0) {
                    html += '<p style="color: #666;">ç›®å‰æ²’æœ‰æ–‡ç« </p>';
                } else {
                    data.checks.recentPosts.posts.slice(0, 3).forEach((post, i) => {
                        const statusColor = {
                            'POSTED': '#28a745',
                            'APPROVED': '#ffc107',
                            'FAILED': '#dc3545',
                            'PENDING_REVIEW': '#17a2b8'
                        }[post.status] || '#6c757d';

                        html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor}">`;
                        html += `<p style="margin: 5px 0;"><strong>æ–‡ç«  ${i + 1}:</strong> <span style="color: ${statusColor}; font-weight: bold;">${post.status}</span></p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">å»ºç«‹: ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>`;
                        if (post.approvedAt) {
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">æ ¸å‡†: ${new Date(post.approvedAt).toLocaleString('zh-TW')}</p>`;
                        }
                        if (post.postedAt) {
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç™¼å¸ƒ: ${new Date(post.postedAt).toLocaleString('zh-TW')}</p>`;
                        }
                        if (post.error) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px;">`;
                            html += `<p style="margin: 3px 0; font-size: 13px; color: #721c24;">éŒ¯èª¤: ${post.error.message || post.error.code}</p>`;
                            html += `</div>`;
                        }
                        if (post.issues.length > 0) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                            post.issues.forEach(issue => {
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += '</div>';

                // Analysis & Recommendations
                html += '<div style="background: white; padding: 15px; border-radius: 8px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ’¡ è¨ºæ–·å»ºè­°</h4>';
                if (data.analysis.recommendations.length === 0) {
                    html += '<p style="color: #28a745;">âœ… æ‰€æœ‰è¨­å®šçœ‹èµ·ä¾†æ­£å¸¸</p>';
                } else {
                    html += '<ul style="margin: 0; padding-left: 20px;">';
                    data.analysis.recommendations.forEach(rec => {
                        html += `<li style="margin: 8px 0; color: #856404;">${rec}</li>`;
                    });
                    html += '</ul>';
                }
                html += '</div>';

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<p style="color: #dc3545;">âŒ è¨ºæ–·å¤±æ•—: ${error.message}</p>`;
            }
        }

        // Settings Management
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥è¨­å®šå¤±æ•—');

                const data = await response.json();
                const settings = data.settings;

                // AI Engine
                if (settings.ai_engine) {
                    const aiEngineEl = document.getElementById('aiEngine');
                    if (aiEngineEl) aiEngineEl.value = settings.ai_engine.value;
                }

                // Custom Prompt
                if (settings.custom_prompt) {
                    const customPromptEl = document.getElementById('customPrompt');
                    if (customPromptEl) customPromptEl.value = settings.custom_prompt.value;
                }

                // Schedule Config
                if (settings.schedule_config) {
                    const scheduleConfig = settings.schedule_config.value;
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                    days.forEach(day => {
                        const config = scheduleConfig[day];
                        if (config) {
                            const checkboxEl = document.getElementById(`schedule_${day}`);
                            const timeEl = document.getElementById(`time_${day}`);
                            if (checkboxEl) checkboxEl.checked = config.enabled;
                            if (timeEl) timeEl.value = config.time;
                        }
                    });
                }

                // Auto Post Threads Account - Store value to apply after dropdown is populated
                if (settings.auto_post_threads_account) {
                    const autoPostEl = document.getElementById('autoPostThreadsAccount');
                    if (autoPostEl && settings.auto_post_threads_account.value) {
                        // Store the saved value temporarily to apply after options are loaded
                        autoPostEl.dataset.savedValue = settings.auto_post_threads_account.value;
                    }
                }

                // LINE Notify User ID
                if (settings.line_notify_user_id) {
                    const lineUserIdEl = document.getElementById('lineNotifyUserId');
                    if (lineUserIdEl) lineUserIdEl.value = settings.line_notify_user_id.value;
                }

            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function saveAllSettings() {
            showLoading(true);

            try {
                // Collect schedule config
                const scheduleConfig = {
                    monday: {
                        enabled: document.getElementById('schedule_monday').checked,
                        time: document.getElementById('time_monday').value
                    },
                    tuesday: {
                        enabled: document.getElementById('schedule_tuesday').checked,
                        time: document.getElementById('time_tuesday').value
                    },
                    wednesday: {
                        enabled: document.getElementById('schedule_wednesday').checked,
                        time: document.getElementById('time_wednesday').value
                    },
                    thursday: {
                        enabled: document.getElementById('schedule_thursday').checked,
                        time: document.getElementById('time_thursday').value
                    },
                    friday: {
                        enabled: document.getElementById('schedule_friday').checked,
                        time: document.getElementById('time_friday').value
                    },
                    saturday: {
                        enabled: document.getElementById('schedule_saturday').checked,
                        time: document.getElementById('time_saturday').value
                    },
                    sunday: {
                        enabled: document.getElementById('schedule_sunday').checked,
                        time: document.getElementById('time_sunday').value
                    }
                };

                const settings = {
                    ai_engine: {
                        value: document.getElementById('aiEngine').value,
                        type: 'STRING'
                    },
                    custom_prompt: {
                        value: document.getElementById('customPrompt').value,
                        type: 'STRING'
                    },
                    schedule_config: {
                        value: scheduleConfig,
                        type: 'JSON'
                    },
                    auto_post_threads_account: {
                        value: document.getElementById('autoPostThreadsAccount').value,
                        type: 'STRING'
                    },
                    line_notify_user_id: {
                        value: document.getElementById('lineNotifyUserId').value,
                        type: 'STRING'
                    }
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ settings })
                });

                if (!response.ok) throw new Error('å„²å­˜è¨­å®šå¤±æ•—');

                showAlert('dashboardAlert', 'âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testLineNotification() {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/settings/test-line`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æ¸¬è©¦é€šçŸ¥å¤±æ•—');
                }

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€åˆ° LINEï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE è¨Šæ¯ã€‚', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function runTestGeneration() {
            showLoading(true);
            document.getElementById('testResults').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/settings/test-generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let errorMessage = 'æ¸¬è©¦ç”Ÿæˆå¤±æ•—';
                    try {
                        const error = await response.json();
                        errorMessage = error.error || error.message || errorMessage;
                        console.error('API Error:', error);
                    } catch (e) {
                        const text = await response.text();
                        console.error('Response text:', text);
                        errorMessage = text || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Test generation response:', data);

                // Display success message with content preview
                const resultHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #1DB446;">
                        <h4 style="margin: 0 0 15px 0; color: #1DB446;">âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆï¼</h4>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“Š ç”Ÿæˆè³‡è¨Šï¼š</strong></p>
                            <p style="margin: 5px 0;">ğŸ¤– å¼•æ“ï¼š${data.engine}</p>
                            <p style="margin: 5px 0;">ğŸ“ˆ ç›¸ä¼¼åº¦ï¼š${(data.similarity * 100).toFixed(1)}%</p>
                            <p style="margin: 5px 0; color: ${data.similarity > 0.86 ? '#ff0000' : '#4CAF50'};">
                                ${data.similarity > 0.86 ? 'âš ï¸ ç›¸ä¼¼åº¦è¼ƒé«˜ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆ' : 'âœ… ç›¸ä¼¼åº¦æ­£å¸¸'}
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“ æ–‡ç« å…§å®¹é è¦½ï¼š</strong></p>
                            <p style="white-space: pre-wrap; margin: 0; line-height: 1.6; color: #333;">
                                ${data.content.substring(0, 200)}${data.content.length > 200 ? '...' : ''}
                            </p>
                        </div>

                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #2e7d32;">ğŸ“± ä¸‹ä¸€æ­¥ï¼š</p>
                            <p style="margin: 10px 0 0 0; line-height: 1.8; color: #333;">
                                æ¸¬è©¦æ–‡ç« å·²ç™¼é€åˆ°æ‚¨çš„ LINEï¼<br>
                                è«‹åˆ° LINE æŸ¥çœ‹å®Œæ•´å…§å®¹ä¸¦é€²è¡Œå¯©æ ¸ï¼š<br>
                                â€¢ âœ… ç¢ºèªç™¼æ–‡ â†’ ç™¼å¸ƒåˆ° Threads<br>
                                â€¢ ğŸ”„ é‡æ–°ç”Ÿæˆ â†’ ç”¢ç”Ÿæ–°æ–‡ç« <br>
                                â€¢ âœï¸ ä¿®æ”¹å…§å®¹ â†’ ç·¨è¼¯å¾Œç™¼å¸ƒ
                            </p>
                        </div>
                    </div>
                `;

                document.getElementById('testResultsContent').innerHTML = resultHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆä¸¦ç™¼é€åˆ° LINEï¼è«‹åˆ° LINE æŸ¥çœ‹ã€‚', 'success');
            } catch (error) {
                const errorHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 10px 0; color: #f44336;">âŒ æ¸¬è©¦å¤±æ•—</h4>
                        <p style="margin: 0; color: #666;">${error.message}</p>
                        ${error.message.includes('LINE User ID') ? `
                            <p style="margin: 15px 0 0 0; padding: 10px; background: #fff3e0; border-radius: 4px; color: #ff6600;">
                                ğŸ’¡ æç¤ºï¼šè«‹å…ˆè¨­å®š LINE User ID<br>
                                1. åœ¨ LINE ä¸­å‚³é€ã€Œ/myidã€çµ¦æ©Ÿå™¨äºº<br>
                                2. è¤‡è£½æ”¶åˆ°çš„ User ID<br>
                                3. è²¼åˆ°ä¸Šæ–¹ã€ŒLINE é€šçŸ¥è¨­å®šã€ä¸¦å„²å­˜
                            </p>
                        ` : ''}
                    </div>
                `;
                document.getElementById('testResultsContent').innerHTML = errorHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Character counter for manual post content
        const manualContentTextarea = document.getElementById('manualPostContent');
        if (manualContentTextarea) {
            manualContentTextarea.addEventListener('input', function () {
                const count = this.value.length;
                document.getElementById('contentCharCount').textContent = count;
            });
        }

        // Toggle schedule input visibility
        function toggleScheduleInput() {
            const scheduleInput = document.getElementById('manualPostSchedule');
            const isScheduled = document.querySelector('input[name="publishTime"]:checked')?.value === 'scheduled';
            if (scheduleInput) {
                scheduleInput.style.display = isScheduled ? 'block' : 'none';
                if (!isScheduled) {
                    scheduleInput.value = '';
                }
            }
        }

        // Load Threads accounts into dropdowns
        async function loadThreadsAccountsForDropdowns() {
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¸³è™Ÿå¤±æ•—');

                const data = await response.json();
                const accounts = data.accounts || [];

                // Populate manual post dropdown
                const manualSelect = document.getElementById('manualPostThreadsAccount');
                if (manualSelect) {
                    manualSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }

                // Populate auto post dropdown
                const autoSelect = document.getElementById('autoPostThreadsAccount');
                if (autoSelect) {
                    autoSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');

                    // Auto-select previously saved account
                    const savedAccountId = autoSelect.dataset.savedValue;
                    if (savedAccountId) {
                        autoSelect.value = savedAccountId;
                        delete autoSelect.dataset.savedValue; // Clear after applying
                    }
                }

                // Populate UCB Threads account dropdown
                const ucbSelect = document.getElementById('ucbThreadsAccount');
                if (ucbSelect) {
                    ucbSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸³è™Ÿåˆ—è¡¨å¤±æ•—:', error);
            }
        }

        // Test UCB LINE notification
        async function testUCBLineNotification() {
            const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

            if (!lineUserId) {
                alert('è«‹å…ˆè¼¸å…¥ LINE User ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/line/test-notification`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lineUserId })
                });

                if (!response.ok) throw new Error('ç™¼é€å¤±æ•—');

                alert('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE');
            } catch (error) {
                alert('âŒ æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        // Create manual post (direct publishing without AI)
        async function createManualPost(event) {
            event.preventDefault();
            showLoading(true);

            const content = document.getElementById('manualPostContent').value.trim();
            const accountId = document.getElementById('manualPostThreadsAccount').value;
            const publishTime = document.querySelector('input[name="publishTime"]:checked')?.value;
            const scheduledFor = publishTime === 'scheduled'
                ? document.getElementById('manualPostSchedule').value
                : null;

            // Validation
            if (!content) {
                showAlert('dashboardAlert', 'è«‹è¼¸å…¥è²¼æ–‡å…§å®¹', 'error');
                showLoading(false);
                return;
            }

            if (content.length > 500) {
                showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½è¶…é 500 å­—', 'error');
                showLoading(false);
                return;
            }

            if (!accountId) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡ Threads å¸³è™Ÿ', 'error');
                showLoading(false);
                return;
            }

            if (publishTime === 'scheduled' && !scheduledFor) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡æ’ç¨‹æ™‚é–“', 'error');
                showLoading(false);
                return;
            }

            try {
                // Create post with manual content
                const postResponse = await fetch(`${API_BASE}/posts/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content,
                        accountId,
                        scheduledFor: scheduledFor ? new Date(scheduledFor).toISOString() : null
                    })
                });

                const postData = await postResponse.json();

                if (postResponse.ok) {
                    showAlert('dashboardAlert', publishTime === 'now' ? 'âœ… è²¼æ–‡å·²åŠ å…¥ç™¼å¸ƒä½‡åˆ—ï¼' : 'âœ… è²¼æ–‡å·²æ’ç¨‹æˆåŠŸï¼', 'success');
                    document.getElementById('manualPostContent').value = '';
                    document.getElementById('contentCharCount').textContent = '0';
                    document.getElementById('manualPostThreadsAccount').value = '';
                    document.querySelector('input[name="publishTime"][value="now"]').checked = true;
                    toggleScheduleInput();
                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', postData.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== SMART SCHEDULING FUNCTIONS ====================

        let smartSchedulingTemplates = [];
        let currentEditingTemplateId = null;
        let currentTestPrompt = '';
        let currentTestEngine = 'GPT5_2';

        // Load scheduling tab (triggers default sub-tab)
        function loadScheduling() {
            // Load the UCB smart scheduling sub-tab by default
            switchSchedulingSubTab('ucb');
        }

        // Load templates tab
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                smartSchedulingTemplates = data.templates || [];
                renderTemplates();
            } catch (error) {
                document.getElementById('templates-container').innerHTML =
                    `<div class="error-message">è¼‰å…¥æ¨¡æ¿å¤±æ•—: ${error.message}</div>`;
            }
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');

            if (smartSchedulingTemplates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h3>é‚„æ²’æœ‰ä»»ä½•æ¨¡æ¿</h3>
                        <p>é»æ“Šã€Œæ–°å¢æ¨¡æ¿ã€é–‹å§‹å»ºç«‹ä½ çš„ç¬¬ä¸€å€‹å…§å®¹æ¨¡æ¿</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="templates-grid">
                    ${smartSchedulingTemplates.map(template => {
                const avgRate = parseFloat(template.avg_engagement_rate) || 0;
                const engineName = getEngineName(template.preferred_engine || 'GPT5_2');
                return `
                        <div class="template-card ${template.enabled ? '' : 'disabled'}">
                            <div class="template-header">
                                <div>
                                    <div class="template-name">${escapeHtml(template.name)}</div>
                                    ${template.description ? `<div class="template-description">${escapeHtml(template.description)}</div>` : ''}
                                    <div style="margin-top: 5px; font-size: 12px; color: #667eea;">
                                        <strong>ğŸ¤– AI å¼•æ“ï¼š</strong>${engineName}
                                    </div>
                                </div>
                                <span class="template-status ${template.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${template.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
                                </span>
                            </div>

                            <div class="template-stats">
                                <div class="stat">
                                    <div class="stat-label">ä½¿ç”¨æ¬¡æ•¸</div>
                                    <div class="stat-value">${template.total_uses || 0}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-label">å¹³å‡äº’å‹•ç‡</div>
                                    <div class="stat-value highlight">${avgRate.toFixed(2)}%</div>
                                </div>
                            </div>

                            <div class="template-prompt">${escapeHtml(template.prompt)}</div>

                            <div class="template-actions">
                                <button class="btn btn-test" onclick="testSmartTemplate('${template.id}')">ğŸ§ª æ¸¬è©¦</button>
                                <button class="btn btn-secondary" onclick="editSmartTemplate('${template.id}')">ç·¨è¼¯</button>
                                <button class="btn btn-danger" onclick="deleteSmartTemplate('${template.id}', '${escapeHtml(template.name)}')">åˆªé™¤</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function openCreateModal() {
            currentEditingTemplateId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢æ¨¡æ¿';
            document.getElementById('template-form').reset();
            document.getElementById('template-enabled').checked = true;
            document.getElementById('template-engine').value = 'GPT5_2';
            document.getElementById('templateModal').classList.add('active');
        }

        function editSmartTemplate(id) {
            const template = smartSchedulingTemplates.find(t => t.id === id);
            if (!template) return;

            currentEditingTemplateId = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯æ¨¡æ¿';
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-description').value = template.description || '';
            document.getElementById('template-engine').value = template.preferred_engine || 'GPT5_2';
            document.getElementById('template-prompt').value = template.prompt;
            document.getElementById('template-enabled').checked = template.enabled;
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            currentEditingTemplateId = null;
        }

        async function saveTemplate(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('template-name').value,
                description: document.getElementById('template-description').value,
                preferred_engine: document.getElementById('template-engine').value,
                prompt: document.getElementById('template-prompt').value,
                enabled: document.getElementById('template-enabled').checked
            };

            try {
                const url = currentEditingTemplateId
                    ? `${API_BASE}/templates/${currentEditingTemplateId}`
                    : `${API_BASE}/templates`;
                const method = currentEditingTemplateId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

                closeTemplateModal();
                loadTemplates();
                showSmartMessage('templates-container', 'æ¨¡æ¿å·²å„²å­˜ï¼', 'success');
            } catch (error) {
                alert('å„²å­˜å¤±æ•—: ' + error.message);
            }
        }

        async function deleteSmartTemplate(id, name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨¡æ¿ã€Œ${name}ã€å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/templates/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('åˆªé™¤å¤±æ•—');

                loadTemplates();
                showSmartMessage('templates-container', 'æ¨¡æ¿å·²åˆªé™¤', 'success');
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        // UCB Config functions
        async function loadUCBTemplatesSelector() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥æ¨¡æ¿å¤±æ•—');

                const data = await response.json();
                const templates = data.templates || [];
                const container = document.getElementById('ucb-templates-selector');

                if (templates.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center;">å°šç„¡æ¨¡æ¿ï¼Œè«‹å…ˆåˆ°ã€Œæ¨¡æ¿ç®¡ç†ã€æ–°å¢</p>';
                    return;
                }

                // Render template checkboxes
                container.innerHTML = templates.map(template => `
                    <div style="padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; transition: background 0.2s; ${!template.enabled ? 'opacity: 0.5;' : ''}"
                         onmouseover="if(${template.enabled}) this.style.background='#f0f4ff'"
                         onmouseout="this.style.background='transparent'">
                        <input type="checkbox"
                               id="ucb-template-${template.id}"
                               value="${template.id}"
                               ${template.enabled ? 'checked' : 'disabled'}
                               style="width: 18px; height: 18px; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex-shrink: 0;">
                        <label for="ucb-template-${template.id}" style="margin: 0; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex: 1; font-size: 14px; line-height: 1.5;">
                            <strong style="color: #1f2937;">${escapeHtml(template.name)}</strong>
                            ${!template.enabled ? '<span style="color: #999; font-size: 12px; margin-left: 8px;">(å·²åœç”¨)</span>' : ''}
                        </label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡æ¿é¸æ“‡å™¨å¤±æ•—:', error);
                document.getElementById('ucb-templates-selector').innerHTML =
                    '<p style="color: #f00; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function loadUCBConfig() {
            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥é…ç½®å¤±æ•—');

                const data = await response.json();
                const config = data.config;

                if (config) {
                    document.getElementById('exploration-factor').value = parseFloat(config.exploration_factor) || 1.5;
                    document.getElementById('min-trials').value = parseInt(config.min_trials_per_template) || 5;
                    document.getElementById('posts-per-day').value = parseInt(config.posts_per_day) || 1;
                    document.getElementById('auto-schedule-enabled').checked = Boolean(config.auto_schedule_enabled);

                    // Load time range settings
                    if (config.time_range_start) {
                        document.getElementById('time-range-start').value = config.time_range_start;
                    }
                    if (config.time_range_end) {
                        document.getElementById('time-range-end').value = config.time_range_end;
                    }

                    // Load Threads account
                    if (config.threads_account_id) {
                        document.getElementById('ucbThreadsAccount').value = config.threads_account_id;
                    }

                    // Load LINE User ID
                    if (config.line_user_id) {
                        document.getElementById('ucbLineNotifyUserId').value = config.line_user_id;
                    }

                    // Load active days
                    const activeDays = config.active_days || [];
                    document.querySelectorAll('.active-day').forEach(checkbox => {
                        checkbox.checked = activeDays.length === 0 || activeDays.includes(parseInt(checkbox.value));
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
            }
        }

        async function saveUCBConfig(event) {
            event.preventDefault();

            const data = {
                exploration_factor: parseFloat(document.getElementById('exploration-factor').value),
                min_trials_per_template: parseInt(document.getElementById('min-trials').value),
                posts_per_day: parseInt(document.getElementById('posts-per-day').value),
                auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                time_range_start: document.getElementById('time-range-start').value,
                time_range_end: document.getElementById('time-range-end').value,
                threads_account_id: document.getElementById('ucbThreadsAccount').value || null,
                line_user_id: document.getElementById('ucbLineNotifyUserId').value || null,
                active_days: Array.from(document.querySelectorAll('.active-day:checked')).map(cb => parseInt(cb.value))
            };

            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

                showSmartMessage('ucb-message', 'é…ç½®å·²å„²å­˜ï¼', 'success');
            } catch (error) {
                showSmartMessage('ucb-message', 'å„²å­˜å¤±æ•—: ' + error.message, 'error');
            }
        }


        async function triggerDailySchedule() {
            // å…ˆæª¢æŸ¥å¿…è¦è¨­å®š
            const threadsAccount = document.getElementById('ucbThreadsAccount').value;
            const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

            if (!threadsAccount) {
                alert('âŒ è«‹å…ˆé¸æ“‡ Threads å¸³è™Ÿä¸¦å„²å­˜é…ç½®');
                return;
            }

            if (!lineUserId) {
                alert('âŒ è«‹å…ˆè¨­å®š LINE User ID ä¸¦å„²å­˜é…ç½®');
                return;
            }

            if (!confirm('âœ… ç³»çµ±å°‡ä½¿ç”¨ UCB æ¼”ç®—æ³•é¸æ“‡æœ€ä½³æ¨¡æ¿å’Œæ™‚æ®µ\n\nğŸ“‹ ç«‹å³å»ºç«‹æ’ç¨‹ä¸¦ç”Ÿæˆæ–‡ç« ï¼ˆæ¸¬è©¦ç”¨ï¼‰\nğŸ’¬ ç”Ÿæˆå®Œæˆå¾Œæœƒç™¼é€ LINE é€šçŸ¥çµ¦æ‚¨å¯©æ ¸\n\nç¢ºå®šè¦ç«‹å³è§¸ç™¼å—ï¼Ÿ')) return;

            try {
                showSmartMessage('ucb-message', 'â³ æ­£åœ¨è§¸ç™¼ UCB æ’ç¨‹ä¸¦ç”Ÿæˆæ–‡ç« ...', 'info');

                const response = await fetch(`${API_BASE}/trigger-daily-schedule`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ immediate: true })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'è§¸ç™¼å¤±æ•—');
                }

                const data = await response.json();
                showSmartMessage('ucb-message', 'âœ… æ’ç¨‹å·²å»ºç«‹ä¸¦é–‹å§‹ç”Ÿæˆæ–‡ç« ï¼è«‹ç¨å€™æŸ¥çœ‹ LINE é€šçŸ¥', 'success');

                // Reload schedule history
                setTimeout(() => {
                    loadScheduleHistory();
                }, 1000);
            } catch (error) {
                showSmartMessage('ucb-message', 'âŒ è§¸ç™¼å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Schedule History functions
        async function loadScheduleHistory() {
            try {
                const response = await fetch(`${API_BASE}/auto-schedules`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.error || 'ç„¡æ³•è¼‰å…¥æ’ç¨‹æ­·å²');
                }

                const data = await response.json();
                const schedules = data.schedules || [];
                renderScheduleHistory(schedules);
            } catch (error) {
                console.error('Failed to load schedule history:', error);
                document.getElementById('schedule-history-container').innerHTML =
                    `<div class="error-message">
                        <strong>ğŸ“‹ è¼‰å…¥æ’ç¨‹æ­·å²å¤±æ•—</strong><br>
                        ${error.message}<br>
                        <small style="opacity: 0.7;">è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æŸ¥çœ‹è©³ç´°éŒ¯èª¤</small>
                    </div>`;
            }
        }

        async function renderScheduleHistory(schedules) {
            const container = document.getElementById('schedule-history-container');

            if (schedules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <h3>é‚„æ²’æœ‰æ’ç¨‹è¨˜éŒ„</h3>
                        <p>ç³»çµ±æœƒåœ¨æ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ï¼Œæˆ–é»æ“Šã€Œæ¸¬è©¦ç”Ÿæˆç™¼é€ã€é€²è¡Œæ¸¬è©¦</p>
                    </div>
                `;
                return;
            }

            // Fetch current UCB config to display
            let ucbConfig = null;
            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    ucbConfig = data.config;
                }
            } catch (error) {
                console.error('Failed to load UCB config for schedule history:', error);
            }

            // Get Threads account name
            let threadsAccountName = 'æœªè¨­å®š';
            if (ucbConfig && ucbConfig.threads_account_id) {
                const accountSelect = document.getElementById('ucbThreadsAccount');
                const selectedOption = accountSelect.querySelector(`option[value="${ucbConfig.threads_account_id}"]`);
                if (selectedOption) {
                    threadsAccountName = selectedOption.textContent;
                }
            }

            container.innerHTML = `
                ${ucbConfig ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">ğŸ¯</span> ç›®å‰åŸ·è¡Œä¸­çš„ UCB åƒæ•¸
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">æ¢ç´¢å› å­</div>
                            <div style="font-size: 18px; font-weight: bold;">${parseFloat(ucbConfig.exploration_factor || 1.5).toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">æ¯æ—¥ç™¼æ–‡æ•¸</div>
                            <div style="font-size: 18px; font-weight: bold;">${ucbConfig.posts_per_day || 1} å‰‡</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">ç™¼æ–‡æ™‚é–“ç¯„åœ</div>
                            <div style="font-size: 16px; font-weight: bold;">${ucbConfig.time_range_start || 'æœªè¨­å®š'} ~ ${ucbConfig.time_range_end || 'æœªè¨­å®š'}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Threads å¸³è™Ÿ</div>
                            <div style="font-size: 14px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(threadsAccountName)}">${escapeHtml(threadsAccountName)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">è‡ªå‹•æ’ç¨‹ç‹€æ…‹</div>
                            <div style="font-size: 16px; font-weight: bold;">${ucbConfig.auto_schedule_enabled ? 'âœ… å·²å•Ÿç”¨' : 'â¸ï¸ å·²æš«åœ'}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">æœ€å°æ¸¬è©¦æ¬¡æ•¸</div>
                            <div style="font-size: 18px; font-weight: bold;">${ucbConfig.min_trials_per_template || 5} æ¬¡</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; opacity: 0.85; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 3px solid rgba(255,255,255,0.5);">
                        ğŸ’¡ ä»¥ä¸Šåƒæ•¸ç”± UCB æ¼”ç®—æ³•ä½¿ç”¨ï¼Œæ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ï¼Œæˆ–ä½¿ç”¨ã€Œç«‹å³è§¸ç™¼ã€æŒ‰éˆ•æ¸¬è©¦
                    </div>
                </div>
                ` : ''}
                <div class="schedule-list">
                    ${schedules.map(schedule => {
                const statusMap = {
                    'PENDING': { label: 'å¾…åŸ·è¡Œ', class: 'status-pending' },
                    'GENERATED': { label: 'å·²ç”Ÿæˆ', class: 'status-generated' },
                    'POSTED': { label: 'å·²ç™¼å¸ƒ', class: 'status-posted' },
                    'FAILED': { label: 'å¤±æ•—', class: 'status-failed' },
                    'CANCELLED': { label: 'å·²å–æ¶ˆ', class: 'status-cancelled' }
                };
                const status = statusMap[schedule.status] || { label: schedule.status, class: '' };

                return `
                        <div class="schedule-item">
                            <div class="schedule-header">
                                <div class="schedule-date">ğŸ“… ${formatDate(schedule.schedule_date)}</div>
                                <span class="schedule-status ${status.class}">${status.label}</span>
                            </div>

                            <div class="schedule-info">
                                <div class="schedule-info-item">
                                    <strong>ç™¼æ–‡æ™‚é–“:</strong> ${formatDateTime(schedule.scheduled_time)}
                                </div>
                                <div class="schedule-info-item">
                                    <strong>ä½¿ç”¨æ¨¡æ¿:</strong> ${escapeHtml(schedule.template_name || 'æœªçŸ¥')}
                                </div>
                                <div class="schedule-info-item">
                                    <strong>UCB åˆ†æ•¸:</strong> ${schedule.ucb_score ? parseFloat(schedule.ucb_score).toFixed(4) : 'â€”'}
                                </div>
                                <div class="schedule-info-item">
                                    <strong>æ™‚æ®µ:</strong> ${escapeHtml(schedule.time_slot_name || 'æœªçŸ¥')}
                                </div>
                            </div>

                            ${schedule.selection_reason ? `
                                <div class="schedule-reason">
                                    <strong>AI æ±ºç­–åŸå› :</strong>
                                    ${escapeHtml(schedule.selection_reason)}
                                </div>
                            ` : ''}

                            ${(schedule.status === 'PENDING' || schedule.status === 'FAILED') ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤æ­¤æ’ç¨‹
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        // Delete auto schedule function
        async function deleteAutoSchedule(scheduleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç¨‹å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            try {
                const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'åˆªé™¤å¤±æ•—');
                }

                showSmartMessage('ucb-message', 'âœ… æ’ç¨‹å·²åˆªé™¤', 'success');
                loadScheduleHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        // Template Testing functions
        async function testSmartTemplate(templateId) {
            const template = smartSchedulingTemplates.find(t => t.id === templateId);
            if (!template) return;

            currentTestPrompt = template.prompt;
            currentTestEngine = template.preferred_engine || 'GPT5_2';
            openPreviewModal(template.name, currentTestEngine);
            await generatePreview();
        }

        async function testCurrentTemplate() {
            const prompt = document.getElementById('template-prompt').value;
            const engine = document.getElementById('template-engine').value;
            const name = document.getElementById('template-name').value || 'æœªå‘½åæ¨¡æ¿';

            if (!prompt) {
                alert('è«‹å…ˆå¡«å¯«æç¤ºè©å…§å®¹');
                return;
            }

            currentTestPrompt = prompt;
            currentTestEngine = engine;
            openPreviewModal(name, currentTestEngine);
            await generatePreview();
        }

        function openPreviewModal(templateName, engine) {
            document.getElementById('previewModal').classList.add('active');
            const engineName = getEngineName(engine);
            document.querySelector('#previewModal .modal-header h2').textContent = `ğŸ“ ${templateName} - å…§å®¹é è¦½ (${engineName})`;
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function regeneratePreview() {
            await generatePreview();
        }

        async function generatePreview() {
            const resultDiv = document.getElementById('preview-result');
            const engine = currentTestEngine;
            const engineName = getEngineName(engine);

            // Show loading
            resultDiv.innerHTML = `
                <div class="preview-loading">
                    <div class="spinner-small"></div>
                    <p>AI æ­£åœ¨ç”Ÿæˆå…§å®¹...</p>
                    <p style="font-size: 13px; color: #9ca3af;">ä½¿ç”¨å¼•æ“: ${engineName}</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/generate/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: currentTestPrompt,
                        engine: engine
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç”Ÿæˆå¤±æ•—');
                }

                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="preview-content">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #0369a1;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>é€™æ˜¯ AI æ ¹æ“šæ¨¡æ¿æç¤ºè©ç”Ÿæˆçš„å…§å®¹ç¯„ä¾‹ã€‚æ¯æ¬¡ç”Ÿæˆçš„å…§å®¹éƒ½æœƒæœ‰æ‰€ä¸åŒã€‚
                        <br><strong>ä½¿ç”¨å¼•æ“ï¼š</strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        ç”Ÿæˆå¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }

        // Helper functions
        function getEngineName(engineCode) {
            const engineNames = {
                'GPT5_2': 'GPT-5.2',
                'GPT5_2_INSTANT': 'GPT-5.2 Instant',
                'GPT4O': 'GPT-4o',
                'GEMINI_3_FLASH': 'Gemini 3 Flash',
                'GEMINI_3_PRO_PREVIEW': 'Gemini 3 Pro',
                'GEMINI_2_5_FLASH': 'Gemini 2.5 Flash'
            };
            return engineNames[engineCode] || engineCode;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSmartMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;

            container.insertBefore(messageDiv, container.firstChild);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Auto refresh
        setInterval(() => {
            if (token && document.getElementById('dashboard').classList.contains('active')) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'overviewTab') {
                    loadOverview();
                    loadStatsSummary(); // Also refresh stats
                }
                if (activeTab.id === 'postsTab') loadPosts();
                if (activeTab.id === 'accountsTab') loadThreadsAccountsList();
            }
        }, 30000); // Refresh every 30 seconds

        // ========== STATISTICS FUNCTIONS ==========

        let stats7DayChartInstance = null;

        // Switch between statistics sub-tabs
        function switchStatsTab(tabName) {
            // Remove active class from all stats sub-tabs
            document.querySelectorAll('.stats-sub-tab').forEach(tab => {
                tab.style.background = '#e5e7eb';
                tab.style.color = '#333';
                tab.classList.remove('active');
            });

            // Hide all stats sub-content
            document.querySelectorAll('.stats-sub-content').forEach(content => {
                content.style.display = 'none';
            });

            // Activate selected tab
            event.target.style.background = '#667eea';
            event.target.style.color = 'white';
            event.target.classList.add('active');

            // Show selected content
            const contentMap = {
                'summary': 'statsSummaryTab',
                'templates': 'statsTemplatesTab',
                'timeslots': 'statsTimeslotsTab',
                'details': 'statsDetailsTab'
            };

            const contentId = contentMap[tabName];
            if (contentId) {
                document.getElementById(contentId).style.display = 'block';
            }

            // Load data for the selected tab
            if (tabName === 'summary') {
                loadStatsSummary();
            } else if (tabName === 'templates') {
                loadStatsTemplates();
            } else if (tabName === 'timeslots') {
                loadStatsTimeslots();
            } else if (tabName === 'details') {
                loadStatsDetails();
            }
        }

        // Load statistics summary
        async function loadStatsSummary() {
            try {
                // Get selected days from dropdown
                const daysSelect = document.getElementById('trendDaysSelect');
                const days = daysSelect ? daysSelect.value : '7';

                // Fetch overview statistics from API
                const [overviewRes, syncStatusRes] = await Promise.all([
                    fetch(`${API_BASE}/statistics/overview?days=${days}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/statistics/sync-status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const overviewData = await overviewRes.json();
                const syncData = await syncStatusRes.json();

                if (!overviewData.success) {
                    throw new Error(overviewData.error || 'Failed to load overview');
                }

                const overview = overviewData.data?.overview || {};
                const trend = overviewData.data?.trend || { dates: [], views: [], engagement: [] };

                const avgEngagement = parseFloat(overview.avg_engagement_rate) || 0;

                const data = {
                    total_posts: overview.total_posts || 0,
                    total_views: overview.total_views || 0,
                    total_likes: overview.total_likes || 0,
                    avg_engagement_rate: avgEngagement.toFixed(1),
                    last_sync: syncData.success && syncData.data?.last_synced_at
                        ? new Date(syncData.data.last_synced_at).toLocaleString('zh-TW')
                        : 'å°šæœªåŒæ­¥',
                    trend_data: {
                        dates: (trend.dates || []).map(d => d ? d.substring(5).replace('-', '/') : ''),
                        views: trend.views || [],
                        engagement: (trend.engagement || []).map(e => parseFloat((parseFloat(e) || 0).toFixed(1)))
                    }
                };

                // Update summary metrics
                document.getElementById('statsTotalPosts').textContent = data.total_posts;
                document.getElementById('statsTotalViews').textContent = data.total_views.toLocaleString();
                document.getElementById('statsTotalLikes').textContent = data.total_likes.toLocaleString();
                document.getElementById('statsAvgEngagement').textContent = data.avg_engagement_rate + '%';
                document.getElementById('statsLastSync').textContent = data.last_sync;

                // Update synced count
                const syncedCountEl = document.getElementById('statsSyncedCount');
                if (syncedCountEl && syncData.success) {
                    syncedCountEl.textContent = syncData.data?.synced_count || 0;
                }

                // Update 7-day trend chart
                const ctx = document.getElementById('stats7DayChart');
                if (ctx) {
                    // Destroy existing chart if it exists
                    if (stats7DayChartInstance) {
                        stats7DayChartInstance.destroy();
                    }

                    stats7DayChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.trend_data.dates,
                            datasets: [
                                {
                                    label: 'è§€çœ‹æ•¸',
                                    data: data.trend_data.views,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'åƒèˆ‡ç‡ (%)',
                                    data: data.trend_data.engagement,
                                    borderColor: '#764ba2',
                                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 11 },
                                        padding: 10
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    position: 'left',
                                    title: { display: true, text: 'è§€çœ‹æ•¸', font: { size: 10 } },
                                    ticks: { font: { size: 10 } }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'right',
                                    title: { display: true, text: 'åƒèˆ‡ç‡ (%)', font: { size: 10 } },
                                    ticks: { font: { size: 10 } },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Failed to load statistics summary:', error);
                showAlert('dashboardAlert', 'çµ±è¨ˆæ•¸æ“šè¼‰å…¥å¤±æ•—', 'danger');
            }
        }

        // Sync Threads posts from account
        async function syncThreadsPosts() {
            if (!confirm('æ­¤æ“ä½œå°‡å¾æ‚¨çš„ Threads å¸³è™ŸåŒ¯å…¥æœ€è¿‘ 50 ç¯‡è²¼æ–‡åŠå…¶äº’å‹•æ•¸æ“šã€‚\n\nç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            try {
                showAlert('dashboardAlert', 'æ­£åœ¨å¾ Threads åŒ¯å…¥æ­·å²è²¼æ–‡ï¼Œè«‹ç¨å€™...', 'info');

                const response = await fetch(`${API_BASE}/statistics/sync-threads-posts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ limit: 50 })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message, 'success');
                loadStatsSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
            } catch (error) {
                console.error('Failed to sync Threads posts:', error);
                showAlert('dashboardAlert', 'åŒ¯å…¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Trigger manual insights sync
        async function triggerManualSync() {
            try {
                showAlert('dashboardAlert', 'æ­£åœ¨åŒæ­¥äº’å‹•æ•¸æ“šï¼Œè«‹ç¨å€™...', 'info');

                const response = await fetch(`${API_BASE}/statistics/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 7, limit: 50 })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message || 'å·²é–‹å§‹åŒæ­¥äº’å‹•æ•¸æ“š', 'success');
                setTimeout(() => loadStatsSummary(), 3000); // 3ç§’å¾Œé‡æ–°è¼‰å…¥
            } catch (error) {
                console.error('Failed to trigger manual sync:', error);
                showAlert('dashboardAlert', 'åŒæ­¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Load template statistics
        async function loadStatsTemplates() {
            const container = document.getElementById('statsTemplatesList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/templates?days=30`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load templates');
                }

                const templates = result.data;

                if (templates.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ¨£æ¿æ•¸æ“š</p>';
                    return;
                }

                let html = '';
                templates.forEach(template => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${template.name}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                <div>ä½¿ç”¨æ¬¡æ•¸: ${template.total_uses || 0}</div>
                                <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(template.avg_likes) || 0)}</div>
                                <div>åƒèˆ‡ç‡: ${(parseFloat(template.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(template.avg_views) || 0)}</div>
                            </div>
                            ${template.best_performing_time ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #28a745;">
                                    â­ æœ€ä½³æ™‚æ®µ: ${template.best_performing_time}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load template statistics:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Load timeslot statistics
        async function loadStatsTimeslots() {
            const container = document.getElementById('statsTimeslotsList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/timeslots?days=30`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load timeslots');
                }

                const timeslots = result.data;

                if (timeslots.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ™‚æ®µæ•¸æ“š</p>';
                    return;
                }

                // çµ„ç¹”æ™‚æ®µæ¨™ç±¤
                const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];

                let html = '';
                timeslots.forEach(slot => {
                    const label = `${dayNames[slot.day_of_week]} ${String(slot.hour).padStart(2, '0')}:00`;
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${label}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                <div>ä½¿ç”¨æ¬¡æ•¸: ${slot.posts_count || 0}</div>
                                <div>åƒèˆ‡ç‡: ${(parseFloat(slot.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(slot.avg_likes) || 0)}</div>
                                <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(slot.avg_views) || 0)}</div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load timeslot statistics:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Load post details
        async function loadStatsDetails() {
            const container = document.getElementById('statsDetailsList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/posts?limit=20&sortBy=posted_at&sortOrder=DESC`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load posts');
                }

                const posts = result.data.posts;

                if (posts.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡è²¼æ–‡æ•¸æ“š</p>';
                    return;
                }

                let html = `
                    <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left;">ç™¼å¸ƒæ™‚é–“</th>
                                <th style="padding: 10px; text-align: left;">å…§å®¹</th>
                                <th style="padding: 10px; text-align: center;">ğŸ‘ï¸ è§€çœ‹</th>
                                <th style="padding: 10px; text-align: center;">â¤ï¸ æŒ‰è®š</th>
                                <th style="padding: 10px; text-align: center;">ğŸ“Š åƒèˆ‡ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                posts.forEach(post => {
                    const content = post.content_preview || post.content || '(ç„¡å…§å®¹)';
                    const truncated = content.length > 25 ? content.substring(0, 25) + '...' : content;
                    const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    html += `
                        <tr style="border-top: 1px solid #e5e7eb;">
                            <td style="padding: 10px; white-space: nowrap;">${postedAt}</td>
                            <td style="padding: 10px;">${truncated}</td>
                            <td style="padding: 10px; text-align: center;">${(post.views || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: center;">${post.likes || 0}</td>
                            <td style="padding: 10px; text-align: center;">${(parseFloat(post.engagement_rate) || 0).toFixed(1)}%</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load post details:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Export statistics to CSV
        function exportStatsToCSV() {
            // TODO: Implement CSV export functionality
            showAlert('dashboardAlert', 'CSV åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
        }

        // Trigger manual sync
        async function triggerManualSync() {
            try {
                showAlert('dashboardAlert', 'é–‹å§‹åŒæ­¥ Insights æ•¸æ“š...', 'info');

                const response = await fetch(`${API_BASE}/statistics/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 7, limit: 50 })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Sync failed');
                }

                showAlert('dashboardAlert', 'âœ… ' + result.message, 'success');

                // ç­‰å¾… 2 ç§’å¾Œé‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                setTimeout(() => {
                    loadStatsSummary();
                    if (currentStatsTab === 'templates') loadStatsTemplates();
                    if (currentStatsTab === 'timeslots') loadStatsTimeslots();
                    if (currentStatsTab === 'details') loadStatsDetails();
                }, 2000);

            } catch (error) {
                console.error('Failed to trigger sync:', error);
                showAlert('dashboardAlert', 'åŒæ­¥å¤±æ•—', 'danger');
            }
        }

        // Initialize statistics on page load
        document.addEventListener('DOMContentLoaded', function () {
            if (token) {
                loadStatsSummary();
            }
        });

    </script>
</body>

</html>