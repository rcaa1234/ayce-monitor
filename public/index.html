<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads ?äËá™?ïÁôº?áÁ≥ªÁµ?- ÁÆ°Á?‰ªãÈù¢</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .user-info {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .user-info p {
            color: #333;
            margin: 5px 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-section,
        .dashboard {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sub-tabs styling */
        .sub-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 15px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .sub-tab-content {
            display: none;
            padding-top: 20px;
        }

        .sub-tab-content.active {
            display: block;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .post-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .post-card .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-DRAFT {
            background: #e9ecef;
            color: #495057;
        }

        .status-GENERATING {
            background: #fff3cd;
            color: #856404;
        }

        .status-PENDING_REVIEW {
            background: #cce5ff;
            color: #004085;
        }

        .status-APPROVED {
            background: #d4edda;
            color: #155724;
        }

        .status-POSTED {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-FAILED {
            background: #f8d7da;
            color: #721c24;
        }

        .post-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            min-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Smart Scheduling Styles */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .template-card {
            background: white;
            border: none;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .template-card:hover {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .template-card.disabled {
            opacity: 0.6;
            background: #f9fafb;
            border-left-color: #9ca3af;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .template-description {
            font-size: 14px;
            color: #6b7280;
        }

        .template-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-enabled {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .template-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .template-prompt {
            font-size: 13px;
            color: #4b5563;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            max-height: 70px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-actions .btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 13px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        .config-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
        }

        .config-card h3 {
            color: #111827;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h4 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 13px;
            opacity: 0.9;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .schedule-date {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .schedule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-generated {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-posted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .schedule-info-item {
            color: #6b7280;
        }

        .schedule-info-item strong {
            color: #111827;
        }

        .schedule-reason {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
            border-left: 3px solid #667eea;
        }

        .schedule-reason strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .preview-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
            color: #1f2937;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }

        .preview-loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .preview-loading .spinner-small {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-test {
            background: #10b981;
            color: white;
        }

        .btn-test:hover {
            background: #059669;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>?? Threads ?äËá™?ïÁôº?áÁ≥ªÁµ?/h1>
            <p>AI È©ÖÂ??ÑÂÖßÂÆπÁ??êË??ºÂ?ÁÆ°Á?Âπ≥Âè∞</p>
            <div id="userInfo" class="user-info">
                <p><strong>‰ΩøÁî®??</strong> <span id="userName"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>ËßíËâ≤:</strong> <span id="userRoles"></span></p>
                <button class="logout-btn" onclick="logout()">?ªÂá∫</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px;">?ªÂÖ•Á≥ªÁµ±</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>ÂØÜÁ¢º</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">?ªÂÖ•</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">?? Á∏ΩË¶Ω</button>
                <button class="tab" onclick="switchTab('scheduling')">?? ?ºÊ??íÁ?</button>
                <button class="tab" onclick="switchTab('templates')">???êÁ§∫Ë©ûË®≠ÂÆ?/button>
                <button class="tab" onclick="switchTab('accounts')">?ôÔ? Â∏≥Ë?ÁÆ°Á?</button>
                <button class="tab" onclick="switchTab('monitor')">?? ?≤È???éß</button>
            </div>

            <!-- Alert Area -->
            <div id="dashboardAlert"></div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">?ïÁ?‰∏?..</p>
            </div>

            <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content active">
                <!-- System Overview -->
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px;">Á≥ªÁµ±Á∏ΩË¶Ω</h2>
                    <div class="stats" id="stats" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card">
                            <h3 id="totalPosts">0</h3>
                            <p>Á∏ΩË≤º?áÊï∏</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingPosts">0</h3>
                            <p>ÂæÖÂØ©??/p>
                        </div>
                        <div class="stat-card">
                            <h3 id="scheduledPosts">0</h3>
                            <p>?íÁ?‰∏?/p>
                        </div>
                        <div class="stat-card">
                            <h3 id="postedPosts">0</h3>
                            <p>Â∑≤ÁôºÂ∏?/p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div>
                    <h2 style="margin-bottom: 20px;">Ë≤ºÊ?Áµ±Ë?</h2>

                    <!-- Statistics Sub-tabs -->
                    <div
                        style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                        <button class="stats-sub-tab active" onclick="switchStatsTab('summary')"
                            style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ?? ?òË?
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('templates')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ?? È°ûÂ?
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('timeslots')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ???ÇÊÆµ
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('details')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ?? ?éÁ¥∞
                        </button>
                    </div>

                    <!-- Statistics Summary Sub-tab -->
                    <div id="statsSummaryTab" class="stats-sub-content active"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; margin: 0;">?¥È?Ë°®Áèæ</h3>
                            <select id="summaryDaysSelect" onchange="loadStatsSummary()"
                                style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                <option value="7">?ÄËø?7 Â§?/option>
                                <option value="30">?ÄËø?30 Â§?/option>
                                <option value="90">?ÄËø?90 Â§?/option>
                                <option value="180">?ÄËø?180 Â§?/option>
                                <option value="360">?ÄËø?360 Â§?/option>
                                <option value="all">?®ÈÉ®Ê≠∑Âè≤</option>
                            </select>
                        </div>

                        <!-- Key Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalPosts">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Â∑≤ÁôºÂ∏ÉË≤º??/div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalViews">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Á∏ΩË??ãÊï∏</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalLikes">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Á∏ΩÊ?ËÆöÊï∏</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;"
                                    id="statsAvgEngagement">-</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Âπ≥Â??ÉË???/div>
                            </div>
                        </div>

                        <!-- Trend Chart -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0;">Ë∂®Âã¢??/h4>
                                <select id="trendDaysSelect" onchange="loadStatsSummary()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                    <option value="7">?ÄËø?7 Â§?/option>
                                    <option value="30">?ÄËø?30 Â§?/option>
                                    <option value="90">?ÄËø?90 Â§?/option>
                                    <option value="180">?ÄËø?180 Â§?/option>
                                    <option value="360">?ÄËø?360 Â§?/option>
                                </select>
                            </div>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="stats7DayChart"></canvas>
                            </div>
                            <div
                                style="margin-top: 10px; padding: 8px 12px; background: #f0f4f8; border-radius: 6px; font-size: 11px; color: #64748b;">
                                <strong>?? ?ÉË??áË?ÁÆóÂÖ¨ÂºèÔ?</strong>
                                <span
                                    style="font-family: monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">
                                    ?ÉË???= (?âË? + ?ûË? + ËΩâÁôº) √∑ ËßÄ?ãÊï∏ ? 100%
                                </span>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div id="statsSyncStatus"
                            style="background: white; padding: 15px; border-radius: 8px; font-size: 13px; color: #666;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div>‰∏äÊ¨°?åÊ≠•: <span id="statsLastSync">-</span></div>
                                    <div style="margin-top: 5px;">Â∑≤Â?Ê≠•Ë≤º?? <span id="statsSyncedCount">-</span> ÁØ?/div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="syncThreadsPosts(true)"
                                        style="padding: 5px 12px; background: #059669; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ?ì¶ ÂÆåÊï¥?ØÂÖ•?®ÈÉ®
                                    </button>
                                    <button onclick="reclassifyTemplates()"
                                        style="padding: 5px 12px; background: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ?è∑Ô∏??çÊñ∞?ÜÈ?Ê®°Êùø
                                    </button>
                                    <button onclick="triggerManualSync()"
                                        style="padding: 5px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ?? ?åÊ≠•‰∫íÂ??∏Ê?
                                    </button>
                                    <button onclick="clearPendingPosts()"
                                        style="padding: 5px 12px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ??Ô∏?Ê∏ÖÈô§ÂæÖÂØ©??
                                    </button>
                                    <button onclick="clearScheduledPosts()"
                                        style="padding: 5px 12px; background: #f97316; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ??Ô∏?Ê∏ÖÈô§?íÁ?‰∏?
                                    </button>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #999;">
                                ?í° ?êÁ§∫Ôºö„ÄåÂ??¥ÂåØ?•ÂÖ®?®„ÄçÂåØ?•Ê??âÊ≠∑?≤Ë≤º?áÔ??åÈ??∞Â?È°ûÊ®°?ø„ÄçÊ??∫Ê??âÊ®°?øÁ?Ë≤ºÊ??™Â??ÜÈ???
                            </p>
                        </div>

                        <!-- Data Analytics Section -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="font-size: 15px; color: #333; margin: 0;">?? ?∏Ê??ÜÊ?</h4>
                                <select id="analyticsDaysSelect" onchange="onAnalyticsDaysChange()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                    <option value="7">?ÄËø?7 Â§?/option>
                                    <option value="30" selected>?ÄËø?30 Â§?/option>
                                    <option value="90">?ÄËø?90 Â§?/option>
                                    <option value="180">?ÄËø?180 Â§?/option>
                                    <option value="365">?ÄËø?365 Â§?/option>
                                    <option value="9999">?®ÈÉ®Ê≠∑Âè≤</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <!-- Best Posting Hours -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">?? ?Ä‰Ω≥Áôº?áÊ?ÊÆ?/h4>
                                <div id="bestHoursChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">ËºâÂÖ•‰∏?..
                                    </p>
                                </div>
                            </div>

                            <!-- Best Posting Days -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">?? ?üÊ?Ë°®Áèæ?ÜÊ?</h4>
                                <div id="bestDaysChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">ËºâÂÖ•‰∏?..
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performing Posts -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">?? Top 5 Ë°®Áèæ?Ä‰Ω≥Ë≤º??/h4>
                            <div id="topPostsList" style="max-height: 300px; overflow-y: auto;">
                                <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- Content Length Analysis -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">?? ?ßÂÆπ?∑Â∫¶?ÜÊ?</h4>
                            <div id="contentLengthAnalysis" style="min-height: 80px;">
                                <p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Templates Sub-tab (?πÁÇ∫?ºÊ?È°ûÂ??ÜÊ?) -->
                    <div id="statsTemplatesTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">?? ?ºÊ?È°ûÂ??ÜÊ?</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                            Áµ±Ë?‰∏âÁ®Æ?ºÊ?È°ûÂ??ÑË°®?æÔ?AI ?ºÊ??ÅÈ? AI (?´Â?)?ÅÈ? AI (?°Â?)
                        </p>
                        <div id="statsTemplatesList" style="display: grid; gap: 15px;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                        </div>
                    </div>

                    <!-- Statistics Timeslots Sub-tab -->
                    <div id="statsTimeslotsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">?ÇÊÆµ?ÜÊ?</h3>
                        <div id="statsTimeslotsList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                        </div>
                    </div>

                    <!-- Statistics Details Sub-tab -->
                    <div id="statsDetailsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">Ë≤ºÊ??éÁ¥∞</h3>

                        <!-- Export Button -->
                        <div style="margin-bottom: 15px; text-align: right;">
                            <button onclick="exportStatsToCSV()"
                                style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                ?ì• ?ØÂá∫ CSV
                            </button>
                        </div>

                        <div id="statsDetailsList" style="max-height: 450px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts Tab -->
        <div id="postsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Ë≤ºÊ?ÁÆ°Á?</h2>

                <div class="filter-bar">
                    <select id="filterStatus" onchange="loadPosts()">
                        <option value="">?®ÈÉ®?Ä??/option>
                        <option value="DRAFT">?âÁ®ø</option>
                        <option value="GENERATING">?¢Á?‰∏?/option>
                        <option value="PENDING_REVIEW">ÂæÖÂØ©??/option>
                        <option value="APPROVED">Â∑≤Ê†∏??/option>
                        <option value="POSTED">Â∑≤ÁôºÂ∏?/option>
                        <option value="FAILED">Â§±Ê?</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="loadPosts()">?? ?çÊñ∞?¥Á?</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">?ëÔ? ?®ÈÅ∏/?çÈÅ∏</button>
                    <button class="btn btn-danger btn-small" onclick="batchDeletePosts()" id="batchDeleteBtn"
                        style="display: none;">??Ô∏??πÊ¨°?™Èô§</button>
                </div>

                <div id="postsGrid" class="posts-grid"></div>
            </div>

            <!-- Scheduling Tab (with sub-tabs) -->
        <div id="schedulingTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">?ºÊ??íÁ?ÁÆ°Á?</h2>

                <!-- Internal Sub-tabs -->
                <div class="sub-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    <button class="sub-tab active" onclick="switchSchedulingSubTab('ai')">?? AI?ºÊ?</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('manual')">?? ?êÁ??ºÊ?</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('pending')">?? ?íÁ?‰∏≠Ë≤º??/button>
                </div>

                <!-- AI Post Sub-tab -->
                <div id="aiSubTab" class="sub-tab-content active">
                    <h3 style="margin-bottom: 20px;">AI ?™Â??ºÊ?Ë®≠Â?</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ë®≠Â? AI ?™Â??üÊ?Ë≤ºÊ??ÑÁôº?áÈ†ª?áÂ??ÇÊÆµÔºåÁ≥ªÁµ±Ê??πÊ??åÊ?Á§∫Ë?Ë®≠Â??çÁ??ßÂÆπ?™Â??¢Á?‰∏¶ÁôºÂ∏ÉË≤º??/p>

                    <div class="config-grid">
                        <!-- Left: Configuration Form -->
                        <div class="config-card">
                            <h3>?ºÊ?Ë®≠Â?</h3>
                            <form id="ai-config-form" onsubmit="saveAIConfig(event)">
                                <div class="form-group">
                                    <label for="posts-per-day">ÊØèÊó•?ºÊ?Ê¨°Êï∏</label>
                                    <input type="number" id="posts-per-day" min="1" max="10" value="1" required>
                                    <small>Á≥ªÁµ±ÊØèÂ§©?™Â?Âª∫Á?ÂπæÂÄãÁôº?áÊ?Á®?/small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-start">?ºÊ??ÇÊÆµ - ?ãÂ??ÇÈ?</label>
                                    <input type="time" id="time-range-start" value="09:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI ?ÉÂú®Ê≠§Ê??ì‰?ÂæåÈö®Ê©üÈÅ∏?áÁôº?áÊ???/small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-end">?ºÊ??ÇÊÆµ - ÁµêÊ??ÇÈ?</label>
                                    <input type="time" id="time-range-end" value="21:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI ?ÉÂú®Ê≠§Ê??ì‰??çÈÅ∏?áÁôº?áÊ???/small>
                                </div>

                                <div class="form-group">
                                    <label>?üÁî®?üÊ?</label>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="1" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±‰?</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="2" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±‰?</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="3" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±‰?</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="4" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±Â?</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="5" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±‰?</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="6" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±ÂÖ≠</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="7" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">?±Êó•</span>
                                        </label>
                                    </div>
                                    <small style="margin-top: 8px; display: block;">?∏Ê? AI ?™Â??ºÊ??ÑÊ??üÔ??™ÈÅ∏?áÁ??üÊ?‰∏çÊ??™Â??ºÊ?</small>
                                </div>

                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="auto-schedule-enabled" checked>
                                        <label for="auto-schedule-enabled" style="margin-bottom: 0;">?üÁî®?™Â??ºÊ?</label>
                                    </div>
                                    <small>ÊØèÂ§© 00:00 ?™Â?Âª∫Á??íÁ?‰∏¶Áôº?ÅÂà∞ LINE ÂØ©Ê†∏</small>
                                </div>

                                <button type="submit" class="btn btn-success" style="width: 100%;">?íæ ?≤Â?Ë®≠Â?</button>
                            </form>
                        </div>

                        <!-- Right: Quick Actions & Info -->
                        <div class="config-card">
                            <h3>Âø´ÈÄüÊ?‰Ω?/h3>

                            <div
                                style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                                <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">?? ‰ΩøÁî®Ë™™Ê?</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #334155; line-height: 1.8;">
                                    <li><strong>?üÁî®?™Â??ºÊ?</strong>ÔºöÊ?Â§?00:00 ?™Â?Âª∫Á??ºÊ??íÁ?</li>
                                    <li><strong>?êÁ§∫Ë©ûË®≠ÂÆ?/strong>ÔºöÂú®?åÊ?Á§∫Ë?Ë®≠Â??çÈ??¢Ë®≠ÂÆ?AI ?üÊ??ßÂÆπ?ÑÊ?‰ª?/li>
                                    <li><strong>LINE ÂØ©Ê†∏</strong>ÔºöÁôº?áÂ??ÉÁôº?ÅÂà∞ LINE ?öÁü•ÂØ©Ê†∏</li>
                                    <li><strong>?∑Ë?ÊµÅÁ?</strong>ÔºöÂª∫Á´ãÊ?Á®????üÊ??áÁ? ??LINE ?öÁü• ??ÂØ©Ê†∏ ???ºÂ?</li>
                                </ul>
                            </div>

                            <div
                                style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">?†Ô? ?çË??êÈ?</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f; line-height: 1.8;">
                                    <li>Ë´ãÂ??®„ÄåÊ?Á§∫Ë?Ë®≠Â??çÈ??¢Ë®≠ÂÆ?AI ?üÊ??êÁ§∫Ë©?/li>
                                    <li>Ë´ãÂú®?åÂ∏≥?üÁÆ°?Ü„ÄçÈ??¢Ë®≠ÂÆ?Threads Â∏≥Ë???LINE User ID</li>
                                    <li>ÊØèÂ§©ÊØèÂÄãÊ?ÊÆµÂè™?ÉÂª∫Á´ã‰??ãÁôº?áÊ?Á®?/li>
                                </ul>
                            </div>

                            <button class="btn btn-primary" onclick="triggerDailySchedule()"
                                style="width: 100%; padding: 15px; font-size: 16px;">
                                ?ß™ Ê∏¨Ë©¶?üÊ??ºÊ?
                            </button>
                            <small
                                style="display: block; margin-top: 10px; color: #6b7280; text-align: center; font-size: 12px;">
                                Á≥ªÁµ±?ÉÁ??≥Á??ê‰?ÁØáÊ?Á´†‰∏¶?ºÈÄ?LINE ?öÁü•ÂØ©Ê†∏
                            </small>
                        </div>
                    </div>

                    <div id="ai-message"></div>

                    <div style="margin-top: 40px;">
                        <div class="action-bar">
                            <h3>?ºÊ??íÁ?Ê≠∑Âè≤</h3>
                            <button class="btn btn-secondary" onclick="loadScheduleHistory()">?çÊñ∞?¥Á?</button>
                        </div>
                        <div id="schedule-history-container"></div>
                    </div>
                </div>
            </div>


            <!-- Threads Accounts Tab -->
        <div id="accountsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Â∏≥Ë?ÁÆ°Á?</h2>

                <!-- AI ?ºÊ?Ë®≠Â? -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- ?ºÂ?Â∏≥Ë?Ë®≠Â? -->
                    <div
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">?ì± AI ?ºÊ?Â∏≥Ë?</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">?∏Ê? Threads Â∏≥Ë?</label>
                            <select id="ucbThreadsAccount" class="form-control"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                                <option value="">Ë´ãÈÅ∏?áÂ∏≥??/option>
                            </select>
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                AI ?™Â??ºÊ?Â∞á‰Ωø?®Ê≠§Â∏≥Ë??ºÂ?Ë≤ºÊ?
                            </p>
                        </div>
                        <button class="btn" onclick="saveAccountSettings()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); width: 100%;">
                            ?íæ ?≤Â?Â∏≥Ë?Ë®≠Â?
                        </button>
                    </div>

                    <!-- LINE ?öÁü•Ë®≠Â? -->
                    <div
                        style="background: linear-gradient(135deg, #00c300 0%, #00a000 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">?í¨ LINE ?öÁü•Ë®≠Â?</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">LINE User ID</label>
                            <input type="text" id="ucbLineNotifyUserId" class="form-control"
                                placeholder="Ë´ãËº∏??LINE User ID"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                ?ºÈÄÅ„Ä?myid?çÁµ¶ LINE Bot ?≥ÂèØ?ñÂ? ID
                            </p>
                        </div>
                        <button class="btn" onclick="testUCBLineNotification()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">?ì®
                            Ê∏¨Ë©¶?öÁü•</button>
                    </div>
                </div>

                <!-- ?∞Â? Threads Â∏≥Ë? -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">?? ?∞Â? Threads Â∏≥Ë?</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ?±Êñº Threads API ?ÄË¶?OAuth ?àÊ?,Ë´ãÊ??ß‰ª•‰∏ãÊ≠•È©üÊ?‰Ω?
                    </p>
                    <ol style="color: #666; line-height: 1.8;">
                        <li>?çÂ? <a href="https://developers.facebook.com/" target="_blank" style="color: #667eea;">Meta
                                Developers</a> Âª∫Á??âÁî®Á®ãÂ?</li>
                        <li>?ñÂ? Client ID ??Client Secret</li>
                        <li>Ë®≠Â? Redirect URI ?? <code
                                style="background: #e1e8ed; padding: 2px 6px; border-radius: 3px;">http://localhost:3000/api/threads/oauth/callback</code>
                        </li>
                        <li>ÈªûÊ?‰∏ãÊñπ?âÈ??ãÂ??àÊ?</li>
                    </ol>
                    <button class="btn" onclick="startThreadsOAuth()" style="margin-top: 15px;">?? ?ãÂ? Threads
                        ?àÊ?</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Â∑≤ÈÄ????Threads Â∏≥Ë?</h3>
                    <button class="btn" onclick="runDiagnostics()" style="background: #17a2b8; padding: 8px 16px;">??
                        Ë®∫Êñ∑?ºÂ??èÈ?</button>
                </div>
                <div id="threadsAccountsList" class="posts-grid"></div>

                <!-- Diagnostics Result -->
                <div id="diagnosticsResult"
                    style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-bottom: 15px;">?? Ë®∫Êñ∑ÁµêÊ?</h3>
                    <div id="diagnosticsContent"></div>
                </div>
            </div>

            <!-- Manual Post Sub-tab -->
            <div id="manualSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">?êÁ??ºÊ?</h3>
                <p style="color: #666; margin-bottom: 20px;">?¥Êé•Ëº∏ÂÖ•Ë≤ºÊ??ßÂÆπÔºåÂèØÁ´ãÂç≥?ºÂ??ñÈ?Á¥ÑÊ??ìÁôºÂ∏?/p>

                <form onsubmit="createManualPost(event)">
                    <div class="form-group">
                        <label>Ë≤ºÊ??ßÂÆπ *</label>
                        <textarea id="manualPostContent" rows="10" placeholder="?¥Êé•Ëº∏ÂÖ•?®ÊÉ≥?ºÂ??ÑÂÖßÂÆ?.." required
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; line-height: 1.6;"></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            Â≠óÊï∏: <span id="contentCharCount">0</span> / 500 (Threads Âª∫Ë≠∞)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>?ºÂ???Threads Â∏≥Ë? *</label>
                        <select id="manualPostThreadsAccount" required style="padding: 12px; font-size: 15px;">
                            <option value="">Ë´ãÈÅ∏?áÂ∏≥??/option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            ?™Ë®≠ÂÆöÂ∏≥?? Ë´ãÂà∞?åThreads Â∏≥Ë??çÂ??ÅÊñ∞Â¢?
                        </p>
                    </div>

                    <div class="form-group">
                        <label>?ºÂ??ÇÈ?</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="now" checked
                                    onchange="toggleScheduleInput()">
                                Á´ãÂç≥?ºÂ?
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="scheduled"
                                    onchange="toggleScheduleInput()">
                                ?íÁ??ºÂ?
                            </label>
                        </div>
                        <input type="datetime-local" id="manualPostSchedule"
                            style="padding: 12px; font-size: 15px; display: none;">
                    </div>

                    <button type="submit" class="btn" style="padding: 15px 30px; font-size: 16px;">?ºÂ?Ë≤ºÊ?</button>
                </form>
            </div>

            <!-- Pending Posts Sub-tab -->
            <div id="pendingSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">?íÁ?‰∏≠Ë≤º??/h3>
                <p style="color: #666; margin-bottom: 20px;">È°ØÁ§∫Â∑≤ÂØ©?∏ÈÄöÈ??ÅÁ?ÂæÖÁôºÂ∏ÉÁ?Ë≤ºÊ?</p>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="loadPendingPosts()">?? ?çÊñ∞?¥Á?</button>
                </div>

                <div id="pendingPostsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999;">ËºâÂÖ•‰∏?..</p>
                </div>
            </div>
        </div>

        <!-- Prompt Settings Tab (?üÊ®°?øË®≠ÂÆ? -->
        <div id="templatesTab" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <!-- Â∑¶ÂÅ¥ÔºöÊ?Á§∫Ë?Á∑®ËºØ?Ä -->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">???êÁ§∫Ë©ûË®≠ÂÆ?/h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Ë®≠Â? AI ?™Â??ºÊ?‰ΩøÁî®?Ñ‰∏ª?êÁ§∫Ë©?/p>

                    <form id="ai-prompt-form" onsubmit="saveAIPrompt(event)">
                        <div class="form-group">
                            <label for="ai-engine">AI ÂºïÊ?</label>
                            <select id="ai-engine" required style="padding: 12px; font-size: 15px;">
                                <option value="GPT5_2">GPT-5.2 (?®Ëñ¶)</option>
                                <option value="GPT5_2_INSTANT">GPT-5.2 Instant (Âø´ÈÄ?</option>
                                <option value="GPT4O">GPT-4o</option>
                                <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                                <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                                <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                            </select>
                            <small>?∏Ê??üÊ?Ë≤ºÊ?‰ΩøÁî®??AI ÂºïÊ?</small>
                        </div>

                        <div class="form-group">
                            <label for="ai-prompt">AI ?êÁ§∫Ë©?/label>
                            <textarea id="ai-prompt" rows="18" required
                                style="width: 100%; padding: 15px; font-size: 14px; line-height: 1.7; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"
                                placeholder="Ë´ãËº∏?•Áµ¶ AI ?ÑÊ?‰ª?.."></textarea>
                            <small>Á≥ªÁµ±?ÉËá™?ïÂ??•Á∂≠Â∫¶Ë®≠ÂÆöÂ??êÂ?ÁØÑ‰?</small>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1; padding: 15px;">?íæ
                                ?≤Â??êÁ§∫Ë©?/button>
                            <button type="button" class="btn btn-primary" onclick="testAIPrompt()"
                                style="flex: 1; padding: 15px;">?ß™ Ê∏¨Ë©¶?üÊ?</button>
                        </div>
                    </form>

                    <!-- Ê∏¨Ë©¶?üÊ?ÁµêÊ? -->
                    <div id="ai-prompt-test-result"
                        style="display: none; margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #374151;">?? ?üÊ?ÁµêÊ??êË¶Ω</h4>
                        <div id="ai-prompt-test-content"
                            style="white-space: pre-wrap; line-height: 1.8; font-size: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>

                <!-- ?≥ÂÅ¥ÔºöÁ∂≠Â∫¶Ë®≠ÂÆöÈù¢??-->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">??Ô∏?Á∂≠Â∫¶Ë®≠Â?</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Ë™øÊï¥?ÑÁ∂≠Â∫¶Á??∏È?Ê¨äÈ??åÁ???/p>

                    <div id="dimensions-container">
                        <!-- MODULE -->
                        <div class="dimension-section" data-dimension="module">
                            <div class="dimension-header" onclick="toggleDimension('module')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?ì¶ ?ßÂÆπÊ®°Á? (MODULE)</span>
                                <span id="module-toggle">??/span>
                            </div>
                            <div id="module-options" class="dimension-options" style="padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- ANGLE -->
                        <div class="dimension-section" data-dimension="angle" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('angle')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?é¨ ?ÖÂ??áË? (ANGLE)</span>
                                <span id="angle-toggle">??/span>
                            </div>
                            <div id="angle-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- OUTLET -->
                        <div class="dimension-section" data-dimension="outlet" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('outlet')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?í° ?ïÁ??∫Âè£ (OUTLET)</span>
                                <span id="outlet-toggle">??/span>
                            </div>
                            <div id="outlet-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- TONE_BIAS -->
                        <div class="dimension-section" data-dimension="tone_bias" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('tone_bias')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?ó£Ô∏?Ë™ûÊ∞£?èÂ? (TONE)</span>
                                <span id="tone_bias-toggle">??/span>
                            </div>
                            <div id="tone_bias-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- ENDING_STYLE -->
                        <div class="dimension-section" data-dimension="ending_style" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('ending_style')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?? ?∂Â∞æ?èÂ? (ENDING)</span>
                                <span id="ending_style-toggle">??/span>
                            </div>
                            <div id="ending_style-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>

                        <!-- LENGTH_TARGET -->
                        <div class="dimension-section" data-dimension="length_target" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('length_target')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">?? Â≠óÊï∏?ÆÊ? (LENGTH)</span>
                                <span id="length_target-toggle">??/span>
                            </div>
                            <div id="length_target-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">ËºâÂÖ•‰∏?..</p>
                            </div>
                        </div>
                    </div>

                    <!-- Áµ±Ë??ÄÂ°?-->
                    <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px;">?? ?ÄËø?30 Â§©‰Ωø?®Áµ±Ë®?/h4>
                        <div id="dimension-stats" style="font-size: 13px; color: #666;">
                            <p>ËºâÂÖ•‰∏?..</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitor Tab (?≤È???éß) -->
        <div id="monitorTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">?? ?≤È???éß</h2>

            <!-- Monitor Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab active" onclick="switchMonitorTab('mentions')">?? ?êÂ??óË°®</button>
                <button class="tab" onclick="switchMonitorTab('brands')">?è∑Ô∏??ÅÁ?ÁÆ°Á?</button>
                <button class="tab" onclick="switchMonitorTab('sources')">?? ‰æÜÊ?ÁÆ°Á?</button>
                <button class="tab" onclick="switchMonitorTab('stats')">?? ?≤È?Áµ±Ë?</button>
            </div>

            <!-- Mentions Sub-tab -->
            <div id="monitorMentionsTab" class="sub-tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="mentionBrandFilter" onchange="loadMentions()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">?®ÈÉ®?ÅÁ?</option>
                        </select>
                        <select id="mentionReadFilter" onchange="loadMentions()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">?®ÈÉ®?Ä??/option>
                            <option value="false">?™Ë?</option>
                            <option value="true">Â∑≤Ë?</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="loadMentions()">?? ?çÊñ∞?¥Á?</button>
                </div>

                <div id="mentionsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                </div>
            </div>

            <!-- Brands Sub-tab -->
            <div id="monitorBrandsTab" class="sub-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>?ÅÁ?/??éß?ÆÊ?</h3>
                    <button class="btn btn-primary" onclick="showAddBrandModal()">???∞Â??ÅÁ?</button>
                </div>

                <div id="brandsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                </div>
            </div>

            <!-- Sources Sub-tab -->
            <div id="monitorSourcesTab" class="sub-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>??éß‰æÜÊ?</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="showSourceTemplates()">?? ?êË®≠‰æÜÊ?</button>
                        <button class="btn btn-primary" onclick="showAddSourceModal()">???∞Â?‰æÜÊ?</button>
                    </div>
                </div>

                <div id="sourcesList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>
                </div>
            </div>

            <!-- Stats Sub-tab -->
            <div id="monitorStatsTab" class="sub-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>?≤È?Áµ±Ë?</h3>
                    <select id="monitorStatsDays" onchange="loadMonitorStats()"
                        style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="7">?éÂéª 7 Â§?/option>
                        <option value="14">?éÂéª 14 Â§?/option>
                        <option value="30" selected>?éÂéª 30 Â§?/option>
                    </select>
                </div>

                <div class="stats" id="monitorStatsCards"
                    style="grid-template-columns: repeat(3, 1fr); margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3 id="monitorTotalMentions">0</h3>
                        <p>Á∏ΩÊ??äÊï∏</p>
                    </div>
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <h3 id="monitorUnreadCount" style="color: white;">0</h3>
                        <p style="color: rgba(255,255,255,0.8);">?™Ë??êÂ?</p>
                    </div>
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 id="monitorBrandCount" style="color: white;">0</h3>
                        <p style="color: rgba(255,255,255,0.8);">??éß?ÅÁ?</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div
                        style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">?? ?ÑÂ??åÊ??äÊï∏</h4>
                        <div id="monitorBrandStats"></div>
                    </div>
                    <div
                        style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">?? ?Ñ‰?Ê∫êÊ??äÊï∏</h4>
                        <div id="monitorSourceStats"></div>
                    </div>
                </div>

                <!-- Google Trends ?ÄÂ°?-->
                <div
                    style="margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">?? Google ?úÂ?Ë∂®Âã¢</h4>
                        <button class="btn btn-secondary" onclick="fetchGoogleTrends()"
                            style="padding: 8px 15px; font-size: 12px;">?? ?ìÂ??Ä?∞Ë∂®??/button>
                    </div>
                    <div id="googleTrendsChart" style="min-height: 200px;">
                        <p style="color: #999; text-align: center; padding: 40px 0;">ÈªûÊ??åÊ??ñÊ??∞Ë∂®?¢„ÄçÊ??ïÈ?ÂßãÊî∂?ÜÊï∏??/p>
                    </div>
                </div>

                <!-- ÊØèÊó•?±È??úÂ? -->
                <div
                    style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">?î• ?∞ÁÅ£?≥Ê??±È??úÂ?</h4>
                        <button class="btn btn-secondary" onclick="loadDailyTrends()"
                            style="padding: 8px 15px; font-size: 12px;">?? ?çÊñ∞?¥Á?</button>
                    </div>
                    <div id="dailyTrendsList" style="display: grid; gap: 10px;">
                        <p style="color: #999; text-align: center; padding: 20px 0;">?â‰??åÈ??∞Êï¥?Ü„ÄçË??•Âç≥?ÇÁÜ±?Ä?úÂ?</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Detail Modal -->
        <div id="postModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Ë≤ºÊ?Ë©≥Ê?</h2>
                    <button class="close-modal" onclick="closeModal()">&times;</button>
                </div>
                <div id="modalBody"></div>
            </div>
        </div>

        <!-- Template Modal -->
        <div id="templateModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">?∞Â?Ê®°Êùø</h2>
                    <button class="close-modal" onclick="closeTemplateModal()">?</button>
                </div>
                <form id="template-form" onsubmit="saveTemplate(event)">
                    <div class="form-group">
                        <label for="template-name">Ê®°Êùø?çÁ®± *</label>
                        <input type="text" id="template-name" required placeholder="‰æãÂ?ÔºöÁü•Ë≠òÂ?‰∫´Â?">
                    </div>

                    <div class="form-group">
                        <label for="template-description">Ê®°Êùø?èËø∞</label>
                        <input type="text" id="template-description" placeholder="Á∞°Áü≠Ë™™Ê??ôÂÄãÊ®°?øÁ??®ÈÄ?>
                    </div>

                    <div class="form-group">
                        <label for="template-engine">AI ÂºïÊ? *</label>
                        <select id="template-engine" required>
                            <option value="GPT5_2">GPT-5.2 (?®Ëñ¶)</option>
                            <option value="GPT5_2_INSTANT">GPT-5.2 Instant (Âø´ÈÄ?</option>
                            <option value="GPT4O">GPT-4o</option>
                            <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                            <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                            <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                        </select>
                        <small>Ê≠§Ê®°?øÁ??êÂÖßÂÆπÊ?Â∞á‰Ωø?®Á? AI ÂºïÊ?</small>
                    </div>

                    <div class="form-group">
                        <label for="template-prompt">?êÁ§∫Ë©ûÂÖßÂÆ?*</label>
                        <textarea id="template-prompt" required placeholder="Ë´ãÁî¢?ü‰?ÁØ?Threads Ë≤ºÊ?..."></textarea>
                        <small>?ôÊòØÁµ?AI ?ÑÊ?‰ª§Ô?Ë´ãË©≥Á¥∞Ê?Ëø∞‰?Â∏åÊ? AI ?üÊ?‰ªÄÈ∫ºÊ®£?ÑÂÖßÂÆ?/small>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="template-enabled" checked>
                            <label for="template-enabled" style="margin-bottom: 0;">?üÁî®Ê≠§Ê®°??/label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">?ñÊ?</button>
                        <button type="button" class="btn btn-test" onclick="testCurrentTemplate()">?ß™ Ê∏¨Ë©¶?üÊ?</button>
                        <button type="submit" class="btn btn-primary">?≤Â?</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>?? ?ßÂÆπ?êË¶Ω</h2>
                    <button class="close-modal" onclick="closePreviewModal()">?</button>
                </div>

                <div id="preview-result"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closePreviewModal()">?úÈ?</button>
                    <button class="btn btn-primary" onclick="regeneratePreview()">?? ?çÊñ∞?üÊ?</button>
                </div>
            </div>
        </div>

        <!-- Edit Post Modal -->
        <div id="editPostModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>?èÔ? Á∑®ËºØË≤ºÊ??ßÂÆπ</h2>
                    <button class="close-modal" onclick="closeEditPostModal()">?</button>
                </div>
                <form id="editPostForm" onsubmit="saveEditedPost(event)">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label for="editPostContent">Ë≤ºÊ??ßÂÆπ</label>
                        <textarea id="editPostContent" rows="15" required
                            style="width: 100%; padding: 15px; font-size: 15px; line-height: 1.8; border: 1px solid #ddd; border-radius: 8px; resize: vertical; min-height: 300px;"
                            placeholder="Ë´ãËº∏?•Ë≤º?áÂÖßÂÆ?.."></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            Â≠óÊï∏: <span id="editPostCharCount">0</span> | Á∑®ËºØÂæåÁ??ßÂÆπ?ÉÂú®?íÁ??ÇÈ??ºÂ???Threads
                        </p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditPostModal()">?ñÊ?</button>
                        <button type="submit" class="btn btn-primary">?íæ ?≤Â?ËÆäÊõ¥</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Global variables
            let token = localStorage.getItem('token');
            const API_BASE = '/api';

            // Initialize
            if (token) {
                checkAuth();
            }

            // Authentication
            async function login(event) {
                event.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        token = data.token;
                        localStorage.setItem('token', token);
                        showDashboard(data.user);
                    } else {
                        showAlert('loginAlert', data.error || '?ªÂÖ•Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('loginAlert', '???Â§±Ê?: ' + error.message, 'error');
                }
            }

            async function checkAuth() {
                try {
                    const response = await fetch(`${API_BASE}/posts?limit=1`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showDashboard();
                    } else {
                        logout();
                    }
                } catch (error) {
                    logout();
                }
            }

            function logout() {
                token = null;
                localStorage.removeItem('token');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('userInfo').classList.remove('active');
            }

            function showDashboard(user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userInfo').classList.add('active');

                if (user) {
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userRoles').textContent = user.roles.join(', ');
                }

                loadOverview();
                loadPosts();
            }

            // Tab switching
            function switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                event.target.classList.add('active');

                document.getElementById(tabName + 'Tab').classList.add('active');

                if (tabName === 'overview') loadOverview();
                if (tabName === 'posts') loadPosts();
                if (tabName === 'scheduling') {
                    loadScheduling();
                }
                if (tabName === 'templates') {
                    loadTemplates();
                }
                if (tabName === 'accounts') {
                    loadThreadsAccountsList();
                    loadThreadsAccountsForDropdowns();
                    loadUCBConfig();
                }
                if (tabName === 'monitor') {
                    loadMentions();
                    loadBrands();
                }
            }

            // Sub-tab switching for scheduling tab
            function switchSchedulingSubTab(subTabName) {
                // Remove active class from all sub-tabs
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked sub-tab
                event.target.classList.add('active');

                // Show corresponding sub-tab content
                if (subTabName === 'manual') {
                    document.getElementById('manualSubTab').classList.add('active');
                    loadThreadsAccountsForDropdowns();
                } else if (subTabName === 'ai') {
                    document.getElementById('aiSubTab').classList.add('active');
                    // ËºâÂÖ• AI ?ºÊ??çÁΩÆ
                    loadAIConfig();
                    loadScheduleHistory();
                } else if (subTabName === 'pending') {
                    document.getElementById('pendingSubTab').classList.add('active');
                    loadPendingPosts();
                }
            }

            // Load overview
            async function loadOverview() {
                try {
                    // ?ñÂ??ÑÁ??ãÁ??∏È?ÔºàÂè™Âæ?posts Ë°®Ë?ÁÆóÔ??øÂ??çË?Ôº?
                    const [pendingRes, approvedRes, postedRes] = await Promise.all([
                        fetch(`${API_BASE}/posts?status=PENDING_REVIEW`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE}/posts?status=APPROVED`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE}/posts?status=POSTED`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);

                    const [pendingData, approvedData, postedData] = await Promise.all([
                        pendingRes.json(),
                        approvedRes.json(),
                        postedRes.json()
                    ]);

                    const pending = pendingData.total || 0;
                    const posted = postedData.total || 0;

                    // ?íÁ?‰∏?= APPROVED ?Ä?ãÁ?Ë≤ºÊ?ÔºàÂ∑≤ÂØ©Ê†∏ÂæÖÁôºÂ∏ÉÔ?
                    // ‰∏çÈ?Ë¶ÅÈ?Â§ñË?ÁÆ?schedulesÔºåÂ???posts.status Â∑≤Á??çÊ?‰∫ÜÂØ©?∏Á???
                    const scheduled = approvedData.total || 0;

                    // Á∏ΩË≤º?áÊï∏ = ÂæÖÂØ©??+ ?íÁ?‰∏?+ Â∑≤ÁôºÂ∏?
                    const total = pending + scheduled + posted;

                    document.getElementById('totalPosts').textContent = total;
                    document.getElementById('pendingPosts').textContent = pending;
                    document.getElementById('scheduledPosts').textContent = scheduled;
                    document.getElementById('postedPosts').textContent = posted;
                } catch (error) {
                    console.error('Failed to load overview:', error);
                    showAlert('dashboardAlert', 'ËºâÂÖ•Á∏ΩË¶ΩÂ§±Ê?: ' + error.message, 'error');
                }
            }

            // Load posts
            async function loadPosts() {
                const status = document.getElementById('filterStatus')?.value || '';
                const url = status ? `${API_BASE}/posts?status=${status}` : `${API_BASE}/posts`;

                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•Â§±Ê?');

                    const data = await response.json();
                    const posts = data.data || data.posts || [];
                    renderPosts(posts, 'postsGrid');
                } catch (error) {
                    showAlert('dashboardAlert', 'ËºâÂÖ•Ë≤ºÊ?Â§±Ê?: ' + error.message, 'error');
                }
            }

            // Render posts
            function renderPosts(posts, containerId) {
                const container = document.getElementById(containerId);

                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px;">?´ÁÑ°Ë≤ºÊ?</p>
                        <p style="margin-top: 10px;">Âª∫Á?Á¨¨‰?ÁØáË≤º?áÈ?Âßã‰Ωø??</p>
                    </div>
                `;
                    // Hide batch delete button when no posts
                    const batchBtn = document.getElementById('batchDeleteBtn');
                    if (batchBtn) batchBtn.style.display = 'none';
                    return;
                }

                // Show checkboxes only in postsGrid (not in recentPosts)
                const showCheckbox = containerId === 'postsGrid';

                container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${showCheckbox ? `<input type="checkbox" class="post-checkbox" data-post-id="${post.id}" onchange="updateBatchDeleteButton()" style="width: 18px; height: 18px; cursor: pointer;">` : ''}
                            <h3>?áÁ? #${post.id.substring(0, 8)}</h3>
                        </div>
                        <span class="status-badge status-${post.status}">${getStatusText(post.status)}</span>
                    </div>

                    <p><strong>Âª∫Á??ÇÈ?:</strong> ${new Date(post.created_at).toLocaleString('zh-TW')}</p>
                    ${post.posted_at ? `<p><strong>?ºÂ??ÇÈ?:</strong> ${new Date(post.posted_at).toLocaleString('zh-TW')}</p>` : ''}
                    ${post.post_url ? `<p><strong>Ë≤ºÊ????:</strong> <a href="${post.post_url}" target="_blank">?•Á?</a></p>` : ''}

                    <div class="post-actions">
                        <button class="btn btn-small btn-secondary" onclick="viewPost('${post.id}')">?•Á?Ë©≥Ê?</button>
                        ${post.status === 'DRAFT' ? `<button class="btn btn-small btn-success" onclick="generateContent('${post.id}')">?üÊ??ßÂÆπ</button>` : ''}
                        ${post.status === 'APPROVED' ? `<button class="btn btn-small btn-success" onclick="publishPost('${post.id}')">?ºÂ?</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-success" onclick="approvePost('${post.id}')">?∏Â?</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-warning" onclick="regenerateContent('${post.id}')">?çÊñ∞?üÊ?</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePost('${post.id}')">?™Èô§</button>
                    </div>
                </div>
            `).join('');
            }

            // Create post
            async function createPost(event) {
                event.preventDefault();
                showLoading(true);

                const topic = document.getElementById('postTopic').value;
                const keywords = document.getElementById('postKeywords').value.split(',').map(k => k.trim());
                const targetTone = document.getElementById('postTone').value;
                const targetLength = parseInt(document.getElementById('postLength').value);
                const scheduledFor = document.getElementById('postSchedule').value;
                const autoGenerate = document.getElementById('autoGenerate').checked;

                const postData = {
                    topic,
                    keywords,
                    targetTone,
                    targetLength,
                    ...(scheduledFor && { scheduledFor: new Date(scheduledFor).toISOString() })
                };

                try {
                    const response = await fetch(`${API_BASE}/posts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(postData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', 'Ë≤ºÊ?Âª∫Á??êÂ?!', 'success');
                        event.target.reset();

                        if (autoGenerate) {
                            await generateContent(data.id);
                        }

                        switchTab('posts');
                        loadPosts();
                        loadOverview();
                    } else {
                        showAlert('dashboardAlert', data.error || 'Âª∫Á?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'Âª∫Á?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Generate content
            async function generateContent(postId) {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}/generate`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', '?ßÂÆπ?üÊ?‰ªªÂ?Â∑≤Â??•‰???Ë´ãÁ?ÂæåÊü•??, 'info');
                        setTimeout(() => {
                            loadPosts();
                            loadOverview();
                        }, 3000);
                    } else {
                        showAlert('dashboardAlert', data.error || '?üÊ?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', '?üÊ?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // View post detail
            async function viewPost(postId) {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const post = await response.json();

                    if (response.ok) {
                        const modalBody = document.getElementById('modalBody');
                        modalBody.innerHTML = `
                        <h3>${post.topic}</h3>
                        <p><span class="status-badge status-${post.status}">${getStatusText(post.status)}</span></p>

                        <div style="margin: 20px 0;">
                            <p><strong>?úÈçµÂ≠?</strong> ${post.keywords.join(', ')}</p>
                            <p><strong>Ë™ûÊ∞£:</strong> ${post.targetTone}</p>
                            <p><strong>?ÆÊ??∑Â∫¶:</strong> ${post.targetLength} Â≠?/p>
                            <p><strong>Âª∫Á??ÇÈ?:</strong> ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>
                            ${post.scheduledFor ? `<p><strong>?íÁ??ÇÈ?:</strong> ${new Date(post.scheduledFor).toLocaleString('zh-TW')}</p>` : ''}
                        </div>

                        ${post.latestRevision ? `
                            <h4>?Ä?∞ÂÖßÂÆπÁ???/h4>
                            <div class="content-preview">${post.latestRevision.content}</div>
                            <p><strong>Â≠óÊï∏:</strong> ${post.latestRevision.wordCount}</p>
                            <p><strong>AI ÂºïÊ?:</strong> ${post.latestRevision.aiEngine}</p>
                            <p><strong>?üÊ??ÇÈ?:</strong> ${new Date(post.latestRevision.createdAt).toLocaleString('zh-TW')}</p>
                        ` : '<p style="color: #666;">Â∞öÊú™?üÊ??ßÂÆπ</p>'}
                    `;

                        document.getElementById('postModal').classList.add('active');
                    } else {
                        showAlert('dashboardAlert', 'ËºâÂÖ•Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'ËºâÂÖ•Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Approve post
            async function approvePost(postId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÊ†∏?ÜÊ≠§Ë≤ºÊ???')) return;

                showLoading(true);

                try {
                    // Get post detail first to get revision ID
                    const postResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const post = await postResponse.json();

                    if (!post.latestRevision) {
                        throw new Error('?æ‰??∞ÂÖßÂÆπÁ???);
                    }

                    const response = await fetch(`${API_BASE}/review/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            postId: postId,
                            revisionId: post.latestRevision.id,
                            action: 'approve'
                        })
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'Ë≤ºÊ?Â∑≤Ê†∏??, 'success');
                        loadPosts();
                        loadOverview();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || '?∏Â?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', '?∏Â?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Regenerate content
            async function regenerateContent(postId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÈ??∞Á??êÂÖßÂÆπÂ??')) return;
                await generateContent(postId);
            }

            // Publish post
            async function publishPost(postId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÁôºÂ∏ÉÊ≠§Ë≤ºÊ???Threads ??')) return;

                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}/publish`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('dashboardAlert', '?ºÂ?‰ªªÂ?Â∑≤Â??•‰???, 'info');
                        setTimeout(() => {
                            loadPosts();
                            loadOverview();
                        }, 3000);
                    } else {
                        showAlert('dashboardAlert', data.error || '?ºÂ?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', '?ºÂ?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Delete post
            async function deletePost(postId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§Ê≠§Ë≤ºÊ??? Ê≠§Ê?‰ΩúÁÑ°Ê≥ïÂæ©?ü„Ä?)) return;

                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'Ë≤ºÊ?Â∑≤Âà™??, 'success');
                        loadPosts();
                        loadOverview();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || '?™Èô§Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', '?™Èô§Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Toggle select all checkboxes
            function toggleSelectAll() {
                const checkboxes = document.querySelectorAll('.post-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });

                updateBatchDeleteButton();
            }

            // Update batch delete button visibility
            function updateBatchDeleteButton() {
                const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
                const batchBtn = document.getElementById('batchDeleteBtn');

                if (batchBtn) {
                    if (checkedBoxes.length > 0) {
                        batchBtn.style.display = 'inline-block';
                        batchBtn.textContent = `??Ô∏??πÊ¨°?™Èô§ (${checkedBoxes.length})`;
                    } else {
                        batchBtn.style.display = 'none';
                    }
                }
            }

            // Batch delete posts
            async function batchDeletePosts() {
                const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
                const postIds = Array.from(checkedBoxes).map(cb => cb.dataset.postId);

                if (postIds.length === 0) {
                    showAlert('dashboardAlert', 'Ë´ãÂ??∏Ê?Ë¶ÅÂà™?§Á?Ë≤ºÊ?', 'error');
                    return;
                }

                if (!confirm(`Á¢∫Â?Ë¶ÅÂà™?§ÈÅ∏‰∏≠Á? ${postIds.length} ÁØáË≤º?áÂ?? Ê≠§Ê?‰ΩúÁÑ°Ê≥ïÂæ©?ü„ÄÇ`)) {
                    return;
                }

                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                try {
                    // Delete posts one by one
                    for (const postId of postIds) {
                        try {
                            const response = await fetch(`${API_BASE}/posts/${postId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            failCount++;
                        }
                    }

                    // Show result
                    if (successCount > 0 && failCount === 0) {
                        showAlert('dashboardAlert', `?êÂ??™Èô§ ${successCount} ÁØáË≤º?á`, 'success');
                    } else if (successCount > 0 && failCount > 0) {
                        showAlert('dashboardAlert', `?êÂ??™Èô§ ${successCount} ÁØ?Â§±Ê? ${failCount} ÁØá`, 'error');
                    } else {
                        showAlert('dashboardAlert', `?™Èô§Â§±Ê?`, 'error');
                    }

                    // Reload posts
                    loadPosts();
                    loadOverview();
                } catch (error) {
                    showAlert('dashboardAlert', '?πÊ¨°?™Èô§Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Utilities
            function getStatusText(status) {
                const statusMap = {
                    'DRAFT': '?âÁ®ø',
                    'GENERATING': '?¢Á?‰∏?,
                    'PENDING_REVIEW': 'ÂæÖÂØ©??,
                    'APPROVED': 'Â∑≤Ê†∏??,
                    'PUBLISHING': '?ºÂ?‰∏?,
                    'POSTED': 'Â∑≤ÁôºÂ∏?,
                    'FAILED': 'Â§±Ê?',
                    'ACTION_REQUIRED': '?ÄË¶ÅË???,
                    'SKIPPED': 'Â∑≤Ë∑≥??
                };
                return statusMap[status] || status;
            }

            function showAlert(elementId, message, type) {
                const alertDiv = document.getElementById(elementId);
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 5000);
            }

            function showLoading(show) {
                const loading = document.getElementById('loading');
                if (show) {
                    loading.classList.add('active');
                } else {
                    loading.classList.remove('active');
                }
            }

            function closeModal() {
                document.getElementById('postModal').classList.remove('active');
            }

            // Threads Accounts Management
            async function loadThreadsAccounts() {
                // Load accounts for dropdown in create form
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const accounts = await response.json();
                        const select = document.getElementById('postThreadsAccount');
                        select.innerHTML = '<option value="">Á®çÂ??∏Ê?</option>';

                        accounts.forEach(acc => {
                            const option = document.createElement('option');
                            option.value = acc.id;
                            option.textContent = `@${acc.username}`;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load accounts:', error);
                }
            }

            async function loadThreadsAccountsList() {
                const container = document.getElementById('threadsAccountsList');

                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const accounts = data.accounts || [];

                        if (accounts.length === 0) {
                            container.innerHTML = '<div class="empty-state"><p>Â∞öÊú™???‰ªª‰? Threads Â∏≥Ë?</p></div>';
                            return;
                        }

                        container.innerHTML = accounts.map(acc => `
                        <div class="post-card" style="${acc.is_default ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3>@${acc.username}</h3>
                                ${acc.is_default ? '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">?êË®≠Â∏≥Ë?</span>' : ''}
                            </div>
                            <p><strong>Â∏≥Ë? ID:</strong> ${acc.account_id || '(?™Ë®≠ÂÆ?'}</p>
                            <p><strong>?Ä??</strong> ${acc.status === 'ACTIVE' ? '<span style="color: #28a745;">???üÁî®‰∏?/span>' : '<span style="color: #dc3545;">Â∑≤È?ÂÆ?/span>'}</p>
                            <p><strong>????ÇÈ?:</strong> ${new Date(acc.created_at).toLocaleString('zh-TW')}</p>
                            <div class="post-actions">
                                ${!acc.is_default ? `<button class="btn btn-small" style="background: #28a745;" onclick="setDefaultAccount('${acc.id}')">Ë®≠ÁÇ∫?êË®≠</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="removeThreadsAccount('${acc.id}')">Ëß?ô§???</button>
                            </div>
                        </div>
                    `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>ËºâÂÖ•Â§±Ê?</p></div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="empty-state"><p>ËºâÂÖ•Â§±Ê?: ' + error.message + '</p></div>';
                }
            }

            async function startThreadsOAuth() {
                try {
                    // Get OAuth URL from backend with authentication
                    const response = await fetch(`${API_BASE}/threads/oauth/authorize`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.authUrl) {
                            // Redirect to Threads authorization page
                            window.location.href = data.authUrl;
                        }
                    } else {
                        const error = await response.json();
                        showAlert('dashboardAlert', `?àÊ?Â§±Ê?: ${error.error || '?™Áü•?ØË™§'}`, 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', `?àÊ?Â§±Ê?: ${error.message}`, 'error');
                }
            }

            async function setDefaultAccount(accountId) {
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts/${accountId}/set-default`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', '??Â∑≤Ë®≠?∫È?Ë®≠Â∏≥??, 'success');
                        loadThreadsAccountsList();
                        // Reload UCB config to refresh account selector
                        if (typeof loadUcbConfig === 'function') {
                            loadUcbConfig();
                        }
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'Ë®≠Â?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'Ë®≠Â?Â§±Ê?: ' + error.message, 'error');
                }
            }

            async function removeThreadsAccount(accountId) {
                if (!confirm('Á¢∫Â?Ë¶ÅËß£?§ÈÄ??Ê≠?Threads Â∏≥Ë???')) return;

                try {
                    const response = await fetch(`${API_BASE}/threads/accounts/${accountId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        showAlert('dashboardAlert', 'Threads Â∏≥Ë?Â∑≤Ëß£?§ÈÄ??', 'success');
                        loadThreadsAccountsList();
                    } else {
                        const data = await response.json();
                        showAlert('dashboardAlert', data.error || 'Ëß?ô§Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'Ëß?ô§Â§±Ê?: ' + error.message, 'error');
                }
            }

            async function runDiagnostics() {
                const resultDiv = document.getElementById('diagnosticsResult');
                const contentDiv = document.getElementById('diagnosticsContent');

                // Show loading
                resultDiv.style.display = 'block';
                contentDiv.innerHTML = '<p style="color: #666;">?? Ë®∫Êñ∑‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/diagnose`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('Ë®∫Êñ∑Ë´ãÊ?Â§±Ê?');
                    }

                    const data = await response.json();

                    // Build diagnostic HTML
                    let html = '';

                    // Threads Accounts
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="margin-bottom: 10px;">?ì± Threads Â∏≥Ë??Ä??/h4>';
                    if (data.checks.threadsAccounts.total === 0) {
                        html += '<p style="color: #dc3545;">???æ‰??∞‰ªª‰Ω?Threads Â∏≥Ë?</p>';
                    } else {
                        data.checks.threadsAccounts.accounts.forEach((acc, i) => {
                            html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${acc.issues.length > 0 ? '#ffc107' : '#28a745'}">`;
                            html += `<p style="margin: 5px 0;"><strong>Â∏≥Ë? ${i + 1}:</strong> ${acc.username}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Account ID: ${acc.accountId || '???™Ë®≠ÂÆ?}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">?Ä?? ${acc.status}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">?êË®≠Â∏≥Ë?: ${acc.isDefault ? '???? : '??}</p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Token ?Ä?? ${acc.tokenStatus || '??}</p>`;
                            if (acc.issues.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                                acc.issues.forEach(issue => {
                                    html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                                });
                                html += `</div>`;
                            }
                            html += `</div>`;
                        });
                    }
                    html += '</div>';

                    // Recent Posts
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="margin-bottom: 10px;">?? ?ÄËøëÁ??áÁ?</h4>';
                    if (data.checks.recentPosts.total === 0) {
                        html += '<p style="color: #666;">?ÆÂ?Ê≤íÊ??áÁ?</p>';
                    } else {
                        data.checks.recentPosts.posts.slice(0, 3).forEach((post, i) => {
                            const statusColor = {
                                'POSTED': '#28a745',
                                'APPROVED': '#ffc107',
                                'FAILED': '#dc3545',
                                'PENDING_REVIEW': '#17a2b8'
                            }[post.status] || '#6c757d';

                            html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor}">`;
                            html += `<p style="margin: 5px 0;"><strong>?áÁ? ${i + 1}:</strong> <span style="color: ${statusColor}; font-weight: bold;">${post.status}</span></p>`;
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Âª∫Á?: ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>`;
                            if (post.approvedAt) {
                                html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">?∏Â?: ${new Date(post.approvedAt).toLocaleString('zh-TW')}</p>`;
                            }
                            if (post.postedAt) {
                                html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">?ºÂ?: ${new Date(post.postedAt).toLocaleString('zh-TW')}</p>`;
                            }
                            if (post.error) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px;">`;
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #721c24;">?ØË™§: ${post.error.message || post.error.code}</p>`;
                                html += `</div>`;
                            }
                            if (post.issues.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                                post.issues.forEach(issue => {
                                    html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                                });
                                html += `</div>`;
                            }
                            html += `</div>`;
                        });
                    }
                    html += '</div>';

                    // Analysis & Recommendations
                    html += '<div style="background: white; padding: 15px; border-radius: 8px;">';
                    html += '<h4 style="margin-bottom: 10px;">?í° Ë®∫Êñ∑Âª∫Ë≠∞</h4>';
                    if (data.analysis.recommendations.length === 0) {
                        html += '<p style="color: #28a745;">???Ä?âË®≠ÂÆöÁ?Ëµ∑‰?Ê≠?∏∏</p>';
                    } else {
                        html += '<ul style="margin: 0; padding-left: 20px;">';
                        data.analysis.recommendations.forEach(rec => {
                            html += `<li style="margin: 8px 0; color: #856404;">${rec}</li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';

                    contentDiv.innerHTML = html;

                } catch (error) {
                    contentDiv.innerHTML = `<p style="color: #dc3545;">??Ë®∫Êñ∑Â§±Ê?: ${error.message}</p>`;
                }
            }

            // Settings Management
            async function loadSettings() {
                try {
                    const response = await fetch(`${API_BASE}/settings`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•Ë®≠Â?Â§±Ê?');

                    const data = await response.json();
                    const settings = data.settings;

                    // AI Engine
                    if (settings.ai_engine) {
                        const aiEngineEl = document.getElementById('aiEngine');
                        if (aiEngineEl) aiEngineEl.value = settings.ai_engine.value;
                    }

                    // Custom Prompt
                    if (settings.custom_prompt) {
                        const customPromptEl = document.getElementById('customPrompt');
                        if (customPromptEl) customPromptEl.value = settings.custom_prompt.value;
                    }

                    // Schedule Config
                    if (settings.schedule_config) {
                        const scheduleConfig = settings.schedule_config.value;
                        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                        days.forEach(day => {
                            const config = scheduleConfig[day];
                            if (config) {
                                const checkboxEl = document.getElementById(`schedule_${day}`);
                                const timeEl = document.getElementById(`time_${day}`);
                                if (checkboxEl) checkboxEl.checked = config.enabled;
                                if (timeEl) timeEl.value = config.time;
                            }
                        });
                    }

                    // Auto Post Threads Account - Store value to apply after dropdown is populated
                    if (settings.auto_post_threads_account) {
                        const autoPostEl = document.getElementById('autoPostThreadsAccount');
                        if (autoPostEl && settings.auto_post_threads_account.value) {
                            // Store the saved value temporarily to apply after options are loaded
                            autoPostEl.dataset.savedValue = settings.auto_post_threads_account.value;
                        }
                    }

                    // LINE Notify User ID
                    if (settings.line_notify_user_id) {
                        const lineUserIdEl = document.getElementById('lineNotifyUserId');
                        if (lineUserIdEl) lineUserIdEl.value = settings.line_notify_user_id.value;
                    }

                } catch (error) {
                    showAlert('dashboardAlert', 'ËºâÂÖ•Ë®≠Â?Â§±Ê?: ' + error.message, 'error');
                }
            }

            async function saveAllSettings() {
                showLoading(true);

                try {
                    // Collect schedule config
                    const scheduleConfig = {
                        monday: {
                            enabled: document.getElementById('schedule_monday').checked,
                            time: document.getElementById('time_monday').value
                        },
                        tuesday: {
                            enabled: document.getElementById('schedule_tuesday').checked,
                            time: document.getElementById('time_tuesday').value
                        },
                        wednesday: {
                            enabled: document.getElementById('schedule_wednesday').checked,
                            time: document.getElementById('time_wednesday').value
                        },
                        thursday: {
                            enabled: document.getElementById('schedule_thursday').checked,
                            time: document.getElementById('time_thursday').value
                        },
                        friday: {
                            enabled: document.getElementById('schedule_friday').checked,
                            time: document.getElementById('time_friday').value
                        },
                        saturday: {
                            enabled: document.getElementById('schedule_saturday').checked,
                            time: document.getElementById('time_saturday').value
                        },
                        sunday: {
                            enabled: document.getElementById('schedule_sunday').checked,
                            time: document.getElementById('time_sunday').value
                        }
                    };

                    const settings = {
                        ai_engine: {
                            value: document.getElementById('aiEngine').value,
                            type: 'STRING'
                        },
                        custom_prompt: {
                            value: document.getElementById('customPrompt').value,
                            type: 'STRING'
                        },
                        schedule_config: {
                            value: scheduleConfig,
                            type: 'JSON'
                        },
                        auto_post_threads_account: {
                            value: document.getElementById('autoPostThreadsAccount').value,
                            type: 'STRING'
                        },
                        line_notify_user_id: {
                            value: document.getElementById('lineNotifyUserId').value,
                            type: 'STRING'
                        }
                    };

                    const response = await fetch(`${API_BASE}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ settings })
                    });

                    if (!response.ok) throw new Error('?≤Â?Ë®≠Â?Â§±Ê?');

                    showAlert('dashboardAlert', '???Ä?âË®≠ÂÆöÂ∑≤?êÂ??≤Â?', 'success');
                } catch (error) {
                    showAlert('dashboardAlert', '?≤Â?Ë®≠Â?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function testLineNotification() {
                showLoading(true);

                try {
                    const response = await fetch(`${API_BASE}/settings/test-line`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Ê∏¨Ë©¶?öÁü•Â§±Ê?');
                    }

                    showAlert('dashboardAlert', '??Ê∏¨Ë©¶?öÁü•Â∑≤Áôº?ÅÂà∞ LINEÔºÅË?Ê™¢Êü•?®Á? LINE Ë®äÊÅØ??, 'success');
                } catch (error) {
                    showAlert('dashboardAlert', '???ºÈÄÅÂ§±?? ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function runTestGeneration() {
                showLoading(true);
                document.getElementById('testResults').style.display = 'none';

                try {
                    const response = await fetch(`${API_BASE}/settings/test-generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = 'Ê∏¨Ë©¶?üÊ?Â§±Ê?';
                        try {
                            const error = await response.json();
                            errorMessage = error.error || error.message || errorMessage;
                            console.error('API Error:', error);
                        } catch (e) {
                            const text = await response.text();
                            console.error('Response text:', text);
                            errorMessage = text || errorMessage;
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('Test generation response:', data);

                    // Display success message with content preview
                    const resultHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #1DB446;">
                        <h4 style="margin: 0 0 15px 0; color: #1DB446;">??Ê∏¨Ë©¶?áÁ?Â∑≤Á??êÔ?</h4>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>?? ?üÊ?Ë≥áË?Ôº?/strong></p>
                            <p style="margin: 5px 0;">?? ÂºïÊ?Ôº?{data.engine}</p>
                            <p style="margin: 5px 0;">?? ?∏‰ººÂ∫¶Ô?${(data.similarity * 100).toFixed(1)}%</p>
                            <p style="margin: 5px 0; color: ${data.similarity > 0.86 ? '#ff0000' : '#4CAF50'};">
                                ${data.similarity > 0.86 ? '?†Ô? ?∏‰ººÂ∫¶Ë?È´òÔ?Âª∫Ë≠∞?çÊñ∞?üÊ?' : '???∏‰ººÂ∫¶Ê≠£Â∏?}
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>?? ?áÁ??ßÂÆπ?êË¶ΩÔº?/strong></p>
                            <p style="white-space: pre-wrap; margin: 0; line-height: 1.6; color: #333;">
                                ${data.content.substring(0, 200)}${data.content.length > 200 ? '...' : ''}
                            </p>
                        </div>

                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #2e7d32;">?ì± ‰∏ã‰?Ê≠•Ô?</p>
                            <p style="margin: 10px 0 0 0; line-height: 1.8; color: #333;">
                                Ê∏¨Ë©¶?áÁ?Â∑≤Áôº?ÅÂà∞?®Á? LINEÔº?br>
                                Ë´ãÂà∞ LINE ?•Á?ÂÆåÊï¥?ßÂÆπ‰∏¶ÈÄ≤Ë?ÂØ©Ê†∏Ôº?br>
                                ????Á¢∫Ë??ºÊ? ???ºÂ???Threads<br>
                                ???? ?çÊñ∞?üÊ? ???¢Á??∞Ê?Á´?br>
                                ???èÔ? ‰øÆÊîπ?ßÂÆπ ??Á∑®ËºØÂæåÁôºÂ∏?
                            </p>
                        </div>
                    </div>
                `;

                    document.getElementById('testResultsContent').innerHTML = resultHtml;
                    document.getElementById('testResults').style.display = 'block';

                    showAlert('dashboardAlert', '??Ê∏¨Ë©¶?áÁ?Â∑≤Á??ê‰∏¶?ºÈÄÅÂà∞ LINEÔºÅË???LINE ?•Á???, 'success');
                } catch (error) {
                    const errorHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 10px 0; color: #f44336;">??Ê∏¨Ë©¶Â§±Ê?</h4>
                        <p style="margin: 0; color: #666;">${error.message}</p>
                        ${error.message.includes('LINE User ID') ? `
                            <p style="margin: 15px 0 0 0; padding: 10px; background: #fff3e0; border-radius: 4px; color: #ff6600;">
                                ?í° ?êÁ§∫ÔºöË??àË®≠ÂÆ?LINE User ID<br>
                                1. ??LINE ‰∏≠ÂÇ≥?Å„Ä?myid?çÁµ¶Ê©üÂô®‰∫?br>
                                2. Ë§áË£Ω?∂Âà∞??User ID<br>
                                3. Ë≤ºÂà∞‰∏äÊñπ?åLINE ?öÁü•Ë®≠Â??ç‰∏¶?≤Â?
                            </p>
                        ` : ''}
                    </div>
                `;
                    document.getElementById('testResultsContent').innerHTML = errorHtml;
                    document.getElementById('testResults').style.display = 'block';

                    showAlert('dashboardAlert', 'Ê∏¨Ë©¶Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Character counter for manual post content
            const manualContentTextarea = document.getElementById('manualPostContent');
            if (manualContentTextarea) {
                manualContentTextarea.addEventListener('input', function () {
                    const count = this.value.length;
                    document.getElementById('contentCharCount').textContent = count;
                });
            }

            // Toggle schedule input visibility
            function toggleScheduleInput() {
                const scheduleInput = document.getElementById('manualPostSchedule');
                const isScheduled = document.querySelector('input[name="publishTime"]:checked')?.value === 'scheduled';
                if (scheduleInput) {
                    scheduleInput.style.display = isScheduled ? 'block' : 'none';
                    if (!isScheduled) {
                        scheduleInput.value = '';
                    }
                }
            }

            // Load Threads accounts into dropdowns
            async function loadThreadsAccountsForDropdowns() {
                try {
                    const response = await fetch(`${API_BASE}/threads/accounts`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•Â∏≥Ë?Â§±Ê?');

                    const data = await response.json();
                    const accounts = data.accounts || [];

                    // Populate manual post dropdown
                    const manualSelect = document.getElementById('manualPostThreadsAccount');
                    if (manualSelect) {
                        manualSelect.innerHTML = '<option value="">Ë´ãÈÅ∏?áÂ∏≥??/option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');
                    }

                    // Populate auto post dropdown
                    const autoSelect = document.getElementById('autoPostThreadsAccount');
                    if (autoSelect) {
                        autoSelect.innerHTML = '<option value="">Ë´ãÈÅ∏?áÂ∏≥??/option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');

                        // Auto-select previously saved account
                        const savedAccountId = autoSelect.dataset.savedValue;
                        if (savedAccountId) {
                            autoSelect.value = savedAccountId;
                            delete autoSelect.dataset.savedValue; // Clear after applying
                        }
                    }

                    // Populate UCB Threads account dropdown
                    const ucbSelect = document.getElementById('ucbThreadsAccount');
                    if (ucbSelect) {
                        ucbSelect.innerHTML = '<option value="">Ë´ãÈÅ∏?áÂ∏≥??/option>' +
                            accounts.map(acc =>
                                `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                            ).join('');
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•Â∏≥Ë??óË°®Â§±Ê?:', error);
                }
            }

            // Test UCB LINE notification
            async function testUCBLineNotification() {
                const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

                if (!lineUserId) {
                    alert('Ë´ãÂ?Ëº∏ÂÖ• LINE User ID');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/line/test-notification`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ lineUserId })
                    });

                    if (!response.ok) throw new Error('?ºÈÄÅÂ§±??);

                    alert('??Ê∏¨Ë©¶Ë®äÊÅØÂ∑≤Áôº?ÅÔ?Ë´ãÊ™¢?•ÊÇ®??LINE');
                } catch (error) {
                    alert('??Ê∏¨Ë©¶Â§±Ê?: ' + error.message);
                }
            }

            // Create manual post (direct publishing without AI)
            async function createManualPost(event) {
                event.preventDefault();
                showLoading(true);

                const content = document.getElementById('manualPostContent').value.trim();
                const accountId = document.getElementById('manualPostThreadsAccount').value;
                const publishTime = document.querySelector('input[name="publishTime"]:checked')?.value;
                const scheduledFor = publishTime === 'scheduled'
                    ? document.getElementById('manualPostSchedule').value
                    : null;

                // Validation
                if (!content) {
                    showAlert('dashboardAlert', 'Ë´ãËº∏?•Ë≤º?áÂÖßÂÆ?, 'error');
                    showLoading(false);
                    return;
                }

                if (content.length > 500) {
                    showAlert('dashboardAlert', 'Ë≤ºÊ??ßÂÆπ‰∏çËÉΩË∂ÖÈ? 500 Â≠?, 'error');
                    showLoading(false);
                    return;
                }

                if (!accountId) {
                    showAlert('dashboardAlert', 'Ë´ãÈÅ∏??Threads Â∏≥Ë?', 'error');
                    showLoading(false);
                    return;
                }

                if (publishTime === 'scheduled' && !scheduledFor) {
                    showAlert('dashboardAlert', 'Ë´ãÈÅ∏?áÊ?Á®ãÊ???, 'error');
                    showLoading(false);
                    return;
                }

                try {
                    // Create post with manual content
                    const postResponse = await fetch(`${API_BASE}/posts/manual`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            content,
                            accountId,
                            scheduledFor: scheduledFor ? new Date(scheduledFor).toISOString() : null
                        })
                    });

                    const postData = await postResponse.json();

                    if (postResponse.ok) {
                        showAlert('dashboardAlert', publishTime === 'now' ? '??Ë≤ºÊ?Â∑≤Â??•ÁôºÂ∏É‰??óÔ?' : '??Ë≤ºÊ?Â∑≤Ê?Á®ãÊ??üÔ?', 'success');
                        document.getElementById('manualPostContent').value = '';
                        document.getElementById('contentCharCount').textContent = '0';
                        document.getElementById('manualPostThreadsAccount').value = '';
                        document.querySelector('input[name="publishTime"][value="now"]').checked = true;
                        toggleScheduleInput();
                        switchTab('posts');
                        loadPosts();
                        loadOverview();
                    } else {
                        showAlert('dashboardAlert', postData.error || '?ºÂ?Â§±Ê?', 'error');
                    }
                } catch (error) {
                    showAlert('dashboardAlert', '?ºÂ?Â§±Ê?: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // ==================== SMART SCHEDULING FUNCTIONS ====================

            let smartSchedulingTemplates = [];
            let currentEditingTemplateId = null;
            let currentTestPrompt = '';
            let currentTestEngine = 'GPT5_2';

            // Load scheduling tab (triggers default sub-tab)
            function loadScheduling() {
                // Load the UCB smart scheduling sub-tab by default
                switchSchedulingSubTab('ucb');
            }

            // Load templates tab
            async function loadTemplates() {
                try {
                    const response = await fetch(`${API_BASE}/templates`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•Â§±Ê?');

                    const data = await response.json();
                    smartSchedulingTemplates = data.templates || [];
                    renderTemplates();
                } catch (error) {
                    document.getElementById('templates-container').innerHTML =
                        `<div class="error-message">ËºâÂÖ•Ê®°ÊùøÂ§±Ê?: ${error.message}</div>`;
                }
            }

            function renderTemplates() {
                const container = document.getElementById('templates-container');

                if (smartSchedulingTemplates.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">??</div>
                        <h3>?ÑÊ??â‰ªª‰ΩïÊ®°??/h3>
                        <p>ÈªûÊ??åÊñ∞Â¢ûÊ®°?ø„ÄçÈ?ÂßãÂª∫Á´ã‰??ÑÁ¨¨‰∏Ä?ãÂÖßÂÆπÊ®°??/p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = `
                <div class="templates-grid">
                    ${smartSchedulingTemplates.map(template => {
                    const avgRate = parseFloat(template.avg_engagement_rate) || 0;
                    const engineName = getEngineName(template.preferred_engine || 'GPT5_2');
                    return `
                        <div class="template-card ${template.enabled ? '' : 'disabled'}">
                            <div class="template-header">
                                <div>
                                    <div class="template-name">${escapeHtml(template.name)}</div>
                                    ${template.description ? `<div class="template-description">${escapeHtml(template.description)}</div>` : ''}
                                    <div style="margin-top: 5px; font-size: 12px; color: #667eea;">
                                        <strong>?? AI ÂºïÊ?Ôº?/strong>${engineName}
                                    </div>
                                </div>
                                <span class="template-status ${template.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${template.enabled ? '?üÁî®' : '?úÁî®'}
                                </span>
                            </div>

                            <div class="template-stats">
                                <div class="stat">
                                    <div class="stat-label">‰ΩøÁî®Ê¨°Êï∏</div>
                                    <div class="stat-value">${template.total_uses || 0}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-label">Âπ≥Â?‰∫íÂ???/div>
                                    <div class="stat-value highlight">${avgRate.toFixed(2)}%</div>
                                </div>
                            </div>

                            <div class="template-prompt">${escapeHtml(template.prompt)}</div>

                            <div class="template-actions">
                                <button class="btn btn-test" onclick="testSmartTemplate('${template.id}')">?ß™ Ê∏¨Ë©¶</button>
                                <button class="btn btn-secondary" onclick="editSmartTemplate('${template.id}')">Á∑®ËºØ</button>
                                <button class="btn btn-danger" onclick="deleteSmartTemplate('${template.id}', '${escapeHtml(template.name)}')">?™Èô§</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            }

            function openCreateModal() {
                currentEditingTemplateId = null;
                document.getElementById('modal-title').textContent = '?∞Â?Ê®°Êùø';
                document.getElementById('template-form').reset();
                document.getElementById('template-enabled').checked = true;
                document.getElementById('template-engine').value = 'GPT5_2';
                document.getElementById('templateModal').classList.add('active');
            }

            function editSmartTemplate(id) {
                const template = smartSchedulingTemplates.find(t => t.id === id);
                if (!template) return;

                currentEditingTemplateId = id;
                document.getElementById('modal-title').textContent = 'Á∑®ËºØÊ®°Êùø';
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-description').value = template.description || '';
                document.getElementById('template-engine').value = template.preferred_engine || 'GPT5_2';
                document.getElementById('template-prompt').value = template.prompt;
                document.getElementById('template-enabled').checked = template.enabled;
                document.getElementById('templateModal').classList.add('active');
            }

            function closeTemplateModal() {
                document.getElementById('templateModal').classList.remove('active');
                currentEditingTemplateId = null;
            }

            async function saveTemplate(event) {
                event.preventDefault();

                const data = {
                    name: document.getElementById('template-name').value,
                    description: document.getElementById('template-description').value,
                    preferred_engine: document.getElementById('template-engine').value,
                    prompt: document.getElementById('template-prompt').value,
                    enabled: document.getElementById('template-enabled').checked
                };

                try {
                    const url = currentEditingTemplateId
                        ? `${API_BASE}/templates/${currentEditingTemplateId}`
                        : `${API_BASE}/templates`;
                    const method = currentEditingTemplateId ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error('?≤Â?Â§±Ê?');

                    closeTemplateModal();
                    loadTemplates();
                    showSmartMessage('templates-container', 'Ê®°ÊùøÂ∑≤ÂÑ≤Â≠òÔ?', 'success');
                } catch (error) {
                    alert('?≤Â?Â§±Ê?: ' + error.message);
                }
            }

            async function deleteSmartTemplate(id, name) {
                if (!confirm(`Á¢∫Â?Ë¶ÅÂà™?§Ê®°?ø„Ä?{name}?çÂ?Ôºü`)) return;

                try {
                    const response = await fetch(`${API_BASE}/templates/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('?™Èô§Â§±Ê?');

                    loadTemplates();
                    showSmartMessage('templates-container', 'Ê®°ÊùøÂ∑≤Âà™??, 'success');
                } catch (error) {
                    alert('?™Èô§Â§±Ê?: ' + error.message);
                }
            }

            // UCB Config functions
            async function loadUCBTemplatesSelector() {
                try {
                    const response = await fetch(`${API_BASE}/templates`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•Ê®°ÊùøÂ§±Ê?');

                    const data = await response.json();
                    const templates = data.templates || [];
                    const container = document.getElementById('ucb-templates-selector');

                    if (templates.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center;">Â∞öÁÑ°Ê®°ÊùøÔºåË??àÂà∞?åÊ®°?øÁÆ°?Ü„ÄçÊñ∞Â¢?/p>';
                        return;
                    }

                    // Render template checkboxes
                    container.innerHTML = templates.map(template => `
                    <div style="padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; transition: background 0.2s; ${!template.enabled ? 'opacity: 0.5;' : ''}"
                         onmouseover="if(${template.enabled}) this.style.background='#f0f4ff'"
                         onmouseout="this.style.background='transparent'">
                        <input type="checkbox"
                               id="ucb-template-${template.id}"
                               value="${template.id}"
                               ${template.enabled ? 'checked' : 'disabled'}
                               style="width: 18px; height: 18px; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex-shrink: 0;">
                        <label for="ucb-template-${template.id}" style="margin: 0; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex: 1; font-size: 14px; line-height: 1.5;">
                            <strong style="color: #1f2937;">${escapeHtml(template.name)}</strong>
                            ${!template.enabled ? '<span style="color: #999; font-size: 12px; margin-left: 8px;">(Â∑≤Â???</span>' : ''}
                        </label>
                    </div>
                `).join('');
                } catch (error) {
                    console.error('ËºâÂÖ•Ê®°Êùø?∏Ê??®Â§±??', error);
                    document.getElementById('ucb-templates-selector').innerHTML =
                        '<p style="color: #f00; text-align: center;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            async function loadUCBConfig() {
                try {
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('ËºâÂÖ•?çÁΩÆÂ§±Ê?');

                    const data = await response.json();
                    const config = data.config;

                    if (config) {
                        document.getElementById('exploration-factor').value = parseFloat(config.exploration_factor) || 1.5;
                        document.getElementById('min-trials').value = parseInt(config.min_trials_per_template) || 5;
                        document.getElementById('posts-per-day').value = parseInt(config.posts_per_day) || 1;
                        document.getElementById('auto-schedule-enabled').checked = Boolean(config.auto_schedule_enabled);

                        // Load time range settings
                        if (config.time_range_start) {
                            document.getElementById('time-range-start').value = config.time_range_start;
                        }
                        if (config.time_range_end) {
                            document.getElementById('time-range-end').value = config.time_range_end;
                        }

                        // Load Threads account
                        if (config.threads_account_id) {
                            document.getElementById('ucbThreadsAccount').value = config.threads_account_id;
                        }

                        // Load LINE User ID
                        if (config.line_user_id) {
                            document.getElementById('ucbLineNotifyUserId').value = config.line_user_id;
                        }

                        // Load active days
                        const activeDays = config.active_days || [];
                        document.querySelectorAll('.active-day').forEach(checkbox => {
                            checkbox.checked = activeDays.length === 0 || activeDays.includes(parseInt(checkbox.value));
                        });
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•?çÁΩÆÂ§±Ê?:', error);
                }
            }

            async function saveUCBConfig(event) {
                event.preventDefault();

                const data = {
                    exploration_factor: parseFloat(document.getElementById('exploration-factor').value),
                    min_trials_per_template: parseInt(document.getElementById('min-trials').value),
                    posts_per_day: parseInt(document.getElementById('posts-per-day').value),
                    auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                    time_range_start: document.getElementById('time-range-start').value,
                    time_range_end: document.getElementById('time-range-end').value,
                    threads_account_id: document.getElementById('ucbThreadsAccount').value || null,
                    line_user_id: document.getElementById('ucbLineNotifyUserId').value || null,
                    active_days: Array.from(document.querySelectorAll('.active-day:checked')).map(cb => parseInt(cb.value))
                };

                try {
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error('?≤Â?Â§±Ê?');

                    showSmartMessage('ucb-message', '?çÁΩÆÂ∑≤ÂÑ≤Â≠òÔ?', 'success');
                } catch (error) {
                    showSmartMessage('ucb-message', '?≤Â?Â§±Ê?: ' + error.message, 'error');
                }
            }


            async function triggerDailySchedule() {
                // ?àÊ™¢?•Â?Ë¶ÅË®≠ÂÆ?
                const threadsAccount = document.getElementById('ucbThreadsAccount').value;
                const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

                if (!threadsAccount) {
                    alert('??Ë´ãÂ??∏Ê? Threads Â∏≥Ë?‰∏¶ÂÑ≤Â≠òÈ?ÁΩ?);
                    return;
                }

                if (!lineUserId) {
                    alert('??Ë´ãÂ?Ë®≠Â? LINE User ID ‰∏¶ÂÑ≤Â≠òÈ?ÁΩ?);
                    return;
                }

                // ?àÊ™¢??AI ?êÁ§∫Ë©ûÊòØ?¶Â∑≤Ë®≠Â?
                try {
                    const configRes = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const configData = await configRes.json();
                    const config = configData.config || {};

                    if (!config.ai_prompt || config.ai_prompt.trim() === '') {
                        alert('??Ë´ãÂ??∞„ÄåÊ?Á§∫Ë?Ë®≠Â??çÈ??¢Ë®≠ÂÆ?AI ?üÊ??êÁ§∫Ë©?);
                        return;
                    }
                } catch (e) {
                    console.error('Failed to check config:', e);
                }

                if (!confirm('?? Á≥ªÁµ±Â∞áÁ??≥Á??ê‰?ÁØáÊ∏¨Ë©¶Ê?Á´†\n?í¨ ?üÊ?ÂÆåÊ?ÂæåÊ??ºÈÄ?LINE ?öÁü•Áµ¶ÊÇ®ÂØ©Ê†∏\n\nÁ¢∫Â?Ë¶ÅÁ??≥Ëß∏?ºÂ?Ôº?)) return;

                try {
                    showSmartMessage('ai-message', '??Ê≠?ú®?üÊ??áÁ?...Ë´ãÁ???, 'info');

                    const response = await fetch(`${API_BASE}/trigger-daily-schedule`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ immediate: true })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.error || 'Ëß∏ÁôºÂ§±Ê?');
                    }

                    const data = await response.json();
                    showSmartMessage('ai-message', '???áÁ?Â∑≤Âª∫Á´ãÔ?Ë´ãÁ??ôÊü•??LINE ?öÁü•?≤Ë?ÂØ©Ê†∏', 'success');

                    // Reload schedule history
                    setTimeout(() => {
                        loadScheduleHistory();
                    }, 1000);
                } catch (error) {
                    showSmartMessage('ai-message', '??Ëß∏ÁôºÂ§±Ê?: ' + error.message, 'error');
                }
            }

            // Schedule History functions
            async function loadScheduleHistory() {
                try {
                    const response = await fetch(`${API_BASE}/auto-schedules`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || errorData.error || '?°Ê?ËºâÂÖ•?íÁ?Ê≠∑Âè≤');
                    }

                    const data = await response.json();
                    const schedules = data.schedules || [];
                    renderScheduleHistory(schedules);
                } catch (error) {
                    console.error('Failed to load schedule history:', error);
                    document.getElementById('schedule-history-container').innerHTML =
                        `<div class="error-message">
                        <strong>?? ËºâÂÖ•?íÁ?Ê≠∑Âè≤Â§±Ê?</strong><br>
                        ${error.message}<br>
                        <small style="opacity: 0.7;">Ë´ãÊ™¢?•ÁÄèË¶Ω?®Êéß?∂Âè∞?•Á?Ë©≥Á¥∞?ØË™§</small>
                    </div>`;
                }
            }

            async function renderScheduleHistory(schedules) {
                const container = document.getElementById('schedule-history-container');

                if (schedules.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">??</div>
                        <h3>?ÑÊ??âÊ?Á®ãË???/h3>
                        <p>Á≥ªÁµ±?ÉÂú®ÊØèÂ§© 00:00 ?™Â?Âª∫Á??íÁ?ÔºåÊ?ÈªûÊ??åÊ∏¨Ë©¶Á??êÁôº?Å„ÄçÈÄ≤Ë?Ê∏¨Ë©¶</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = `
                <div class="schedule-list">
                    ${schedules.map(schedule => {
                    const statusMap = {
                        'PENDING': { label: 'ÂæÖÂü∑Ë°?, class: 'status-pending' },
                        'GENERATED': { label: 'ÂæÖÂØ©??, class: 'status-generated' },
                        'APPROVED': { label: 'Â∑≤Ê†∏??, class: 'status-approved' },
                        'POSTED': { label: 'Â∑≤ÁôºÂ∏?, class: 'status-posted' },
                        'FAILED': { label: 'Â§±Ê?', class: 'status-failed' },
                        'CANCELLED': { label: 'Â∑≤Â?Ê∂?, class: 'status-cancelled' }
                    };
                    const status = statusMap[schedule.status] || { label: schedule.status, class: '' };

                    return `
                        <div class="schedule-item">
                            <div class="schedule-header">
                                <div class="schedule-date">?? ${formatDate(schedule.schedule_date)}</div>
                                <span class="schedule-status ${status.class}">${status.label}</span>
                            </div>

                            <div class="schedule-info">
                                <div class="schedule-info-item">
                                    <strong>?ºÊ??ÇÈ?:</strong> ${formatDateTime(schedule.scheduled_time)}
                                </div>
                            </div>

                            ${schedule.generation_plan ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                                    ${schedule.generation_plan.moduleName ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?ì¶ ${escapeHtml(schedule.generation_plan.moduleName)}</span>` : ''}
                                    ${schedule.generation_plan.angleName ? `<span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?é¨ ${escapeHtml(schedule.generation_plan.angleName)}</span>` : ''}
                                    ${schedule.generation_plan.outletName ? `<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?í° ${escapeHtml(schedule.generation_plan.outletName)}</span>` : ''}
                                    ${schedule.generation_plan.toneBiasName ? `<span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?ó£Ô∏?${escapeHtml(schedule.generation_plan.toneBiasName)}</span>` : ''}
                                    ${schedule.generation_plan.endingStyleName ? `<span style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?? ${escapeHtml(schedule.generation_plan.endingStyleName)}</span>` : ''}
                                    ${schedule.generation_plan.lengthTarget ? `<span style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">?? ${escapeHtml(schedule.generation_plan.lengthTarget)}Â≠?/span>` : ''}
                                </div>
                            ` : `
                                <div style="margin-top: 10px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #6b7280;">
                                    AI ?™Â??ºÊ?ÔºàÂñÆ‰∏Ä?êÁ§∫Ë©ûÔ?
                                </div>
                            `}

                            ${schedule.selection_reason ? `
                                <div class="schedule-reason">
                                    <strong>AI Ê±∫Á??üÂ?:</strong>
                                    ${escapeHtml(schedule.selection_reason)}
                                </div>
                            ` : ''}

                            ${schedule.status === 'GENERATED' ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="resendReviewNotification('${schedule.id}')" class="btn btn-secondary btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ?ì± ?çÊñ∞?ºÈÄÅÂØ©??
                                    </button>
                                    <button onclick="manualApproveSchedule('${schedule.id}')" class="btn btn-success btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ???ãÂ??∏Â?
                                    </button>
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ??Ô∏??™Èô§?íÁ?
                                    </button>
                                </div>
                            ` : ''}

                            ${schedule.status === 'APPROVED' ? `
                                <div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px; color: #065f46;">
                                    ??Â∑≤Ê†∏?ÜÔ?Â∞áÊñº?íÁ??ÇÈ??™Â??ºÂ?
                                </div>
                            ` : ''}

                            ${(schedule.status === 'PENDING' || schedule.status === 'FAILED') ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ??Ô∏??™Èô§Ê≠§Ê?Á®?
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
            }

            // Delete auto schedule function
            async function deleteAutoSchedule(scheduleId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§Ê≠§?íÁ??éÔ?\n\nÊ≠§Ê?‰ΩúÁÑ°Ê≥ïÂæ©?ü„Ä?)) return;

                try {
                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '?™Èô§Â§±Ê?');
                    }

                    showSmartMessage('ucb-message', '???íÁ?Â∑≤Âà™??, 'success');
                    loadScheduleHistory(); // ?çÊñ∞ËºâÂÖ•?óË°®
                } catch (error) {
                    alert('???™Èô§Â§±Ê?: ' + error.message);
                }
            }

            // Resend review notification function
            async function resendReviewNotification(scheduleId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÈ??∞Áôº??LINE ÂØ©Ê†∏?öÁü•?éÔ?\n\n?æÊ??ÑÂØ©?∏ÈÄ??Â∞áÂ§±?à„Ä?)) return;

                try {
                    showSmartMessage('ucb-message', '?ì± Ê≠?ú®?çÊñ∞?ºÈÄÅÂØ©?∏ÈÄöÁü•...', 'info');

                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/resend-review`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '?ºÈÄÅÂ§±??);
                    }

                    showSmartMessage('ucb-message', data.message || '??Â∑≤È??∞Áôº?ÅÂØ©?∏ÈÄöÁü•', 'success');
                } catch (error) {
                    showSmartMessage('ucb-message', '???ºÈÄÅÂ§±?? ' + error.message, 'error');
                }
            }

            // Manual approve schedule function
            async function manualApproveSchedule(scheduleId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÊ??ïÊ†∏?ÜÊ≠§?íÁ??éÔ?\n\n?∏Â?ÂæåÂ??ºÊ?Á®ãÊ??ìËá™?ïÁôºÂ∏ÉÂà∞ Threads??)) return;

                try {
                    showSmartMessage('ucb-message', '??Ê≠?ú®?∏Â?...', 'info');

                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/manual-approve`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '?∏Â?Â§±Ê?');
                    }

                    showSmartMessage('ucb-message', data.message || '??Â∑≤Ê??ïÊ†∏??, 'success');
                    loadScheduleHistory(); // ?çÊñ∞ËºâÂÖ•?óË°®
                } catch (error) {
                    showSmartMessage('ucb-message', '???∏Â?Â§±Ê?: ' + error.message, 'error');
                }
            }

            // Template Testing functions
            async function testSmartTemplate(templateId) {
                const template = smartSchedulingTemplates.find(t => t.id === templateId);
                if (!template) return;

                currentTestPrompt = template.prompt;
                currentTestEngine = template.preferred_engine || 'GPT5_2';
                openPreviewModal(template.name, currentTestEngine);
                await generatePreview();
            }

            async function testCurrentTemplate() {
                const prompt = document.getElementById('template-prompt').value;
                const engine = document.getElementById('template-engine').value;
                const name = document.getElementById('template-name').value || '?™ÂëΩ?çÊ®°??;

                if (!prompt) {
                    alert('Ë´ãÂ?Â°´ÂØ´?êÁ§∫Ë©ûÂÖßÂÆ?);
                    return;
                }

                currentTestPrompt = prompt;
                currentTestEngine = engine;
                openPreviewModal(name, currentTestEngine);
                await generatePreview();
            }

            function openPreviewModal(templateName, engine) {
                document.getElementById('previewModal').classList.add('active');
                const engineName = getEngineName(engine);
                document.querySelector('#previewModal .modal-header h2').textContent = `?? ${templateName} - ?ßÂÆπ?êË¶Ω (${engineName})`;
            }

            function closePreviewModal() {
                document.getElementById('previewModal').classList.remove('active');
            }

            async function regeneratePreview() {
                await generatePreview();
            }

            async function generatePreview() {
                const resultDiv = document.getElementById('preview-result');
                const engine = currentTestEngine;
                const engineName = getEngineName(engine);

                // Show loading
                resultDiv.innerHTML = `
                <div class="preview-loading">
                    <div class="spinner-small"></div>
                    <p>AI Ê≠?ú®?üÊ??ßÂÆπ...</p>
                    <p style="font-size: 13px; color: #9ca3af;">‰ΩøÁî®ÂºïÊ?: ${engineName}</p>
                </div>
            `;

                try {
                    const response = await fetch(`${API_BASE}/generate/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: currentTestPrompt,
                            engine: engine
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || '?üÊ?Â§±Ê?');
                    }

                    const data = await response.json();

                    resultDiv.innerHTML = `
                    <div class="preview-content">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #0369a1;">
                        <strong>?í° ?êÁ§∫Ôº?/strong>?ôÊòØ AI ?πÊ?Ê®°Êùø?êÁ§∫Ë©ûÁ??êÁ??ßÂÆπÁØÑ‰??ÇÊ?Ê¨°Á??êÁ??ßÂÆπ?ΩÊ??âÊ?‰∏çÂ???
                        <br><strong>‰ΩøÁî®ÂºïÊ?Ôº?/strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
                } catch (error) {
                    resultDiv.innerHTML = `
                    <div class="error-message">
                        ?üÊ?Â§±Ê?: ${error.message}
                    </div>
                `;
                }
            }

            // Helper functions
            function getEngineName(engineCode) {
                const engineNames = {
                    'GPT5_2': 'GPT-5.2',
                    'GPT5_2_INSTANT': 'GPT-5.2 Instant',
                    'GPT4O': 'GPT-4o',
                    'GEMINI_3_FLASH': 'Gemini 3 Flash',
                    'GEMINI_3_PRO_PREVIEW': 'Gemini 3 Pro',
                    'GEMINI_2_5_FLASH': 'Gemini 2.5 Flash'
                };
                return engineNames[engineCode] || engineCode;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            }

            function formatDateTime(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function showSmartMessage(containerId, message, type) {
                const container = document.getElementById(containerId);
                const messageDiv = document.createElement('div');
                messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
                messageDiv.textContent = message;

                container.insertBefore(messageDiv, container.firstChild);

                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            // Auto refresh (?ÖÂà∑?∞Ë≤º?áÂ?Ë°®Â?Â∏≥Ë??óË°®ÔºåÁµ±Ë®àÂ?Ë°®‰??™Â??∑Êñ∞‰ª•Á??ÅË?Ê∫?
            setInterval(() => {
                if (token && document.getElementById('dashboard').classList.contains('active')) {
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'overviewTab') {
                        loadOverview(); // ?™Âà∑?∞Á∏ΩË¶ΩÊï∏Â≠óÔ?‰∏çÂà∑?∞Áµ±Ë®àÂ?Ë°?
                    }
                    if (activeTab.id === 'postsTab') loadPosts();
                    if (activeTab.id === 'accountsTab') loadThreadsAccountsList();
                }
            }, 60000); // ?πÁÇ∫ÊØ?60 ÁßíÂà∑?∞‰?Ê¨?

            // ========== STATISTICS FUNCTIONS ==========

            let stats7DayChartInstance = null;

            // Switch between statistics sub-tabs
            function switchStatsTab(tabName) {
                // Remove active class from all stats sub-tabs
                document.querySelectorAll('.stats-sub-tab').forEach(tab => {
                    tab.style.background = '#e5e7eb';
                    tab.style.color = '#333';
                    tab.classList.remove('active');
                });

                // Hide all stats sub-content
                document.querySelectorAll('.stats-sub-content').forEach(content => {
                    content.style.display = 'none';
                });

                // Activate selected tab
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';
                event.target.classList.add('active');

                // Show selected content
                const contentMap = {
                    'summary': 'statsSummaryTab',
                    'templates': 'statsTemplatesTab',
                    'timeslots': 'statsTimeslotsTab',
                    'details': 'statsDetailsTab'
                };

                const contentId = contentMap[tabName];
                if (contentId) {
                    document.getElementById(contentId).style.display = 'block';
                }

                // Load data for the selected tab
                if (tabName === 'summary') {
                    loadStatsSummary();
                } else if (tabName === 'templates') {
                    loadStatsTemplates();
                } else if (tabName === 'timeslots') {
                    loadStatsTimeslots();
                } else if (tabName === 'details') {
                    loadStatsDetails();
                }
            }

            // Load statistics summary
            async function loadStatsSummary() {
                try {
                    // Get selected days from both dropdowns
                    const trendDaysSelect = document.getElementById('trendDaysSelect');
                    const summaryDaysSelect = document.getElementById('summaryDaysSelect');

                    // Ë∂®Âã¢?ñ‰Ωø??trendDaysSelectÔºåÊï¥È´îË°®?æ‰Ωø??summaryDaysSelect
                    const trendDays = trendDaysSelect ? trendDaysSelect.value : '7';
                    const summaryDays = summaryDaysSelect ? summaryDaysSelect.value : '7';

                    // Â¶ÇÊ??∏Ê??åÂÖ®?®Ê≠∑?≤„ÄçÔ?‰ΩøÁî® 3650 Â§©Ô?Á¥?10 Âπ¥Ô?
                    const summaryDaysNum = summaryDays === 'all' ? 3650 : summaryDays;

                    // Fetch overview statistics from API
                    const [overviewRes, syncStatusRes, trendRes] = await Promise.all([
                        fetch(`${API_BASE}/statistics/overview?days=${summaryDaysNum}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        fetch(`${API_BASE}/statistics/sync-status`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        // Ë∂®Âã¢?ñ‰Ωø?®Áç®Á´ãÁ?Â§©Êï∏
                        fetch(`${API_BASE}/statistics/overview?days=${trendDays}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);

                    const overviewData = await overviewRes.json();
                    const syncData = await syncStatusRes.json();
                    const trendData = await trendRes.json();

                    if (!overviewData.success) {
                        throw new Error(overviewData.error || 'Failed to load overview');
                    }

                    const overview = overviewData.data?.overview || {};
                    // Ë∂®Âã¢?ñË??ôÂ??®Á???API ?ûÊ??ñÂ?
                    const trend = trendData.data?.trend || { dates: [], views: [], engagement: [] };

                    const avgEngagement = parseFloat(overview.avg_engagement_rate) || 0;

                    const data = {
                        total_posts: overview.total_posts || 0,
                        total_views: overview.total_views || 0,
                        total_likes: overview.total_likes || 0,
                        avg_engagement_rate: avgEngagement.toFixed(1),
                        last_sync: syncData.success && syncData.data?.last_synced_at
                            ? new Date(syncData.data.last_synced_at).toLocaleString('zh-TW')
                            : 'Â∞öÊú™?åÊ≠•',
                        trend_data: {
                            dates: (trend.dates || []).map(d => d ? d.substring(5).replace('-', '/') : ''),
                            views: trend.views || [],
                            engagement: (trend.engagement || []).map(e => parseFloat((parseFloat(e) || 0).toFixed(1)))
                        }
                    };

                    // Update summary metrics
                    document.getElementById('statsTotalPosts').textContent = data.total_posts;
                    document.getElementById('statsTotalViews').textContent = data.total_views.toLocaleString();
                    document.getElementById('statsTotalLikes').textContent = data.total_likes.toLocaleString();
                    document.getElementById('statsAvgEngagement').textContent = data.avg_engagement_rate + '%';
                    document.getElementById('statsLastSync').textContent = data.last_sync;

                    // Update synced count
                    const syncedCountEl = document.getElementById('statsSyncedCount');
                    if (syncedCountEl && syncData.success) {
                        syncedCountEl.textContent = syncData.data?.synced_count || 0;
                    }

                    // Update 7-day trend chart
                    const ctx = document.getElementById('stats7DayChart');
                    if (ctx) {
                        // Destroy existing chart if it exists
                        if (stats7DayChartInstance) {
                            stats7DayChartInstance.destroy();
                        }

                        stats7DayChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.trend_data.dates,
                                datasets: [
                                    {
                                        label: 'ËßÄ?ãÊï∏',
                                        data: data.trend_data.views,
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '?ÉË???(%)',
                                        data: data.trend_data.engagement,
                                        borderColor: '#764ba2',
                                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            font: { size: 11 },
                                            padding: 10
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        position: 'left',
                                        title: { display: true, text: 'ËßÄ?ãÊï∏', font: { size: 10 } },
                                        ticks: { font: { size: 10 } }
                                    },
                                    y1: {
                                        type: 'linear',
                                        position: 'right',
                                        title: { display: true, text: '?ÉË???(%)', font: { size: 10 } },
                                        ticks: { font: { size: 10 } },
                                        grid: { drawOnChartArea: false }
                                    }
                                }
                            }
                        });
                    }

                    // Load analytics data (‰ΩøÁî®?ÜÊ??ÄÂ°äÁ??ÇÈ??∏Ê???
                    const analyticsDays = parseInt(document.getElementById('analyticsDaysSelect')?.value || '30');
                    await loadAnalyticsData(analyticsDays);

                } catch (error) {
                    console.error('Failed to load statistics summary:', error);
                    showAlert('dashboardAlert', 'Áµ±Ë??∏Ê?ËºâÂÖ•Â§±Ê?', 'danger');
                }
            }

            // Handle analytics time range change
            function onAnalyticsDaysChange() {
                const days = parseInt(document.getElementById('analyticsDaysSelect').value);
                loadAnalyticsData(days);
            }

            // Load and render analytics data
            async function loadAnalyticsData(days) {
                const containers = ['bestHoursChart', 'bestDaysChart', 'topPostsList', 'contentLengthAnalysis'];

                try {
                    const response = await fetch(`${API_BASE}/statistics/analytics?days=${days}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Analytics API error:', response.status, errorText);
                        containers.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">ËºâÂÖ•Â§±Ê? (${response.status})</p>`;
                        });
                        return;
                    }

                    const result = await response.json();
                    if (!result.success) {
                        console.error('Analytics API returned error:', result.error);
                        containers.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">${result.error || 'ËºâÂÖ•Â§±Ê?'}</p>`;
                        });
                        return;
                    }

                    const { hourlyAnalysis, dayAnalysis, topPosts, contentAnalysis } = result.data;

                    // Render best hours chart
                    renderBestHoursChart(hourlyAnalysis);

                    // Render best days chart
                    renderBestDaysChart(dayAnalysis);

                    // Render top posts
                    renderTopPosts(topPosts);

                    // Render content length analysis
                    renderContentLengthAnalysis(contentAnalysis);

                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    containers.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">ËºâÂÖ•Â§±Ê?: ${error.message}</p>`;
                    });
                }
            }

            // Render best hours chart
            function renderBestHoursChart(data) {
                const container = document.getElementById('bestHoursChart');
                if (!container) return;

                if (!data.hours || data.hours.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">Â∞öÁÑ°Ë∂≥Â??∏Ê?</p>';
                    return;
                }

                // Find top 5 hours by engagement
                const sortedHours = [...data.hours].filter(h => h.posts >= 1).sort((a, b) => b.avgEngagement - a.avgEngagement).slice(0, 5);

                if (sortedHours.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">Â∞öÁÑ°Ë∂≥Â??∏Ê?</p>';
                    return;
                }

                const maxEngagement = Math.max(...sortedHours.map(h => h.avgEngagement));

                container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ?? ?Ä‰Ω≥Ê?ÊÆ? <strong style="color: #059669;">${data.bestHour}:00</strong>
                </div>
                ${sortedHours.map(h => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 50px; font-size: 11px; color: #666;">${h.hour}:00</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${(h.avgEngagement / maxEngagement * 100).toFixed(0)}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 60px; text-align: right; font-size: 10px; color: #666;">${h.avgEngagement.toFixed(1)}%</div>
                    </div>
                `).join('')}
                <div style="font-size: 10px; color: #999; margin-top: 8px;">‰æùÂ??áÁ??íÂ?ÔºåÊ?Â∞?1 ÁØáË≤º??/div>
            `;
            }

            // Render best days chart
            function renderBestDaysChart(data) {
                const container = document.getElementById('bestDaysChart');
                if (!container) return;

                if (!data.days || data.days.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">Â∞öÁÑ°Ë∂≥Â??∏Ê?</p>';
                    return;
                }

                const dayNames = ['?±Êó•', '?±‰?', '?±‰?', '?±‰?', '?±Â?', '?±‰?', '?±ÂÖ≠'];
                const maxEngagement = Math.max(...data.days.map(d => d.avgEngagement));

                container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ?? ?Ä‰Ω≥Ê??? <strong style="color: #059669;">${dayNames[data.bestDay]}</strong>
                </div>
                ${data.days.map(d => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 40px; font-size: 11px; color: #666;">${dayNames[d.day]}</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${maxEngagement > 0 ? (d.avgEngagement / maxEngagement * 100).toFixed(0) : 0}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 50px; text-align: right; font-size: 10px; color: #666;">${d.avgEngagement.toFixed(1)}%</div>
                        <div style="width: 40px; text-align: right; font-size: 9px; color: #999;">(${d.posts}ÁØ?</div>
                    </div>
                `).join('')}
            `;
            }

            // Render top posts
            function renderTopPosts(posts) {
                const container = document.getElementById('topPostsList');
                if (!container) return;

                if (!posts || posts.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">Â∞öÁÑ°Ë∂≥Â??∏Ê?</p>';
                    return;
                }

                container.innerHTML = posts.map((post, index) => `
                <div style="display: flex; align-items: flex-start; padding: 10px; background: ${index === 0 ? '#fef3c7' : '#f9fafb'}; border-radius: 6px; margin-bottom: 8px; gap: 10px;">
                    <div style="width: 24px; height: 24px; background: ${index === 0 ? '#f59e0b' : '#9ca3af'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 12px; color: #333; line-height: 1.4; word-break: break-word;">
                            ${escapeHtml(post.content || '(?°ÂÖßÂÆ?')}
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: #666;">
                            <span>??Ô∏?${post.views.toLocaleString()}</span>
                            <span>?§Ô? ${post.likes}</span>
                            <span>?í¨ ${post.replies}</span>
                            <span style="color: #059669; font-weight: bold;">?? ${post.engagementRate.toFixed(2)}%</span>
                        </div>
                    </div>
                    ${post.postUrl ? `<a href="${post.postUrl}" target="_blank" style="color: #667eea; font-size: 10px; text-decoration: none;">?•Á? ??/a>` : ''}
                </div>
            `).join('');
            }

            // Render content length analysis
            function renderContentLengthAnalysis(data) {
                const container = document.getElementById('contentLengthAnalysis');
                if (!container) return;

                if (!data || (data.short.count === 0 && data.medium.count === 0 && data.long.count === 0)) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">Â∞öÁÑ°Ë∂≥Â??∏Ê?</p>';
                    return;
                }

                const categories = [
                    { name: '?≠Ê?', label: '< 100 Â≠?, ...data.short, color: '#3b82f6' },
                    { name: '‰∏≠Á?', label: '100-300 Â≠?, ...data.medium, color: '#8b5cf6' },
                    { name: '?∑Ê?', label: '> 300 Â≠?, ...data.long, color: '#ec4899' },
                ];

                const totalPosts = categories.reduce((sum, c) => sum + c.count, 0);

                container.innerHTML = `
                <div style="font-size: 10px; color: #666; margin-bottom: 8px; text-align: center;">
                    ?? ?ÜÊ? ${totalPosts} ÁØáË≤º?áÁ?<strong>Âπ≥Â??ÉË???/strong>ÔºàÈ??Ü‰?ÊØî‰?Ôº?
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                    ${categories.map(c => `
                        <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">${c.name} ${c.label}</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${c.color};">${c.avgEngagement.toFixed(1)}%</div>
                            <div style="font-size: 9px; color: #999;">Âπ≥Â??ÉË???/div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${c.count} ÁØ?/div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 8px 12px; background: #ecfdf5; border-radius: 6px; font-size: 11px; color: #065f46;">
                    ?í° ${data.recommendation}
                </div>
            `
            }

            // Sync Threads posts from account
            async function syncThreadsPosts(fetchAll = false) {
                const message = fetchAll
                    ? 'Ê≠§Ê?‰ΩúÂ?ÂæûÊÇ®??Threads Â∏≥Ë??ØÂÖ•?Ä?âÊ≠∑?≤Ë≤º?á„ÄÇ\n\n?ôÂèØ?ΩÈ?Ë¶ÅË??∑Ê??ìÔ?ÁπºÁ??éÔ?'
                    : 'Ê≠§Ê?‰ΩúÂ?ÂæûÊÇ®??Threads Â∏≥Ë??ØÂÖ•?ÄËø?50 ÁØáË≤º?áÂ??∂‰??ïÊï∏?ö„ÄÇ\n\nÁπºÁ??éÔ?';

                if (!confirm(message)) {
                    return;
                }

                try {
                    const loadingMessage = fetchAll
                        ? 'Ê≠?ú®ÂÆåÊï¥?ØÂÖ•?Ä?âÊ≠∑?≤Ë≤º?áÔ??ôÂèØ?ΩÈ?Ë¶ÅÊï∏?ÜÈ?ÔºåË?Á®çÂÄ?..'
                        : 'Ê≠?ú®Âæ?Threads ?ØÂÖ•Ê≠∑Âè≤Ë≤ºÊ?ÔºåË?Á®çÂÄ?..';
                    showAlert('dashboardAlert', loadingMessage, 'info');

                    const response = await fetch(`${API_BASE}/statistics/sync-threads-posts`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ limit: 50, fetchAll: fetchAll })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || '?åÊ≠•Â§±Ê?');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadStatsSummary(); // ?çÊñ∞ËºâÂÖ•Áµ±Ë??∏Ê?
                    loadOverview(); // ?çÊñ∞ËºâÂÖ•Á∏ΩË¶Ω?∏È?
                } catch (error) {
                    console.error('Failed to sync Threads posts:', error);
                    showAlert('dashboardAlert', '?ØÂÖ•Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Trigger manual insights sync
            async function triggerManualSync() {
                try {
                    showAlert('dashboardAlert', 'Ê≠?ú®?åÊ≠•‰∫íÂ??∏Ê?ÔºåË?Á®çÂÄôÔ??ØËÉΩ?ÄË¶?30-60 ÁßíÔ?...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/sync`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: 365, limit: 500 })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || result.message || '?åÊ≠•Â§±Ê?');
                    }

                    showAlert('dashboardAlert', result.message || '?åÊ≠•ÂÆåÊ?Ôº?, 'success');
                    // Á´ãÂç≥?çË?Áµ±Ë??∏Ê?
                    loadStatsSummary();
                } catch (error) {
                    console.error('Failed to trigger manual sync:', error);
                    showAlert('dashboardAlert', '?åÊ≠•Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Clear all pending review posts
            async function clearPendingPosts() {
                if (!confirm('Ê≠§Ê?‰ΩúÂ??™Èô§?Ä?âÂ?ÂØ©Ê†∏?ÅË?Á®øÁ??ãÁ?Ë≤ºÊ??Ç\n\nÊ≠§Ê?‰ΩúÁÑ°Ê≥ïÂæ©?üÔ?Á¢∫Â?Ë¶ÅÁπºÁ∫åÂ?Ôº?)) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'Ê≠?ú®Ê∏ÖÈô§ÂæÖÂØ©?∏Ë≤º??..', 'info');

                    const response = await fetch(`${API_BASE}/statistics/clear-pending`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Ê∏ÖÈô§Â§±Ê?');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadOverview(); // ?çÊñ∞ËºâÂÖ•Á∏ΩË¶Ω?∏È?
                } catch (error) {
                    console.error('Failed to clear pending posts:', error);
                    showAlert('dashboardAlert', 'Ê∏ÖÈô§Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Clear all scheduled (APPROVED) posts
            async function clearScheduledPosts() {
                if (!confirm('Ê≠§Ê?‰ΩúÂ??™Èô§?Ä?âÊ?Á®ã‰∏≠ÔºàÂ∑≤ÂØ©Ê†∏ÂæÖÁôºÂ∏ÉÔ??ÑË≤º?á„ÄÇ\n\nÊ≠§Ê?‰ΩúÁÑ°Ê≥ïÂæ©?üÔ?Á¢∫Â?Ë¶ÅÁπºÁ∫åÂ?Ôº?)) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'Ê≠?ú®Ê∏ÖÈô§?íÁ?‰∏≠Ë≤º??..', 'info');

                    const response = await fetch(`${API_BASE}/statistics/clear-scheduled`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Ê∏ÖÈô§Â§±Ê?');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadOverview(); // ?çÊñ∞ËºâÂÖ•Á∏ΩË¶Ω?∏È?
                } catch (error) {
                    console.error('Failed to clear scheduled posts:', error);
                    showAlert('dashboardAlert', 'Ê∏ÖÈô§Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Reclassify templates for posts without template
            async function reclassifyTemplates() {
                if (!confirm('Ê≠§Ê?‰ΩúÂ??∫Ê??âÊ??âÊ®°?øÂ?È°ûÁ?Ë≤ºÊ??™Â??ÜÈ??Ç\n\nÁπºÁ??éÔ?')) {
                    return;
                }

                try {
                    showAlert('dashboardAlert', 'Ê≠?ú®?çÊñ∞?ÜÈ?Ë≤ºÊ?Ê®°Êùø...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/reclassify-templates`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || '?ÜÈ?Â§±Ê?');
                    }

                    showAlert('dashboardAlert', result.message, 'success');
                    loadStatsSummary(); // ?çÊñ∞ËºâÂÖ•Áµ±Ë??∏Ê?
                    loadStatsTemplates(); // ?çÊñ∞ËºâÂÖ•Ê®°ÊùøÁµ±Ë?
                } catch (error) {
                    console.error('Failed to reclassify templates:', error);
                    showAlert('dashboardAlert', '?çÊñ∞?ÜÈ?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Load pending posts (?íÁ?‰∏≠Ë≤º?? - ?•Ë©¢ UCB ?íÁ?‰∏≠Á?Â∑≤Ê†∏?ÜË≤º??
            async function loadPendingPosts() {
                const container = document.getElementById('pendingPostsList');
                if (!container) return;

                try {
                    container.innerHTML = '<p style="text-align: center; color: #999;">ËºâÂÖ•‰∏?..</p>';

                    // ?•Ë©¢ UCB ?™Â??íÁ?ÔºàÂ∑≤?∏Â??Ä?ãÔ?
                    const response = await fetch(`${API_BASE}/auto-schedules`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ËºâÂÖ•Â§±Ê?');
                    }

                    // ?éÊøæ?∫Â∑≤?∏Â??ÑÊ?Á®ãÔ?status = APPROVED ??GENERATED ‰∏îÊú™?∑Ë?Ôº?
                    const schedules = (data.schedules || []).filter(s =>
                        s.status === 'APPROVED' || s.status === 'GENERATED'
                    );

                    if (schedules.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 48px; margin-bottom: 10px;">?ì≠</p>
                            <p>?ÆÂ?Ê≤íÊ??íÁ?‰∏≠Á?Ë≤ºÊ?</p>
                        </div>`;
                        return;
                    }

                    // Â≠òÂÑ≤?íÁ?Ë≥áÊ?‰æõÁ∑®ËºØ‰Ωø??
                    window.pendingSchedulesData = {};

                    container.innerHTML = schedules.map(schedule => {
                        const scheduledTime = schedule.scheduled_time
                            ? new Date(schedule.scheduled_time).toLocaleString('zh-TW')
                            : '?™Ë®≠ÂÆ?;
                        const templateName = schedule.template_name || '?™Áü•Ê®°Êùø';
                        const statusText = schedule.status === 'APPROVED' ? 'Â∑≤Ê†∏?? : 'ÂæÖÂØ©??;
                        const statusColor = schedule.status === 'APPROVED' ? '#10b981' : '#f59e0b';

                        // ?ñÂ?Ë≤ºÊ??ßÂÆπ
                        const postContent = schedule.revision_content || schedule.post_content || '';
                        const preview = postContent.length > 150 ? postContent.substring(0, 150) + '...' : postContent;

                        // Â≠òÂÑ≤ÂÆåÊï¥?ßÂÆπ‰æõÁ∑®ËºØ‰Ωø??
                        if (schedule.post_id) {
                            window.pendingSchedulesData[schedule.post_id] = postContent;
                        }

                        return `
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <span style="background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${statusText}</span>
                                    <span style="margin-left: 10px; color: #666; font-size: 13px;">???êÂ??ºÂ?Ôº?{scheduledTime}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${schedule.post_id ? `
                                    <button onclick="editPendingPost('${schedule.post_id}')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ?èÔ? Á∑®ËºØ
                                    </button>
                                    ` : ''}
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" 
                                        style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ??Ô∏??™Èô§
                                    </button>
                                </div>
                            </div>
                            ${postContent ? `
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                                ${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: #666;">
                                <div>?? Ê®°ÊùøÔº?strong>${templateName}</strong></div>
                                <div>?? ?íÁ??•Ê?Ôº?strong>${schedule.schedule_date || '?™Áü•'}</strong></div>
                            </div>
                            ${schedule.selection_reason ? `
                            <div style="background: #f3e8ff; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px; color: #7c3aed;">
                                ?? ${schedule.selection_reason}
                            </div>
                            ` : ''}
                        </div>`;
                    }).join('');

                } catch (error) {
                    console.error('Failed to load pending posts:', error);
                    container.innerHTML = `<p style="text-align: center; color: #ef4444;">ËºâÂÖ•Â§±Ê?Ôº?{error.message}</p>`;
                }
            }

            // Delete auto schedule
            async function deleteAutoSchedule(scheduleId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§ÈÄôÂÄãÊ?Á®ãÂ?Ôº?)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || '?™Èô§Â§±Ê?');
                    }

                    showAlert('dashboardAlert', '?íÁ?Â∑≤Âà™??, 'success');
                    loadPendingPosts();
                    loadScheduleHistory(); // ?¥Êñ∞?íÁ?Ê≠∑Âè≤
                } catch (error) {
                    console.error('Failed to delete auto schedule:', error);
                    showAlert('dashboardAlert', '?™Èô§Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Edit pending post - ‰ΩøÁî® Modal Â∞çË©±Ê°?
            async function editPendingPost(postId) {
                try {
                    // ?™Â?‰ΩøÁî®Â∑≤Â??≤Á??ßÂÆπ
                    let content = window.pendingSchedulesData?.[postId] || '';

                    // Â¶ÇÊ?Ê≤íÊ?Â≠òÂÑ≤?ÑÂÖßÂÆπÔ?Âæ?API ?ñÂ?
                    if (!content) {
                        const response = await fetch(`${API_BASE}/posts/${postId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await response.json();

                        if (response.ok) {
                            const post = data.post || data;
                            content = post.content || post.generated_content || '';
                        }
                    }

                    if (!content) {
                        showAlert('dashboardAlert', '?æ‰??∞Ë≤º?áÂÖßÂÆ?, 'danger');
                        return;
                    }

                    // ?ìÈ?Á∑®ËºØ Modal
                    openEditPostModal(postId, content);
                } catch (error) {
                    console.error('Failed to load post for editing:', error);
                    showAlert('dashboardAlert', 'ËºâÂÖ•Ë≤ºÊ?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // ?ìÈ?Á∑®ËºØË≤ºÊ? Modal
            function openEditPostModal(postId, content) {
                document.getElementById('editPostId').value = postId;
                document.getElementById('editPostContent').value = content;
                document.getElementById('editPostCharCount').textContent = content.length;
                document.getElementById('editPostModal').style.display = 'flex';

                // ??ÅΩËº∏ÂÖ•?¥Êñ∞Â≠óÊï∏
                const textarea = document.getElementById('editPostContent');
                textarea.oninput = function () {
                    document.getElementById('editPostCharCount').textContent = this.value.length;
                };

                // ?öÁÑ¶?∞Ê?Â≠óÂ???
                setTimeout(() => textarea.focus(), 100);
            }

            // ?úÈ?Á∑®ËºØË≤ºÊ? Modal
            function closeEditPostModal() {
                document.getElementById('editPostModal').style.display = 'none';
                document.getElementById('editPostId').value = '';
                document.getElementById('editPostContent').value = '';
            }

            // ?≤Â?Á∑®ËºØ?ÑË≤º??
            async function saveEditedPost(event) {
                event.preventDefault();

                const postId = document.getElementById('editPostId').value;
                const newContent = document.getElementById('editPostContent').value;

                if (!postId || !newContent.trim()) {
                    showAlert('dashboardAlert', 'Ë≤ºÊ??ßÂÆπ‰∏çËÉΩ?∫Á©∫', 'danger');
                    return;
                }

                try {
                    const updateResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: newContent })
                    });

                    if (!updateResponse.ok) {
                        const updateData = await updateResponse.json();
                        throw new Error(updateData.error || '?¥Êñ∞Â§±Ê?');
                    }

                    closeEditPostModal();
                    showAlert('dashboardAlert', '??Ë≤ºÊ?Â∑≤Êõ¥?∞Ô?Â∞áÊ??®Ê?Á®ãÊ??ìÁôºÂ∏ÉÂà∞ Threads', 'success');
                    loadPendingPosts();
                } catch (error) {
                    console.error('Failed to save edited post:', error);
                    showAlert('dashboardAlert', '?≤Â?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Delete pending post
            async function deletePendingPost(postId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§ÈÄôÁ??íÁ?‰∏≠Á?Ë≤ºÊ??éÔ?')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || '?™Èô§Â§±Ê?');
                    }

                    showAlert('dashboardAlert', 'Ë≤ºÊ?Â∑≤Âà™??, 'success');
                    loadPendingPosts();
                    loadOverview(); // ?¥Êñ∞Á∏ΩË¶Ω?∏Â?
                } catch (error) {
                    console.error('Failed to delete pending post:', error);
                    showAlert('dashboardAlert', '?™Èô§Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // ========== AI ?ºÊ??çÁΩÆ?∏È??ΩÊï∏ ==========

            // ËºâÂÖ• AI ?ºÊ??çÁΩÆ
            async function loadAIConfig() {
                try {
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const data = await response.json();
                    const config = data.config || {};

                    // Ë®≠Â?Ë°®ÂñÆ??
                    document.getElementById('posts-per-day').value = config.posts_per_day || 1;
                    document.getElementById('time-range-start').value = config.time_range_start || '09:00';
                    document.getElementById('time-range-end').value = config.time_range_end || '21:00';
                    document.getElementById('auto-schedule-enabled').checked = config.auto_schedule_enabled !== false;

                    // Ë®≠Â??üÁî®?üÊ?
                    const activeDays = config.active_days || [1, 2, 3, 4, 5, 6, 7];
                    document.querySelectorAll('.active-day').forEach(checkbox => {
                        checkbox.checked = activeDays.includes(parseInt(checkbox.value));
                    });
                } catch (error) {
                    console.error('Failed to load AI config:', error);
                }
            }

            // ?≤Â? AI ?ºÊ??çÁΩÆ
            async function saveAIConfig(event) {
                event.preventDefault();

                try {
                    showLoading(true);

                    const activeDays = [];
                    document.querySelectorAll('.active-day:checked').forEach(checkbox => {
                        activeDays.push(parseInt(checkbox.value));
                    });

                    const config = {
                        posts_per_day: parseInt(document.getElementById('posts-per-day').value) || 1,
                        time_range_start: document.getElementById('time-range-start').value || '09:00',
                        time_range_end: document.getElementById('time-range-end').value || '21:00',
                        auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                        active_days: activeDays
                    };

                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', '??AI ?ºÊ?Ë®≠Â?Â∑≤ÂÑ≤Â≠?, 'success');
                    } else {
                        throw new Error(result.error || '?≤Â?Â§±Ê?');
                    }
                } catch (error) {
                    console.error('Failed to save AI config:', error);
                    showAlert('dashboardAlert', '?≤Â?Â§±Ê?: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // ËºâÂÖ• AI ?êÁ§∫Ë©ûË®≠ÂÆ?
            async function loadAIPrompt() {
                try {
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const data = await response.json();
                    const config = data.config || {};

                    // Ë®≠Â??êÁ§∫Ë©ûÂ?ÂºïÊ?
                    document.getElementById('ai-prompt').value = config.ai_prompt || '';
                    document.getElementById('ai-engine').value = config.ai_engine || 'GPT5_2';
                } catch (error) {
                    console.error('Failed to load AI prompt:', error);
                }
            }

            // ?≤Â? AI ?êÁ§∫Ë©ûË®≠ÂÆ?
            async function saveAIPrompt(event) {
                event.preventDefault();

                try {
                    showLoading(true);

                    const aiPrompt = document.getElementById('ai-prompt').value;
                    const aiEngine = document.getElementById('ai-engine').value;

                    if (!aiPrompt.trim()) {
                        showAlert('dashboardAlert', 'Ë´ãËº∏??AI ?êÁ§∫Ë©?, 'danger');
                        return;
                    }

                    // ?àÂ?ÂæóÁèæ?âÈ?ÁΩ?
                    const configResponse = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    let currentConfig = {};
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        currentConfig = configData.config || {};
                    }

                    // ?¥Êñ∞?çÁΩÆ
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...currentConfig,
                            ai_prompt: aiPrompt,
                            ai_engine: aiEngine
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', '???êÁ§∫Ë©ûË®≠ÂÆöÂ∑≤?≤Â?', 'success');
                    } else {
                        throw new Error(result.error || '?≤Â?Â§±Ê?');
                    }
                } catch (error) {
                    console.error('Failed to save AI prompt:', error);
                    showAlert('dashboardAlert', '?≤Â?Â§±Ê?: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // Ê∏¨Ë©¶ AI ?êÁ§∫Ë©ûÁ???
            async function testAIPrompt() {
                const prompt = document.getElementById('ai-prompt').value;
                const engine = document.getElementById('ai-engine').value;

                if (!prompt.trim()) {
                    showAlert('dashboardAlert', 'Ë´ãÂ?Ëº∏ÂÖ• AI ?êÁ§∫Ë©?, 'danger');
                    return;
                }

                const resultContainer = document.getElementById('ai-prompt-test-result');
                const contentDiv = document.getElementById('ai-prompt-test-content');

                resultContainer.style.display = 'block';
                contentDiv.innerHTML = '<div style="text-align: center; padding: 30px;"><div class="spinner"></div><p style="margin-top: 15px; color: #666;">AI Ê≠?ú®?üÊ??ßÂÆπ...</p></div>';

                try {
                    const response = await fetch(`${API_BASE}/generate/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            engine: engine
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || '?üÊ?Â§±Ê?');
                    }

                    const data = await response.json();

                    contentDiv.innerHTML = `
                    <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                        <strong>‰ΩøÁî®ÂºïÊ?Ôº?/strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
                } catch (error) {
                    contentDiv.innerHTML = `<div style="color: #ef4444;">?üÊ?Â§±Ê?: ${error.message}</div>`;
                }
            }

            // ËºâÂÖ•?êÁ§∫Ë©ûË®≠ÂÆöÈ???
            function loadTemplates() {
                loadAIPrompt();
                loadDimensions();
                loadDimensionStats();
            }

            // ========================================
            // Á∂≠Â∫¶Ë®≠Â??∏È??ΩÊï∏
            // ========================================

            let dimensionsData = {};
            const dimensionExpanded = {
                module: true,
                angle: false,
                outlet: false,
                tone_bias: false,
                ending_style: false,
                length_target: false
            };

            // ËºâÂÖ•?Ä?âÁ∂≠Â∫¶Ë®≠ÂÆ?
            async function loadDimensions() {
                try {
                    const response = await fetch(`${API_BASE}/dimensions`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('ËºâÂÖ•Â§±Ê?');
                    }

                    const result = await response.json();
                    if (result.success) {
                        dimensionsData = result.data;
                        renderAllDimensions();
                    }
                } catch (error) {
                    console.error('Failed to load dimensions:', error);
                    document.querySelectorAll('.dimension-options').forEach(el => {
                        el.innerHTML = '<p style="color: #ef4444; font-size: 13px;">ËºâÂÖ•Â§±Ê?</p>';
                    });
                }
            }

            // ËºâÂÖ•Á∂≠Â∫¶‰ΩøÁî®Áµ±Ë?
            async function loadDimensionStats() {
                try {
                    const response = await fetch(`${API_BASE}/generation/stats`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) return;

                    const result = await response.json();
                    if (result.success) {
                        renderDimensionStats(result.data);
                    }
                } catch (error) {
                    console.error('Failed to load dimension stats:', error);
                }
            }

            // Ê∏≤Ê??Ä?âÁ∂≠Â∫?
            function renderAllDimensions() {
                const dimensions = ['module', 'angle', 'outlet', 'tone_bias', 'ending_style', 'length_target'];
                dimensions.forEach(dim => renderDimensionOptions(dim));
            }

            // Ê∏≤Ê??Æ‰?Á∂≠Â∫¶?ÑÈÅ∏??
            function renderDimensionOptions(dimension) {
                const container = document.getElementById(`${dimension}-options`);
                if (!container) return;

                const options = dimensionsData[dimension] || [];

                if (options.length === 0) {
                    container.innerHTML = '<p style="color: #999; font-size: 13px;">Â∞öÁÑ°?∏È?</p>';
                    return;
                }

                let html = '';
                options.forEach(opt => {
                    const weightPercent = Math.round(opt.weight * 100);
                    const activeClass = opt.isActive ? '' : 'opacity: 0.5;';

                    html += `
                    <div class="dimension-option" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; ${activeClass}">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${escapeHtml(opt.name)}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${escapeHtml(opt.code)}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="100" value="${weightPercent}" 
                                onchange="updateDimensionWeight('${opt.id}', this.value)"
                                style="width: 60px; cursor: pointer;">
                            <span style="font-size: 12px; width: 35px; text-align: right;">${weightPercent}%</span>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${opt.isActive ? 'checked' : ''} 
                                    onchange="toggleDimensionActive('${opt.id}', this.checked)"
                                    style="margin: 0;">
                            </label>
                        </div>
                    </div>
                `;
                });

                html += `
                <div style="padding: 10px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showAddDimensionModal('${dimension}')" 
                        style="font-size: 12px; padding: 6px 12px;">
                        ???∞Â??∏È?
                    </button>
                </div>
            `;

                container.innerHTML = html;
            }

            // ?áÊ?Á∂≠Â∫¶Â±ïÈ?/?∂Â?
            function toggleDimension(dimension) {
                dimensionExpanded[dimension] = !dimensionExpanded[dimension];

                const optionsEl = document.getElementById(`${dimension}-options`);
                const toggleEl = document.getElementById(`${dimension}-toggle`);

                if (optionsEl) {
                    optionsEl.style.display = dimensionExpanded[dimension] ? 'block' : 'none';
                }
                if (toggleEl) {
                    toggleEl.textContent = dimensionExpanded[dimension] ? '?? : '??;
                }
            }

            // ?¥Êñ∞Á∂≠Â∫¶Ê¨äÈ?
            async function updateDimensionWeight(id, value) {
                try {
                    const weight = parseFloat(value) / 100;

                    const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ weight })
                    });

                    if (!response.ok) {
                        throw new Error('?¥Êñ∞Â§±Ê?');
                    }
                } catch (error) {
                    console.error('Failed to update dimension weight:', error);
                    showAlert('dashboardAlert', 'Ê¨äÈ??¥Êñ∞Â§±Ê?', 'danger');
                }
            }

            // ?áÊ?Á∂≠Â∫¶?üÁî®?Ä??
            async function toggleDimensionActive(id, isActive) {
                try {
                    const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isActive })
                    });

                    if (!response.ok) {
                        throw new Error('?¥Êñ∞Â§±Ê?');
                    }

                    // ?çÊñ∞ËºâÂÖ•Á∂≠Â∫¶
                    loadDimensions();
                } catch (error) {
                    console.error('Failed to toggle dimension active:', error);
                    showAlert('dashboardAlert', '?Ä?ãÊõ¥?∞Â§±??, 'danger');
                }
            }

            // È°ØÁ§∫?∞Â?Á∂≠Â∫¶?∏È??ÑÂ?Ë©±Ê?
            function showAddDimensionModal(dimensionType) {
                const dimensionNames = {
                    module: '?ßÂÆπÊ®°Á?',
                    angle: '?ÖÂ??áË?',
                    outlet: '?ïÁ??∫Âè£',
                    tone_bias: 'Ë™ûÊ∞£?èÂ?',
                    ending_style: '?∂Â∞æ?èÂ?',
                    length_target: 'Â≠óÊï∏?ÆÊ?'
                };

                const code = prompt(`Ë´ãËº∏?•Êñ∞??{dimensionNames[dimensionType]}?ëÈÅ∏?ÖÁ?‰ª?¢ºÔºàËã±?áÔ?‰æãÂ?Ôºönew_optionÔºâÔ?`);
                if (!code) return;

                const name = prompt('Ë´ãËº∏?•ÈÅ∏?ÖÁ?‰∏≠Ê??çÁ®±Ôº?);
                if (!name) return;

                addDimensionOption(dimensionType, code, name);
            }

            // ?∞Â?Á∂≠Â∫¶?∏È?
            async function addDimensionOption(dimensionType, code, name) {
                try {
                    const response = await fetch(`${API_BASE}/dimensions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            dimensionType,
                            code,
                            name,
                            weight: 0.10
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || '?∞Â?Â§±Ê?');
                    }

                    showAlert('dashboardAlert', '???∏È?Â∑≤Êñ∞Â¢?, 'success');
                    loadDimensions();
                } catch (error) {
                    console.error('Failed to add dimension option:', error);
                    showAlert('dashboardAlert', '?∞Â?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // Ê∏≤Ê?Áµ±Ë?Ë≥áÊ?
            function renderDimensionStats(stats) {
                const container = document.getElementById('dimension-stats');
                if (!container) return;

                const moduleStats = stats.module || {};
                const total = Object.values(moduleStats).reduce((a, b) => a + b, 0);

                if (total === 0) {
                    container.innerHTML = '<p style="color: #999;">Â∞öÁÑ°Áµ±Ë?Ë≥áÊ?</p>';
                    return;
                }

                const moduleNames = {
                    pleasure_relief: '?ΩË?Ëß??',
                    practical: '?ôÂØ¶?ïÁ?',
                    uncomfortable_truth: '‰∏çË??çÁ?ÂØ?,
                    controversial: '?≠Ë≠∞?êÂ?'
                };

                let html = '<div style="display: grid; gap: 8px;">';

                for (const [code, count] of Object.entries(moduleStats)) {
                    const percent = Math.round((count / total) * 100);
                    const name = moduleNames[code] || code;

                    html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span>${name}</span>
                            <span>${count} ÁØ?(${percent}%)</span>
                        </div>
                        <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                        </div>
                    </div>
                `;
                }

                html += '</div>';
                container.innerHTML = html;
            }

            // ËºâÂÖ•?ºÊ??íÁ??ÅÈù¢
            function loadScheduling() {
                loadAIConfig();
                loadScheduleHistory();
            }

            // Load UCB template ranking (‰øùÁ?‰ΩÜÁ∞°??
            async function loadUCBTemplateRanking() {
                const container = document.getElementById('ucbTemplateRanking');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE}/statistics/debug-performance-log`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        container.innerHTML = '<p style="opacity: 0.8;">Ë≥áÊ?ËºâÂÖ•Â§±Ê?</p>';
                        return;
                    }

                    const data = await response.json();
                    const templates = data.data?.template_stats || [];

                    if (templates.length === 0) {
                        container.innerHTML = '<p style="opacity: 0.8;">Â∞öÁÑ°Ê®°Êùø?∏Ê?</p>';
                        return;
                    }

                    // Ë®àÁ? UCB ?ÜÊï∏‰∏¶Ê?Â∫?
                    const totalPosts = templates.reduce((sum, t) => sum + (t.total_uses || 0), 0);
                    const minTrials = 5; // ?êË®≠?ÄÂ∞ëË©¶È©óÊ¨°??
                    const explorationFactor = 1.5; // ?êË®≠?¢Á¥¢‰øÇÊï∏

                    const rankedTemplates = templates
                        .filter(t => t.enabled)
                        .map(t => {
                            const uses = parseInt(t.total_uses) || 0;
                            const avgRateRaw = parseFloat(t.avg_engagement_rate) || 0;
                            const avgRate = avgRateRaw / 100;

                            let ucbScore, status, statusColor;
                            if (uses < minTrials) {
                                ucbScore = 999 + Math.random();
                                status = `?¢Á¥¢‰∏?(${uses}/${minTrials})`;
                                statusColor = '#ffd700';
                            } else {
                                const explorationBonus = explorationFactor * Math.sqrt(Math.log(Math.max(totalPosts, 1)) / Math.max(uses, 1));
                                ucbScore = avgRate + explorationBonus;
                                status = '?™Â?‰∏?;
                                statusColor = '#90EE90';
                            }

                            return { ...t, ucbScore, status, statusColor, avgRateRaw };
                        })
                        .sort((a, b) => b.ucbScore - a.ucbScore);

                    container.innerHTML = rankedTemplates.map((t, idx) => `
                    <div style="display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; width: 30px;">${idx + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${t.name}</div>
                            <div style="font-size: 12px; opacity: 0.8;">
                                ‰ΩøÁî® ${parseInt(t.total_uses) || 0} Ê¨???‰∫íÂ???${t.avgRateRaw.toFixed(1)}%
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: ${t.statusColor}; font-weight: 600;">${t.status}</div>
                            <div style="font-size: 10px; opacity: 0.7;">UCB: ${t.ucbScore < 100 ? t.ucbScore.toFixed(3) : '?¢Á¥¢?™Â?'}</div>
                        </div>
                    </div>
                `).join('');

                } catch (error) {
                    console.error('Failed to load UCB template ranking:', error);
                    container.innerHTML = '<p style="opacity: 0.8;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            // Save account settings (UCB account and LINE ID)
            async function saveAccountSettings() {
                try {
                    showLoading(true);

                    const threadsAccountId = document.getElementById('ucbThreadsAccount')?.value || '';
                    const lineUserId = document.getElementById('ucbLineNotifyUserId')?.value || '';

                    // ?ñÂ??æÊ???UCB ?çÁΩÆ
                    const configResponse = await fetch(`${API_BASE}/ucb-config`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    let currentConfig = {};
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        currentConfig = configData.config || {};
                    }

                    // ?¥Êñ∞?çÁΩÆÔºà‰Ωø??PUT ?πÊ?Ôº?
                    const response = await fetch(`${API_BASE}/ucb-config`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            exploration_factor: currentConfig.exploration_factor || 1.5,
                            min_trials_per_template: currentConfig.min_trials_per_template || 5,
                            posts_per_day: currentConfig.posts_per_day || 1,
                            auto_schedule_enabled: currentConfig.auto_schedule_enabled !== false,
                            threads_account_id: threadsAccountId,
                            line_user_id: lineUserId,
                            time_range_start: currentConfig.time_range_start || '09:00',
                            time_range_end: currentConfig.time_range_end || '21:00',
                            active_days: currentConfig.active_days || []
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('dashboardAlert', 'Â∏≥Ë?Ë®≠Â?Â∑≤ÂÑ≤Â≠?, 'success');
                    } else {
                        throw new Error(result.error || '?≤Â?Â§±Ê?');
                    }
                } catch (error) {
                    console.error('Failed to save account settings:', error);
                    showAlert('dashboardAlert', '?≤Â?Â§±Ê?: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }

            // Auto sync on page load (silent, no alert)
            async function autoSyncOnLoad() {
                try {
                    // ?úÈ??åÊ≠•‰∫íÂ??∏Ê?Ôºå‰?È°ØÁ§∫?êÁ§∫
                    await fetch(`${API_BASE}/statistics/sync`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: 7, limit: 100 })
                    });
                    console.log('Auto sync triggered on page load');
                } catch (error) {
                    console.warn('Auto sync failed:', error);
                }
            }

            // Load template statistics
            async function loadStatsTemplates() {
                const container = document.getElementById('statsTemplatesList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/templates?days=30`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load templates');
                    }

                    const templates = result.data;

                    if (templates.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">Â∞öÁÑ°Ê®?ùø?∏Ê?</p>';
                        return;
                    }

                    let html = '';
                    templates.forEach(template => {
                        html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${template.name}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                <div>‰ΩøÁî®Ê¨°Êï∏: ${template.total_uses || 0}</div>
                                <div>Âπ≥Â??âË?: ${Math.round(parseFloat(template.avg_likes) || 0)}</div>
                                <div>?ÉË??? ${(parseFloat(template.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                <div>Âπ≥Â?ËßÄ?? ${Math.round(parseFloat(template.avg_views) || 0)}</div>
                            </div>
                            ${template.best_performing_time ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #28a745;">
                                    ‚≠??Ä‰Ω≥Ê?ÊÆ? ${template.best_performing_time}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    });

                    container.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load template statistics:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            // Load timeslot statistics
            async function loadStatsTimeslots() {
                const container = document.getElementById('statsTimeslotsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/timeslots?days=30`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load timeslots');
                    }

                    const timeslots = result.data;

                    if (timeslots.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">Â∞öÁÑ°?ÇÊÆµ?∏Ê?</p>';
                        return;
                    }

                    let html = '';
                    timeslots.forEach(slot => {
                        // ‰ΩøÁî®ÂæåÁ´ØËøîÂ???name Ê¨Ñ‰?Ôºà‰?Â¶?"08:00 - 08:59"Ôº?
                        const label = slot.name || `${String(slot.start_hour || 0).padStart(2, '0')}:00`;
                        const hour = slot.start_hour || slot.id || 0;
                        html += `
                        <div style="background: white; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                            <div onclick="toggleTimeslotDetail(${hour}, this)" 
                                 style="padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                 onmouseover="this.style.background='#f5f5f5'" 
                                 onmouseout="this.style.background='white'">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 8px;">?? ${label}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                        <div>Ë≤ºÊ??? ${slot.posts_count || 0}</div>
                                        <div>?ÉË??? ${(parseFloat(slot.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                        <div>Âπ≥Â??âË?: ${Math.round(parseFloat(slot.avg_likes) || 0)}</div>
                                        <div>Âπ≥Â?ËßÄ?? ${Math.round(parseFloat(slot.avg_views) || 0)}</div>
                                    </div>
                                </div>
                                <span style="font-size: 18px; color: #999; transition: transform 0.2s;">??/span>
                            </div>
                            <div id="timeslot-detail-${hour}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid #eee;">
                                <p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">ÈªûÊ?ËºâÂÖ•Ë≤ºÊ?...</p>
                            </div>
                        </div>
                    `;
                    });

                    container.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load timeslot statistics:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            // Toggle timeslot detail
            async function toggleTimeslotDetail(hour, headerEl) {
                const detailEl = document.getElementById(`timeslot-detail-${hour}`);
                const arrowEl = headerEl.querySelector('span');

                if (detailEl.style.display === 'none') {
                    detailEl.style.display = 'block';
                    arrowEl.style.transform = 'rotate(180deg)';

                    // ËºâÂÖ•Ë©≤Ê?ÊÆµÁ?Ë≤ºÊ?
                    detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">ËºâÂÖ•‰∏?..</p>';

                    try {
                        const response = await fetch(`${API_BASE}/statistics/posts-by-hour?hour=${hour}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const result = await response.json();
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to load posts');
                        }

                        const posts = result.data.posts || [];

                        if (posts.length === 0) {
                            detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">Ê≠§Ê?ÊÆµÁÑ°Ë≤ºÊ?</p>';
                            return;
                        }

                        let html = '<div style="font-size: 12px;">';
                        posts.forEach(post => {
                            const content = post.content_preview || post.content || '(?°ÂÖßÂÆ?';
                            const truncated = content.length > 40 ? content.substring(0, 40) + '...' : content;
                            const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                            }) : '-';

                            html += `
                            <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #666;">${postedAt}</span>
                                    <span style="color: #667eea;">?? ${(post.views || 0).toLocaleString()} ¬∑ ?§Ô? ${post.likes || 0}</span>
                                </div>
                                <div style="color: #333;">${truncated}</div>
                            </div>
                        `;
                        });
                        html += '</div>';

                        detailEl.innerHTML = html;

                    } catch (error) {
                        console.error('Failed to load posts for hour:', error);
                        detailEl.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 10px 0; font-size: 12px;">ËºâÂÖ•Â§±Ê?</p>';
                    }
                } else {
                    detailEl.style.display = 'none';
                    arrowEl.style.transform = 'rotate(0deg)';
                }
            }

            // Load post details
            async function loadStatsDetails() {
                const container = document.getElementById('statsDetailsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/posts?limit=20&sortBy=posted_at&sortOrder=DESC`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load posts');
                    }

                    const posts = result.data.posts;

                    if (posts.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">Â∞öÁÑ°Ë≤ºÊ??∏Ê?</p>';
                        return;
                    }

                    let html = `
                    <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left;">?ºÂ??ÇÈ?</th>
                                <th style="padding: 10px; text-align: left;">?ßÂÆπ</th>
                                <th style="padding: 10px; text-align: center;">??Ô∏?ËßÄ??/th>
                                <th style="padding: 10px; text-align: center;">?§Ô? ?âË?</th>
                                <th style="padding: 10px; text-align: center;">?? ?ÉË???/th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                    posts.forEach(post => {
                        const content = post.content_preview || post.content || '(?°ÂÖßÂÆ?';
                        const truncated = content.length > 25 ? content.substring(0, 25) + '...' : content;
                        const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '-';
                        html += `
                        <tr style="border-top: 1px solid #e5e7eb;">
                            <td style="padding: 10px; white-space: nowrap;">${postedAt}</td>
                            <td style="padding: 10px;">${truncated}</td>
                            <td style="padding: 10px; text-align: center;">${(post.views || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: center;">${post.likes || 0}</td>
                            <td style="padding: 10px; text-align: center;">${(parseFloat(post.engagement_rate) || 0).toFixed(1)}%</td>
                        </tr>
                    `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load post details:', error);
                    container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            // Export statistics to CSV
            function exportStatsToCSV() {
                // TODO: Implement CSV export functionality
                showAlert('dashboardAlert', 'CSV ?ØÂá∫?üËÉΩ?ãÁôº‰∏?, 'info');
            }

            // Trigger manual sync
            async function triggerManualSync() {
                try {
                    showAlert('dashboardAlert', '?ãÂ??åÊ≠• Insights ?∏Ê?...', 'info');

                    const response = await fetch(`${API_BASE}/statistics/sync`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: 7, limit: 50 })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Sync failed');
                    }

                    showAlert('dashboardAlert', '??' + result.message, 'success');

                    // Á≠âÂ? 2 ÁßíÂ??çÊñ∞ËºâÂÖ•Áµ±Ë??∏Ê?
                    setTimeout(() => {
                        loadStatsSummary();
                        if (currentStatsTab === 'templates') loadStatsTemplates();
                        if (currentStatsTab === 'timeslots') loadStatsTimeslots();
                        if (currentStatsTab === 'details') loadStatsDetails();
                    }, 2000);

                } catch (error) {
                    console.error('Failed to trigger sync:', error);
                    showAlert('dashboardAlert', '?åÊ≠•Â§±Ê?', 'danger');
                }
            }

            // Initialize statistics on page load
            document.addEventListener('DOMContentLoaded', function () {
                if (token) {
                    // ?™Â??åÊ≠•‰∫íÂ??∏Ê?ÔºàÈ?ÈªòÂü∑Ë°åÔ?
                    autoSyncOnLoad();
                    // ËºâÂÖ•Áµ±Ë??òË?
                    loadStatsSummary();
                }
            });

            // ========================================
            // ?≤È???éß?üËÉΩ
            // ========================================

            let currentMonitorTab = 'mentions';

            function switchMonitorTab(tabName) {
                currentMonitorTab = tabName;

                // ?¥Êñ∞ sub-tab ?âÈ?Ê®??
                document.querySelectorAll('#monitorTab .tabs .tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                // ?±Ë??Ä??sub-tab ?ßÂÆπ
                document.getElementById('monitorMentionsTab').style.display = 'none';
                document.getElementById('monitorBrandsTab').style.display = 'none';
                document.getElementById('monitorSourcesTab').style.display = 'none';
                document.getElementById('monitorStatsTab').style.display = 'none';

                // È°ØÁ§∫?∏‰∏≠??sub-tab
                if (tabName === 'mentions') {
                    document.getElementById('monitorMentionsTab').style.display = 'block';
                    loadMentions();
                } else if (tabName === 'brands') {
                    document.getElementById('monitorBrandsTab').style.display = 'block';
                    loadBrands();
                } else if (tabName === 'sources') {
                    document.getElementById('monitorSourcesTab').style.display = 'block';
                    loadSources();
                } else if (tabName === 'stats') {
                    document.getElementById('monitorStatsTab').style.display = 'block';
                    loadMonitorStats();
                }
            }

            async function loadMentions() {
                const container = document.getElementById('mentionsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const brandId = document.getElementById('mentionBrandFilter').value;
                    const isRead = document.getElementById('mentionReadFilter').value;

                    let url = `${API_BASE}/monitor/mentions?limit=20`;
                    if (brandId) url += `&brand_id=${brandId}`;
                    if (isRead) url += `&is_read=${isRead}`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const mentions = result.data.mentions || [];

                    if (mentions.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">Â∞öÁÑ°?êÂ?Ë®òÈ?</p>';
                        return;
                    }

                    container.innerHTML = mentions.map(m => `
                    <div style="background: ${m.is_read ? '#f8f9fa' : 'white'}; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${m.brand_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <span style="background: ${m.brand_color || '#667eea'}; color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px;">${m.brand_name}</span>
                                <span style="margin-left: 10px; color: #666; font-size: 12px;">${m.source_name}</span>
                            </div>
                            <span style="color: #999; font-size: 12px;">${new Date(m.discovered_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <h4 style="margin-bottom: 10px; color: #333;">${m.title || '(?°Ê?È°?'}</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">${m.content_preview || ''}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #888;">
                                ?? ${JSON.parse(m.matched_keywords || '[]').join(', ')}
                                ${m.likes_count ? ` ¬∑ ?§Ô? ${m.likes_count}` : ''}
                                ${m.comments_count ? ` ¬∑ ?í¨ ${m.comments_count}` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <a href="${m.url}" target="_blank" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;">?? ?•Á??üÊ?</a>
                                ${!m.is_read ? `<button class="btn btn-primary" style="padding: 5px 15px; font-size: 12px;" onclick="markMentionRead('${m.id}', this)">??Ê®ôÁÇ∫Â∑≤Ë?</button>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                } catch (error) {
                    console.error('Failed to load mentions:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            async function markMentionRead(mentionId, btn) {
                try {
                    await fetch(`${API_BASE}/monitor/mentions/${mentionId}/read`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    btn.closest('div[style*="background"]').style.background = '#f8f9fa';
                    btn.remove();
                } catch (error) {
                    console.error('Failed to mark as read:', error);
                }
            }

            async function loadBrands() {
                const container = document.getElementById('brandsList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const brands = result.data || [];

                    // ?¥Êñ∞?ÅÁ??éÊøæ‰∏ãÊ??∏ÂñÆ
                    const brandFilter = document.getElementById('mentionBrandFilter');
                    brandFilter.innerHTML = '<option value="">?®ÈÉ®?ÅÁ?</option>' +
                        brands.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                    if (brands.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">Â∞öÊú™Ë®≠Â???éß?ÅÁ?</p>
                            <button class="btn btn-primary" onclick="showAddBrandModal()">???∞Â?Á¨¨‰??ãÂ???/button>
                        </div>
                    `;
                        return;
                    }

                    container.innerHTML = brands.map(b => `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${b.display_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 5px;">${b.name} 
                                    <span style="background: ${b.brand_type === 'own' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">
                                        ${b.brand_type === 'own' ? '?™Ê??ÅÁ?' : 'Á´∂Â?'}
                                    </span>
                                </h4>
                                <p style="color: #666; font-size: 13px;">?úÈçµÂ≠óÔ?${JSON.parse(b.keywords || '[]').join(', ')}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <span style="color: ${b.is_active ? '#10b981' : '#dc3545'}; font-size: 12px;">${b.is_active ? '???üÁî®‰∏? : '???úÁî®'}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteBrand('${b.id}')">?™Èô§</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                } catch (error) {
                    console.error('Failed to load brands:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            async function loadSources() {
                const container = document.getElementById('sourcesList');
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/sources`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const sources = result.data || [];

                    if (sources.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">Â∞öÊú™Ë®≠Â???éß‰æÜÊ?</p>
                            <button class="btn btn-primary" onclick="showSourceTemplates()">?? ÂæûÈ?Ë®≠‰?Ê∫êÊñ∞Â¢?/button>
                        </div>
                    `;
                        return;
                    }

                    const healthColors = {
                        healthy: '#10b981',
                        warning: '#f59e0b',
                        error: '#dc3545',
                        unknown: '#999'
                    };

                    container.innerHTML = sources.map(s => `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 5px;">
                                    <span style="color: ${healthColors[s.health_status] || '#999'};">??/span>
                                    ${s.name}
                                    <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">${s.platform}</span>
                                </h4>
                                <p style="color: #666; font-size: 12px; word-break: break-all;">${s.url}</p>
                                <p style="color: #888; font-size: 11px; margin-top: 5px;">
                                    Ê™¢Êü•?ìÈ?: ${s.check_interval_hours} Â∞èÊ? ¬∑ 
                                    ‰∏äÊ¨°Ê™¢Êü•: ${s.last_checked_at ? new Date(s.last_checked_at).toLocaleString('zh-TW') : 'ÂæûÊú™'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="triggerCrawl('${s.id}')">?? Á´ãÂç≥?¨Â?</button>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSource('${s.id}')">?™Èô§</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                } catch (error) {
                    console.error('Failed to load sources:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">ËºâÂÖ•Â§±Ê?</p>';
                }
            }

            async function loadMonitorStats() {
                try {
                    const days = document.getElementById('monitorStatsDays').value;
                    const response = await fetch(`${API_BASE}/monitor/stats/overview?days=${days}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const data = result.data;

                    document.getElementById('monitorTotalMentions').textContent = data.total_mentions || 0;
                    document.getElementById('monitorUnreadCount').textContent = data.unread_count || 0;
                    document.getElementById('monitorBrandCount').textContent = (data.brand_stats || []).length;

                    // ?ÅÁ?Áµ±Ë?
                    const brandStats = document.getElementById('monitorBrandStats');
                    if (data.brand_stats && data.brand_stats.length > 0) {
                        brandStats.innerHTML = data.brand_stats.map(b => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span style="color: ${b.display_color || '#667eea'};">??${b.name}</span>
                            <span><strong>${b.mention_count}</strong> Ê¨?/span>
                        </div>
                    `).join('');
                    } else {
                        brandStats.innerHTML = '<p style="color: #999; text-align: center;">?°Ë???/p>';
                    }

                    // ‰æÜÊ?Áµ±Ë?
                    const sourceStats = document.getElementById('monitorSourceStats');
                    if (data.source_stats && data.source_stats.length > 0) {
                        sourceStats.innerHTML = data.source_stats.map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span>${s.name} <small style="color: #888;">(${s.platform})</small></span>
                            <span><strong>${s.mention_count}</strong> Ê¨?/span>
                        </div>
                    `).join('');
                    } else {
                        sourceStats.innerHTML = '<p style="color: #999; text-align: center;">?°Ë???/p>';
                    }

                } catch (error) {
                    console.error('Failed to load monitor stats:', error);
                }
            }

            function showAddBrandModal() {
                const keywords = prompt('Ë´ãËº∏?•Â??åÂ?Á®±Â???éß?úÈçµÂ≠óÔ??®ÈÄóË??ÜÈ?ÔºâÔ?\n‰æãÂ?ÔºöÊ??ÑÂ??? ?ÅÁ?A, ?¢Â???);
                if (!keywords) return;

                const name = prompt('Ë´ãËº∏?•Â??åÈ°ØÁ§∫Â?Á®±Ô?');
                if (!name) return;

                const brandType = confirm('?ôÊòØ?®Á??™Ê??ÅÁ??éÔ?\n\n?â„ÄåÁ¢∫ÂÆö„Ä? ?™Ê??ÅÁ?\n?â„ÄåÂ?Ê∂à„Ä? Á´∂Â?') ? 'own' : 'competitor';

                createBrand(name, keywords.split(',').map(k => k.trim()), brandType);
            }

            async function createBrand(name, keywords, brandType) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/brands`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, keywords, brand_type: brandType })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', '?ÅÁ?Â∑≤Âª∫Á´?, 'success');
                    loadBrands();
                } catch (error) {
                    showAlert('dashboardAlert', 'Âª∫Á?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            async function deleteBrand(brandId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§Ê≠§?ÅÁ??éÔ??Ä?âÁõ∏?úÁ??êÂ?Ë®òÈ?‰πüÊ?Ë¢´Âà™?§„Ä?)) return;

                try {
                    await fetch(`${API_BASE}/monitor/brands/${brandId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadBrands();
                } catch (error) {
                    showAlert('dashboardAlert', '?™Èô§Â§±Ê?', 'danger');
                }
            }

            async function showSourceTemplates() {
                try {
                    const response = await fetch(`${API_BASE}/monitor/templates`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    const templates = result.data || [];

                    const options = templates.map((t, i) => `${i + 1}. ${t.name}`).join('\n');
                    const choice = prompt(`Ë´ãÈÅ∏?áË??∞Â??Ñ‰?Ê∫êÔ?Ëº∏ÂÖ•Á∑®Ë?ÔºâÔ?\n\n${options}`);

                    if (!choice) return;

                    const idx = parseInt(choice) - 1;
                    if (idx >= 0 && idx < templates.length) {
                        const template = templates[idx];
                        await createSource(template.name, template.url, template.platform);
                    }
                } catch (error) {
                    showAlert('dashboardAlert', 'ËºâÂÖ•?êË®≠‰æÜÊ?Â§±Ê?', 'danger');
                }
            }

            function showAddSourceModal() {
                const name = prompt('Ë´ãËº∏?•‰?Ê∫êÂ?Á®±Ô?');
                if (!name) return;

                const url = prompt('Ë´ãËº∏?•Áõ£?ßÁ∂≤?ÄÔº?);
                if (!url) return;

                const platform = prompt('Ë´ãÈÅ∏?áÂπ≥?∞È??ãÔ?\ndcard, ptt, facebook, instagram, youtube, threads, news, blog, forum, other') || 'other';

                createSource(name, url, platform);
            }

            async function createSource(name, url, platform) {
                try {
                    // ?ñÂ??Ä?âÂ???ID
                    const brandsRes = await fetch(`${API_BASE}/monitor/brands`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const brandsResult = await brandsRes.json();
                    const brandIds = (brandsResult.data || []).map(b => b.id);

                    const response = await fetch(`${API_BASE}/monitor/sources`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, url, platform, brand_ids: brandIds })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', '‰æÜÊ?Â∑≤Âª∫Á´?, 'success');
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', 'Âª∫Á?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            async function deleteSource(sourceId) {
                if (!confirm('Á¢∫Â?Ë¶ÅÂà™?§Ê≠§‰æÜÊ??éÔ?')) return;

                try {
                    await fetch(`${API_BASE}/monitor/sources/${sourceId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', '?™Èô§Â§±Ê?', 'danger');
                }
            }

            async function triggerCrawl(sourceId) {
                try {
                    showAlert('dashboardAlert', 'Ê≠?ú®?¨Â?...', 'info');

                    const response = await fetch(`${API_BASE}/monitor/crawl`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ source_id: sourceId })
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    showAlert('dashboardAlert', result.message, 'success');
                    loadSources();
                } catch (error) {
                    showAlert('dashboardAlert', '?¨Â?Â§±Ê?: ' + error.message, 'danger');
                }
            }

            // ?∂Â??õÂà∞ monitor tab ?ÇË??•Ë???
            const originalSwitchTab = switchTab;
            switchTab = function (tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'monitor') {
                    loadMentions();
                    loadBrands();
                }
            };

            // ========================================
            // Google Trends ?üËÉΩ
            // ========================================

            async function fetchGoogleTrends() {
                const container = document.getElementById('googleTrendsChart');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">Ê≠?ú®?ìÂ?Ë∂®Âã¢?∏Ê?...</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/trends/fetch`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #d4edda; border-radius: 8px; color: #155724;">
                        ??${result.message}<br>
                        <small>?∏Ê??ÉÂú®?åÊôØ?ÅÁ??ìÂ?ÔºåË?Á®çÂ??çÊñ∞?¥Á??•Á?ÁµêÊ?</small>
                    </div>
                `;

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 40px 0;">?ìÂ?Â§±Ê?: ${error.message}</p>`;
                }
            }

            async function loadDailyTrends() {
                const container = document.getElementById('dailyTrendsList');
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">ËºâÂÖ•‰∏?..</p>';

                try {
                    const response = await fetch(`${API_BASE}/monitor/trends/daily`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const trends = result.data || [];

                    if (trends.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">?´ÁÑ°?±È??úÂ??∏Ê?</p>';
                        return;
                    }

                    container.innerHTML = trends.slice(0, 10).map((t, idx) => `
                    <div style="display: flex; align-items: center; padding: 12px; background: ${idx < 3 ? '#fef3c7' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${idx < 3 ? '#f59e0b' : '#d1d5db'};">
                        <span style="font-weight: bold; font-size: 18px; width: 30px; color: ${idx < 3 ? '#d97706' : '#6b7280'};">${idx + 1}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${t.title || '?™Áü•'}</div>
                            <div style="font-size: 12px; color: #666;">${t.traffic || ''}</div>
                        </div>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 11px;" 
                            onclick="searchRelatedQueries('${(t.title || '').replace(/'/g, "\\'")}')">?? ?∏È?Ë©?/button>
                    </div>
                `).join('');

                } catch (error) {
                    container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px 0;">ËºâÂÖ•Â§±Ê?: ${error.message}</p>`;
                }
            }

            async function searchRelatedQueries(keyword) {
                try {
                    const response = await fetch(`${API_BASE}/monitor/trends/related/${encodeURIComponent(keyword)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    const data = result.data;
                    const topList = (data.top || []).slice(0, 5).map(q => q.query).join(', ') || '??;
                    const risingList = (data.rising || []).slice(0, 5).map(q => `${q.query} (${q.value})`).join(', ') || '??;

                    alert(`?? ??{keyword}?çÁõ∏?úÊ?Â∞ã\n\n?? ?±È??úÂ?Ë©ûÔ?\n${topList}\n\n?? Âø´ÈÄü‰??áÔ?\n${risingList}`);
                } catch (error) {
                    alert('?•Ë©¢Â§±Ê?: ' + error.message);
                }
            }

        </script>
</body>

</html>