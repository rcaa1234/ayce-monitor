<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ± - ç®¡ç†ä»‹é¢</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .user-info {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .user-info p {
            color: #333;
            margin: 5px 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-section,
        .dashboard {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sub-tabs styling */
        .sub-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 15px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .sub-tab-content {
            display: none;
            padding-top: 20px;
        }

        .sub-tab-content.active {
            display: block;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .post-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .post-card .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-DRAFT {
            background: #e9ecef;
            color: #495057;
        }

        .status-GENERATING {
            background: #fff3cd;
            color: #856404;
        }

        .status-PENDING_REVIEW {
            background: #cce5ff;
            color: #004085;
        }

        .status-APPROVED {
            background: #d4edda;
            color: #155724;
        }

        .status-POSTED {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-FAILED {
            background: #f8d7da;
            color: #721c24;
        }

        .post-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            min-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Smart Scheduling Styles */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .template-card {
            background: white;
            border: none;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .template-card:hover {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .template-card.disabled {
            opacity: 0.6;
            background: #f9fafb;
            border-left-color: #9ca3af;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .template-description {
            font-size: 14px;
            color: #6b7280;
        }

        .template-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-enabled {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .template-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .template-prompt {
            font-size: 13px;
            color: #4b5563;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            max-height: 70px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-actions .btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 13px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        .config-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
        }

        .config-card h3 {
            color: #111827;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h4 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 13px;
            opacity: 0.9;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .schedule-date {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .schedule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-generated {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-posted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-cancelled {
            background: #f3f4f6;
            color: #374151;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .schedule-info-item {
            color: #6b7280;
        }

        .schedule-info-item strong {
            color: #111827;
        }

        .schedule-reason {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
            border-left: 3px solid #667eea;
        }

        .schedule-reason strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .preview-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
            color: #1f2937;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }

        .preview-loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .preview-loading .spinner-small {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-test {
            background: #10b981;
            color: white;
        }

        .btn-test:hover {
            background: #059669;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸš€ Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ±</h1>
            <p>AI é©…å‹•çš„å…§å®¹ç”Ÿæˆèˆ‡ç™¼å¸ƒç®¡ç†å¹³å°</p>
            <div id="userInfo" class="user-info">
                <p><strong>ä½¿ç”¨è€…:</strong> <span id="userName"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>è§’è‰²:</strong> <span id="userRoles"></span></p>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px;">ç™»å…¥ç³»çµ±</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">ç™»å…¥</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">ğŸ“Š ç¸½è¦½</button>
                <button class="tab" onclick="switchTab('scheduling')">ğŸ“… ç™¼æ–‡æ’ç¨‹</button>
                <button class="tab" onclick="switchTab('templates')">âœ¨ æç¤ºè©è¨­å®š</button>
                <button class="tab" onclick="switchTab('accounts')">âš™ï¸ å¸³è™Ÿç®¡ç†</button>
                <button class="tab" onclick="switchTab('monitor')">ğŸ”” è²é‡ç›£æ§</button>
            </div>

            <!-- Alert Area -->
            <div id="dashboardAlert"></div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">è™•ç†ä¸­...</p>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <!-- System Overview -->
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px;">ç³»çµ±ç¸½è¦½</h2>
                    <div class="stats" id="stats" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card">
                            <h3 id="totalPosts">0</h3>
                            <p>ç¸½è²¼æ–‡æ•¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingPosts">0</h3>
                            <p>å¾…å¯©æ ¸</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="scheduledPosts">0</h3>
                            <p>æ’ç¨‹ä¸­</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="postedPosts">0</h3>
                            <p>å·²ç™¼å¸ƒ</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div>
                    <h2 style="margin-bottom: 20px;">è²¼æ–‡çµ±è¨ˆ</h2>

                    <!-- Statistics Sub-tabs -->
                    <div
                        style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; overflow-x: auto;">
                        <button class="stats-sub-tab active" onclick="switchStatsTab('summary')"
                            style="padding: 8px 12px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“Š æ‘˜è¦
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('templates')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“Š é¡å‹
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('timeslots')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            â° æ™‚æ®µ
                        </button>
                        <button class="stats-sub-tab" onclick="switchStatsTab('details')"
                            style="padding: 8px 12px; border: none; background: #e5e7eb; color: #333; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                            ğŸ“‹ æ˜ç´°
                        </button>
                    </div>

                    <!-- Statistics Summary Sub-tab -->
                    <div id="statsSummaryTab" class="stats-sub-content active"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; margin: 0;">æ•´é«”è¡¨ç¾</h3>
                            <select id="summaryDaysSelect" onchange="loadStatsSummary()"
                                style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                <option value="7">æœ€è¿‘ 7 å¤©</option>
                                <option value="30">æœ€è¿‘ 30 å¤©</option>
                                <option value="90">æœ€è¿‘ 90 å¤©</option>
                                <option value="180">æœ€è¿‘ 180 å¤©</option>
                                <option value="360">æœ€è¿‘ 360 å¤©</option>
                                <option value="all">å…¨éƒ¨æ­·å²</option>
                            </select>
                        </div>

                        <!-- Key Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalPosts">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å·²ç™¼å¸ƒè²¼æ–‡</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalViews">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½è§€çœ‹æ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="statsTotalLikes">-
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ç¸½æŒ‰è®šæ•¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;"
                                    id="statsAvgEngagement">-</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">å¹³å‡åƒèˆ‡ç‡</div>
                            </div>
                        </div>

                        <!-- Trend Chart -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0;">è¶¨å‹¢åœ–</h4>
                                <select id="trendDaysSelect" onchange="loadStatsSummary()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                                    <option value="30">æœ€è¿‘ 30 å¤©</option>
                                    <option value="90">æœ€è¿‘ 90 å¤©</option>
                                    <option value="180">æœ€è¿‘ 180 å¤©</option>
                                    <option value="360">æœ€è¿‘ 360 å¤©</option>
                                </select>
                            </div>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="stats7DayChart"></canvas>
                            </div>
                            <div
                                style="margin-top: 10px; padding: 8px 12px; background: #f0f4f8; border-radius: 6px; font-size: 11px; color: #64748b;">
                                <strong>ğŸ“Š åƒèˆ‡ç‡è¨ˆç®—å…¬å¼ï¼š</strong>
                                <span
                                    style="font-family: monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">
                                    åƒèˆ‡ç‡ = (æŒ‰è®š + å›è¦† + è½‰ç™¼) Ã· è§€çœ‹æ•¸ Ã— 100%
                                </span>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div id="statsSyncStatus"
                            style="background: white; padding: 15px; border-radius: 8px; font-size: 13px; color: #666;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div>ä¸Šæ¬¡åŒæ­¥: <span id="statsLastSync">-</span></div>
                                    <div style="margin-top: 5px;">å·²åŒæ­¥è²¼æ–‡: <span id="statsSyncedCount">-</span> ç¯‡</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="syncThreadsPosts(true)"
                                        style="padding: 5px 12px; background: #059669; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ“¦ å®Œæ•´åŒ¯å…¥å…¨éƒ¨
                                    </button>
                                    <button onclick="reclassifyTemplates()"
                                        style="padding: 5px 12px; background: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ·ï¸ é‡æ–°åˆ†é¡æ¨¡æ¿
                                    </button>
                                    <button onclick="triggerManualSync()"
                                        style="padding: 5px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ”„ åŒæ­¥äº’å‹•æ•¸æ“š
                                    </button>
                                    <button onclick="clearPendingPosts()"
                                        style="padding: 5px 12px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ æ¸…é™¤å¾…å¯©æ ¸
                                    </button>
                                    <button onclick="clearScheduledPosts()"
                                        style="padding: 5px 12px; background: #f97316; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹ä¸­
                                    </button>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #999;">
                                ğŸ’¡ æç¤ºï¼šã€Œå®Œæ•´åŒ¯å…¥å…¨éƒ¨ã€åŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ï¼Œã€Œé‡æ–°åˆ†é¡æ¨¡æ¿ã€æœƒç‚ºæ²’æœ‰æ¨¡æ¿çš„è²¼æ–‡è‡ªå‹•åˆ†é¡ã€‚
                            </p>
                        </div>

                        <!-- Data Analytics Section -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="font-size: 15px; color: #333; margin: 0;">ğŸ“ˆ æ•¸æ“šåˆ†æ</h4>
                                <select id="analyticsDaysSelect" onchange="onAnalyticsDaysChange()"
                                    style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                                    <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
                                    <option value="90">æœ€è¿‘ 90 å¤©</option>
                                    <option value="180">æœ€è¿‘ 180 å¤©</option>
                                    <option value="365">æœ€è¿‘ 365 å¤©</option>
                                    <option value="9999">å…¨éƒ¨æ­·å²</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <!-- Best Posting Hours -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ• æœ€ä½³ç™¼æ–‡æ™‚æ®µ</h4>
                                <div id="bestHoursChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...
                                    </p>
                                </div>
                            </div>

                            <!-- Best Posting Days -->
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ“… æ˜ŸæœŸè¡¨ç¾åˆ†æ</h4>
                                <div id="bestDaysChart" style="min-height: 150px;">
                                    <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performing Posts -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ† Top 5 è¡¨ç¾æœ€ä½³è²¼æ–‡</h4>
                            <div id="topPostsList" style="max-height: 300px; overflow-y: auto;">
                                <p style="color: #999; text-align: center; padding: 40px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- Content Length Analysis -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 12px 0;">ğŸ“ å…§å®¹é•·åº¦åˆ†æ</h4>
                            <div id="contentLengthAnalysis" style="min-height: 80px;">
                                <p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Templates Sub-tab (æ”¹ç‚ºç™¼æ–‡é¡å‹åˆ†æ) -->
                    <div id="statsTemplatesTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“Š ç™¼æ–‡é¡å‹åˆ†æ</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                            çµ±è¨ˆä¸‰ç¨®ç™¼æ–‡é¡å‹çš„è¡¨ç¾ï¼šAI ç™¼æ–‡ã€é AI (å«åœ–)ã€é AI (ç„¡åœ–)
                        </p>
                        <div id="statsTemplatesList" style="display: grid; gap: 15px;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- Statistics Timeslots Sub-tab -->
                    <div id="statsTimeslotsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">æ™‚æ®µåˆ†æ</h3>
                        <div id="statsTimeslotsList" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- Statistics Details Sub-tab -->
                    <div id="statsDetailsTab" class="stats-sub-content"
                        style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">è²¼æ–‡æ˜ç´°</h3>

                        <!-- Export Button -->
                        <div style="margin-bottom: 15px; text-align: right;">
                            <button onclick="exportStatsToCSV()"
                                style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                ğŸ“¥ åŒ¯å‡º CSV
                            </button>
                        </div>

                        <div id="statsDetailsList" style="max-height: 450px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts Tab -->
            <div id="postsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">è²¼æ–‡ç®¡ç†</h2>

                <div class="filter-bar">
                    <select id="filterStatus" onchange="loadPosts()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="DRAFT">è‰ç¨¿</option>
                        <option value="GENERATING">ç”¢ç”Ÿä¸­</option>
                        <option value="PENDING_REVIEW">å¾…å¯©æ ¸</option>
                        <option value="APPROVED">å·²æ ¸å‡†</option>
                        <option value="POSTED">å·²ç™¼å¸ƒ</option>
                        <option value="FAILED">å¤±æ•—</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="loadPosts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">â˜‘ï¸ å…¨é¸/åé¸</button>
                    <button class="btn btn-danger btn-small" onclick="batchDeletePosts()" id="batchDeleteBtn"
                        style="display: none;">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤</button>
                </div>

                <div id="postsGrid" class="posts-grid"></div>
            </div>

            <!-- Scheduling Tab (with sub-tabs) -->
            <div id="schedulingTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ç™¼æ–‡æ’ç¨‹ç®¡ç†</h2>

                <!-- Internal Sub-tabs -->
                <div class="sub-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    <button class="sub-tab active" onclick="switchSchedulingSubTab('ai')">ğŸ¤– AIç™¼æ–‡</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('manual')">ğŸ“ é ç´„ç™¼æ–‡</button>
                    <button class="sub-tab" onclick="switchSchedulingSubTab('pending')">ğŸ“‹ æ’ç¨‹ä¸­è²¼æ–‡</button>
                </div>

                <!-- AI Post Sub-tab -->
                <div id="aiSubTab" class="sub-tab-content active">
                    <h3 style="margin-bottom: 20px;">AI è‡ªå‹•ç™¼æ–‡è¨­å®š</h3>
                    <p style="color: #666; margin-bottom: 20px;">è¨­å®š AI è‡ªå‹•ç”Ÿæˆè²¼æ–‡çš„ç™¼æ–‡é »ç‡å’Œæ™‚æ®µï¼Œç³»çµ±æœƒæ ¹æ“šã€Œæç¤ºè©è¨­å®šã€çš„å…§å®¹è‡ªå‹•ç”¢ç”Ÿä¸¦ç™¼å¸ƒè²¼æ–‡</p>

                    <div class="config-grid">
                        <!-- Left: Configuration Form -->
                        <div class="config-card">
                            <h3>ç™¼æ–‡è¨­å®š</h3>
                            <form id="ai-config-form" onsubmit="saveAIConfig(event)">
                                <div class="form-group">
                                    <label for="posts-per-day">æ¯æ—¥ç™¼æ–‡æ¬¡æ•¸</label>
                                    <input type="number" id="posts-per-day" min="1" max="10" value="1" required>
                                    <small>ç³»çµ±æ¯å¤©è‡ªå‹•å»ºç«‹å¹¾å€‹ç™¼æ–‡æ’ç¨‹</small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-start">ç™¼æ–‡æ™‚æ®µ - é–‹å§‹æ™‚é–“</label>
                                    <input type="time" id="time-range-start" value="09:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI æœƒåœ¨æ­¤æ™‚é–“ä¹‹å¾Œéš¨æ©Ÿé¸æ“‡ç™¼æ–‡æ™‚é–“</small>
                                </div>

                                <div class="form-group">
                                    <label for="time-range-end">ç™¼æ–‡æ™‚æ®µ - çµæŸæ™‚é–“</label>
                                    <input type="time" id="time-range-end" value="21:00" class="form-control"
                                        style="padding: 12px; font-size: 16px;">
                                    <small>AI æœƒåœ¨æ­¤æ™‚é–“ä¹‹å‰é¸æ“‡ç™¼æ–‡æ™‚é–“</small>
                                </div>

                                <div class="form-group">
                                    <label>å•Ÿç”¨æ˜ŸæœŸ</label>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="1" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±ä¸€</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="2" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±äºŒ</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="3" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±ä¸‰</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="4" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±å››</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="5" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±äº”</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="6" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±å…­</span>
                                        </label>
                                        <label
                                            style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                                            <input type="checkbox" class="active-day" value="7" checked
                                                style="margin-bottom: 4px;">
                                            <span style="font-size: 12px;">é€±æ—¥</span>
                                        </label>
                                    </div>
                                    <small style="margin-top: 8px; display: block;">é¸æ“‡ AI è‡ªå‹•ç™¼æ–‡çš„æ˜ŸæœŸï¼Œæœªé¸æ“‡çš„æ˜ŸæœŸä¸æœƒè‡ªå‹•ç™¼æ–‡</small>
                                </div>

                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="auto-schedule-enabled" checked>
                                        <label for="auto-schedule-enabled" style="margin-bottom: 0;">å•Ÿç”¨è‡ªå‹•ç™¼æ–‡</label>
                                    </div>
                                    <small>æ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ä¸¦ç™¼é€åˆ° LINE å¯©æ ¸</small>
                                </div>

                                <button type="submit" class="btn btn-success" style="width: 100%;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                            </form>
                        </div>

                        <!-- Right: Quick Actions & Info -->
                        <div class="config-card">
                            <h3>å¿«é€Ÿæ“ä½œ</h3>

                            <div
                                style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                                <h4 style="margin: 0 0 10px 0; color: #0369a1; font-size: 14px;">ğŸ“Œ ä½¿ç”¨èªªæ˜</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #334155; line-height: 1.8;">
                                    <li><strong>å•Ÿç”¨è‡ªå‹•ç™¼æ–‡</strong>ï¼šæ¯å¤© 00:00 è‡ªå‹•å»ºç«‹ç™¼æ–‡æ’ç¨‹</li>
                                    <li><strong>æç¤ºè©è¨­å®š</strong>ï¼šåœ¨ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆå…§å®¹çš„æŒ‡ä»¤</li>
                                    <li><strong>LINE å¯©æ ¸</strong>ï¼šç™¼æ–‡å‰æœƒç™¼é€åˆ° LINE é€šçŸ¥å¯©æ ¸</li>
                                    <li><strong>åŸ·è¡Œæµç¨‹</strong>ï¼šå»ºç«‹æ’ç¨‹ â†’ ç”Ÿæˆæ–‡ç«  â†’ LINE é€šçŸ¥ â†’ å¯©æ ¸ â†’ ç™¼å¸ƒ</li>
                                </ul>
                            </div>

                            <div
                                style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">âš ï¸ é‡è¦æé†’</h4>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f; line-height: 1.8;">
                                    <li>è«‹å…ˆåœ¨ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆæç¤ºè©</li>
                                    <li>è«‹åœ¨ã€Œå¸³è™Ÿç®¡ç†ã€é é¢è¨­å®š Threads å¸³è™Ÿå’Œ LINE User ID</li>
                                    <li>æ¯å¤©æ¯å€‹æ™‚æ®µåªæœƒå»ºç«‹ä¸€å€‹ç™¼æ–‡æ’ç¨‹</li>
                                </ul>
                            </div>

                            <button class="btn btn-primary" onclick="triggerDailySchedule()"
                                style="width: 100%; padding: 15px; font-size: 16px;">
                                ğŸ§ª æ¸¬è©¦ç”Ÿæˆç™¼æ–‡
                            </button>
                            <small
                                style="display: block; margin-top: 10px; color: #6b7280; text-align: center; font-size: 12px;">
                                ç³»çµ±æœƒç«‹å³ç”Ÿæˆä¸€ç¯‡æ–‡ç« ä¸¦ç™¼é€ LINE é€šçŸ¥å¯©æ ¸
                            </small>
                        </div>
                    </div>

                    <div id="ai-message"></div>

                    <div style="margin-top: 40px;">
                        <div class="action-bar">
                            <h3>ç™¼æ–‡æ’ç¨‹æ­·å²</h3>
                            <button class="btn btn-secondary" onclick="loadScheduleHistory()">é‡æ–°æ•´ç†</button>
                        </div>
                        <div id="schedule-history-container"></div>
                    </div>
                </div>
            </div>


            <!-- Threads Accounts Tab -->
            <div id="accountsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">å¸³è™Ÿç®¡ç†</h2>

                <!-- AI ç™¼æ–‡è¨­å®š -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- ç™¼å¸ƒå¸³è™Ÿè¨­å®š -->
                    <div
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">ğŸ“± AI ç™¼æ–‡å¸³è™Ÿ</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">é¸æ“‡ Threads å¸³è™Ÿ</label>
                            <select id="ucbThreadsAccount" class="form-control"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                                <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                            </select>
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                AI è‡ªå‹•ç™¼æ–‡å°‡ä½¿ç”¨æ­¤å¸³è™Ÿç™¼å¸ƒè²¼æ–‡
                            </p>
                        </div>
                        <button class="btn" onclick="saveAccountSettings()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); width: 100%;">
                            ğŸ’¾ å„²å­˜å¸³è™Ÿè¨­å®š
                        </button>
                    </div>

                    <!-- LINE é€šçŸ¥è¨­å®š -->
                    <div
                        style="background: linear-gradient(135deg, #00c300 0%, #00a000 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; color: white;">ğŸ’¬ LINE é€šçŸ¥è¨­å®š</h3>
                        <div class="form-group">
                            <label style="color: rgba(255,255,255,0.9);">LINE User ID</label>
                            <input type="text" id="ucbLineNotifyUserId" class="form-control"
                                placeholder="è«‹è¼¸å…¥ LINE User ID"
                                style="padding: 12px; font-size: 16px; background: rgba(255,255,255,0.95); border: none;">
                            <p style="font-size: 11px; opacity: 0.8; margin-top: 8px;">
                                ç™¼é€ã€Œ/myidã€çµ¦ LINE Bot å³å¯å–å¾— ID
                            </p>
                        </div>
                        <button class="btn" onclick="testUCBLineNotification()"
                            style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">ğŸ“¨
                            æ¸¬è©¦é€šçŸ¥</button>
                    </div>
                </div>

                <!-- æ–°å¢ Threads å¸³è™Ÿ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ”— æ–°å¢ Threads å¸³è™Ÿ</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ç”±æ–¼ Threads API éœ€è¦ OAuth æˆæ¬Š,è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œ:
                    </p>
                    <ol style="color: #666; line-height: 1.8;">
                        <li>å‰å¾€ <a href="https://developers.facebook.com/" target="_blank" style="color: #667eea;">Meta
                                Developers</a> å»ºç«‹æ‡‰ç”¨ç¨‹å¼</li>
                        <li>å–å¾— Client ID å’Œ Client Secret</li>
                        <li>è¨­å®š Redirect URI ç‚º: <code
                                style="background: #e1e8ed; padding: 2px 6px; border-radius: 3px;">http://localhost:3000/api/threads/oauth/callback</code>
                        </li>
                        <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æˆæ¬Š</li>
                    </ol>
                    <button class="btn" onclick="startThreadsOAuth()" style="margin-top: 15px;">ğŸ”— é–‹å§‹ Threads
                        æˆæ¬Š</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">å·²é€£çµçš„ Threads å¸³è™Ÿ</h3>
                    <button class="btn" onclick="runDiagnostics()" style="background: #17a2b8; padding: 8px 16px;">ğŸ”
                        è¨ºæ–·ç™¼å¸ƒå•é¡Œ</button>
                </div>
                <div id="threadsAccountsList" class="posts-grid"></div>

                <!-- Diagnostics Result -->
                <div id="diagnosticsResult"
                    style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-bottom: 15px;">ğŸ” è¨ºæ–·çµæœ</h3>
                    <div id="diagnosticsContent"></div>
                </div>
            </div>

            <!-- Manual Post Sub-tab -->
            <div id="manualSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">é ç´„ç™¼æ–‡</h3>
                <p style="color: #666; margin-bottom: 20px;">ç›´æ¥è¼¸å…¥è²¼æ–‡å…§å®¹ï¼Œå¯ç«‹å³ç™¼å¸ƒæˆ–é ç´„æ™‚é–“ç™¼å¸ƒ</p>

                <form onsubmit="createManualPost(event)">
                    <div class="form-group">
                        <label>è²¼æ–‡å…§å®¹ *</label>
                        <textarea id="manualPostContent" rows="10" placeholder="ç›´æ¥è¼¸å…¥æ‚¨æƒ³ç™¼å¸ƒçš„å…§å®¹..." required
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; line-height: 1.6;"></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            å­—æ•¸: <span id="contentCharCount">0</span> / 500 (Threads å»ºè­°)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒåˆ° Threads å¸³è™Ÿ *</label>
                        <select id="manualPostThreadsAccount" required style="padding: 12px; font-size: 15px;">
                            <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒæ™‚é–“</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="now" checked
                                    onchange="toggleScheduleInput()">
                                ç«‹å³ç™¼å¸ƒ
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="scheduled"
                                    onchange="toggleScheduleInput()">
                                æ’ç¨‹ç™¼å¸ƒ
                            </label>
                        </div>
                        <input type="datetime-local" id="manualPostSchedule"
                            style="padding: 12px; font-size: 15px; display: none;">
                    </div>

                    <button type="submit" class="btn" style="padding: 15px 30px; font-size: 16px;">ç™¼å¸ƒè²¼æ–‡</button>
                </form>
            </div>

            <!-- Pending Posts Sub-tab -->
            <div id="pendingSubTab" class="sub-tab-content">
                <h3 style="margin-bottom: 20px;">æ’ç¨‹ä¸­è²¼æ–‡</h3>
                <p style="color: #666; margin-bottom: 20px;">é¡¯ç¤ºå·²å¯©æ ¸é€šéã€ç­‰å¾…ç™¼å¸ƒçš„è²¼æ–‡</p>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="loadPendingPosts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>

                <div id="pendingPostsList" style="display: grid; gap: 15px;">
                    <p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Prompt Settings Tab (åŸæ¨¡æ¿è¨­å®š) -->
        <div id="templatesTab" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <!-- å·¦å´ï¼šæç¤ºè©ç·¨è¼¯å€ -->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">âœ¨ æç¤ºè©è¨­å®š</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è¨­å®š AI è‡ªå‹•ç™¼æ–‡ä½¿ç”¨çš„ä¸»æç¤ºè©</p>

                    <form id="ai-prompt-form" onsubmit="saveAIPrompt(event)">
                        <div class="form-group">
                            <label for="ai-engine">AI å¼•æ“</label>
                            <select id="ai-engine" required style="padding: 12px; font-size: 15px;">
                                <option value="GPT5_2">GPT-5.2 (æ¨è–¦)</option>
                                <option value="GPT5_2_INSTANT">GPT-5.2 Instant (å¿«é€Ÿ)</option>
                                <option value="GPT4O">GPT-4o</option>
                                <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                                <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                                <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                            </select>
                            <small>é¸æ“‡ç”Ÿæˆè²¼æ–‡ä½¿ç”¨çš„ AI å¼•æ“</small>
                        </div>

                        <div class="form-group">
                            <label for="ai-prompt">AI æç¤ºè©</label>
                            <textarea id="ai-prompt" rows="18" required
                                style="width: 100%; padding: 15px; font-size: 14px; line-height: 1.7; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"
                                placeholder="è«‹è¼¸å…¥çµ¦ AI çš„æŒ‡ä»¤..."></textarea>
                            <small>ç³»çµ±æœƒè‡ªå‹•åŠ å…¥ç¶­åº¦è¨­å®šå’ŒæˆåŠŸç¯„ä¾‹</small>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1; padding: 15px;">ğŸ’¾
                                å„²å­˜æç¤ºè©</button>
                            <button type="button" class="btn btn-primary" onclick="testAIPrompt()"
                                style="flex: 1; padding: 15px;">ğŸ§ª æ¸¬è©¦ç”Ÿæˆ</button>
                        </div>
                    </form>

                    <!-- æ¸¬è©¦ç”Ÿæˆçµæœ -->
                    <div id="ai-prompt-test-result"
                        style="display: none; margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #374151;">ğŸ“ ç”Ÿæˆçµæœé è¦½</h4>
                        <div id="ai-prompt-test-content"
                            style="white-space: pre-wrap; line-height: 1.8; font-size: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šç¶­åº¦è¨­å®šé¢æ¿ -->
                <div
                    style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 10px; color: #1f2937;">ğŸ›ï¸ ç¶­åº¦è¨­å®š</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">èª¿æ•´å„ç¶­åº¦çš„é¸é …æ¬Šé‡å’Œç‹€æ…‹</p>

                    <div id="dimensions-container">
                        <!-- MODULE -->
                        <div class="dimension-section" data-dimension="module">
                            <div class="dimension-header" onclick="toggleDimension('module')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ“¦ å…§å®¹æ¨¡çµ„ (MODULE)</span>
                                <span id="module-toggle">â–¼</span>
                            </div>
                            <div id="module-options" class="dimension-options" style="padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- ANGLE -->
                        <div class="dimension-section" data-dimension="angle" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('angle')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ¬ æƒ…å¢ƒåˆ‡è§’ (ANGLE)</span>
                                <span id="angle-toggle">â–¶</span>
                            </div>
                            <div id="angle-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- OUTLET -->
                        <div class="dimension-section" data-dimension="outlet" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('outlet')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ’¡ è™•ç†å‡ºå£ (OUTLET)</span>
                                <span id="outlet-toggle">â–¶</span>
                            </div>
                            <div id="outlet-options" class="dimension-options" style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- TONE_BIAS -->
                        <div class="dimension-section" data-dimension="tone_bias" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('tone_bias')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ—£ï¸ èªæ°£åå£“ (TONE)</span>
                                <span id="tone_bias-toggle">â–¶</span>
                            </div>
                            <div id="tone_bias-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- ENDING_STYLE -->
                        <div class="dimension-section" data-dimension="ending_style" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('ending_style')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ”š æ”¶å°¾æ„åœ– (ENDING)</span>
                                <span id="ending_style-toggle">â–¶</span>
                            </div>
                            <div id="ending_style-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <!-- LENGTH_TARGET -->
                        <div class="dimension-section" data-dimension="length_target" style="margin-top: 15px;">
                            <div class="dimension-header" onclick="toggleDimension('length_target')"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
                                <span style="font-weight: 600;">ğŸ“ å­—æ•¸ç›®æ¨™ (LENGTH)</span>
                                <span id="length_target-toggle">â–¶</span>
                            </div>
                            <div id="length_target-options" class="dimension-options"
                                style="display: none; padding: 0 10px;">
                                <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- çµ±è¨ˆå€å¡Š -->
                    <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px;">ğŸ“Š æœ€è¿‘ 30 å¤©ä½¿ç”¨çµ±è¨ˆ</h4>
                        <div id="dimension-stats" style="font-size: 13px; color: #666;">
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Monitor Tab (è²é‡ç›£æ§) -->
    <div id="monitorTab" class="tab-content">
        <h2 style="margin-bottom: 20px;">ğŸ”” è²é‡ç›£æ§</h2>

        <!-- Monitor Sub-tabs -->
        <div class="tabs" style="margin-bottom: 20px;">
            <button class="tab active" onclick="switchMonitorTab('mentions')">ğŸ“‹ æåŠåˆ—è¡¨</button>
            <button class="tab" onclick="switchMonitorTab('brands')">ğŸ·ï¸ å“ç‰Œç®¡ç†</button>
            <button class="tab" onclick="switchMonitorTab('sources')">ğŸŒ ä¾†æºç®¡ç†</button>
            <button class="tab" onclick="switchMonitorTab('stats')">ğŸ“Š è²é‡çµ±è¨ˆ</button>
        </div>

        <!-- Mentions Sub-tab -->
        <div id="monitorMentionsTab" class="sub-tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="mentionBrandFilter" onchange="loadMentions()"
                        style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">å…¨éƒ¨å“ç‰Œ</option>
                    </select>
                    <select id="mentionReadFilter" onchange="loadMentions()"
                        style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="false">æœªè®€</option>
                        <option value="true">å·²è®€</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="loadMentions()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>

            <div id="mentionsList" style="display: grid; gap: 15px;">
                <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- Brands Sub-tab -->
        <div id="monitorBrandsTab" class="sub-tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>å“ç‰Œ/ç›£æ§ç›®æ¨™</h3>
                <button class="btn btn-primary" onclick="showAddBrandModal()">â• æ–°å¢å“ç‰Œ</button>
            </div>

            <div id="brandsList" style="display: grid; gap: 15px;">
                <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- Sources Sub-tab -->
        <div id="monitorSourcesTab" class="sub-tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ç›£æ§ä¾†æº</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="showSourceTemplates()">ğŸ“‹ é è¨­ä¾†æº</button>
                    <button class="btn btn-primary" onclick="showAddSourceModal()">â• æ–°å¢ä¾†æº</button>
                </div>
            </div>

            <div id="sourcesList" style="display: grid; gap: 15px;">
                <p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- Stats Sub-tab -->
        <div id="monitorStatsTab" class="sub-tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>è²é‡çµ±è¨ˆ</h3>
                <select id="monitorStatsDays" onchange="loadMonitorStats()"
                    style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="7">éå» 7 å¤©</option>
                    <option value="14">éå» 14 å¤©</option>
                    <option value="30" selected>éå» 30 å¤©</option>
                </select>
            </div>

            <div class="stats" id="monitorStatsCards"
                style="grid-template-columns: repeat(3, 1fr); margin-bottom: 30px;">
                <div class="stat-card">
                    <h3 id="monitorTotalMentions">0</h3>
                    <p>ç¸½æåŠæ•¸</p>
                </div>
                <div class="stat-card"
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    <h3 id="monitorUnreadCount" style="color: white;">0</h3>
                    <p style="color: rgba(255,255,255,0.8);">æœªè®€æåŠ</p>
                </div>
                <div class="stat-card"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <h3 id="monitorBrandCount" style="color: white;">0</h3>
                    <p style="color: rgba(255,255,255,0.8);">ç›£æ§å“ç‰Œ</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div
                    style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin-bottom: 15px;">ğŸ“Š å„å“ç‰ŒæåŠæ•¸</h4>
                    <div id="monitorBrandStats"></div>
                </div>
                <div
                    style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin-bottom: 15px;">ğŸŒ å„ä¾†æºæåŠæ•¸</h4>
                    <div id="monitorSourceStats"></div>
                </div>
            </div>

            <!-- Google Trends å€å¡Š -->
            <div
                style="margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0;">ğŸ“ˆ Google æœå°‹è¶¨å‹¢</h4>
                    <button class="btn btn-secondary" onclick="fetchGoogleTrends()"
                        style="padding: 8px 15px; font-size: 12px;">ğŸ”„ æŠ“å–æœ€æ–°è¶¨å‹¢</button>
                </div>
                <div id="googleTrendsChart" style="min-height: 200px;">
                    <p style="color: #999; text-align: center; padding: 40px 0;">é»æ“Šã€ŒæŠ“å–æœ€æ–°è¶¨å‹¢ã€æŒ‰éˆ•é–‹å§‹æ”¶é›†æ•¸æ“š</p>
                </div>
            </div>

            <!-- æ¯æ—¥ç†±é–€æœå°‹ -->
            <div
                style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0;">ğŸ”¥ å°ç£å³æ™‚ç†±é–€æœå°‹</h4>
                    <button class="btn btn-secondary" onclick="loadDailyTrends()"
                        style="padding: 8px 15px; font-size: 12px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
                <div id="dailyTrendsList" style="display: grid; gap: 10px;">
                    <p style="color: #999; text-align: center; padding: 20px 0;">æŒ‰ä¸‹ã€Œé‡æ–°æ•´ç†ã€è¼‰å…¥å³æ™‚ç†±é–€æœå°‹</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è²¼æ–‡è©³æƒ…</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ–°å¢æ¨¡æ¿</h2>
                <button class="close-modal" onclick="closeTemplateModal()">Ã—</button>
            </div>
            <form id="template-form" onsubmit="saveTemplate(event)">
                <div class="form-group">
                    <label for="template-name">æ¨¡æ¿åç¨± *</label>
                    <input type="text" id="template-name" required placeholder="ä¾‹å¦‚ï¼šçŸ¥è­˜åˆ†äº«å‹">
                </div>

                <div class="form-group">
                    <label for="template-description">æ¨¡æ¿æè¿°</label>
                    <input type="text" id="template-description" placeholder="ç°¡çŸ­èªªæ˜é€™å€‹æ¨¡æ¿çš„ç”¨é€”">
                </div>

                <div class="form-group">
                    <label for="template-engine">AI å¼•æ“ *</label>
                    <select id="template-engine" required>
                        <option value="GPT5_2">GPT-5.2 (æ¨è–¦)</option>
                        <option value="GPT5_2_INSTANT">GPT-5.2 Instant (å¿«é€Ÿ)</option>
                        <option value="GPT4O">GPT-4o</option>
                        <option value="GEMINI_3_FLASH">Gemini 3 Flash</option>
                        <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro</option>
                        <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                    </select>
                    <small>æ­¤æ¨¡æ¿ç”Ÿæˆå…§å®¹æ™‚å°‡ä½¿ç”¨çš„ AI å¼•æ“</small>
                </div>

                <div class="form-group">
                    <label for="template-prompt">æç¤ºè©å…§å®¹ *</label>
                    <textarea id="template-prompt" required placeholder="è«‹ç”¢ç”Ÿä¸€ç¯‡ Threads è²¼æ–‡..."></textarea>
                    <small>é€™æ˜¯çµ¦ AI çš„æŒ‡ä»¤ï¼Œè«‹è©³ç´°æè¿°ä½ å¸Œæœ› AI ç”Ÿæˆä»€éº¼æ¨£çš„å…§å®¹</small>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="template-enabled" checked>
                        <label for="template-enabled" style="margin-bottom: 0;">å•Ÿç”¨æ­¤æ¨¡æ¿</label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-test" onclick="testCurrentTemplate()">ğŸ§ª æ¸¬è©¦ç”Ÿæˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ å…§å®¹é è¦½</h2>
                <button class="close-modal" onclick="closePreviewModal()">Ã—</button>
            </div>

            <div id="preview-result"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePreviewModal()">é—œé–‰</button>
                <button class="btn btn-primary" onclick="regeneratePreview()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>âœï¸ ç·¨è¼¯è²¼æ–‡å…§å®¹</h2>
                <button class="close-modal" onclick="closeEditPostModal()">Ã—</button>
            </div>
            <form id="editPostForm" onsubmit="saveEditedPost(event)">
                <input type="hidden" id="editPostId">
                <div class="form-group">
                    <label for="editPostContent">è²¼æ–‡å…§å®¹</label>
                    <textarea id="editPostContent" rows="15" required
                        style="width: 100%; padding: 15px; font-size: 15px; line-height: 1.8; border: 1px solid #ddd; border-radius: 8px; resize: vertical; min-height: 300px;"
                        placeholder="è«‹è¼¸å…¥è²¼æ–‡å…§å®¹..."></textarea>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        å­—æ•¸: <span id="editPostCharCount">0</span> | ç·¨è¼¯å¾Œçš„å…§å®¹æœƒåœ¨æ’ç¨‹æ™‚é–“ç™¼å¸ƒåˆ° Threads
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPostModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let token = localStorage.getItem('token');
        const API_BASE = '/api';

        // Initialize
        if (token) {
            checkAuth();
        }

        // Authentication
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showDashboard(data.user);
                } else {
                    showAlert('loginAlert', data.error || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'é€£ç·šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/posts?limit=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('userInfo').classList.remove('active');
        }

        function showDashboard(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userInfo').classList.add('active');

            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRoles').textContent = user.roles.join(', ');
            }

            loadOverview();
            loadPosts();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');

            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'overview') loadOverview();
            if (tabName === 'posts') loadPosts();
            if (tabName === 'scheduling') {
                loadScheduling();
            }
            if (tabName === 'templates') {
                loadTemplates();
            }
            if (tabName === 'accounts') {
                loadThreadsAccountsList();
                loadThreadsAccountsForDropdowns();
                loadUCBConfig(); // è¼‰å…¥ UCB é…ç½®ä»¥è¨­å®šå¸³è™Ÿå’Œ LINE ID
            }
        }

        // Sub-tab switching for scheduling tab
        function switchSchedulingSubTab(subTabName) {
            // Remove active class from all sub-tabs
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to clicked sub-tab
            event.target.classList.add('active');

            // Show corresponding sub-tab content
            if (subTabName === 'manual') {
                document.getElementById('manualSubTab').classList.add('active');
                loadThreadsAccountsForDropdowns();
            } else if (subTabName === 'ai') {
                document.getElementById('aiSubTab').classList.add('active');
                // è¼‰å…¥ AI ç™¼æ–‡é…ç½®
                loadAIConfig();
                loadScheduleHistory();
            } else if (subTabName === 'pending') {
                document.getElementById('pendingSubTab').classList.add('active');
                loadPendingPosts();
            }
        }

        // Load overview
        async function loadOverview() {
            try {
                // å–å¾—å„ç‹€æ…‹çš„æ•¸é‡ï¼ˆåªå¾ posts è¡¨è¨ˆç®—ï¼Œé¿å…é‡è¤‡ï¼‰
                const [pendingRes, approvedRes, postedRes] = await Promise.all([
                    fetch(`${API_BASE}/posts?status=PENDING_REVIEW`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_BASE}/posts?status=APPROVED`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_BASE}/posts?status=POSTED`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const [pendingData, approvedData, postedData] = await Promise.all([
                    pendingRes.json(),
                    approvedRes.json(),
                    postedRes.json()
                ]);

                const pending = pendingData.total || 0;
                const posted = postedData.total || 0;

                // æ’ç¨‹ä¸­ = APPROVED ç‹€æ…‹çš„è²¼æ–‡ï¼ˆå·²å¯©æ ¸å¾…ç™¼å¸ƒï¼‰
                // ä¸éœ€è¦é¡å¤–è¨ˆç®— schedulesï¼Œå› ç‚º posts.status å·²ç¶“åæ˜ äº†å¯©æ ¸ç‹€æ…‹
                const scheduled = approvedData.total || 0;

                // ç¸½è²¼æ–‡æ•¸ = å¾…å¯©æ ¸ + æ’ç¨‹ä¸­ + å·²ç™¼å¸ƒ
                const total = pending + scheduled + posted;

                document.getElementById('totalPosts').textContent = total;
                document.getElementById('pendingPosts').textContent = pending;
                document.getElementById('scheduledPosts').textContent = scheduled;
                document.getElementById('postedPosts').textContent = posted;
            } catch (error) {
                console.error('Failed to load overview:', error);
                showAlert('dashboardAlert', 'è¼‰å…¥ç¸½è¦½å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Load posts
        async function loadPosts() {
            const status = document.getElementById('filterStatus')?.value || '';
            const url = status ? `${API_BASE}/posts?status=${status}` : `${API_BASE}/posts`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                const posts = data.data || data.posts || [];
                renderPosts(posts, 'postsGrid');
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Render posts
        function renderPosts(posts, containerId) {
            const container = document.getElementById(containerId);

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px;">æš«ç„¡è²¼æ–‡</p>
                        <p style="margin-top: 10px;">å»ºç«‹ç¬¬ä¸€ç¯‡è²¼æ–‡é–‹å§‹ä½¿ç”¨!</p>
                    </div>
                `;
                // Hide batch delete button when no posts
                const batchBtn = document.getElementById('batchDeleteBtn');
                if (batchBtn) batchBtn.style.display = 'none';
                return;
            }

            // Show checkboxes only in postsGrid (not in recentPosts)
            const showCheckbox = containerId === 'postsGrid';

            container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${showCheckbox ? `<input type="checkbox" class="post-checkbox" data-post-id="${post.id}" onchange="updateBatchDeleteButton()" style="width: 18px; height: 18px; cursor: pointer;">` : ''}
                            <h3>æ–‡ç«  #${post.id.substring(0, 8)}</h3>
                        </div>
                        <span class="status-badge status-${post.status}">${getStatusText(post.status)}</span>
                    </div>

                    <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.created_at).toLocaleString('zh-TW')}</p>
                    ${post.posted_at ? `<p><strong>ç™¼å¸ƒæ™‚é–“:</strong> ${new Date(post.posted_at).toLocaleString('zh-TW')}</p>` : ''}
                    ${post.post_url ? `<p><strong>è²¼æ–‡é€£çµ:</strong> <a href="${post.post_url}" target="_blank">æŸ¥çœ‹</a></p>` : ''}

                    <div class="post-actions">
                        <button class="btn btn-small btn-secondary" onclick="viewPost('${post.id}')">æŸ¥çœ‹è©³æƒ…</button>
                        ${post.status === 'DRAFT' ? `<button class="btn btn-small btn-success" onclick="generateContent('${post.id}')">ç”Ÿæˆå…§å®¹</button>` : ''}
                        ${post.status === 'APPROVED' ? `<button class="btn btn-small btn-success" onclick="publishPost('${post.id}')">ç™¼å¸ƒ</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-success" onclick="approvePost('${post.id}')">æ ¸å‡†</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-warning" onclick="regenerateContent('${post.id}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePost('${post.id}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // Create post
        async function createPost(event) {
            event.preventDefault();
            showLoading(true);

            const topic = document.getElementById('postTopic').value;
            const keywords = document.getElementById('postKeywords').value.split(',').map(k => k.trim());
            const targetTone = document.getElementById('postTone').value;
            const targetLength = parseInt(document.getElementById('postLength').value);
            const scheduledFor = document.getElementById('postSchedule').value;
            const autoGenerate = document.getElementById('autoGenerate').checked;

            const postData = {
                topic,
                keywords,
                targetTone,
                targetLength,
                ...(scheduledFor && { scheduledFor: new Date(scheduledFor).toISOString() })
            };

            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å»ºç«‹æˆåŠŸ!', 'success');
                    event.target.reset();

                    if (autoGenerate) {
                        await generateContent(data.id);
                    }

                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', data.error || 'å»ºç«‹å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Generate content
        async function generateContent(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'å…§å®¹ç”Ÿæˆä»»å‹™å·²åŠ å…¥ä½‡åˆ—,è«‹ç¨å¾ŒæŸ¥çœ‹', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç”Ÿæˆå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // View post detail
        async function viewPost(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const post = await response.json();

                if (response.ok) {
                    const modalBody = document.getElementById('modalBody');
                    modalBody.innerHTML = `
                        <h3>${post.topic}</h3>
                        <p><span class="status-badge status-${post.status}">${getStatusText(post.status)}</span></p>

                        <div style="margin: 20px 0;">
                            <p><strong>é—œéµå­—:</strong> ${post.keywords.join(', ')}</p>
                            <p><strong>èªæ°£:</strong> ${post.targetTone}</p>
                            <p><strong>ç›®æ¨™é•·åº¦:</strong> ${post.targetLength} å­—</p>
                            <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>
                            ${post.scheduledFor ? `<p><strong>æ’ç¨‹æ™‚é–“:</strong> ${new Date(post.scheduledFor).toLocaleString('zh-TW')}</p>` : ''}
                        </div>

                        ${post.latestRevision ? `
                            <h4>æœ€æ–°å…§å®¹ç‰ˆæœ¬</h4>
                            <div class="content-preview">${post.latestRevision.content}</div>
                            <p><strong>å­—æ•¸:</strong> ${post.latestRevision.wordCount}</p>
                            <p><strong>AI å¼•æ“:</strong> ${post.latestRevision.aiEngine}</p>
                            <p><strong>ç”Ÿæˆæ™‚é–“:</strong> ${new Date(post.latestRevision.createdAt).toLocaleString('zh-TW')}</p>
                        ` : '<p style="color: #666;">å°šæœªç”Ÿæˆå…§å®¹</p>'}
                    `;

                    document.getElementById('postModal').classList.add('active');
                } else {
                    showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Approve post
        async function approvePost(postId) {
            if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤è²¼æ–‡å—?')) return;

            showLoading(true);

            try {
                // Get post detail first to get revision ID
                const postResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const post = await postResponse.json();

                if (!post.latestRevision) {
                    throw new Error('æ‰¾ä¸åˆ°å…§å®¹ç‰ˆæœ¬');
                }

                const response = await fetch(`${API_BASE}/review/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        postId: postId,
                        revisionId: post.latestRevision.id,
                        action: 'approve'
                    })
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²æ ¸å‡†', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'æ ¸å‡†å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Regenerate content
        async function regenerateContent(postId) {
            if (!confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆå…§å®¹å—?')) return;
            await generateContent(postId);
        }

        // Publish post
        async function publishPost(postId) {
            if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒæ­¤è²¼æ–‡åˆ° Threads å—?')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/publish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'ç™¼å¸ƒä»»å‹™å·²åŠ å…¥ä½‡åˆ—', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Delete post
        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.post-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            updateBatchDeleteButton();
        }

        // Update batch delete button visibility
        function updateBatchDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
            const batchBtn = document.getElementById('batchDeleteBtn');

            if (batchBtn) {
                if (checkedBoxes.length > 0) {
                    batchBtn.style.display = 'inline-block';
                    batchBtn.textContent = `ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤ (${checkedBoxes.length})`;
                } else {
                    batchBtn.style.display = 'none';
                }
            }
        }

        // Batch delete posts
        async function batchDeletePosts() {
            const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
            const postIds = Array.from(checkedBoxes).map(cb => cb.dataset.postId);

            if (postIds.length === 0) {
                showAlert('dashboardAlert', 'è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è²¼æ–‡', 'error');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${postIds.length} ç¯‡è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            showLoading(true);
            let successCount = 0;
            let failCount = 0;

            try {
                // Delete posts one by one
                for (const postId of postIds) {
                    try {
                        const response = await fetch(`${API_BASE}/posts/${postId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }

                // Show result
                if (successCount > 0 && failCount === 0) {
                    showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡è²¼æ–‡`, 'success');
                } else if (successCount > 0 && failCount > 0) {
                    showAlert('dashboardAlert', `æˆåŠŸåˆªé™¤ ${successCount} ç¯‡,å¤±æ•— ${failCount} ç¯‡`, 'error');
                } else {
                    showAlert('dashboardAlert', `åˆªé™¤å¤±æ•—`, 'error');
                }

                // Reload posts
                loadPosts();
                loadOverview();
            } catch (error) {
                showAlert('dashboardAlert', 'æ‰¹æ¬¡åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Utilities
        function getStatusText(status) {
            const statusMap = {
                'DRAFT': 'è‰ç¨¿',
                'GENERATING': 'ç”¢ç”Ÿä¸­',
                'PENDING_REVIEW': 'å¾…å¯©æ ¸',
                'APPROVED': 'å·²æ ¸å‡†',
                'PUBLISHING': 'ç™¼å¸ƒä¸­',
                'POSTED': 'å·²ç™¼å¸ƒ',
                'FAILED': 'å¤±æ•—',
                'ACTION_REQUIRED': 'éœ€è¦è™•ç†',
                'SKIPPED': 'å·²è·³é'
            };
            return statusMap[status] || status;
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function closeModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        // Threads Accounts Management
        async function loadThreadsAccounts() {
            // Load accounts for dropdown in create form
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const accounts = await response.json();
                    const select = document.getElementById('postThreadsAccount');
                    select.innerHTML = '<option value="">ç¨å¾Œé¸æ“‡</option>';

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = `@${acc.username}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
        }

        async function loadThreadsAccountsList() {
            const container = document.getElementById('threadsAccountsList');

            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const accounts = data.accounts || [];

                    if (accounts.length === 0) {
                        container.innerHTML = '<div class="empty-state"><p>å°šæœªé€£çµä»»ä½• Threads å¸³è™Ÿ</p></div>';
                        return;
                    }

                    container.innerHTML = accounts.map(acc => `
                        <div class="post-card" style="${acc.is_default ? 'border-left: 4px solid #28a745;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3>@${acc.username}</h3>
                                ${acc.is_default ? '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">é è¨­å¸³è™Ÿ</span>' : ''}
                            </div>
                            <p><strong>å¸³è™Ÿ ID:</strong> ${acc.account_id || '(æœªè¨­å®š)'}</p>
                            <p><strong>ç‹€æ…‹:</strong> ${acc.status === 'ACTIVE' ? '<span style="color: #28a745;">âœ“ å•Ÿç”¨ä¸­</span>' : '<span style="color: #dc3545;">å·²é–å®š</span>'}</p>
                            <p><strong>é€£çµæ™‚é–“:</strong> ${new Date(acc.created_at).toLocaleString('zh-TW')}</p>
                            <div class="post-actions">
                                ${!acc.is_default ? `<button class="btn btn-small" style="background: #28a745;" onclick="setDefaultAccount('${acc.id}')">è¨­ç‚ºé è¨­</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="removeThreadsAccount('${acc.id}')">è§£é™¤é€£çµ</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—: ' + error.message + '</p></div>';
            }
        }

        async function startThreadsOAuth() {
            try {
                // Get OAuth URL from backend with authentication
                const response = await fetch(`${API_BASE}/threads/oauth/authorize`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authUrl) {
                        // Redirect to Threads authorization page
                        window.location.href = data.authUrl;
                    }
                } else {
                    const error = await response.json();
                    showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function setDefaultAccount(accountId) {
            try {
                const response = await fetch(`${API_BASE}/threads/accounts/${accountId}/set-default`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'âœ… å·²è¨­ç‚ºé è¨­å¸³è™Ÿ', 'success');
                    loadThreadsAccountsList();
                    // Reload UCB config to refresh account selector
                    if (typeof loadUcbConfig === 'function') {
                        loadUcbConfig();
                    }
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'è¨­å®šå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function removeThreadsAccount(accountId) {
            if (!confirm('ç¢ºå®šè¦è§£é™¤é€£çµæ­¤ Threads å¸³è™Ÿå—?')) return;

            try {
                const response = await fetch(`${API_BASE}/threads/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'Threads å¸³è™Ÿå·²è§£é™¤é€£çµ', 'success');
                    loadThreadsAccountsList();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'è§£é™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è§£é™¤å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            const contentDiv = document.getElementById('diagnosticsContent');

            // Show loading
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<p style="color: #666;">ğŸ”„ è¨ºæ–·ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/diagnose`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('è¨ºæ–·è«‹æ±‚å¤±æ•—');
                }

                const data = await response.json();

                // Build diagnostic HTML
                let html = '';

                // Threads Accounts
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ“± Threads å¸³è™Ÿç‹€æ…‹</h4>';
                if (data.checks.threadsAccounts.total === 0) {
                    html += '<p style="color: #dc3545;">âŒ æ‰¾ä¸åˆ°ä»»ä½• Threads å¸³è™Ÿ</p>';
                } else {
                    data.checks.threadsAccounts.accounts.forEach((acc, i) => {
                        html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${acc.issues.length > 0 ? '#ffc107' : '#28a745'}">`;
                        html += `<p style="margin: 5px 0;"><strong>å¸³è™Ÿ ${i + 1}:</strong> ${acc.username}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Account ID: ${acc.accountId || 'âŒ æœªè¨­å®š'}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç‹€æ…‹: ${acc.status}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">é è¨­å¸³è™Ÿ: ${acc.isDefault ? 'âœ“ æ˜¯' : 'å¦'}</p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">Token ç‹€æ…‹: ${acc.tokenStatus || 'ç„¡'}</p>`;
                        if (acc.issues.length > 0) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                            acc.issues.forEach(issue => {
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += '</div>';

                // Recent Posts
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ“ æœ€è¿‘çš„æ–‡ç« </h4>';
                if (data.checks.recentPosts.total === 0) {
                    html += '<p style="color: #666;">ç›®å‰æ²’æœ‰æ–‡ç« </p>';
                } else {
                    data.checks.recentPosts.posts.slice(0, 3).forEach((post, i) => {
                        const statusColor = {
                            'POSTED': '#28a745',
                            'APPROVED': '#ffc107',
                            'FAILED': '#dc3545',
                            'PENDING_REVIEW': '#17a2b8'
                        }[post.status] || '#6c757d';

                        html += `<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor}">`;
                        html += `<p style="margin: 5px 0;"><strong>æ–‡ç«  ${i + 1}:</strong> <span style="color: ${statusColor}; font-weight: bold;">${post.status}</span></p>`;
                        html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">å»ºç«‹: ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>`;
                        if (post.approvedAt) {
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">æ ¸å‡†: ${new Date(post.approvedAt).toLocaleString('zh-TW')}</p>`;
                        }
                        if (post.postedAt) {
                            html += `<p style="margin: 5px 0; font-size: 13px; color: #666;">ç™¼å¸ƒ: ${new Date(post.postedAt).toLocaleString('zh-TW')}</p>`;
                        }
                        if (post.error) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px;">`;
                            html += `<p style="margin: 3px 0; font-size: 13px; color: #721c24;">éŒ¯èª¤: ${post.error.message || post.error.code}</p>`;
                            html += `</div>`;
                        }
                        if (post.issues.length > 0) {
                            html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                            post.issues.forEach(issue => {
                                html += `<p style="margin: 3px 0; font-size: 13px; color: #856404;">${issue}</p>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += '</div>';

                // Analysis & Recommendations
                html += '<div style="background: white; padding: 15px; border-radius: 8px;">';
                html += '<h4 style="margin-bottom: 10px;">ğŸ’¡ è¨ºæ–·å»ºè­°</h4>';
                if (data.analysis.recommendations.length === 0) {
                    html += '<p style="color: #28a745;">âœ… æ‰€æœ‰è¨­å®šçœ‹èµ·ä¾†æ­£å¸¸</p>';
                } else {
                    html += '<ul style="margin: 0; padding-left: 20px;">';
                    data.analysis.recommendations.forEach(rec => {
                        html += `<li style="margin: 8px 0; color: #856404;">${rec}</li>`;
                    });
                    html += '</ul>';
                }
                html += '</div>';

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<p style="color: #dc3545;">âŒ è¨ºæ–·å¤±æ•—: ${error.message}</p>`;
            }
        }

        // Settings Management
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥è¨­å®šå¤±æ•—');

                const data = await response.json();
                const settings = data.settings;

                // AI Engine
                if (settings.ai_engine) {
                    const aiEngineEl = document.getElementById('aiEngine');
                    if (aiEngineEl) aiEngineEl.value = settings.ai_engine.value;
                }

                // Custom Prompt
                if (settings.custom_prompt) {
                    const customPromptEl = document.getElementById('customPrompt');
                    if (customPromptEl) customPromptEl.value = settings.custom_prompt.value;
                }

                // Schedule Config
                if (settings.schedule_config) {
                    const scheduleConfig = settings.schedule_config.value;
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                    days.forEach(day => {
                        const config = scheduleConfig[day];
                        if (config) {
                            const checkboxEl = document.getElementById(`schedule_${day}`);
                            const timeEl = document.getElementById(`time_${day}`);
                            if (checkboxEl) checkboxEl.checked = config.enabled;
                            if (timeEl) timeEl.value = config.time;
                        }
                    });
                }

                // Auto Post Threads Account - Store value to apply after dropdown is populated
                if (settings.auto_post_threads_account) {
                    const autoPostEl = document.getElementById('autoPostThreadsAccount');
                    if (autoPostEl && settings.auto_post_threads_account.value) {
                        // Store the saved value temporarily to apply after options are loaded
                        autoPostEl.dataset.savedValue = settings.auto_post_threads_account.value;
                    }
                }

                // LINE Notify User ID
                if (settings.line_notify_user_id) {
                    const lineUserIdEl = document.getElementById('lineNotifyUserId');
                    if (lineUserIdEl) lineUserIdEl.value = settings.line_notify_user_id.value;
                }

            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function saveAllSettings() {
            showLoading(true);

            try {
                // Collect schedule config
                const scheduleConfig = {
                    monday: {
                        enabled: document.getElementById('schedule_monday').checked,
                        time: document.getElementById('time_monday').value
                    },
                    tuesday: {
                        enabled: document.getElementById('schedule_tuesday').checked,
                        time: document.getElementById('time_tuesday').value
                    },
                    wednesday: {
                        enabled: document.getElementById('schedule_wednesday').checked,
                        time: document.getElementById('time_wednesday').value
                    },
                    thursday: {
                        enabled: document.getElementById('schedule_thursday').checked,
                        time: document.getElementById('time_thursday').value
                    },
                    friday: {
                        enabled: document.getElementById('schedule_friday').checked,
                        time: document.getElementById('time_friday').value
                    },
                    saturday: {
                        enabled: document.getElementById('schedule_saturday').checked,
                        time: document.getElementById('time_saturday').value
                    },
                    sunday: {
                        enabled: document.getElementById('schedule_sunday').checked,
                        time: document.getElementById('time_sunday').value
                    }
                };

                const settings = {
                    ai_engine: {
                        value: document.getElementById('aiEngine').value,
                        type: 'STRING'
                    },
                    custom_prompt: {
                        value: document.getElementById('customPrompt').value,
                        type: 'STRING'
                    },
                    schedule_config: {
                        value: scheduleConfig,
                        type: 'JSON'
                    },
                    auto_post_threads_account: {
                        value: document.getElementById('autoPostThreadsAccount').value,
                        type: 'STRING'
                    },
                    line_notify_user_id: {
                        value: document.getElementById('lineNotifyUserId').value,
                        type: 'STRING'
                    }
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ settings })
                });

                if (!response.ok) throw new Error('å„²å­˜è¨­å®šå¤±æ•—');

                showAlert('dashboardAlert', 'âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testLineNotification() {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/settings/test-line`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æ¸¬è©¦é€šçŸ¥å¤±æ•—');
                }

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€åˆ° LINEï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE è¨Šæ¯ã€‚', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function runTestGeneration() {
            showLoading(true);
            document.getElementById('testResults').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/settings/test-generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let errorMessage = 'æ¸¬è©¦ç”Ÿæˆå¤±æ•—';
                    try {
                        const error = await response.json();
                        errorMessage = error.error || error.message || errorMessage;
                        console.error('API Error:', error);
                    } catch (e) {
                        const text = await response.text();
                        console.error('Response text:', text);
                        errorMessage = text || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Test generation response:', data);

                // Display success message with content preview
                const resultHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #1DB446;">
                        <h4 style="margin: 0 0 15px 0; color: #1DB446;">âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆï¼</h4>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“Š ç”Ÿæˆè³‡è¨Šï¼š</strong></p>
                            <p style="margin: 5px 0;">ğŸ¤– å¼•æ“ï¼š${data.engine}</p>
                            <p style="margin: 5px 0;">ğŸ“ˆ ç›¸ä¼¼åº¦ï¼š${(data.similarity * 100).toFixed(1)}%</p>
                            <p style="margin: 5px 0; color: ${data.similarity > 0.86 ? '#ff0000' : '#4CAF50'};">
                                ${data.similarity > 0.86 ? 'âš ï¸ ç›¸ä¼¼åº¦è¼ƒé«˜ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆ' : 'âœ… ç›¸ä¼¼åº¦æ­£å¸¸'}
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“ æ–‡ç« å…§å®¹é è¦½ï¼š</strong></p>
                            <p style="white-space: pre-wrap; margin: 0; line-height: 1.6; color: #333;">
                                ${data.content.substring(0, 200)}${data.content.length > 200 ? '...' : ''}
                            </p>
                        </div>

                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #2e7d32;">ğŸ“± ä¸‹ä¸€æ­¥ï¼š</p>
                            <p style="margin: 10px 0 0 0; line-height: 1.8; color: #333;">
                                æ¸¬è©¦æ–‡ç« å·²ç™¼é€åˆ°æ‚¨çš„ LINEï¼<br>
                                è«‹åˆ° LINE æŸ¥çœ‹å®Œæ•´å…§å®¹ä¸¦é€²è¡Œå¯©æ ¸ï¼š<br>
                                â€¢ âœ… ç¢ºèªç™¼æ–‡ â†’ ç™¼å¸ƒåˆ° Threads<br>
                                â€¢ ğŸ”„ é‡æ–°ç”Ÿæˆ â†’ ç”¢ç”Ÿæ–°æ–‡ç« <br>
                                â€¢ âœï¸ ä¿®æ”¹å…§å®¹ â†’ ç·¨è¼¯å¾Œç™¼å¸ƒ
                            </p>
                        </div>
                    </div>
                `;

                document.getElementById('testResultsContent').innerHTML = resultHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆä¸¦ç™¼é€åˆ° LINEï¼è«‹åˆ° LINE æŸ¥çœ‹ã€‚', 'success');
            } catch (error) {
                const errorHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 10px 0; color: #f44336;">âŒ æ¸¬è©¦å¤±æ•—</h4>
                        <p style="margin: 0; color: #666;">${error.message}</p>
                        ${error.message.includes('LINE User ID') ? `
                            <p style="margin: 15px 0 0 0; padding: 10px; background: #fff3e0; border-radius: 4px; color: #ff6600;">
                                ğŸ’¡ æç¤ºï¼šè«‹å…ˆè¨­å®š LINE User ID<br>
                                1. åœ¨ LINE ä¸­å‚³é€ã€Œ/myidã€çµ¦æ©Ÿå™¨äºº<br>
                                2. è¤‡è£½æ”¶åˆ°çš„ User ID<br>
                                3. è²¼åˆ°ä¸Šæ–¹ã€ŒLINE é€šçŸ¥è¨­å®šã€ä¸¦å„²å­˜
                            </p>
                        ` : ''}
                    </div>
                `;
                document.getElementById('testResultsContent').innerHTML = errorHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Character counter for manual post content
        const manualContentTextarea = document.getElementById('manualPostContent');
        if (manualContentTextarea) {
            manualContentTextarea.addEventListener('input', function () {
                const count = this.value.length;
                document.getElementById('contentCharCount').textContent = count;
            });
        }

        // Toggle schedule input visibility
        function toggleScheduleInput() {
            const scheduleInput = document.getElementById('manualPostSchedule');
            const isScheduled = document.querySelector('input[name="publishTime"]:checked')?.value === 'scheduled';
            if (scheduleInput) {
                scheduleInput.style.display = isScheduled ? 'block' : 'none';
                if (!isScheduled) {
                    scheduleInput.value = '';
                }
            }
        }

        // Load Threads accounts into dropdowns
        async function loadThreadsAccountsForDropdowns() {
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¸³è™Ÿå¤±æ•—');

                const data = await response.json();
                const accounts = data.accounts || [];

                // Populate manual post dropdown
                const manualSelect = document.getElementById('manualPostThreadsAccount');
                if (manualSelect) {
                    manualSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }

                // Populate auto post dropdown
                const autoSelect = document.getElementById('autoPostThreadsAccount');
                if (autoSelect) {
                    autoSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');

                    // Auto-select previously saved account
                    const savedAccountId = autoSelect.dataset.savedValue;
                    if (savedAccountId) {
                        autoSelect.value = savedAccountId;
                        delete autoSelect.dataset.savedValue; // Clear after applying
                    }
                }

                // Populate UCB Threads account dropdown
                const ucbSelect = document.getElementById('ucbThreadsAccount');
                if (ucbSelect) {
                    ucbSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸³è™Ÿåˆ—è¡¨å¤±æ•—:', error);
            }
        }

        // Test UCB LINE notification
        async function testUCBLineNotification() {
            const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

            if (!lineUserId) {
                alert('è«‹å…ˆè¼¸å…¥ LINE User ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/line/test-notification`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lineUserId })
                });

                if (!response.ok) throw new Error('ç™¼é€å¤±æ•—');

                alert('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE');
            } catch (error) {
                alert('âŒ æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        // Create manual post (direct publishing without AI)
        async function createManualPost(event) {
            event.preventDefault();
            showLoading(true);

            const content = document.getElementById('manualPostContent').value.trim();
            const accountId = document.getElementById('manualPostThreadsAccount').value;
            const publishTime = document.querySelector('input[name="publishTime"]:checked')?.value;
            const scheduledFor = publishTime === 'scheduled'
                ? document.getElementById('manualPostSchedule').value
                : null;

            // Validation
            if (!content) {
                showAlert('dashboardAlert', 'è«‹è¼¸å…¥è²¼æ–‡å…§å®¹', 'error');
                showLoading(false);
                return;
            }

            if (content.length > 500) {
                showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½è¶…é 500 å­—', 'error');
                showLoading(false);
                return;
            }

            if (!accountId) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡ Threads å¸³è™Ÿ', 'error');
                showLoading(false);
                return;
            }

            if (publishTime === 'scheduled' && !scheduledFor) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡æ’ç¨‹æ™‚é–“', 'error');
                showLoading(false);
                return;
            }

            try {
                // Create post with manual content
                const postResponse = await fetch(`${API_BASE}/posts/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content,
                        accountId,
                        scheduledFor: scheduledFor ? new Date(scheduledFor).toISOString() : null
                    })
                });

                const postData = await postResponse.json();

                if (postResponse.ok) {
                    showAlert('dashboardAlert', publishTime === 'now' ? 'âœ… è²¼æ–‡å·²åŠ å…¥ç™¼å¸ƒä½‡åˆ—ï¼' : 'âœ… è²¼æ–‡å·²æ’ç¨‹æˆåŠŸï¼', 'success');
                    document.getElementById('manualPostContent').value = '';
                    document.getElementById('contentCharCount').textContent = '0';
                    document.getElementById('manualPostThreadsAccount').value = '';
                    document.querySelector('input[name="publishTime"][value="now"]').checked = true;
                    toggleScheduleInput();
                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', postData.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== SMART SCHEDULING FUNCTIONS ====================

        let smartSchedulingTemplates = [];
        let currentEditingTemplateId = null;
        let currentTestPrompt = '';
        let currentTestEngine = 'GPT5_2';

        // Load scheduling tab (triggers default sub-tab)
        function loadScheduling() {
            // Load the UCB smart scheduling sub-tab by default
            switchSchedulingSubTab('ucb');
        }

        // Load templates tab
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                smartSchedulingTemplates = data.templates || [];
                renderTemplates();
            } catch (error) {
                document.getElementById('templates-container').innerHTML =
                    `<div class="error-message">è¼‰å…¥æ¨¡æ¿å¤±æ•—: ${error.message}</div>`;
            }
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');

            if (smartSchedulingTemplates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h3>é‚„æ²’æœ‰ä»»ä½•æ¨¡æ¿</h3>
                        <p>é»æ“Šã€Œæ–°å¢æ¨¡æ¿ã€é–‹å§‹å»ºç«‹ä½ çš„ç¬¬ä¸€å€‹å…§å®¹æ¨¡æ¿</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="templates-grid">
                    ${smartSchedulingTemplates.map(template => {
                const avgRate = parseFloat(template.avg_engagement_rate) || 0;
                const engineName = getEngineName(template.preferred_engine || 'GPT5_2');
                return `
                        <div class="template-card ${template.enabled ? '' : 'disabled'}">
                            <div class="template-header">
                                <div>
                                    <div class="template-name">${escapeHtml(template.name)}</div>
                                    ${template.description ? `<div class="template-description">${escapeHtml(template.description)}</div>` : ''}
                                    <div style="margin-top: 5px; font-size: 12px; color: #667eea;">
                                        <strong>ğŸ¤– AI å¼•æ“ï¼š</strong>${engineName}
                                    </div>
                                </div>
                                <span class="template-status ${template.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${template.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
                                </span>
                            </div>

                            <div class="template-stats">
                                <div class="stat">
                                    <div class="stat-label">ä½¿ç”¨æ¬¡æ•¸</div>
                                    <div class="stat-value">${template.total_uses || 0}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-label">å¹³å‡äº’å‹•ç‡</div>
                                    <div class="stat-value highlight">${avgRate.toFixed(2)}%</div>
                                </div>
                            </div>

                            <div class="template-prompt">${escapeHtml(template.prompt)}</div>

                            <div class="template-actions">
                                <button class="btn btn-test" onclick="testSmartTemplate('${template.id}')">ğŸ§ª æ¸¬è©¦</button>
                                <button class="btn btn-secondary" onclick="editSmartTemplate('${template.id}')">ç·¨è¼¯</button>
                                <button class="btn btn-danger" onclick="deleteSmartTemplate('${template.id}', '${escapeHtml(template.name)}')">åˆªé™¤</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function openCreateModal() {
            currentEditingTemplateId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢æ¨¡æ¿';
            document.getElementById('template-form').reset();
            document.getElementById('template-enabled').checked = true;
            document.getElementById('template-engine').value = 'GPT5_2';
            document.getElementById('templateModal').classList.add('active');
        }

        function editSmartTemplate(id) {
            const template = smartSchedulingTemplates.find(t => t.id === id);
            if (!template) return;

            currentEditingTemplateId = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯æ¨¡æ¿';
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-description').value = template.description || '';
            document.getElementById('template-engine').value = template.preferred_engine || 'GPT5_2';
            document.getElementById('template-prompt').value = template.prompt;
            document.getElementById('template-enabled').checked = template.enabled;
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            currentEditingTemplateId = null;
        }

        async function saveTemplate(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('template-name').value,
                description: document.getElementById('template-description').value,
                preferred_engine: document.getElementById('template-engine').value,
                prompt: document.getElementById('template-prompt').value,
                enabled: document.getElementById('template-enabled').checked
            };

            try {
                const url = currentEditingTemplateId
                    ? `${API_BASE}/templates/${currentEditingTemplateId}`
                    : `${API_BASE}/templates`;
                const method = currentEditingTemplateId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

                closeTemplateModal();
                loadTemplates();
                showSmartMessage('templates-container', 'æ¨¡æ¿å·²å„²å­˜ï¼', 'success');
            } catch (error) {
                alert('å„²å­˜å¤±æ•—: ' + error.message);
            }
        }

        async function deleteSmartTemplate(id, name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨¡æ¿ã€Œ${name}ã€å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/templates/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('åˆªé™¤å¤±æ•—');

                loadTemplates();
                showSmartMessage('templates-container', 'æ¨¡æ¿å·²åˆªé™¤', 'success');
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        // UCB Config functions
        async function loadUCBTemplatesSelector() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥æ¨¡æ¿å¤±æ•—');

                const data = await response.json();
                const templates = data.templates || [];
                const container = document.getElementById('ucb-templates-selector');

                if (templates.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center;">å°šç„¡æ¨¡æ¿ï¼Œè«‹å…ˆåˆ°ã€Œæ¨¡æ¿ç®¡ç†ã€æ–°å¢</p>';
                    return;
                }

                // Render template checkboxes
                container.innerHTML = templates.map(template => `
                    <div style="padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; transition: background 0.2s; ${!template.enabled ? 'opacity: 0.5;' : ''}"
                         onmouseover="if(${template.enabled}) this.style.background='#f0f4ff'"
                         onmouseout="this.style.background='transparent'">
                        <input type="checkbox"
                               id="ucb-template-${template.id}"
                               value="${template.id}"
                               ${template.enabled ? 'checked' : 'disabled'}
                               style="width: 18px; height: 18px; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex-shrink: 0;">
                        <label for="ucb-template-${template.id}" style="margin: 0; cursor: ${template.enabled ? 'pointer' : 'not-allowed'}; flex: 1; font-size: 14px; line-height: 1.5;">
                            <strong style="color: #1f2937;">${escapeHtml(template.name)}</strong>
                            ${!template.enabled ? '<span style="color: #999; font-size: 12px; margin-left: 8px;">(å·²åœç”¨)</span>' : ''}
                        </label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡æ¿é¸æ“‡å™¨å¤±æ•—:', error);
                document.getElementById('ucb-templates-selector').innerHTML =
                    '<p style="color: #f00; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function loadUCBConfig() {
            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥é…ç½®å¤±æ•—');

                const data = await response.json();
                const config = data.config;

                if (config) {
                    document.getElementById('exploration-factor').value = parseFloat(config.exploration_factor) || 1.5;
                    document.getElementById('min-trials').value = parseInt(config.min_trials_per_template) || 5;
                    document.getElementById('posts-per-day').value = parseInt(config.posts_per_day) || 1;
                    document.getElementById('auto-schedule-enabled').checked = Boolean(config.auto_schedule_enabled);

                    // Load time range settings
                    if (config.time_range_start) {
                        document.getElementById('time-range-start').value = config.time_range_start;
                    }
                    if (config.time_range_end) {
                        document.getElementById('time-range-end').value = config.time_range_end;
                    }

                    // Load Threads account
                    if (config.threads_account_id) {
                        document.getElementById('ucbThreadsAccount').value = config.threads_account_id;
                    }

                    // Load LINE User ID
                    if (config.line_user_id) {
                        document.getElementById('ucbLineNotifyUserId').value = config.line_user_id;
                    }

                    // Load active days
                    const activeDays = config.active_days || [];
                    document.querySelectorAll('.active-day').forEach(checkbox => {
                        checkbox.checked = activeDays.length === 0 || activeDays.includes(parseInt(checkbox.value));
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
            }
        }

        async function saveUCBConfig(event) {
            event.preventDefault();

            const data = {
                exploration_factor: parseFloat(document.getElementById('exploration-factor').value),
                min_trials_per_template: parseInt(document.getElementById('min-trials').value),
                posts_per_day: parseInt(document.getElementById('posts-per-day').value),
                auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                time_range_start: document.getElementById('time-range-start').value,
                time_range_end: document.getElementById('time-range-end').value,
                threads_account_id: document.getElementById('ucbThreadsAccount').value || null,
                line_user_id: document.getElementById('ucbLineNotifyUserId').value || null,
                active_days: Array.from(document.querySelectorAll('.active-day:checked')).map(cb => parseInt(cb.value))
            };

            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

                showSmartMessage('ucb-message', 'é…ç½®å·²å„²å­˜ï¼', 'success');
            } catch (error) {
                showSmartMessage('ucb-message', 'å„²å­˜å¤±æ•—: ' + error.message, 'error');
            }
        }


        async function triggerDailySchedule() {
            // å…ˆæª¢æŸ¥å¿…è¦è¨­å®š
            const threadsAccount = document.getElementById('ucbThreadsAccount').value;
            const lineUserId = document.getElementById('ucbLineNotifyUserId').value;

            if (!threadsAccount) {
                alert('âŒ è«‹å…ˆé¸æ“‡ Threads å¸³è™Ÿä¸¦å„²å­˜é…ç½®');
                return;
            }

            if (!lineUserId) {
                alert('âŒ è«‹å…ˆè¨­å®š LINE User ID ä¸¦å„²å­˜é…ç½®');
                return;
            }

            // å…ˆæª¢æŸ¥ AI æç¤ºè©æ˜¯å¦å·²è¨­å®š
            try {
                const configRes = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const configData = await configRes.json();
                const config = configData.config || {};

                if (!config.ai_prompt || config.ai_prompt.trim() === '') {
                    alert('âŒ è«‹å…ˆåˆ°ã€Œæç¤ºè©è¨­å®šã€é é¢è¨­å®š AI ç”Ÿæˆæç¤ºè©');
                    return;
                }
            } catch (e) {
                console.error('Failed to check config:', e);
            }

            if (!confirm('ğŸ“‹ ç³»çµ±å°‡ç«‹å³ç”Ÿæˆä¸€ç¯‡æ¸¬è©¦æ–‡ç« \nğŸ’¬ ç”Ÿæˆå®Œæˆå¾Œæœƒç™¼é€ LINE é€šçŸ¥çµ¦æ‚¨å¯©æ ¸\n\nç¢ºå®šè¦ç«‹å³è§¸ç™¼å—ï¼Ÿ')) return;

            try {
                showSmartMessage('ai-message', 'â³ æ­£åœ¨ç”Ÿæˆæ–‡ç« ...è«‹ç¨å€™', 'info');

                const response = await fetch(`${API_BASE}/trigger-daily-schedule`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ immediate: true })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.error || 'è§¸ç™¼å¤±æ•—');
                }

                const data = await response.json();
                showSmartMessage('ai-message', 'âœ… æ–‡ç« å·²å»ºç«‹ï¼è«‹ç¨å€™æŸ¥çœ‹ LINE é€šçŸ¥é€²è¡Œå¯©æ ¸', 'success');

                // Reload schedule history
                setTimeout(() => {
                    loadScheduleHistory();
                }, 1000);
            } catch (error) {
                showSmartMessage('ai-message', 'âŒ è§¸ç™¼å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Schedule History functions
        async function loadScheduleHistory() {
            try {
                const response = await fetch(`${API_BASE}/auto-schedules`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.error || 'ç„¡æ³•è¼‰å…¥æ’ç¨‹æ­·å²');
                }

                const data = await response.json();
                const schedules = data.schedules || [];
                renderScheduleHistory(schedules);
            } catch (error) {
                console.error('Failed to load schedule history:', error);
                document.getElementById('schedule-history-container').innerHTML =
                    `<div class="error-message">
                        <strong>ğŸ“‹ è¼‰å…¥æ’ç¨‹æ­·å²å¤±æ•—</strong><br>
                        ${error.message}<br>
                        <small style="opacity: 0.7;">è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æŸ¥çœ‹è©³ç´°éŒ¯èª¤</small>
                    </div>`;
            }
        }

        async function renderScheduleHistory(schedules) {
            const container = document.getElementById('schedule-history-container');

            if (schedules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <h3>é‚„æ²’æœ‰æ’ç¨‹è¨˜éŒ„</h3>
                        <p>ç³»çµ±æœƒåœ¨æ¯å¤© 00:00 è‡ªå‹•å»ºç«‹æ’ç¨‹ï¼Œæˆ–é»æ“Šã€Œæ¸¬è©¦ç”Ÿæˆç™¼é€ã€é€²è¡Œæ¸¬è©¦</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="schedule-list">
                    ${schedules.map(schedule => {
                const statusMap = {
                    'PENDING': { label: 'å¾…åŸ·è¡Œ', class: 'status-pending' },
                    'GENERATED': { label: 'å¾…å¯©æ ¸', class: 'status-generated' },
                    'APPROVED': { label: 'å·²æ ¸å‡†', class: 'status-approved' },
                    'POSTED': { label: 'å·²ç™¼å¸ƒ', class: 'status-posted' },
                    'FAILED': { label: 'å¤±æ•—', class: 'status-failed' },
                    'CANCELLED': { label: 'å·²å–æ¶ˆ', class: 'status-cancelled' }
                };
                const status = statusMap[schedule.status] || { label: schedule.status, class: '' };

                return `
                        <div class="schedule-item">
                            <div class="schedule-header">
                                <div class="schedule-date">ğŸ“… ${formatDate(schedule.schedule_date)}</div>
                                <span class="schedule-status ${status.class}">${status.label}</span>
                            </div>

                            <div class="schedule-info">
                                <div class="schedule-info-item">
                                    <strong>ç™¼æ–‡æ™‚é–“:</strong> ${formatDateTime(schedule.scheduled_time)}
                                </div>
                            </div>

                            ${schedule.generation_plan ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                                    ${schedule.generation_plan.moduleName ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ“¦ ${escapeHtml(schedule.generation_plan.moduleName)}</span>` : ''}
                                    ${schedule.generation_plan.angleName ? `<span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ¬ ${escapeHtml(schedule.generation_plan.angleName)}</span>` : ''}
                                    ${schedule.generation_plan.outletName ? `<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ’¡ ${escapeHtml(schedule.generation_plan.outletName)}</span>` : ''}
                                    ${schedule.generation_plan.toneBiasName ? `<span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ—£ï¸ ${escapeHtml(schedule.generation_plan.toneBiasName)}</span>` : ''}
                                    ${schedule.generation_plan.endingStyleName ? `<span style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ”š ${escapeHtml(schedule.generation_plan.endingStyleName)}</span>` : ''}
                                    ${schedule.generation_plan.lengthTarget ? `<span style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">ğŸ“ ${escapeHtml(schedule.generation_plan.lengthTarget)}å­—</span>` : ''}
                                </div>
                            ` : `
                                <div style="margin-top: 10px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #6b7280;">
                                    AI è‡ªå‹•ç™¼æ–‡ï¼ˆå–®ä¸€æç¤ºè©ï¼‰
                                </div>
                            `}

                            ${schedule.selection_reason ? `
                                <div class="schedule-reason">
                                    <strong>AI æ±ºç­–åŸå› :</strong>
                                    ${escapeHtml(schedule.selection_reason)}
                                </div>
                            ` : ''}

                            ${schedule.status === 'GENERATED' ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="resendReviewNotification('${schedule.id}')" class="btn btn-secondary btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ“± é‡æ–°ç™¼é€å¯©æ ¸
                                    </button>
                                    <button onclick="manualApproveSchedule('${schedule.id}')" class="btn btn-success btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        âœ… æ‰‹å‹•æ ¸å‡†
                                    </button>
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤æ’ç¨‹
                                    </button>
                                </div>
                            ` : ''}

                            ${schedule.status === 'APPROVED' ? `
                                <div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px; color: #065f46;">
                                    âœ… å·²æ ¸å‡†ï¼Œå°‡æ–¼æ’ç¨‹æ™‚é–“è‡ªå‹•ç™¼å¸ƒ
                                </div>
                            ` : ''}

                            ${(schedule.status === 'PENDING' || schedule.status === 'FAILED') ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" class="btn btn-danger btn-small" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤æ­¤æ’ç¨‹
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        // Delete auto schedule function
        async function deleteAutoSchedule(scheduleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç¨‹å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            try {
                const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'åˆªé™¤å¤±æ•—');
                }

                showSmartMessage('ucb-message', 'âœ… æ’ç¨‹å·²åˆªé™¤', 'success');
                loadScheduleHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        // Resend review notification function
        async function resendReviewNotification(scheduleId) {
            if (!confirm('ç¢ºå®šè¦é‡æ–°ç™¼é€ LINE å¯©æ ¸é€šçŸ¥å—ï¼Ÿ\n\nç¾æœ‰çš„å¯©æ ¸é€£çµå°‡å¤±æ•ˆã€‚')) return;

            try {
                showSmartMessage('ucb-message', 'ğŸ“± æ­£åœ¨é‡æ–°ç™¼é€å¯©æ ¸é€šçŸ¥...', 'info');

                const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/resend-review`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ç™¼é€å¤±æ•—');
                }

                showSmartMessage('ucb-message', data.message || 'âœ… å·²é‡æ–°ç™¼é€å¯©æ ¸é€šçŸ¥', 'success');
            } catch (error) {
                showSmartMessage('ucb-message', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Manual approve schedule function
        async function manualApproveSchedule(scheduleId) {
            if (!confirm('ç¢ºå®šè¦æ‰‹å‹•æ ¸å‡†æ­¤æ’ç¨‹å—ï¼Ÿ\n\næ ¸å‡†å¾Œå°‡æ–¼æ’ç¨‹æ™‚é–“è‡ªå‹•ç™¼å¸ƒåˆ° Threadsã€‚')) return;

            try {
                showSmartMessage('ucb-message', 'â³ æ­£åœ¨æ ¸å‡†...', 'info');

                const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}/manual-approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'æ ¸å‡†å¤±æ•—');
                }

                showSmartMessage('ucb-message', data.message || 'âœ… å·²æ‰‹å‹•æ ¸å‡†', 'success');
                loadScheduleHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } catch (error) {
                showSmartMessage('ucb-message', 'âŒ æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Template Testing functions
        async function testSmartTemplate(templateId) {
            const template = smartSchedulingTemplates.find(t => t.id === templateId);
            if (!template) return;

            currentTestPrompt = template.prompt;
            currentTestEngine = template.preferred_engine || 'GPT5_2';
            openPreviewModal(template.name, currentTestEngine);
            await generatePreview();
        }

        async function testCurrentTemplate() {
            const prompt = document.getElementById('template-prompt').value;
            const engine = document.getElementById('template-engine').value;
            const name = document.getElementById('template-name').value || 'æœªå‘½åæ¨¡æ¿';

            if (!prompt) {
                alert('è«‹å…ˆå¡«å¯«æç¤ºè©å…§å®¹');
                return;
            }

            currentTestPrompt = prompt;
            currentTestEngine = engine;
            openPreviewModal(name, currentTestEngine);
            await generatePreview();
        }

        function openPreviewModal(templateName, engine) {
            document.getElementById('previewModal').classList.add('active');
            const engineName = getEngineName(engine);
            document.querySelector('#previewModal .modal-header h2').textContent = `ğŸ“ ${templateName} - å…§å®¹é è¦½ (${engineName})`;
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function regeneratePreview() {
            await generatePreview();
        }

        async function generatePreview() {
            const resultDiv = document.getElementById('preview-result');
            const engine = currentTestEngine;
            const engineName = getEngineName(engine);

            // Show loading
            resultDiv.innerHTML = `
                <div class="preview-loading">
                    <div class="spinner-small"></div>
                    <p>AI æ­£åœ¨ç”Ÿæˆå…§å®¹...</p>
                    <p style="font-size: 13px; color: #9ca3af;">ä½¿ç”¨å¼•æ“: ${engineName}</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/generate/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: currentTestPrompt,
                        engine: engine
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç”Ÿæˆå¤±æ•—');
                }

                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="preview-content">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #0369a1;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>é€™æ˜¯ AI æ ¹æ“šæ¨¡æ¿æç¤ºè©ç”Ÿæˆçš„å…§å®¹ç¯„ä¾‹ã€‚æ¯æ¬¡ç”Ÿæˆçš„å…§å®¹éƒ½æœƒæœ‰æ‰€ä¸åŒã€‚
                        <br><strong>ä½¿ç”¨å¼•æ“ï¼š</strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        ç”Ÿæˆå¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }

        // Helper functions
        function getEngineName(engineCode) {
            const engineNames = {
                'GPT5_2': 'GPT-5.2',
                'GPT5_2_INSTANT': 'GPT-5.2 Instant',
                'GPT4O': 'GPT-4o',
                'GEMINI_3_FLASH': 'Gemini 3 Flash',
                'GEMINI_3_PRO_PREVIEW': 'Gemini 3 Pro',
                'GEMINI_2_5_FLASH': 'Gemini 2.5 Flash'
            };
            return engineNames[engineCode] || engineCode;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSmartMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;

            container.insertBefore(messageDiv, container.firstChild);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Auto refresh (åƒ…åˆ·æ–°è²¼æ–‡åˆ—è¡¨å’Œå¸³è™Ÿåˆ—è¡¨ï¼Œçµ±è¨ˆåœ–è¡¨ä¸è‡ªå‹•åˆ·æ–°ä»¥ç¯€çœè³‡æº)
        setInterval(() => {
            if (token && document.getElementById('dashboard').classList.contains('active')) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'overviewTab') {
                    loadOverview(); // åªåˆ·æ–°ç¸½è¦½æ•¸å­—ï¼Œä¸åˆ·æ–°çµ±è¨ˆåœ–è¡¨
                }
                if (activeTab.id === 'postsTab') loadPosts();
                if (activeTab.id === 'accountsTab') loadThreadsAccountsList();
            }
        }, 60000); // æ”¹ç‚ºæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡

        // ========== STATISTICS FUNCTIONS ==========

        let stats7DayChartInstance = null;

        // Switch between statistics sub-tabs
        function switchStatsTab(tabName) {
            // Remove active class from all stats sub-tabs
            document.querySelectorAll('.stats-sub-tab').forEach(tab => {
                tab.style.background = '#e5e7eb';
                tab.style.color = '#333';
                tab.classList.remove('active');
            });

            // Hide all stats sub-content
            document.querySelectorAll('.stats-sub-content').forEach(content => {
                content.style.display = 'none';
            });

            // Activate selected tab
            event.target.style.background = '#667eea';
            event.target.style.color = 'white';
            event.target.classList.add('active');

            // Show selected content
            const contentMap = {
                'summary': 'statsSummaryTab',
                'templates': 'statsTemplatesTab',
                'timeslots': 'statsTimeslotsTab',
                'details': 'statsDetailsTab'
            };

            const contentId = contentMap[tabName];
            if (contentId) {
                document.getElementById(contentId).style.display = 'block';
            }

            // Load data for the selected tab
            if (tabName === 'summary') {
                loadStatsSummary();
            } else if (tabName === 'templates') {
                loadStatsTemplates();
            } else if (tabName === 'timeslots') {
                loadStatsTimeslots();
            } else if (tabName === 'details') {
                loadStatsDetails();
            }
        }

        // Load statistics summary
        async function loadStatsSummary() {
            try {
                // Get selected days from both dropdowns
                const trendDaysSelect = document.getElementById('trendDaysSelect');
                const summaryDaysSelect = document.getElementById('summaryDaysSelect');

                // è¶¨å‹¢åœ–ä½¿ç”¨ trendDaysSelectï¼Œæ•´é«”è¡¨ç¾ä½¿ç”¨ summaryDaysSelect
                const trendDays = trendDaysSelect ? trendDaysSelect.value : '7';
                const summaryDays = summaryDaysSelect ? summaryDaysSelect.value : '7';

                // å¦‚æœé¸æ“‡ã€Œå…¨éƒ¨æ­·å²ã€ï¼Œä½¿ç”¨ 3650 å¤©ï¼ˆç´„ 10 å¹´ï¼‰
                const summaryDaysNum = summaryDays === 'all' ? 3650 : summaryDays;

                // Fetch overview statistics from API
                const [overviewRes, syncStatusRes, trendRes] = await Promise.all([
                    fetch(`${API_BASE}/statistics/overview?days=${summaryDaysNum}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/statistics/sync-status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    // è¶¨å‹¢åœ–ä½¿ç”¨ç¨ç«‹çš„å¤©æ•¸
                    fetch(`${API_BASE}/statistics/overview?days=${trendDays}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const overviewData = await overviewRes.json();
                const syncData = await syncStatusRes.json();
                const trendData = await trendRes.json();

                if (!overviewData.success) {
                    throw new Error(overviewData.error || 'Failed to load overview');
                }

                const overview = overviewData.data?.overview || {};
                // è¶¨å‹¢åœ–è³‡æ–™å¾ç¨ç«‹çš„ API å›æ‡‰å–å¾—
                const trend = trendData.data?.trend || { dates: [], views: [], engagement: [] };

                const avgEngagement = parseFloat(overview.avg_engagement_rate) || 0;

                const data = {
                    total_posts: overview.total_posts || 0,
                    total_views: overview.total_views || 0,
                    total_likes: overview.total_likes || 0,
                    avg_engagement_rate: avgEngagement.toFixed(1),
                    last_sync: syncData.success && syncData.data?.last_synced_at
                        ? new Date(syncData.data.last_synced_at).toLocaleString('zh-TW')
                        : 'å°šæœªåŒæ­¥',
                    trend_data: {
                        dates: (trend.dates || []).map(d => d ? d.substring(5).replace('-', '/') : ''),
                        views: trend.views || [],
                        engagement: (trend.engagement || []).map(e => parseFloat((parseFloat(e) || 0).toFixed(1)))
                    }
                };

                // Update summary metrics
                document.getElementById('statsTotalPosts').textContent = data.total_posts;
                document.getElementById('statsTotalViews').textContent = data.total_views.toLocaleString();
                document.getElementById('statsTotalLikes').textContent = data.total_likes.toLocaleString();
                document.getElementById('statsAvgEngagement').textContent = data.avg_engagement_rate + '%';
                document.getElementById('statsLastSync').textContent = data.last_sync;

                // Update synced count
                const syncedCountEl = document.getElementById('statsSyncedCount');
                if (syncedCountEl && syncData.success) {
                    syncedCountEl.textContent = syncData.data?.synced_count || 0;
                }

                // Update 7-day trend chart
                const ctx = document.getElementById('stats7DayChart');
                if (ctx) {
                    // Destroy existing chart if it exists
                    if (stats7DayChartInstance) {
                        stats7DayChartInstance.destroy();
                    }

                    stats7DayChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.trend_data.dates,
                            datasets: [
                                {
                                    label: 'è§€çœ‹æ•¸',
                                    data: data.trend_data.views,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'åƒèˆ‡ç‡ (%)',
                                    data: data.trend_data.engagement,
                                    borderColor: '#764ba2',
                                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 11 },
                                        padding: 10
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    position: 'left',
                                    title: { display: true, text: 'è§€çœ‹æ•¸', font: { size: 10 } },
                                    ticks: { font: { size: 10 } }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'right',
                                    title: { display: true, text: 'åƒèˆ‡ç‡ (%)', font: { size: 10 } },
                                    ticks: { font: { size: 10 } },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }

                // Load analytics data (ä½¿ç”¨åˆ†æå€å¡Šçš„æ™‚é–“é¸æ“‡å™¨)
                const analyticsDays = parseInt(document.getElementById('analyticsDaysSelect')?.value || '30');
                await loadAnalyticsData(analyticsDays);

            } catch (error) {
                console.error('Failed to load statistics summary:', error);
                showAlert('dashboardAlert', 'çµ±è¨ˆæ•¸æ“šè¼‰å…¥å¤±æ•—', 'danger');
            }
        }

        // Handle analytics time range change
        function onAnalyticsDaysChange() {
            const days = parseInt(document.getElementById('analyticsDaysSelect').value);
            loadAnalyticsData(days);
        }

        // Load and render analytics data
        async function loadAnalyticsData(days) {
            const containers = ['bestHoursChart', 'bestDaysChart', 'topPostsList', 'contentLengthAnalysis'];

            try {
                const response = await fetch(`${API_BASE}/statistics/analytics?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Analytics API error:', response.status, errorText);
                    containers.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">è¼‰å…¥å¤±æ•— (${response.status})</p>`;
                    });
                    return;
                }

                const result = await response.json();
                if (!result.success) {
                    console.error('Analytics API returned error:', result.error);
                    containers.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">${result.error || 'è¼‰å…¥å¤±æ•—'}</p>`;
                    });
                    return;
                }

                const { hourlyAnalysis, dayAnalysis, topPosts, contentAnalysis } = result.data;

                // Render best hours chart
                renderBestHoursChart(hourlyAnalysis);

                // Render best days chart
                renderBestDaysChart(dayAnalysis);

                // Render top posts
                renderTopPosts(topPosts);

                // Render content length analysis
                renderContentLengthAnalysis(contentAnalysis);

            } catch (error) {
                console.error('Failed to load analytics:', error);
                containers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px 0; font-size: 11px;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                });
            }
        }

        // Render best hours chart
        function renderBestHoursChart(data) {
            const container = document.getElementById('bestHoursChart');
            if (!container) return;

            if (!data.hours || data.hours.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                return;
            }

            // Find top 5 hours by engagement
            const sortedHours = [...data.hours].filter(h => h.posts >= 1).sort((a, b) => b.avgEngagement - a.avgEngagement).slice(0, 5);

            if (sortedHours.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                return;
            }

            const maxEngagement = Math.max(...sortedHours.map(h => h.avgEngagement));

            container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ğŸ† æœ€ä½³æ™‚æ®µ: <strong style="color: #059669;">${data.bestHour}:00</strong>
                </div>
                ${sortedHours.map(h => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 50px; font-size: 11px; color: #666;">${h.hour}:00</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${(h.avgEngagement / maxEngagement * 100).toFixed(0)}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 60px; text-align: right; font-size: 10px; color: #666;">${h.avgEngagement.toFixed(1)}%</div>
                    </div>
                `).join('')}
                <div style="font-size: 10px; color: #999; margin-top: 8px;">ä¾åƒèˆ‡ç‡æ’åºï¼Œæœ€å°‘ 1 ç¯‡è²¼æ–‡</div>
            `;
        }

        // Render best days chart
        function renderBestDaysChart(data) {
            const container = document.getElementById('bestDaysChart');
            if (!container) return;

            if (!data.days || data.days.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                return;
            }

            const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const maxEngagement = Math.max(...data.days.map(d => d.avgEngagement));

            container.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ğŸ† æœ€ä½³æ˜ŸæœŸ: <strong style="color: #059669;">${dayNames[data.bestDay]}</strong>
                </div>
                ${data.days.map(d => `
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div style="width: 40px; font-size: 11px; color: #666;">${dayNames[d.day]}</div>
                        <div style="flex: 1; height: 16px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${maxEngagement > 0 ? (d.avgEngagement / maxEngagement * 100).toFixed(0) : 0}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px;"></div>
                        </div>
                        <div style="width: 50px; text-align: right; font-size: 10px; color: #666;">${d.avgEngagement.toFixed(1)}%</div>
                        <div style="width: 40px; text-align: right; font-size: 9px; color: #999;">(${d.posts}ç¯‡)</div>
                    </div>
                `).join('')}
            `;
        }

        // Render top posts
        function renderTopPosts(posts) {
            const container = document.getElementById('topPostsList');
            if (!container) return;

            if (!posts || posts.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 30px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                return;
            }

            container.innerHTML = posts.map((post, index) => `
                <div style="display: flex; align-items: flex-start; padding: 10px; background: ${index === 0 ? '#fef3c7' : '#f9fafb'}; border-radius: 6px; margin-bottom: 8px; gap: 10px;">
                    <div style="width: 24px; height: 24px; background: ${index === 0 ? '#f59e0b' : '#9ca3af'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 12px; color: #333; line-height: 1.4; word-break: break-word;">
                            ${escapeHtml(post.content || '(ç„¡å…§å®¹)')}
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: #666;">
                            <span>ğŸ‘ï¸ ${post.views.toLocaleString()}</span>
                            <span>â¤ï¸ ${post.likes}</span>
                            <span>ğŸ’¬ ${post.replies}</span>
                            <span style="color: #059669; font-weight: bold;">ğŸ“Š ${post.engagementRate.toFixed(2)}%</span>
                        </div>
                    </div>
                    ${post.postUrl ? `<a href="${post.postUrl}" target="_blank" style="color: #667eea; font-size: 10px; text-decoration: none;">æŸ¥çœ‹ â†—</a>` : ''}
                </div>
            `).join('');
        }

        // Render content length analysis
        function renderContentLengthAnalysis(data) {
            const container = document.getElementById('contentLengthAnalysis');
            if (!container) return;

            if (!data || (data.short.count === 0 && data.medium.count === 0 && data.long.count === 0)) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0; font-size: 12px;">å°šç„¡è¶³å¤ æ•¸æ“š</p>';
                return;
            }

            const categories = [
                { name: 'çŸ­æ–‡', label: '< 100 å­—', ...data.short, color: '#3b82f6' },
                { name: 'ä¸­ç­‰', label: '100-300 å­—', ...data.medium, color: '#8b5cf6' },
                { name: 'é•·æ–‡', label: '> 300 å­—', ...data.long, color: '#ec4899' },
            ];

            const totalPosts = categories.reduce((sum, c) => sum + c.count, 0);

            container.innerHTML = `
                <div style="font-size: 10px; color: #666; margin-bottom: 8px; text-align: center;">
                    ğŸ“Š åˆ†æ ${totalPosts} ç¯‡è²¼æ–‡çš„<strong>å¹³å‡åƒèˆ‡ç‡</strong>ï¼ˆéåˆ†ä½ˆæ¯”ä¾‹ï¼‰
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                    ${categories.map(c => `
                        <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">${c.name} ${c.label}</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${c.color};">${c.avgEngagement.toFixed(1)}%</div>
                            <div style="font-size: 9px; color: #999;">å¹³å‡åƒèˆ‡ç‡</div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${c.count} ç¯‡</div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 8px 12px; background: #ecfdf5; border-radius: 6px; font-size: 11px; color: #065f46;">
                    ğŸ’¡ ${data.recommendation}
                </div>
            `
        }

        // Sync Threads posts from account
        async function syncThreadsPosts(fetchAll = false) {
            const message = fetchAll
                ? 'æ­¤æ“ä½œå°‡å¾æ‚¨çš„ Threads å¸³è™ŸåŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ã€‚\n\né€™å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œç¹¼çºŒå—ï¼Ÿ'
                : 'æ­¤æ“ä½œå°‡å¾æ‚¨çš„ Threads å¸³è™ŸåŒ¯å…¥æœ€è¿‘ 50 ç¯‡è²¼æ–‡åŠå…¶äº’å‹•æ•¸æ“šã€‚\n\nç¹¼çºŒå—ï¼Ÿ';

            if (!confirm(message)) {
                return;
            }

            try {
                const loadingMessage = fetchAll
                    ? 'æ­£åœ¨å®Œæ•´åŒ¯å…¥æ‰€æœ‰æ­·å²è²¼æ–‡ï¼Œé€™å¯èƒ½éœ€è¦æ•¸åˆ†é˜ï¼Œè«‹ç¨å€™...'
                    : 'æ­£åœ¨å¾ Threads åŒ¯å…¥æ­·å²è²¼æ–‡ï¼Œè«‹ç¨å€™...';
                showAlert('dashboardAlert', loadingMessage, 'info');

                const response = await fetch(`${API_BASE}/statistics/sync-threads-posts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ limit: 50, fetchAll: fetchAll })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message, 'success');
                loadStatsSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
            } catch (error) {
                console.error('Failed to sync Threads posts:', error);
                showAlert('dashboardAlert', 'åŒ¯å…¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Trigger manual insights sync
        async function triggerManualSync() {
            try {
                showAlert('dashboardAlert', 'æ­£åœ¨åŒæ­¥äº’å‹•æ•¸æ“šï¼Œè«‹ç¨å€™ï¼ˆå¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰...', 'info');

                const response = await fetch(`${API_BASE}/statistics/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 365, limit: 500 })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || result.message || 'åŒæ­¥å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message || 'åŒæ­¥å®Œæˆï¼', 'success');
                // ç«‹å³é‡è¼‰çµ±è¨ˆæ•¸æ“š
                loadStatsSummary();
            } catch (error) {
                console.error('Failed to trigger manual sync:', error);
                showAlert('dashboardAlert', 'åŒæ­¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Clear all pending review posts
        async function clearPendingPosts() {
            if (!confirm('æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰å¾…å¯©æ ¸ã€è‰ç¨¿ç‹€æ…‹çš„è²¼æ–‡ã€‚\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            try {
                showAlert('dashboardAlert', 'æ­£åœ¨æ¸…é™¤å¾…å¯©æ ¸è²¼æ–‡...', 'info');

                const response = await fetch(`${API_BASE}/statistics/clear-pending`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ¸…é™¤å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message, 'success');
                loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
            } catch (error) {
                console.error('Failed to clear pending posts:', error);
                showAlert('dashboardAlert', 'æ¸…é™¤å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Clear all scheduled (APPROVED) posts
        async function clearScheduledPosts() {
            if (!confirm('æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰æ’ç¨‹ä¸­ï¼ˆå·²å¯©æ ¸å¾…ç™¼å¸ƒï¼‰çš„è²¼æ–‡ã€‚\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            try {
                showAlert('dashboardAlert', 'æ­£åœ¨æ¸…é™¤æ’ç¨‹ä¸­è²¼æ–‡...', 'info');

                const response = await fetch(`${API_BASE}/statistics/clear-scheduled`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ¸…é™¤å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message, 'success');
                loadOverview(); // é‡æ–°è¼‰å…¥ç¸½è¦½æ•¸é‡
            } catch (error) {
                console.error('Failed to clear scheduled posts:', error);
                showAlert('dashboardAlert', 'æ¸…é™¤å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Reclassify templates for posts without template
        async function reclassifyTemplates() {
            if (!confirm('æ­¤æ“ä½œå°‡ç‚ºæ‰€æœ‰æ²’æœ‰æ¨¡æ¿åˆ†é¡çš„è²¼æ–‡è‡ªå‹•åˆ†é¡ã€‚\n\nç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            try {
                showAlert('dashboardAlert', 'æ­£åœ¨é‡æ–°åˆ†é¡è²¼æ–‡æ¨¡æ¿...', 'info');

                const response = await fetch(`${API_BASE}/statistics/reclassify-templates`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'åˆ†é¡å¤±æ•—');
                }

                showAlert('dashboardAlert', result.message, 'success');
                loadStatsSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                loadStatsTemplates(); // é‡æ–°è¼‰å…¥æ¨¡æ¿çµ±è¨ˆ
            } catch (error) {
                console.error('Failed to reclassify templates:', error);
                showAlert('dashboardAlert', 'é‡æ–°åˆ†é¡å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Load pending posts (æ’ç¨‹ä¸­è²¼æ–‡) - æŸ¥è©¢ UCB æ’ç¨‹ä¸­çš„å·²æ ¸å‡†è²¼æ–‡
        async function loadPendingPosts() {
            const container = document.getElementById('pendingPostsList');
            if (!container) return;

            try {
                container.innerHTML = '<p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>';

                // æŸ¥è©¢ UCB è‡ªå‹•æ’ç¨‹ï¼ˆå·²æ ¸å‡†ç‹€æ…‹ï¼‰
                const response = await fetch(`${API_BASE}/auto-schedules`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
                }

                // éæ¿¾å‡ºå·²æ ¸å‡†çš„æ’ç¨‹ï¼ˆstatus = APPROVED æˆ– GENERATED ä¸”æœªåŸ·è¡Œï¼‰
                const schedules = (data.schedules || []).filter(s =>
                    s.status === 'APPROVED' || s.status === 'GENERATED'
                );

                if (schedules.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</p>
                            <p>ç›®å‰æ²’æœ‰æ’ç¨‹ä¸­çš„è²¼æ–‡</p>
                        </div>`;
                    return;
                }

                // å­˜å„²æ’ç¨‹è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨
                window.pendingSchedulesData = {};

                container.innerHTML = schedules.map(schedule => {
                    const scheduledTime = schedule.scheduled_time
                        ? new Date(schedule.scheduled_time).toLocaleString('zh-TW')
                        : 'æœªè¨­å®š';
                    const templateName = schedule.template_name || 'æœªçŸ¥æ¨¡æ¿';
                    const statusText = schedule.status === 'APPROVED' ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸';
                    const statusColor = schedule.status === 'APPROVED' ? '#10b981' : '#f59e0b';

                    // å–å¾—è²¼æ–‡å…§å®¹
                    const postContent = schedule.revision_content || schedule.post_content || '';
                    const preview = postContent.length > 150 ? postContent.substring(0, 150) + '...' : postContent;

                    // å­˜å„²å®Œæ•´å…§å®¹ä¾›ç·¨è¼¯ä½¿ç”¨
                    if (schedule.post_id) {
                        window.pendingSchedulesData[schedule.post_id] = postContent;
                    }

                    return `
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <span style="background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${statusText}</span>
                                    <span style="margin-left: 10px; color: #666; font-size: 13px;">â° é å®šç™¼å¸ƒï¼š${scheduledTime}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${schedule.post_id ? `
                                    <button onclick="editPendingPost('${schedule.post_id}')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        âœï¸ ç·¨è¼¯
                                    </button>
                                    ` : ''}
                                    <button onclick="deleteAutoSchedule('${schedule.id}')" 
                                        style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            </div>
                            ${postContent ? `
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                                ${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: #666;">
                                <div>ğŸ“ æ¨¡æ¿ï¼š<strong>${templateName}</strong></div>
                                <div>ğŸ“… æ’ç¨‹æ—¥æœŸï¼š<strong>${schedule.schedule_date || 'æœªçŸ¥'}</strong></div>
                            </div>
                            ${schedule.selection_reason ? `
                            <div style="background: #f3e8ff; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px; color: #7c3aed;">
                                ğŸ¤– ${schedule.selection_reason}
                            </div>
                            ` : ''}
                        </div>`;
                }).join('');

            } catch (error) {
                console.error('Failed to load pending posts:', error);
                container.innerHTML = `<p style="text-align: center; color: #ef4444;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
            }
        }

        // Delete auto schedule
        async function deleteAutoSchedule(scheduleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ’ç¨‹å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auto-schedules/${scheduleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                }

                showAlert('dashboardAlert', 'æ’ç¨‹å·²åˆªé™¤', 'success');
                loadPendingPosts();
                loadScheduleHistory(); // æ›´æ–°æ’ç¨‹æ­·å²
            } catch (error) {
                console.error('Failed to delete auto schedule:', error);
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Edit pending post - ä½¿ç”¨ Modal å°è©±æ¡†
        async function editPendingPost(postId) {
            try {
                // å„ªå…ˆä½¿ç”¨å·²å­˜å„²çš„å…§å®¹
                let content = window.pendingSchedulesData?.[postId] || '';

                // å¦‚æœæ²’æœ‰å­˜å„²çš„å…§å®¹ï¼Œå¾ API å–å¾—
                if (!content) {
                    const response = await fetch(`${API_BASE}/posts/${postId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const post = data.post || data;
                        content = post.content || post.generated_content || '';
                    }
                }

                if (!content) {
                    showAlert('dashboardAlert', 'æ‰¾ä¸åˆ°è²¼æ–‡å…§å®¹', 'danger');
                    return;
                }

                // æ‰“é–‹ç·¨è¼¯ Modal
                openEditPostModal(postId, content);
            } catch (error) {
                console.error('Failed to load post for editing:', error);
                showAlert('dashboardAlert', 'è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // æ‰“é–‹ç·¨è¼¯è²¼æ–‡ Modal
        function openEditPostModal(postId, content) {
            document.getElementById('editPostId').value = postId;
            document.getElementById('editPostContent').value = content;
            document.getElementById('editPostCharCount').textContent = content.length;
            document.getElementById('editPostModal').style.display = 'flex';

            // ç›£è½è¼¸å…¥æ›´æ–°å­—æ•¸
            const textarea = document.getElementById('editPostContent');
            textarea.oninput = function () {
                document.getElementById('editPostCharCount').textContent = this.value.length;
            };

            // èšç„¦åˆ°æ–‡å­—å€åŸŸ
            setTimeout(() => textarea.focus(), 100);
        }

        // é—œé–‰ç·¨è¼¯è²¼æ–‡ Modal
        function closeEditPostModal() {
            document.getElementById('editPostModal').style.display = 'none';
            document.getElementById('editPostId').value = '';
            document.getElementById('editPostContent').value = '';
        }

        // å„²å­˜ç·¨è¼¯çš„è²¼æ–‡
        async function saveEditedPost(event) {
            event.preventDefault();

            const postId = document.getElementById('editPostId').value;
            const newContent = document.getElementById('editPostContent').value;

            if (!postId || !newContent.trim()) {
                showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½ç‚ºç©º', 'danger');
                return;
            }

            try {
                const updateResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: newContent })
                });

                if (!updateResponse.ok) {
                    const updateData = await updateResponse.json();
                    throw new Error(updateData.error || 'æ›´æ–°å¤±æ•—');
                }

                closeEditPostModal();
                showAlert('dashboardAlert', 'âœ… è²¼æ–‡å·²æ›´æ–°ï¼Œå°‡æœƒåœ¨æ’ç¨‹æ™‚é–“ç™¼å¸ƒåˆ° Threads', 'success');
                loadPendingPosts();
            } catch (error) {
                console.error('Failed to save edited post:', error);
                showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // Delete pending post
        async function deletePendingPost(postId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ’ç¨‹ä¸­çš„è²¼æ–‡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                }

                showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                loadPendingPosts();
                loadOverview(); // æ›´æ–°ç¸½è¦½æ•¸å­—
            } catch (error) {
                console.error('Failed to delete pending post:', error);
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // ========== AI ç™¼æ–‡é…ç½®ç›¸é—œå‡½æ•¸ ==========

        // è¼‰å…¥ AI ç™¼æ–‡é…ç½®
        async function loadAIConfig() {
            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                const config = data.config || {};

                // è¨­å®šè¡¨å–®å€¼
                document.getElementById('posts-per-day').value = config.posts_per_day || 1;
                document.getElementById('time-range-start').value = config.time_range_start || '09:00';
                document.getElementById('time-range-end').value = config.time_range_end || '21:00';
                document.getElementById('auto-schedule-enabled').checked = config.auto_schedule_enabled !== false;

                // è¨­å®šå•Ÿç”¨æ˜ŸæœŸ
                const activeDays = config.active_days || [1, 2, 3, 4, 5, 6, 7];
                document.querySelectorAll('.active-day').forEach(checkbox => {
                    checkbox.checked = activeDays.includes(parseInt(checkbox.value));
                });
            } catch (error) {
                console.error('Failed to load AI config:', error);
            }
        }

        // å„²å­˜ AI ç™¼æ–‡é…ç½®
        async function saveAIConfig(event) {
            event.preventDefault();

            try {
                showLoading(true);

                const activeDays = [];
                document.querySelectorAll('.active-day:checked').forEach(checkbox => {
                    activeDays.push(parseInt(checkbox.value));
                });

                const config = {
                    posts_per_day: parseInt(document.getElementById('posts-per-day').value) || 1,
                    time_range_start: document.getElementById('time-range-start').value || '09:00',
                    time_range_end: document.getElementById('time-range-end').value || '21:00',
                    auto_schedule_enabled: document.getElementById('auto-schedule-enabled').checked,
                    active_days: activeDays
                };

                const response = await fetch(`${API_BASE}/ucb-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('dashboardAlert', 'âœ… AI ç™¼æ–‡è¨­å®šå·²å„²å­˜', 'success');
                } else {
                    throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to save AI config:', error);
                showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // è¼‰å…¥ AI æç¤ºè©è¨­å®š
        async function loadAIPrompt() {
            try {
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                const config = data.config || {};

                // è¨­å®šæç¤ºè©å’Œå¼•æ“
                document.getElementById('ai-prompt').value = config.ai_prompt || '';
                document.getElementById('ai-engine').value = config.ai_engine || 'GPT5_2';
            } catch (error) {
                console.error('Failed to load AI prompt:', error);
            }
        }

        // å„²å­˜ AI æç¤ºè©è¨­å®š
        async function saveAIPrompt(event) {
            event.preventDefault();

            try {
                showLoading(true);

                const aiPrompt = document.getElementById('ai-prompt').value;
                const aiEngine = document.getElementById('ai-engine').value;

                if (!aiPrompt.trim()) {
                    showAlert('dashboardAlert', 'è«‹è¼¸å…¥ AI æç¤ºè©', 'danger');
                    return;
                }

                // å…ˆå–å¾—ç¾æœ‰é…ç½®
                const configResponse = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                let currentConfig = {};
                if (configResponse.ok) {
                    const configData = await configResponse.json();
                    currentConfig = configData.config || {};
                }

                // æ›´æ–°é…ç½®
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...currentConfig,
                        ai_prompt: aiPrompt,
                        ai_engine: aiEngine
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('dashboardAlert', 'âœ… æç¤ºè©è¨­å®šå·²å„²å­˜', 'success');
                } else {
                    throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to save AI prompt:', error);
                showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // æ¸¬è©¦ AI æç¤ºè©ç”Ÿæˆ
        async function testAIPrompt() {
            const prompt = document.getElementById('ai-prompt').value;
            const engine = document.getElementById('ai-engine').value;

            if (!prompt.trim()) {
                showAlert('dashboardAlert', 'è«‹å…ˆè¼¸å…¥ AI æç¤ºè©', 'danger');
                return;
            }

            const resultContainer = document.getElementById('ai-prompt-test-result');
            const contentDiv = document.getElementById('ai-prompt-test-content');

            resultContainer.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; padding: 30px;"><div class="spinner"></div><p style="margin-top: 15px; color: #666;">AI æ­£åœ¨ç”Ÿæˆå…§å®¹...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/generate/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        engine: engine
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç”Ÿæˆå¤±æ•—');
                }

                const data = await response.json();

                contentDiv.innerHTML = `
                    <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(data.content)}</div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                        <strong>ä½¿ç”¨å¼•æ“ï¼š</strong>${getEngineName(data.engine || engine)}
                    </div>
                `;
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: #ef4444;">ç”Ÿæˆå¤±æ•—: ${error.message}</div>`;
            }
        }

        // è¼‰å…¥æç¤ºè©è¨­å®šé é¢
        function loadTemplates() {
            loadAIPrompt();
            loadDimensions();
            loadDimensionStats();
        }

        // ========================================
        // ç¶­åº¦è¨­å®šç›¸é—œå‡½æ•¸
        // ========================================

        let dimensionsData = {};
        const dimensionExpanded = {
            module: true,
            angle: false,
            outlet: false,
            tone_bias: false,
            ending_style: false,
            length_target: false
        };

        // è¼‰å…¥æ‰€æœ‰ç¶­åº¦è¨­å®š
        async function loadDimensions() {
            try {
                const response = await fetch(`${API_BASE}/dimensions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('è¼‰å…¥å¤±æ•—');
                }

                const result = await response.json();
                if (result.success) {
                    dimensionsData = result.data;
                    renderAllDimensions();
                }
            } catch (error) {
                console.error('Failed to load dimensions:', error);
                document.querySelectorAll('.dimension-options').forEach(el => {
                    el.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
                });
            }
        }

        // è¼‰å…¥ç¶­åº¦ä½¿ç”¨çµ±è¨ˆ
        async function loadDimensionStats() {
            try {
                const response = await fetch(`${API_BASE}/generation/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const result = await response.json();
                if (result.success) {
                    renderDimensionStats(result.data);
                }
            } catch (error) {
                console.error('Failed to load dimension stats:', error);
            }
        }

        // æ¸²æŸ“æ‰€æœ‰ç¶­åº¦
        function renderAllDimensions() {
            const dimensions = ['module', 'angle', 'outlet', 'tone_bias', 'ending_style', 'length_target'];
            dimensions.forEach(dim => renderDimensionOptions(dim));
        }

        // æ¸²æŸ“å–®ä¸€ç¶­åº¦çš„é¸é …
        function renderDimensionOptions(dimension) {
            const container = document.getElementById(`${dimension}-options`);
            if (!container) return;

            const options = dimensionsData[dimension] || [];

            if (options.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px;">å°šç„¡é¸é …</p>';
                return;
            }

            let html = '';
            options.forEach(opt => {
                const weightPercent = Math.round(opt.weight * 100);
                const activeClass = opt.isActive ? '' : 'opacity: 0.5;';

                html += `
                    <div class="dimension-option" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; ${activeClass}">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${escapeHtml(opt.name)}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${escapeHtml(opt.code)}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="100" value="${weightPercent}" 
                                onchange="updateDimensionWeight('${opt.id}', this.value)"
                                style="width: 60px; cursor: pointer;">
                            <span style="font-size: 12px; width: 35px; text-align: right;">${weightPercent}%</span>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${opt.isActive ? 'checked' : ''} 
                                    onchange="toggleDimensionActive('${opt.id}', this.checked)"
                                    style="margin: 0;">
                            </label>
                        </div>
                    </div>
                `;
            });

            html += `
                <div style="padding: 10px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showAddDimensionModal('${dimension}')" 
                        style="font-size: 12px; padding: 6px 12px;">
                        â• æ–°å¢é¸é …
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        // åˆ‡æ›ç¶­åº¦å±•é–‹/æ”¶åˆ
        function toggleDimension(dimension) {
            dimensionExpanded[dimension] = !dimensionExpanded[dimension];

            const optionsEl = document.getElementById(`${dimension}-options`);
            const toggleEl = document.getElementById(`${dimension}-toggle`);

            if (optionsEl) {
                optionsEl.style.display = dimensionExpanded[dimension] ? 'block' : 'none';
            }
            if (toggleEl) {
                toggleEl.textContent = dimensionExpanded[dimension] ? 'â–¼' : 'â–¶';
            }
        }

        // æ›´æ–°ç¶­åº¦æ¬Šé‡
        async function updateDimensionWeight(id, value) {
            try {
                const weight = parseFloat(value) / 100;

                const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ weight })
                });

                if (!response.ok) {
                    throw new Error('æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to update dimension weight:', error);
                showAlert('dashboardAlert', 'æ¬Šé‡æ›´æ–°å¤±æ•—', 'danger');
            }
        }

        // åˆ‡æ›ç¶­åº¦å•Ÿç”¨ç‹€æ…‹
        async function toggleDimensionActive(id, isActive) {
            try {
                const response = await fetch(`${API_BASE}/dimensions/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });

                if (!response.ok) {
                    throw new Error('æ›´æ–°å¤±æ•—');
                }

                // é‡æ–°è¼‰å…¥ç¶­åº¦
                loadDimensions();
            } catch (error) {
                console.error('Failed to toggle dimension active:', error);
                showAlert('dashboardAlert', 'ç‹€æ…‹æ›´æ–°å¤±æ•—', 'danger');
            }
        }

        // é¡¯ç¤ºæ–°å¢ç¶­åº¦é¸é …çš„å°è©±æ¡†
        function showAddDimensionModal(dimensionType) {
            const dimensionNames = {
                module: 'å…§å®¹æ¨¡çµ„',
                angle: 'æƒ…å¢ƒåˆ‡è§’',
                outlet: 'è™•ç†å‡ºå£',
                tone_bias: 'èªæ°£åå£“',
                ending_style: 'æ”¶å°¾æ„åœ–',
                length_target: 'å­—æ•¸ç›®æ¨™'
            };

            const code = prompt(`è«‹è¼¸å…¥æ–°ã€${dimensionNames[dimensionType]}ã€‘é¸é …çš„ä»£ç¢¼ï¼ˆè‹±æ–‡ï¼Œä¾‹å¦‚ï¼šnew_optionï¼‰ï¼š`);
            if (!code) return;

            const name = prompt('è«‹è¼¸å…¥é¸é …çš„ä¸­æ–‡åç¨±ï¼š');
            if (!name) return;

            addDimensionOption(dimensionType, code, name);
        }

        // æ–°å¢ç¶­åº¦é¸é …
        async function addDimensionOption(dimensionType, code, name) {
            try {
                const response = await fetch(`${API_BASE}/dimensions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dimensionType,
                        code,
                        name,
                        weight: 0.10
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'æ–°å¢å¤±æ•—');
                }

                showAlert('dashboardAlert', 'âœ… é¸é …å·²æ–°å¢', 'success');
                loadDimensions();
            } catch (error) {
                console.error('Failed to add dimension option:', error);
                showAlert('dashboardAlert', 'æ–°å¢å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // æ¸²æŸ“çµ±è¨ˆè³‡æ–™
        function renderDimensionStats(stats) {
            const container = document.getElementById('dimension-stats');
            if (!container) return;

            const moduleStats = stats.module || {};
            const total = Object.values(moduleStats).reduce((a, b) => a + b, 0);

            if (total === 0) {
                container.innerHTML = '<p style="color: #999;">å°šç„¡çµ±è¨ˆè³‡æ–™</p>';
                return;
            }

            const moduleNames = {
                pleasure_relief: 'çˆ½èˆ‡è§£å£“',
                practical: 'å‹™å¯¦è™•ç†',
                uncomfortable_truth: 'ä¸èˆ’æœçœŸå¯¦',
                controversial: 'çˆ­è­°æå•'
            };

            let html = '<div style="display: grid; gap: 8px;">';

            for (const [code, count] of Object.entries(moduleStats)) {
                const percent = Math.round((count / total) * 100);
                const name = moduleNames[code] || code;

                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span>${name}</span>
                            <span>${count} ç¯‡ (${percent}%)</span>
                        </div>
                        <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // è¼‰å…¥ç™¼æ–‡æ’ç¨‹é é¢
        function loadScheduling() {
            loadAIConfig();
            loadScheduleHistory();
        }

        // Load UCB template ranking (ä¿ç•™ä½†ç°¡åŒ–)
        async function loadUCBTemplateRanking() {
            const container = document.getElementById('ucbTemplateRanking');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/statistics/debug-performance-log`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    container.innerHTML = '<p style="opacity: 0.8;">è³‡æ–™è¼‰å…¥å¤±æ•—</p>';
                    return;
                }

                const data = await response.json();
                const templates = data.data?.template_stats || [];

                if (templates.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.8;">å°šç„¡æ¨¡æ¿æ•¸æ“š</p>';
                    return;
                }

                // è¨ˆç®— UCB åˆ†æ•¸ä¸¦æ’åº
                const totalPosts = templates.reduce((sum, t) => sum + (t.total_uses || 0), 0);
                const minTrials = 5; // é è¨­æœ€å°‘è©¦é©—æ¬¡æ•¸
                const explorationFactor = 1.5; // é è¨­æ¢ç´¢ä¿‚æ•¸

                const rankedTemplates = templates
                    .filter(t => t.enabled)
                    .map(t => {
                        const uses = parseInt(t.total_uses) || 0;
                        const avgRateRaw = parseFloat(t.avg_engagement_rate) || 0;
                        const avgRate = avgRateRaw / 100;

                        let ucbScore, status, statusColor;
                        if (uses < minTrials) {
                            ucbScore = 999 + Math.random();
                            status = `æ¢ç´¢ä¸­ (${uses}/${minTrials})`;
                            statusColor = '#ffd700';
                        } else {
                            const explorationBonus = explorationFactor * Math.sqrt(Math.log(Math.max(totalPosts, 1)) / Math.max(uses, 1));
                            ucbScore = avgRate + explorationBonus;
                            status = 'å„ªåŒ–ä¸­';
                            statusColor = '#90EE90';
                        }

                        return { ...t, ucbScore, status, statusColor, avgRateRaw };
                    })
                    .sort((a, b) => b.ucbScore - a.ucbScore);

                container.innerHTML = rankedTemplates.map((t, idx) => `
                    <div style="display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; width: 30px;">${idx + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${t.name}</div>
                            <div style="font-size: 12px; opacity: 0.8;">
                                ä½¿ç”¨ ${parseInt(t.total_uses) || 0} æ¬¡ â€¢ äº’å‹•ç‡ ${t.avgRateRaw.toFixed(1)}%
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: ${t.statusColor}; font-weight: 600;">${t.status}</div>
                            <div style="font-size: 10px; opacity: 0.7;">UCB: ${t.ucbScore < 100 ? t.ucbScore.toFixed(3) : 'æ¢ç´¢å„ªå…ˆ'}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load UCB template ranking:', error);
                container.innerHTML = '<p style="opacity: 0.8;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Save account settings (UCB account and LINE ID)
        async function saveAccountSettings() {
            try {
                showLoading(true);

                const threadsAccountId = document.getElementById('ucbThreadsAccount')?.value || '';
                const lineUserId = document.getElementById('ucbLineNotifyUserId')?.value || '';

                // å–å¾—ç¾æœ‰çš„ UCB é…ç½®
                const configResponse = await fetch(`${API_BASE}/ucb-config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let currentConfig = {};
                if (configResponse.ok) {
                    const configData = await configResponse.json();
                    currentConfig = configData.config || {};
                }

                // æ›´æ–°é…ç½®ï¼ˆä½¿ç”¨ PUT æ–¹æ³•ï¼‰
                const response = await fetch(`${API_BASE}/ucb-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        exploration_factor: currentConfig.exploration_factor || 1.5,
                        min_trials_per_template: currentConfig.min_trials_per_template || 5,
                        posts_per_day: currentConfig.posts_per_day || 1,
                        auto_schedule_enabled: currentConfig.auto_schedule_enabled !== false,
                        threads_account_id: threadsAccountId,
                        line_user_id: lineUserId,
                        time_range_start: currentConfig.time_range_start || '09:00',
                        time_range_end: currentConfig.time_range_end || '21:00',
                        active_days: currentConfig.active_days || []
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('dashboardAlert', 'å¸³è™Ÿè¨­å®šå·²å„²å­˜', 'success');
                } else {
                    throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to save account settings:', error);
                showAlert('dashboardAlert', 'å„²å­˜å¤±æ•—: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Auto sync on page load (silent, no alert)
        async function autoSyncOnLoad() {
            try {
                // éœé»˜åŒæ­¥äº’å‹•æ•¸æ“šï¼Œä¸é¡¯ç¤ºæç¤º
                await fetch(`${API_BASE}/statistics/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 7, limit: 100 })
                });
                console.log('Auto sync triggered on page load');
            } catch (error) {
                console.warn('Auto sync failed:', error);
            }
        }

        // Load template statistics
        async function loadStatsTemplates() {
            const container = document.getElementById('statsTemplatesList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/templates?days=30`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load templates');
                }

                const templates = result.data;

                if (templates.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ¨£æ¿æ•¸æ“š</p>';
                    return;
                }

                let html = '';
                templates.forEach(template => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${template.name}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                <div>ä½¿ç”¨æ¬¡æ•¸: ${template.total_uses || 0}</div>
                                <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(template.avg_likes) || 0)}</div>
                                <div>åƒèˆ‡ç‡: ${(parseFloat(template.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(template.avg_views) || 0)}</div>
                            </div>
                            ${template.best_performing_time ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #28a745;">
                                    â­ æœ€ä½³æ™‚æ®µ: ${template.best_performing_time}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load template statistics:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Load timeslot statistics
        async function loadStatsTimeslots() {
            const container = document.getElementById('statsTimeslotsList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/timeslots?days=30`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load timeslots');
                }

                const timeslots = result.data;

                if (timeslots.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡æ™‚æ®µæ•¸æ“š</p>';
                    return;
                }

                let html = '';
                timeslots.forEach(slot => {
                    // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ name æ¬„ä½ï¼ˆä¾‹å¦‚ "08:00 - 08:59"ï¼‰
                    const label = slot.name || `${String(slot.start_hour || 0).padStart(2, '0')}:00`;
                    const hour = slot.start_hour || slot.id || 0;
                    html += `
                        <div style="background: white; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                            <div onclick="toggleTimeslotDetail(${hour}, this)" 
                                 style="padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                 onmouseover="this.style.background='#f5f5f5'" 
                                 onmouseout="this.style.background='white'">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ• ${label}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: #666;">
                                        <div>è²¼æ–‡æ•¸: ${slot.posts_count || 0}</div>
                                        <div>åƒèˆ‡ç‡: ${(parseFloat(slot.avg_engagement_rate) || 0).toFixed(1)}%</div>
                                        <div>å¹³å‡æŒ‰è®š: ${Math.round(parseFloat(slot.avg_likes) || 0)}</div>
                                        <div>å¹³å‡è§€çœ‹: ${Math.round(parseFloat(slot.avg_views) || 0)}</div>
                                    </div>
                                </div>
                                <span style="font-size: 18px; color: #999; transition: transform 0.2s;">â–¼</span>
                            </div>
                            <div id="timeslot-detail-${hour}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid #eee;">
                                <p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">é»æ“Šè¼‰å…¥è²¼æ–‡...</p>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load timeslot statistics:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Toggle timeslot detail
        async function toggleTimeslotDetail(hour, headerEl) {
            const detailEl = document.getElementById(`timeslot-detail-${hour}`);
            const arrowEl = headerEl.querySelector('span');

            if (detailEl.style.display === 'none') {
                detailEl.style.display = 'block';
                arrowEl.style.transform = 'rotate(180deg)';

                // è¼‰å…¥è©²æ™‚æ®µçš„è²¼æ–‡
                detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">è¼‰å…¥ä¸­...</p>';

                try {
                    const response = await fetch(`${API_BASE}/statistics/posts-by-hour?hour=${hour}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to load posts');
                    }

                    const posts = result.data.posts || [];

                    if (posts.length === 0) {
                        detailEl.innerHTML = '<p style="color: #999; text-align: center; padding: 10px 0; font-size: 12px;">æ­¤æ™‚æ®µç„¡è²¼æ–‡</p>';
                        return;
                    }

                    let html = '<div style="font-size: 12px;">';
                    posts.forEach(post => {
                        const content = post.content_preview || post.content || '(ç„¡å…§å®¹)';
                        const truncated = content.length > 40 ? content.substring(0, 40) + '...' : content;
                        const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                            month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        }) : '-';

                        html += `
                            <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #666;">${postedAt}</span>
                                    <span style="color: #667eea;">ğŸ‘ ${(post.views || 0).toLocaleString()} Â· â¤ï¸ ${post.likes || 0}</span>
                                </div>
                                <div style="color: #333;">${truncated}</div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    detailEl.innerHTML = html;

                } catch (error) {
                    console.error('Failed to load posts for hour:', error);
                    detailEl.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 10px 0; font-size: 12px;">è¼‰å…¥å¤±æ•—</p>';
                }
            } else {
                detailEl.style.display = 'none';
                arrowEl.style.transform = 'rotate(0deg)';
            }
        }

        // Load post details
        async function loadStatsDetails() {
            const container = document.getElementById('statsDetailsList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/statistics/posts?limit=20&sortBy=posted_at&sortOrder=DESC`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load posts');
                }

                const posts = result.data.posts;

                if (posts.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">å°šç„¡è²¼æ–‡æ•¸æ“š</p>';
                    return;
                }

                let html = `
                    <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left;">ç™¼å¸ƒæ™‚é–“</th>
                                <th style="padding: 10px; text-align: left;">å…§å®¹</th>
                                <th style="padding: 10px; text-align: center;">ğŸ‘ï¸ è§€çœ‹</th>
                                <th style="padding: 10px; text-align: center;">â¤ï¸ æŒ‰è®š</th>
                                <th style="padding: 10px; text-align: center;">ğŸ“Š åƒèˆ‡ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                posts.forEach(post => {
                    const content = post.content_preview || post.content || '(ç„¡å…§å®¹)';
                    const truncated = content.length > 25 ? content.substring(0, 25) + '...' : content;
                    const postedAt = post.posted_at ? new Date(post.posted_at).toLocaleDateString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    html += `
                        <tr style="border-top: 1px solid #e5e7eb;">
                            <td style="padding: 10px; white-space: nowrap;">${postedAt}</td>
                            <td style="padding: 10px;">${truncated}</td>
                            <td style="padding: 10px; text-align: center;">${(post.views || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: center;">${post.likes || 0}</td>
                            <td style="padding: 10px; text-align: center;">${(parseFloat(post.engagement_rate) || 0).toFixed(1)}%</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load post details:', error);
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // Export statistics to CSV
        function exportStatsToCSV() {
            // TODO: Implement CSV export functionality
            showAlert('dashboardAlert', 'CSV åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
        }

        // Trigger manual sync
        async function triggerManualSync() {
            try {
                showAlert('dashboardAlert', 'é–‹å§‹åŒæ­¥ Insights æ•¸æ“š...', 'info');

                const response = await fetch(`${API_BASE}/statistics/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: 7, limit: 50 })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Sync failed');
                }

                showAlert('dashboardAlert', 'âœ… ' + result.message, 'success');

                // ç­‰å¾… 2 ç§’å¾Œé‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                setTimeout(() => {
                    loadStatsSummary();
                    if (currentStatsTab === 'templates') loadStatsTemplates();
                    if (currentStatsTab === 'timeslots') loadStatsTimeslots();
                    if (currentStatsTab === 'details') loadStatsDetails();
                }, 2000);

            } catch (error) {
                console.error('Failed to trigger sync:', error);
                showAlert('dashboardAlert', 'åŒæ­¥å¤±æ•—', 'danger');
            }
        }

        // Initialize statistics on page load
        document.addEventListener('DOMContentLoaded', function () {
            if (token) {
                // è‡ªå‹•åŒæ­¥äº’å‹•æ•¸æ“šï¼ˆéœé»˜åŸ·è¡Œï¼‰
                autoSyncOnLoad();
                // è¼‰å…¥çµ±è¨ˆæ‘˜è¦
                loadStatsSummary();
            }
        });

        // ========================================
        // è²é‡ç›£æ§åŠŸèƒ½
        // ========================================

        let currentMonitorTab = 'mentions';

        function switchMonitorTab(tabName) {
            currentMonitorTab = tabName;

            // æ›´æ–° sub-tab æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('#monitorTab .tabs .tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // éš±è—æ‰€æœ‰ sub-tab å…§å®¹
            document.getElementById('monitorMentionsTab').style.display = 'none';
            document.getElementById('monitorBrandsTab').style.display = 'none';
            document.getElementById('monitorSourcesTab').style.display = 'none';
            document.getElementById('monitorStatsTab').style.display = 'none';

            // é¡¯ç¤ºé¸ä¸­çš„ sub-tab
            if (tabName === 'mentions') {
                document.getElementById('monitorMentionsTab').style.display = 'block';
                loadMentions();
            } else if (tabName === 'brands') {
                document.getElementById('monitorBrandsTab').style.display = 'block';
                loadBrands();
            } else if (tabName === 'sources') {
                document.getElementById('monitorSourcesTab').style.display = 'block';
                loadSources();
            } else if (tabName === 'stats') {
                document.getElementById('monitorStatsTab').style.display = 'block';
                loadMonitorStats();
            }
        }

        async function loadMentions() {
            const container = document.getElementById('mentionsList');
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const brandId = document.getElementById('mentionBrandFilter').value;
                const isRead = document.getElementById('mentionReadFilter').value;

                let url = `${API_BASE}/monitor/mentions?limit=20`;
                if (brandId) url += `&brand_id=${brandId}`;
                if (isRead) url += `&is_read=${isRead}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const mentions = result.data.mentions || [];

                if (mentions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">å°šç„¡æåŠè¨˜éŒ„</p>';
                    return;
                }

                container.innerHTML = mentions.map(m => `
                    <div style="background: ${m.is_read ? '#f8f9fa' : 'white'}; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${m.brand_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <span style="background: ${m.brand_color || '#667eea'}; color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px;">${m.brand_name}</span>
                                <span style="margin-left: 10px; color: #666; font-size: 12px;">${m.source_name}</span>
                            </div>
                            <span style="color: #999; font-size: 12px;">${new Date(m.discovered_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <h4 style="margin-bottom: 10px; color: #333;">${m.title || '(ç„¡æ¨™é¡Œ)'}</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">${m.content_preview || ''}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #888;">
                                ğŸ”‘ ${JSON.parse(m.matched_keywords || '[]').join(', ')}
                                ${m.likes_count ? ` Â· â¤ï¸ ${m.likes_count}` : ''}
                                ${m.comments_count ? ` Â· ğŸ’¬ ${m.comments_count}` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <a href="${m.url}" target="_blank" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;">ğŸ”— æŸ¥çœ‹åŸæ–‡</a>
                                ${!m.is_read ? `<button class="btn btn-primary" style="padding: 5px 15px; font-size: 12px;" onclick="markMentionRead('${m.id}', this)">âœ“ æ¨™ç‚ºå·²è®€</button>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load mentions:', error);
                container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function markMentionRead(mentionId, btn) {
            try {
                await fetch(`${API_BASE}/monitor/mentions/${mentionId}/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                btn.closest('div[style*="background"]').style.background = '#f8f9fa';
                btn.remove();
            } catch (error) {
                console.error('Failed to mark as read:', error);
            }
        }

        async function loadBrands() {
            const container = document.getElementById('brandsList');
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/monitor/brands`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const brands = result.data || [];

                // æ›´æ–°å“ç‰Œéæ¿¾ä¸‹æ‹‰é¸å–®
                const brandFilter = document.getElementById('mentionBrandFilter');
                brandFilter.innerHTML = '<option value="">å…¨éƒ¨å“ç‰Œ</option>' +
                    brands.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                if (brands.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">å°šæœªè¨­å®šç›£æ§å“ç‰Œ</p>
                            <button class="btn btn-primary" onclick="showAddBrandModal()">â• æ–°å¢ç¬¬ä¸€å€‹å“ç‰Œ</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = brands.map(b => `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${b.display_color || '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 5px;">${b.name} 
                                    <span style="background: ${b.brand_type === 'own' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">
                                        ${b.brand_type === 'own' ? 'è‡ªæœ‰å“ç‰Œ' : 'ç«¶å“'}
                                    </span>
                                </h4>
                                <p style="color: #666; font-size: 13px;">é—œéµå­—ï¼š${JSON.parse(b.keywords || '[]').join(', ')}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <span style="color: ${b.is_active ? '#10b981' : '#dc3545'}; font-size: 12px;">${b.is_active ? 'âœ“ å•Ÿç”¨ä¸­' : 'âŠ˜ åœç”¨'}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteBrand('${b.id}')">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load brands:', error);
                container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function loadSources() {
            const container = document.getElementById('sourcesList');
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/monitor/sources`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const sources = result.data || [];

                if (sources.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 0;">
                            <p style="color: #999; margin-bottom: 20px;">å°šæœªè¨­å®šç›£æ§ä¾†æº</p>
                            <button class="btn btn-primary" onclick="showSourceTemplates()">ğŸ“‹ å¾é è¨­ä¾†æºæ–°å¢</button>
                        </div>
                    `;
                    return;
                }

                const healthColors = {
                    healthy: '#10b981',
                    warning: '#f59e0b',
                    error: '#dc3545',
                    unknown: '#999'
                };

                container.innerHTML = sources.map(s => `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 5px;">
                                    <span style="color: ${healthColors[s.health_status] || '#999'};">â—</span>
                                    ${s.name}
                                    <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">${s.platform}</span>
                                </h4>
                                <p style="color: #666; font-size: 12px; word-break: break-all;">${s.url}</p>
                                <p style="color: #888; font-size: 11px; margin-top: 5px;">
                                    æª¢æŸ¥é–“éš”: ${s.check_interval_hours} å°æ™‚ Â· 
                                    ä¸Šæ¬¡æª¢æŸ¥: ${s.last_checked_at ? new Date(s.last_checked_at).toLocaleString('zh-TW') : 'å¾æœª'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="triggerCrawl('${s.id}')">ğŸ”„ ç«‹å³çˆ¬å–</button>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSource('${s.id}')">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load sources:', error);
                container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px 0;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function loadMonitorStats() {
            try {
                const days = document.getElementById('monitorStatsDays').value;
                const response = await fetch(`${API_BASE}/monitor/stats/overview?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const data = result.data;

                document.getElementById('monitorTotalMentions').textContent = data.total_mentions || 0;
                document.getElementById('monitorUnreadCount').textContent = data.unread_count || 0;
                document.getElementById('monitorBrandCount').textContent = (data.brand_stats || []).length;

                // å“ç‰Œçµ±è¨ˆ
                const brandStats = document.getElementById('monitorBrandStats');
                if (data.brand_stats && data.brand_stats.length > 0) {
                    brandStats.innerHTML = data.brand_stats.map(b => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span style="color: ${b.display_color || '#667eea'};">â— ${b.name}</span>
                            <span><strong>${b.mention_count}</strong> æ¬¡</span>
                        </div>
                    `).join('');
                } else {
                    brandStats.innerHTML = '<p style="color: #999; text-align: center;">ç„¡è³‡æ–™</p>';
                }

                // ä¾†æºçµ±è¨ˆ
                const sourceStats = document.getElementById('monitorSourceStats');
                if (data.source_stats && data.source_stats.length > 0) {
                    sourceStats.innerHTML = data.source_stats.map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span>${s.name} <small style="color: #888;">(${s.platform})</small></span>
                            <span><strong>${s.mention_count}</strong> æ¬¡</span>
                        </div>
                    `).join('');
                } else {
                    sourceStats.innerHTML = '<p style="color: #999; text-align: center;">ç„¡è³‡æ–™</p>';
                }

            } catch (error) {
                console.error('Failed to load monitor stats:', error);
            }
        }

        function showAddBrandModal() {
            const keywords = prompt('è«‹è¼¸å…¥å“ç‰Œåç¨±å’Œç›£æ§é—œéµå­—ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š\nä¾‹å¦‚ï¼šæˆ‘çš„å“ç‰Œ, å“ç‰ŒA, ç”¢å“å');
            if (!keywords) return;

            const name = prompt('è«‹è¼¸å…¥å“ç‰Œé¡¯ç¤ºåç¨±ï¼š');
            if (!name) return;

            const brandType = confirm('é€™æ˜¯æ‚¨çš„è‡ªæœ‰å“ç‰Œå—ï¼Ÿ\n\næŒ‰ã€Œç¢ºå®šã€= è‡ªæœ‰å“ç‰Œ\næŒ‰ã€Œå–æ¶ˆã€= ç«¶å“') ? 'own' : 'competitor';

            createBrand(name, keywords.split(',').map(k => k.trim()), brandType);
        }

        async function createBrand(name, keywords, brandType) {
            try {
                const response = await fetch(`${API_BASE}/monitor/brands`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, keywords, brand_type: brandType })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                showAlert('dashboardAlert', 'å“ç‰Œå·²å»ºç«‹', 'success');
                loadBrands();
            } catch (error) {
                showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'danger');
            }
        }

        async function deleteBrand(brandId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“ç‰Œå—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„æåŠè¨˜éŒ„ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) return;

            try {
                await fetch(`${API_BASE}/monitor/brands/${brandId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadBrands();
            } catch (error) {
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—', 'danger');
            }
        }

        async function showSourceTemplates() {
            try {
                const response = await fetch(`${API_BASE}/monitor/templates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                const templates = result.data || [];

                const options = templates.map((t, i) => `${i + 1}. ${t.name}`).join('\n');
                const choice = prompt(`è«‹é¸æ“‡è¦æ–°å¢çš„ä¾†æºï¼ˆè¼¸å…¥ç·¨è™Ÿï¼‰ï¼š\n\n${options}`);

                if (!choice) return;

                const idx = parseInt(choice) - 1;
                if (idx >= 0 && idx < templates.length) {
                    const template = templates[idx];
                    await createSource(template.name, template.url, template.platform);
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥é è¨­ä¾†æºå¤±æ•—', 'danger');
            }
        }

        function showAddSourceModal() {
            const name = prompt('è«‹è¼¸å…¥ä¾†æºåç¨±ï¼š');
            if (!name) return;

            const url = prompt('è«‹è¼¸å…¥ç›£æ§ç¶²å€ï¼š');
            if (!url) return;

            const platform = prompt('è«‹é¸æ“‡å¹³å°é¡å‹ï¼š\ndcard, ptt, facebook, instagram, youtube, threads, news, blog, forum, other') || 'other';

            createSource(name, url, platform);
        }

        async function createSource(name, url, platform) {
            try {
                // å–å¾—æ‰€æœ‰å“ç‰Œ ID
                const brandsRes = await fetch(`${API_BASE}/monitor/brands`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const brandsResult = await brandsRes.json();
                const brandIds = (brandsResult.data || []).map(b => b.id);

                const response = await fetch(`${API_BASE}/monitor/sources`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url, platform, brand_ids: brandIds })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                showAlert('dashboardAlert', 'ä¾†æºå·²å»ºç«‹', 'success');
                loadSources();
            } catch (error) {
                showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'danger');
            }
        }

        async function deleteSource(sourceId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä¾†æºå—ï¼Ÿ')) return;

            try {
                await fetch(`${API_BASE}/monitor/sources/${sourceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadSources();
            } catch (error) {
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—', 'danger');
            }
        }

        async function triggerCrawl(sourceId) {
            try {
                showAlert('dashboardAlert', 'æ­£åœ¨çˆ¬å–...', 'info');

                const response = await fetch(`${API_BASE}/monitor/crawl`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source_id: sourceId })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                showAlert('dashboardAlert', result.message, 'success');
                loadSources();
            } catch (error) {
                showAlert('dashboardAlert', 'çˆ¬å–å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // ç•¶åˆ‡æ›åˆ° monitor tab æ™‚è¼‰å…¥è³‡æ–™
        const originalSwitchTab = switchTab;
        switchTab = function (tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'monitor') {
                loadMentions();
                loadBrands();
            }
        };

        // ========================================
        // Google Trends åŠŸèƒ½
        // ========================================

        async function fetchGoogleTrends() {
            const container = document.getElementById('googleTrendsChart');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 0;">æ­£åœ¨æŠ“å–è¶¨å‹¢æ•¸æ“š...</p>';

            try {
                const response = await fetch(`${API_BASE}/monitor/trends/fetch`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #d4edda; border-radius: 8px; color: #155724;">
                        âœ… ${result.message}<br>
                        <small>æ•¸æ“šæœƒåœ¨èƒŒæ™¯æŒçºŒæŠ“å–ï¼Œè«‹ç¨å¾Œé‡æ–°æ•´ç†æŸ¥çœ‹çµæœ</small>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 40px 0;">æŠ“å–å¤±æ•—: ${error.message}</p>`;
            }
        }

        async function loadDailyTrends() {
            const container = document.getElementById('dailyTrendsList');
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/monitor/trends/daily`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const trends = result.data || [];

                if (trends.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px 0;">æš«ç„¡ç†±é–€æœå°‹æ•¸æ“š</p>';
                    return;
                }

                container.innerHTML = trends.slice(0, 10).map((t, idx) => `
                    <div style="display: flex; align-items: center; padding: 12px; background: ${idx < 3 ? '#fef3c7' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${idx < 3 ? '#f59e0b' : '#d1d5db'};">
                        <span style="font-weight: bold; font-size: 18px; width: 30px; color: ${idx < 3 ? '#d97706' : '#6b7280'};">${idx + 1}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${t.title || 'æœªçŸ¥'}</div>
                            <div style="font-size: 12px; color: #666;">${t.traffic || ''}</div>
                        </div>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 11px;" 
                            onclick="searchRelatedQueries('${(t.title || '').replace(/'/g, "\\'")}')">ğŸ” ç›¸é—œè©</button>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px 0;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        async function searchRelatedQueries(keyword) {
            try {
                const response = await fetch(`${API_BASE}/monitor/trends/related/${encodeURIComponent(keyword)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const data = result.data;
                const topList = (data.top || []).slice(0, 5).map(q => q.query).join(', ') || 'ç„¡';
                const risingList = (data.rising || []).slice(0, 5).map(q => `${q.query} (${q.value})`).join(', ') || 'ç„¡';

                alert(`ğŸ” ã€Œ${keyword}ã€ç›¸é—œæœå°‹\n\nğŸ“Š ç†±é–€æœå°‹è©ï¼š\n${topList}\n\nğŸš€ å¿«é€Ÿä¸Šå‡ï¼š\n${risingList}`);
            } catch (error) {
                alert('æŸ¥è©¢å¤±æ•—: ' + error.message);
            }
        }

    </script>
</body>

</html>