<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ± - ç®¡ç†ä»‹é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .user-info {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .user-info p {
            color: #333;
            margin: 5px 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-section, .dashboard {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .posts-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .post-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .post-card .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-DRAFT { background: #e9ecef; color: #495057; }
        .status-GENERATING { background: #fff3cd; color: #856404; }
        .status-PENDING_REVIEW { background: #cce5ff; color: #004085; }
        .status-APPROVED { background: #d4edda; color: #155724; }
        .status-POSTED { background: #d1ecf1; color: #0c5460; }
        .status-FAILED { background: #f8d7da; color: #721c24; }

        .post-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            min-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸš€ Threads åŠè‡ªå‹•ç™¼æ–‡ç³»çµ±</h1>
            <p>AI é©…å‹•çš„å…§å®¹ç”Ÿæˆèˆ‡ç™¼å¸ƒç®¡ç†å¹³å°</p>
            <div id="userInfo" class="user-info">
                <p><strong>ä½¿ç”¨è€…:</strong> <span id="userName"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>è§’è‰²:</strong> <span id="userRoles"></span></p>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px;">ç™»å…¥ç³»çµ±</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">ç™»å…¥</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">ğŸ“Š ç¸½è¦½</button>
                <button class="tab" onclick="switchTab('posts')">ğŸ“ è²¼æ–‡ç®¡ç†</button>
                <button class="tab" onclick="switchTab('create')">âœï¸ æ‰‹å‹•å»ºç«‹è²¼æ–‡</button>
                <button class="tab" onclick="switchTab('accounts')">ğŸ‘¤ Threads å¸³è™Ÿ</button>
                <button class="tab" onclick="switchTab('settings')">ğŸ¤– è‡ªå‹•åŒ–ç™¼æ–‡</button>
            </div>

            <!-- Alert Area -->
            <div id="dashboardAlert"></div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">è™•ç†ä¸­...</p>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <h2 style="margin-bottom: 20px;">ç³»çµ±ç¸½è¦½</h2>
                <div class="stats" id="stats">
                    <div class="stat-card">
                        <h3 id="totalPosts">0</h3>
                        <p>ç¸½è²¼æ–‡æ•¸</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="draftPosts">0</h3>
                        <p>è‰ç¨¿</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingPosts">0</h3>
                        <p>å¾…å¯©æ ¸</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="postedPosts">0</h3>
                        <p>å·²ç™¼å¸ƒ</p>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">æœ€è¿‘è²¼æ–‡</h3>
                <div id="recentPosts" class="posts-grid"></div>
            </div>

            <!-- Posts Tab -->
            <div id="postsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">è²¼æ–‡ç®¡ç†</h2>

                <div class="filter-bar">
                    <select id="filterStatus" onchange="loadPosts()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="DRAFT">è‰ç¨¿</option>
                        <option value="GENERATING">ç”¢ç”Ÿä¸­</option>
                        <option value="PENDING_REVIEW">å¾…å¯©æ ¸</option>
                        <option value="APPROVED">å·²æ ¸å‡†</option>
                        <option value="POSTED">å·²ç™¼å¸ƒ</option>
                        <option value="FAILED">å¤±æ•—</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="loadPosts()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>

                <div id="postsGrid" class="posts-grid"></div>
            </div>

            <!-- Create Tab (Manual Post) -->
            <div id="createTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">âœï¸ æ‰‹å‹•å»ºç«‹è²¼æ–‡</h2>
                <p style="color: #666; margin-bottom: 20px;">ç›´æ¥è¼¸å…¥è²¼æ–‡å…§å®¹ï¼Œç„¡éœ€ AI ç”Ÿæˆ</p>

                <form onsubmit="createManualPost(event)">
                    <div class="form-group">
                        <label>è²¼æ–‡å…§å®¹ *</label>
                        <textarea id="manualPostContent" rows="10" placeholder="ç›´æ¥è¼¸å…¥æ‚¨æƒ³ç™¼å¸ƒçš„å…§å®¹..." required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; line-height: 1.6;"></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            å­—æ•¸: <span id="contentCharCount">0</span> / 500 (Threads å»ºè­°)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒåˆ° Threads å¸³è™Ÿ *</label>
                        <select id="manualPostThreadsAccount" required style="padding: 12px; font-size: 15px;">
                            <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ç™¼å¸ƒæ™‚é–“</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="now" checked onchange="toggleScheduleInput()">
                                ç«‹å³ç™¼å¸ƒ
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="publishTime" value="scheduled" onchange="toggleScheduleInput()">
                                æ’ç¨‹ç™¼å¸ƒ
                            </label>
                        </div>
                        <input type="datetime-local" id="manualPostSchedule" style="padding: 12px; font-size: 15px; display: none;">
                    </div>

                    <button type="submit" class="btn" style="padding: 15px 30px; font-size: 16px;">ğŸ“¤ ç™¼å¸ƒè²¼æ–‡</button>
                </form>
            </div>

            <!-- Threads Accounts Tab -->
            <div id="accountsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Threads å¸³è™Ÿç®¡ç†</h2>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“± æ–°å¢ Threads å¸³è™Ÿ</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ç”±æ–¼ Threads API éœ€è¦ OAuth æˆæ¬Š,è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œ:
                    </p>
                    <ol style="color: #666; line-height: 1.8;">
                        <li>å‰å¾€ <a href="https://developers.facebook.com/" target="_blank" style="color: #667eea;">Meta Developers</a> å»ºç«‹æ‡‰ç”¨ç¨‹å¼</li>
                        <li>å–å¾— Client ID å’Œ Client Secret</li>
                        <li>è¨­å®š Redirect URI ç‚º: <code style="background: #e1e8ed; padding: 2px 6px; border-radius: 3px;">http://localhost:3000/api/threads/oauth/callback</code></li>
                        <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æˆæ¬Š</li>
                    </ol>
                    <button class="btn" onclick="startThreadsOAuth()" style="margin-top: 15px;">ğŸ”— é–‹å§‹ Threads æˆæ¬Š</button>
                </div>

                <h3 style="margin-bottom: 15px;">å·²é€£çµçš„ Threads å¸³è™Ÿ</h3>
                <div id="threadsAccountsList" class="posts-grid"></div>
            </div>

            <!-- Settings Tab (Automated Posting) -->
            <div id="settingsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ¤– è‡ªå‹•åŒ–ç™¼æ–‡è¨­å®š</h2>
                <p style="color: #666; margin-bottom: 20px;">è¨­å®š AI è‡ªå‹•ç”Ÿæˆå…§å®¹ä¸¦æŒ‰æ’ç¨‹ç™¼å¸ƒåˆ° Threads</p>

                <!-- Threads Account Selection -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ‘¤ ç™¼å¸ƒå¸³è™Ÿ</h3>
                    <div class="form-group">
                        <label>é¸æ“‡ Threads å¸³è™Ÿ</label>
                        <select id="autoPostThreadsAccount" class="form-control" style="padding: 12px; font-size: 16px;">
                            <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            è‡ªå‹•ç”Ÿæˆçš„è²¼æ–‡å°‡ç™¼å¸ƒåˆ°æ­¤å¸³è™Ÿã€‚æœªè¨­å®šå¸³è™Ÿ? è«‹åˆ°ã€ŒThreads å¸³è™Ÿã€åˆ†é æ–°å¢
                        </p>
                    </div>
                </div>

                <!-- LINE Notification Settings -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“± LINE é€šçŸ¥è¨­å®š</h3>
                    <div class="form-group">
                        <label>LINE User ID (æ¥æ”¶å¯©æ ¸é€šçŸ¥)</label>
                        <input type="text" id="lineNotifyUserId" class="form-control" placeholder="è«‹è¼¸å…¥ LINE User ID" style="padding: 12px; font-size: 16px;">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            ğŸ’¡ ç•¶è‡ªå‹•ç”Ÿæˆæ–‡ç« å®Œæˆå¾Œï¼Œç³»çµ±æœƒç™¼é€ LINE è¨Šæ¯åˆ°æ­¤å¸³è™Ÿé€²è¡Œå¯©æ ¸ã€‚<br>
                            ğŸ“Œ å¦‚ä½•å–å¾— LINE User ID: è«‹åŠ å…¥ LINE Bot ç‚ºå¥½å‹ï¼Œç™¼é€ã€Œ/myidã€æˆ–ã€Œæˆ‘çš„IDã€æˆ–ã€ŒæŸ¥è©¢IDã€å³å¯å–å¾—
                        </p>
                    </div>
                    <button class="btn btn-secondary" onclick="testLineNotification()" style="margin-top: 10px;">ğŸ”” æ¸¬è©¦ LINE é€šçŸ¥</button>
                </div>

                <!-- AI Engine Selection -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ¤– AI å¼•æ“é¸æ“‡</h3>
                    <div class="form-group">
                        <label>é¸æ“‡ AI å¼•æ“</label>
                        <select id="aiEngine" class="form-control" style="padding: 12px; font-size: 16px;">
                            <optgroup label="ğŸš€ OpenAI GPT-5.2 ç³»åˆ— (2025å¹´12æœˆ11æ—¥ç™¼å¸ƒ)">
                                <option value="GPT5_2">GPT-5.2 Thinking â­ æ¨ç†æ¨¡å¼ ($1.75/1Mè¼¸å…¥)</option>
                                <option value="GPT5_2_INSTANT">GPT-5.2 Instant âš¡ å³æ™‚æ¨¡å¼ ($1.75/1Mè¼¸å…¥)</option>
                                <option value="GPT5_2_PRO">GPT-5.2 Pro ğŸ† å°ˆæ¥­ç‰ˆæœ¬ ($1.75/1Mè¼¸å…¥)</option>
                            </optgroup>
                            <optgroup label="ğŸ¨ OpenAI GPT-4o ç³»åˆ—">
                                <option value="GPT4O">GPT-4o ğŸ”¥ æ——è‰¦å¤šæ¨¡æ…‹æ¨¡å‹</option>
                                <option value="GPT4O_MINI">GPT-4o Mini ğŸ’° å¿«é€Ÿç¶“æ¿Ÿç‰ˆæœ¬</option>
                            </optgroup>
                            <optgroup label="âš¡ Google Gemini 3 ç³»åˆ— (2025æœ€æ–°)">
                                <option value="GEMINI_3_FLASH">Gemini 3 Flash â­ æœ€æ–°Flash ($0.50/1Mè¼¸å…¥)</option>
                                <option value="GEMINI_3_PRO_PREVIEW">Gemini 3 Pro Preview ğŸ† æœ€æ–°Pro ($2/1Mè¼¸å…¥)</option>
                            </optgroup>
                            <optgroup label="âœ¨ Google Gemini 2.5 ç³»åˆ—">
                                <option value="GEMINI_2_5_PRO">Gemini 2.5 Pro</option>
                                <option value="GEMINI_2_5_FLASH">Gemini 2.5 Flash</option>
                                <option value="GEMINI_2_5_FLASH_LITE">Gemini 2.5 Flash Lite</option>
                            </optgroup>
                            <optgroup label="ğŸ“¦ Google Gemini 2.0 ç³»åˆ—">
                                <option value="GEMINI_2_0_FLASH">Gemini 2.0 Flash</option>
                                <option value="GEMINI_2_0_FLASH_LITE">Gemini 2.0 Flash Lite</option>
                            </optgroup>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            é¸æ“‡ç”¨æ–¼è‡ªå‹•ç”Ÿæˆå…§å®¹çš„ AI å¼•æ“ç‰ˆæœ¬ï¼ˆå·²æ›´æ–°è‡³ 2025 å¹´æœ€æ–°æ¨¡å‹ï¼‰
                        </p>
                    </div>
                </div>

                <!-- Custom Prompt -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">âœï¸ è‡ªè¨‚æç¤ºè©</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        è¨­å®š AI ç”Ÿæˆå…§å®¹çš„æç¤ºè©ï¼ŒåŒ…å«ç™¼æ–‡é¢¨æ ¼ã€èªæ°£ã€ä¸»é¡Œç­‰æ‰€æœ‰è¦æ±‚ã€‚
                    </p>

                    <div class="form-group">
                        <label>æç¤ºè©å…§å®¹</label>
                        <textarea id="customPrompt" rows="8" placeholder="ä¾‹å¦‚: è«‹ä»¥å°ˆæ¥­ã€å‹å–„çš„èªæ°£æ’°å¯«é—œæ–¼ç§‘æŠ€è¶¨å‹¢çš„æ–‡ç« ï¼Œå…§å®¹éœ€åŒ…å«å¯¦ç”¨å»ºè­°ï¼Œå­—æ•¸æ§åˆ¶åœ¨ 400 å­—ä»¥å…§..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 14px;"></textarea>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            ğŸ’¡ æç¤ºè©ä¸­è«‹æ˜ç¢ºèªªæ˜é¢¨æ ¼ã€èªæ°£ã€ä¸»é¡Œã€é•·åº¦ç­‰æ‰€æœ‰éœ€æ±‚
                        </p>
                    </div>
                </div>

                <!-- Schedule Configuration -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“… è‡ªå‹•ç™¼æ–‡æ’ç¨‹</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        è¨­å®šæ¯é€±è‡ªå‹•ç”¢ç”Ÿå…§å®¹çš„æ™‚é–“ï¼Œç³»çµ±æœƒåœ¨æŒ‡å®šæ™‚é–“è‡ªå‹•ç”Ÿæˆä¸€ç¯‡æ–‡ç« ä¸¦æ¨é€åˆ° LINE ç­‰å¾…å¯©æ ¸ã€‚
                    </p>

                    <div id="scheduleConfig" style="display: grid; gap: 15px;">
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_monday" checked>
                                <span style="font-weight: 600; min-width: 60px;">é€±ä¸€</span>
                                <input type="time" id="time_monday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_tuesday" checked>
                                <span style="font-weight: 600; min-width: 60px;">é€±äºŒ</span>
                                <input type="time" id="time_tuesday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_wednesday" checked>
                                <span style="font-weight: 600; min-width: 60px;">é€±ä¸‰</span>
                                <input type="time" id="time_wednesday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_thursday" checked>
                                <span style="font-weight: 600; min-width: 60px;">é€±å››</span>
                                <input type="time" id="time_thursday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_friday" checked>
                                <span style="font-weight: 600; min-width: 60px;">é€±äº”</span>
                                <input type="time" id="time_friday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_saturday">
                                <span style="font-weight: 600; min-width: 60px;">é€±å…­</span>
                                <input type="time" id="time_saturday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                        <div class="schedule-day" style="background: white; padding: 15px; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="schedule_sunday">
                                <span style="font-weight: 600; min-width: 60px;">é€±æ—¥</span>
                                <input type="time" id="time_sunday" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Test Generation -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ§ª å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
                    <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                        <strong>ç«¯åˆ°ç«¯æ¸¬è©¦æµç¨‹ï¼š</strong><br>
                        1ï¸âƒ£ ä½¿ç”¨ç•¶å‰è¨­å®šç”Ÿæˆæ¸¬è©¦æ–‡ç« <br>
                        2ï¸âƒ£ è‡ªå‹•å­˜å…¥ MySQL è³‡æ–™åº«<br>
                        3ï¸âƒ£ ç™¼é€å¯©æ ¸é€šçŸ¥åˆ°æ‚¨çš„ LINE<br>
                        4ï¸âƒ£ æ‚¨å¯åœ¨ LINE ä¸­ï¼š<br>
                        ã€€ã€€âœ… ç¢ºèªç™¼æ–‡ â†’ ç™¼å¸ƒåˆ° Threads<br>
                        ã€€ã€€ğŸ”„ é‡æ–°ç”Ÿæˆ â†’ ç”¢ç”Ÿæ–°æ–‡ç« <br>
                        ã€€ã€€âœï¸ ä¿®æ”¹å…§å®¹ â†’ ç·¨è¼¯å¾Œç™¼å¸ƒ<br>
                        <br>
                        <span style="color: #ff6600;">âš ï¸ è«‹å…ˆè¨­å®š LINE User ID æ‰èƒ½é€²è¡Œæ¸¬è©¦</span>
                    </p>

                    <button class="btn btn-secondary" onclick="runTestGeneration()" style="width: 100%; padding: 15px; font-size: 16px; font-weight: bold;">
                        ğŸš€ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦
                    </button>

                    <div id="testResults" style="margin-top: 20px; display: none;">
                        <div id="testResultsContent"></div>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="text-align: center;">
                    <button class="btn" onclick="saveAllSettings()" style="padding: 15px 40px; font-size: 18px;">
                        ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è²¼æ–‡è©³æƒ…</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Global variables
        let token = localStorage.getItem('token');
        const API_BASE = '/api';

        // Initialize
        if (token) {
            checkAuth();
        }

        // Authentication
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showDashboard(data.user);
                } else {
                    showAlert('loginAlert', data.error || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'é€£ç·šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/posts?limit=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('userInfo').classList.remove('active');
        }

        function showDashboard(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userInfo').classList.add('active');

            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRoles').textContent = user.roles.join(', ');
            }

            loadOverview();
            loadPosts();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'overview') loadOverview();
            if (tabName === 'posts') loadPosts();
            if (tabName === 'create') {
                loadThreadsAccountsForDropdowns();
            }
            if (tabName === 'accounts') loadThreadsAccountsList();
            if (tabName === 'settings') {
                loadSettings();
                loadThreadsAccountsForDropdowns();
            }
        }

        // Load overview
        async function loadOverview() {
            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();

                // Update stats
                document.getElementById('totalPosts').textContent = data.total || 0;

                // Safely handle data array
                const posts = data.data || data.posts || [];

                const statuses = posts.reduce((acc, post) => {
                    acc[post.status] = (acc[post.status] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('draftPosts').textContent = statuses.DRAFT || 0;
                document.getElementById('pendingPosts').textContent = statuses.PENDING_REVIEW || 0;
                document.getElementById('postedPosts').textContent = statuses.POSTED || 0;

                // Show recent posts
                const recentPosts = posts.slice(0, 5);
                renderPosts(recentPosts, 'recentPosts');
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥ç¸½è¦½å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Load posts
        async function loadPosts() {
            const status = document.getElementById('filterStatus')?.value || '';
            const url = status ? `${API_BASE}/posts?status=${status}` : `${API_BASE}/posts`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                const posts = data.data || data.posts || [];
                renderPosts(posts, 'postsGrid');
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è²¼æ–‡å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Render posts
        function renderPosts(posts, containerId) {
            const container = document.getElementById(containerId);

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px;">æš«ç„¡è²¼æ–‡</p>
                        <p style="margin-top: 10px;">å»ºç«‹ç¬¬ä¸€ç¯‡è²¼æ–‡é–‹å§‹ä½¿ç”¨!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h3>æ–‡ç«  #${post.id.substring(0, 8)}</h3>
                        <span class="status-badge status-${post.status}">${getStatusText(post.status)}</span>
                    </div>

                    <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.created_at).toLocaleString('zh-TW')}</p>
                    ${post.posted_at ? `<p><strong>ç™¼å¸ƒæ™‚é–“:</strong> ${new Date(post.posted_at).toLocaleString('zh-TW')}</p>` : ''}
                    ${post.post_url ? `<p><strong>è²¼æ–‡é€£çµ:</strong> <a href="${post.post_url}" target="_blank">æŸ¥çœ‹</a></p>` : ''}

                    <div class="post-actions">
                        <button class="btn btn-small btn-secondary" onclick="viewPost('${post.id}')">æŸ¥çœ‹è©³æƒ…</button>
                        ${post.status === 'DRAFT' ? `<button class="btn btn-small btn-success" onclick="generateContent('${post.id}')">ç”Ÿæˆå…§å®¹</button>` : ''}
                        ${post.status === 'APPROVED' ? `<button class="btn btn-small btn-success" onclick="publishPost('${post.id}')">ç™¼å¸ƒ</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-success" onclick="approvePost('${post.id}')">æ ¸å‡†</button>` : ''}
                        ${post.status === 'PENDING_REVIEW' ? `<button class="btn btn-small btn-warning" onclick="regenerateContent('${post.id}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePost('${post.id}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // Create post
        async function createPost(event) {
            event.preventDefault();
            showLoading(true);

            const topic = document.getElementById('postTopic').value;
            const keywords = document.getElementById('postKeywords').value.split(',').map(k => k.trim());
            const targetTone = document.getElementById('postTone').value;
            const targetLength = parseInt(document.getElementById('postLength').value);
            const scheduledFor = document.getElementById('postSchedule').value;
            const autoGenerate = document.getElementById('autoGenerate').checked;

            const postData = {
                topic,
                keywords,
                targetTone,
                targetLength,
                ...(scheduledFor && { scheduledFor: new Date(scheduledFor).toISOString() })
            };

            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å»ºç«‹æˆåŠŸ!', 'success');
                    event.target.reset();

                    if (autoGenerate) {
                        await generateContent(data.id);
                    }

                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', data.error || 'å»ºç«‹å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Generate content
        async function generateContent(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'å…§å®¹ç”Ÿæˆä»»å‹™å·²åŠ å…¥ä½‡åˆ—,è«‹ç¨å¾ŒæŸ¥çœ‹', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç”Ÿæˆå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // View post detail
        async function viewPost(postId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const post = await response.json();

                if (response.ok) {
                    const modalBody = document.getElementById('modalBody');
                    modalBody.innerHTML = `
                        <h3>${post.topic}</h3>
                        <p><span class="status-badge status-${post.status}">${getStatusText(post.status)}</span></p>

                        <div style="margin: 20px 0;">
                            <p><strong>é—œéµå­—:</strong> ${post.keywords.join(', ')}</p>
                            <p><strong>èªæ°£:</strong> ${post.targetTone}</p>
                            <p><strong>ç›®æ¨™é•·åº¦:</strong> ${post.targetLength} å­—</p>
                            <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(post.createdAt).toLocaleString('zh-TW')}</p>
                            ${post.scheduledFor ? `<p><strong>æ’ç¨‹æ™‚é–“:</strong> ${new Date(post.scheduledFor).toLocaleString('zh-TW')}</p>` : ''}
                        </div>

                        ${post.latestRevision ? `
                            <h4>æœ€æ–°å…§å®¹ç‰ˆæœ¬</h4>
                            <div class="content-preview">${post.latestRevision.content}</div>
                            <p><strong>å­—æ•¸:</strong> ${post.latestRevision.wordCount}</p>
                            <p><strong>AI å¼•æ“:</strong> ${post.latestRevision.aiEngine}</p>
                            <p><strong>ç”Ÿæˆæ™‚é–“:</strong> ${new Date(post.latestRevision.createdAt).toLocaleString('zh-TW')}</p>
                        ` : '<p style="color: #666;">å°šæœªç”Ÿæˆå…§å®¹</p>'}
                    `;

                    document.getElementById('postModal').classList.add('active');
                } else {
                    showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Approve post
        async function approvePost(postId) {
            if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤è²¼æ–‡å—?')) return;

            showLoading(true);

            try {
                // Get post detail first to get revision ID
                const postResponse = await fetch(`${API_BASE}/posts/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const post = await postResponse.json();

                if (!post.latestRevision) {
                    throw new Error('æ‰¾ä¸åˆ°å…§å®¹ç‰ˆæœ¬');
                }

                const response = await fetch(`${API_BASE}/review/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        postId: postId,
                        revisionId: post.latestRevision.id,
                        action: 'approve'
                    })
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²æ ¸å‡†', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'æ ¸å‡†å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'æ ¸å‡†å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Regenerate content
        async function regenerateContent(postId) {
            if (!confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆå…§å®¹å—?')) return;
            await generateContent(postId);
        }

        // Publish post
        async function publishPost(postId) {
            if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒæ­¤è²¼æ–‡åˆ° Threads å—?')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/publish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('dashboardAlert', 'ç™¼å¸ƒä»»å‹™å·²åŠ å…¥ä½‡åˆ—', 'info');
                    setTimeout(() => {
                        loadPosts();
                        loadOverview();
                    }, 3000);
                } else {
                    showAlert('dashboardAlert', data.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Delete post
        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'è²¼æ–‡å·²åˆªé™¤', 'success');
                    loadPosts();
                    loadOverview();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Utilities
        function getStatusText(status) {
            const statusMap = {
                'DRAFT': 'è‰ç¨¿',
                'GENERATING': 'ç”¢ç”Ÿä¸­',
                'PENDING_REVIEW': 'å¾…å¯©æ ¸',
                'APPROVED': 'å·²æ ¸å‡†',
                'PUBLISHING': 'ç™¼å¸ƒä¸­',
                'POSTED': 'å·²ç™¼å¸ƒ',
                'FAILED': 'å¤±æ•—',
                'ACTION_REQUIRED': 'éœ€è¦è™•ç†',
                'SKIPPED': 'å·²è·³é'
            };
            return statusMap[status] || status;
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function closeModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        // Threads Accounts Management
        async function loadThreadsAccounts() {
            // Load accounts for dropdown in create form
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const accounts = await response.json();
                    const select = document.getElementById('postThreadsAccount');
                    select.innerHTML = '<option value="">ç¨å¾Œé¸æ“‡</option>';

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = `@${acc.username}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
        }

        async function loadThreadsAccountsList() {
            const container = document.getElementById('threadsAccountsList');

            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const accounts = data.accounts || [];

                    if (accounts.length === 0) {
                        container.innerHTML = '<div class="empty-state"><p>å°šæœªé€£çµä»»ä½• Threads å¸³è™Ÿ</p></div>';
                        return;
                    }

                    container.innerHTML = accounts.map(acc => `
                        <div class="post-card">
                            <h3>@${acc.username}</h3>
                            <p><strong>å¸³è™Ÿ ID:</strong> ${acc.threads_user_id || acc.account_id}</p>
                            <p><strong>é€£çµæ™‚é–“:</strong> ${new Date(acc.created_at).toLocaleString('zh-TW')}</p>
                            <div class="post-actions">
                                <button class="btn btn-small btn-danger" onclick="removeThreadsAccount('${acc.id}')">è§£é™¤é€£çµ</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—: ' + error.message + '</p></div>';
            }
        }

        async function startThreadsOAuth() {
            try {
                // Get OAuth URL from backend with authentication
                const response = await fetch(`${API_BASE}/threads/oauth/authorize`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authUrl) {
                        // Redirect to Threads authorization page
                        window.location.href = data.authUrl;
                    }
                } else {
                    const error = await response.json();
                    showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', `æˆæ¬Šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function removeThreadsAccount(accountId) {
            if (!confirm('ç¢ºå®šè¦è§£é™¤é€£çµæ­¤ Threads å¸³è™Ÿå—?')) return;

            try {
                const response = await fetch(`${API_BASE}/threads/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('dashboardAlert', 'Threads å¸³è™Ÿå·²è§£é™¤é€£çµ', 'success');
                    loadThreadsAccountsList();
                } else {
                    const data = await response.json();
                    showAlert('dashboardAlert', data.error || 'è§£é™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'è§£é™¤å¤±æ•—: ' + error.message, 'error');
            }
        }

        // Settings Management
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('è¼‰å…¥è¨­å®šå¤±æ•—');

                const data = await response.json();
                const settings = data.settings;

                // AI Engine
                if (settings.ai_engine) {
                    const aiEngineEl = document.getElementById('aiEngine');
                    if (aiEngineEl) aiEngineEl.value = settings.ai_engine.value;
                }

                // Custom Prompt
                if (settings.custom_prompt) {
                    const customPromptEl = document.getElementById('customPrompt');
                    if (customPromptEl) customPromptEl.value = settings.custom_prompt.value;
                }

                // Schedule Config
                if (settings.schedule_config) {
                    const scheduleConfig = settings.schedule_config.value;
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                    days.forEach(day => {
                        const config = scheduleConfig[day];
                        if (config) {
                            const checkboxEl = document.getElementById(`schedule_${day}`);
                            const timeEl = document.getElementById(`time_${day}`);
                            if (checkboxEl) checkboxEl.checked = config.enabled;
                            if (timeEl) timeEl.value = config.time;
                        }
                    });
                }

                // Auto Post Threads Account
                if (settings.auto_post_threads_account) {
                    const autoPostEl = document.getElementById('autoPostThreadsAccount');
                    if (autoPostEl) autoPostEl.value = settings.auto_post_threads_account.value;
                }

                // LINE Notify User ID
                if (settings.line_notify_user_id) {
                    const lineUserIdEl = document.getElementById('lineNotifyUserId');
                    if (lineUserIdEl) lineUserIdEl.value = settings.line_notify_user_id.value;
                }

            } catch (error) {
                showAlert('dashboardAlert', 'è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function saveAllSettings() {
            showLoading(true);

            try {
                // Collect schedule config
                const scheduleConfig = {
                    monday: {
                        enabled: document.getElementById('schedule_monday').checked,
                        time: document.getElementById('time_monday').value
                    },
                    tuesday: {
                        enabled: document.getElementById('schedule_tuesday').checked,
                        time: document.getElementById('time_tuesday').value
                    },
                    wednesday: {
                        enabled: document.getElementById('schedule_wednesday').checked,
                        time: document.getElementById('time_wednesday').value
                    },
                    thursday: {
                        enabled: document.getElementById('schedule_thursday').checked,
                        time: document.getElementById('time_thursday').value
                    },
                    friday: {
                        enabled: document.getElementById('schedule_friday').checked,
                        time: document.getElementById('time_friday').value
                    },
                    saturday: {
                        enabled: document.getElementById('schedule_saturday').checked,
                        time: document.getElementById('time_saturday').value
                    },
                    sunday: {
                        enabled: document.getElementById('schedule_sunday').checked,
                        time: document.getElementById('time_sunday').value
                    }
                };

                const settings = {
                    ai_engine: {
                        value: document.getElementById('aiEngine').value,
                        type: 'STRING'
                    },
                    custom_prompt: {
                        value: document.getElementById('customPrompt').value,
                        type: 'STRING'
                    },
                    schedule_config: {
                        value: scheduleConfig,
                        type: 'JSON'
                    },
                    auto_post_threads_account: {
                        value: document.getElementById('autoPostThreadsAccount').value,
                        type: 'STRING'
                    },
                    line_notify_user_id: {
                        value: document.getElementById('lineNotifyUserId').value,
                        type: 'STRING'
                    }
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ settings })
                });

                if (!response.ok) throw new Error('å„²å­˜è¨­å®šå¤±æ•—');

                showAlert('dashboardAlert', 'âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testLineNotification() {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/settings/test-line`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æ¸¬è©¦é€šçŸ¥å¤±æ•—');
                }

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€åˆ° LINEï¼è«‹æª¢æŸ¥æ‚¨çš„ LINE è¨Šæ¯ã€‚', 'success');
            } catch (error) {
                showAlert('dashboardAlert', 'âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function runTestGeneration() {
            showLoading(true);
            document.getElementById('testResults').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/settings/test-generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let errorMessage = 'æ¸¬è©¦ç”Ÿæˆå¤±æ•—';
                    try {
                        const error = await response.json();
                        errorMessage = error.error || error.message || errorMessage;
                        console.error('API Error:', error);
                    } catch (e) {
                        const text = await response.text();
                        console.error('Response text:', text);
                        errorMessage = text || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Test generation response:', data);

                // Display success message with content preview
                const resultHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #1DB446;">
                        <h4 style="margin: 0 0 15px 0; color: #1DB446;">âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆï¼</h4>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“Š ç”Ÿæˆè³‡è¨Šï¼š</strong></p>
                            <p style="margin: 5px 0;">ğŸ¤– å¼•æ“ï¼š${data.engine}</p>
                            <p style="margin: 5px 0;">ğŸ“ˆ ç›¸ä¼¼åº¦ï¼š${(data.similarity * 100).toFixed(1)}%</p>
                            <p style="margin: 5px 0; color: ${data.similarity > 0.86 ? '#ff0000' : '#4CAF50'};">
                                ${data.similarity > 0.86 ? 'âš ï¸ ç›¸ä¼¼åº¦è¼ƒé«˜ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆ' : 'âœ… ç›¸ä¼¼åº¦æ­£å¸¸'}
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0;"><strong>ğŸ“ æ–‡ç« å…§å®¹é è¦½ï¼š</strong></p>
                            <p style="white-space: pre-wrap; margin: 0; line-height: 1.6; color: #333;">
                                ${data.content.substring(0, 200)}${data.content.length > 200 ? '...' : ''}
                            </p>
                        </div>

                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #2e7d32;">ğŸ“± ä¸‹ä¸€æ­¥ï¼š</p>
                            <p style="margin: 10px 0 0 0; line-height: 1.8; color: #333;">
                                æ¸¬è©¦æ–‡ç« å·²ç™¼é€åˆ°æ‚¨çš„ LINEï¼<br>
                                è«‹åˆ° LINE æŸ¥çœ‹å®Œæ•´å…§å®¹ä¸¦é€²è¡Œå¯©æ ¸ï¼š<br>
                                â€¢ âœ… ç¢ºèªç™¼æ–‡ â†’ ç™¼å¸ƒåˆ° Threads<br>
                                â€¢ ğŸ”„ é‡æ–°ç”Ÿæˆ â†’ ç”¢ç”Ÿæ–°æ–‡ç« <br>
                                â€¢ âœï¸ ä¿®æ”¹å…§å®¹ â†’ ç·¨è¼¯å¾Œç™¼å¸ƒ
                            </p>
                        </div>
                    </div>
                `;

                document.getElementById('testResultsContent').innerHTML = resultHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'âœ… æ¸¬è©¦æ–‡ç« å·²ç”Ÿæˆä¸¦ç™¼é€åˆ° LINEï¼è«‹åˆ° LINE æŸ¥çœ‹ã€‚', 'success');
            } catch (error) {
                const errorHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 10px 0; color: #f44336;">âŒ æ¸¬è©¦å¤±æ•—</h4>
                        <p style="margin: 0; color: #666;">${error.message}</p>
                        ${error.message.includes('LINE User ID') ? `
                            <p style="margin: 15px 0 0 0; padding: 10px; background: #fff3e0; border-radius: 4px; color: #ff6600;">
                                ğŸ’¡ æç¤ºï¼šè«‹å…ˆè¨­å®š LINE User ID<br>
                                1. åœ¨ LINE ä¸­å‚³é€ã€Œ/myidã€çµ¦æ©Ÿå™¨äºº<br>
                                2. è¤‡è£½æ”¶åˆ°çš„ User ID<br>
                                3. è²¼åˆ°ä¸Šæ–¹ã€ŒLINE é€šçŸ¥è¨­å®šã€ä¸¦å„²å­˜
                            </p>
                        ` : ''}
                    </div>
                `;
                document.getElementById('testResultsContent').innerHTML = errorHtml;
                document.getElementById('testResults').style.display = 'block';

                showAlert('dashboardAlert', 'æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Character counter for manual post content
        const manualContentTextarea = document.getElementById('manualPostContent');
        if (manualContentTextarea) {
            manualContentTextarea.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('contentCharCount').textContent = count;
            });
        }

        // Toggle schedule input visibility
        function toggleScheduleInput() {
            const scheduleInput = document.getElementById('manualPostSchedule');
            const isScheduled = document.querySelector('input[name="publishTime"]:checked')?.value === 'scheduled';
            if (scheduleInput) {
                scheduleInput.style.display = isScheduled ? 'block' : 'none';
                if (!isScheduled) {
                    scheduleInput.value = '';
                }
            }
        }

        // Load Threads accounts into dropdowns
        async function loadThreadsAccountsForDropdowns() {
            try {
                const response = await fetch(`${API_BASE}/threads/accounts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¸³è™Ÿå¤±æ•—');

                const data = await response.json();
                const accounts = data.accounts || [];

                // Populate manual post dropdown
                const manualSelect = document.getElementById('manualPostThreadsAccount');
                if (manualSelect) {
                    manualSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }

                // Populate auto post dropdown
                const autoSelect = document.getElementById('autoPostThreadsAccount');
                if (autoSelect) {
                    autoSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>' +
                        accounts.map(acc =>
                            `<option value="${acc.id}">${acc.username} (@${acc.threads_user_id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸³è™Ÿåˆ—è¡¨å¤±æ•—:', error);
            }
        }

        // Create manual post (direct publishing without AI)
        async function createManualPost(event) {
            event.preventDefault();
            showLoading(true);

            const content = document.getElementById('manualPostContent').value.trim();
            const accountId = document.getElementById('manualPostThreadsAccount').value;
            const publishTime = document.querySelector('input[name="publishTime"]:checked')?.value;
            const scheduledFor = publishTime === 'scheduled'
                ? document.getElementById('manualPostSchedule').value
                : null;

            // Validation
            if (!content) {
                showAlert('dashboardAlert', 'è«‹è¼¸å…¥è²¼æ–‡å…§å®¹', 'error');
                showLoading(false);
                return;
            }

            if (content.length > 500) {
                showAlert('dashboardAlert', 'è²¼æ–‡å…§å®¹ä¸èƒ½è¶…é 500 å­—', 'error');
                showLoading(false);
                return;
            }

            if (!accountId) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡ Threads å¸³è™Ÿ', 'error');
                showLoading(false);
                return;
            }

            if (publishTime === 'scheduled' && !scheduledFor) {
                showAlert('dashboardAlert', 'è«‹é¸æ“‡æ’ç¨‹æ™‚é–“', 'error');
                showLoading(false);
                return;
            }

            try {
                // Create post with manual content
                const postResponse = await fetch(`${API_BASE}/posts/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content,
                        accountId,
                        scheduledFor: scheduledFor ? new Date(scheduledFor).toISOString() : null
                    })
                });

                const postData = await postResponse.json();

                if (postResponse.ok) {
                    showAlert('dashboardAlert', publishTime === 'now' ? 'âœ… è²¼æ–‡å·²åŠ å…¥ç™¼å¸ƒä½‡åˆ—ï¼' : 'âœ… è²¼æ–‡å·²æ’ç¨‹æˆåŠŸï¼', 'success');
                    document.getElementById('manualPostContent').value = '';
                    document.getElementById('contentCharCount').textContent = '0';
                    document.getElementById('manualPostThreadsAccount').value = '';
                    document.querySelector('input[name="publishTime"][value="now"]').checked = true;
                    toggleScheduleInput();
                    switchTab('posts');
                    loadPosts();
                    loadOverview();
                } else {
                    showAlert('dashboardAlert', postData.error || 'ç™¼å¸ƒå¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'ç™¼å¸ƒå¤±æ•—: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Auto refresh
        setInterval(() => {
            if (token && document.getElementById('dashboard').classList.contains('active')) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'overviewTab') loadOverview();
                if (activeTab.id === 'postsTab') loadPosts();
                if (activeTab.id === 'accountsTab') loadThreadsAccountsList();
            }
        }, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>
